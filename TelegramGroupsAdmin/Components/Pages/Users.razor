@page "/users"
@attribute [Authorize(Roles = "Admin,Owner")]
@using TelegramGroupsAdmin.Telegram.Services
@using TelegramGroupsAdmin.Telegram.Models
@inject TelegramUserManagementService UserManagementService
@inject ISnackbar Snackbar

<PageTitle>Users - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Telegram Users</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Manage Telegram users across all monitored chats</MudText>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="All" Icon="@Icons.Material.Filled.People" BadgeData="@_allUsers.Count">
            <MudTable Items="@_allUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Chats</MudTh>
                    <MudTh>Warnings</MudTh>
                    <MudTh>Last Seen</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/images/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.TelegramUserId</MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @GetStatusIcon(context.Status) @context.Status.ToString()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Chats">@context.ChatCount</MudTd>
                    <MudTd DataLabel="Warnings">
                        @if (context.WarningCount > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.WarningCount</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">None</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Last Seen">@FormatTimestamp(context.LastSeenAt)</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                        <MudTooltip Text="@(context.IsTrusted ? "Remove Trust" : "Trust User")">
                            <MudIconButton Icon="@(context.IsTrusted ? Icons.Material.Filled.PersonOff : Icons.Material.Filled.VerifiedUser)"
                                          Size="Size.Small"
                                          Color="@(context.IsTrusted ? Color.Default : Color.Success)"
                                          OnClick="@(() => ToggleTrust(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Flagged" Icon="@Icons.Material.Filled.Flag" BadgeData="@_flaggedUsers.Count" BadgeColor="Color.Warning">
            <MudTable Items="@_flaggedUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Warnings</MudTh>
                    <MudTh>Last Seen</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/images/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.TelegramUserId</MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @GetStatusIcon(context.Status) @context.Status.ToString()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Warnings">
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.WarningCount</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Last Seen">@FormatTimestamp(context.LastSeenAt)</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Trusted" Icon="@Icons.Material.Filled.VerifiedUser" BadgeData="@_trustedUsers.Count" BadgeColor="Color.Success">
            <MudTable Items="@_trustedUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Chats</MudTh>
                    <MudTh>Last Seen</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/images/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.TelegramUserId</MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Chats">@context.ChatCount</MudTd>
                    <MudTd DataLabel="Last Seen">@FormatTimestamp(context.LastSeenAt)</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                        <MudTooltip Text="Remove Trust">
                            <MudIconButton Icon="@Icons.Material.Filled.PersonOff" Size="Size.Small" OnClick="@(() => ToggleTrust(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Banned" Icon="@Icons.Material.Filled.Block" BadgeData="@_bannedUsers.Count" BadgeColor="Color.Error">
            <MudTable Items="@_bannedUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Warnings</MudTh>
                    <MudTh>Last Seen</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/images/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.TelegramUserId</MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Warnings">@context.WarningCount</MudTd>
                    <MudTd DataLabel="Last Seen">@FormatTimestamp(context.LastSeenAt)</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<TelegramUserListItem> _allUsers = new();
    private List<TelegramUserListItem> _flaggedUsers = new();
    private List<TelegramUserListItem> _trustedUsers = new();
    private List<TelegramUserListItem> _bannedUsers = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Load all user lists in parallel
            var allUsersTask = UserManagementService.GetAllUsersAsync();
            var flaggedTask = UserManagementService.GetFlaggedUsersAsync();
            var trustedTask = UserManagementService.GetTrustedUsersAsync();
            var bannedTask = UserManagementService.GetBannedUsersAsync();

            await Task.WhenAll(allUsersTask, flaggedTask, trustedTask, bannedTask);

            _allUsers = await allUsersTask;
            _flaggedUsers = await flaggedTask;
            _trustedUsers = await trustedTask;
            _bannedUsers = await bannedTask;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ToggleTrust(TelegramUserListItem user)
    {
        try
        {
            var action = user.IsTrusted ? "remove trust from" : "trust";
            var success = await UserManagementService.ToggleTrustAsync(user.TelegramUserId, "web_admin");

            if (success)
            {
                Snackbar.Add($"Successfully {action}ed {user.DisplayName}", Severity.Success);
                await LoadUsersAsync();
            }
            else
            {
                Snackbar.Add($"Failed to {action} {user.DisplayName}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error toggling trust: {ex.Message}", Severity.Error);
        }
    }

    private void ViewUserDetail(long userId)
    {
        // TODO: Implement user detail modal/page
        Snackbar.Add($"User detail view for {userId} - Coming soon", Severity.Info);
    }

    private static Color GetStatusColor(TelegramUserStatus status) => status switch
    {
        TelegramUserStatus.Trusted => Color.Success,
        TelegramUserStatus.Banned => Color.Error,
        TelegramUserStatus.Warned => Color.Warning,
        TelegramUserStatus.Flagged => Color.Warning,
        TelegramUserStatus.Clean => Color.Info,
        _ => Color.Default
    };

    private static string GetStatusIcon(TelegramUserStatus status) => status switch
    {
        TelegramUserStatus.Trusted => "ðŸŸ¢",
        TelegramUserStatus.Banned => "ðŸ”´",
        TelegramUserStatus.Warned => "ðŸŸ ",
        TelegramUserStatus.Flagged => "ðŸŸ¡",
        TelegramUserStatus.Clean => "ðŸ”µ",
        _ => ""
    };

    private static string FormatTimestamp(DateTimeOffset timestamp)
    {
        var dt = timestamp.ToLocalTime();
        var now = DateTimeOffset.Now;

        if (dt.Date == now.Date)
            return dt.ToString("h:mm tt");
        if (dt.Date == now.AddDays(-1).Date)
            return $"Yesterday {dt:h:mm tt}";
        if (dt.Year == now.Year)
            return dt.ToString("MMM dd h:mm tt");
        return dt.ToString("MMM dd yyyy");
    }
}
