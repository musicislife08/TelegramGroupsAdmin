@page "/users"
@attribute [Authorize(Roles = "GlobalAdmin,Owner")]
@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Components.Shared.Settings
@inject TelegramUserManagementService UserManagementService
@inject BlazorAuthHelper AuthHelper
@inject IManagedChatsRepository ManagedChatsRepository
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Users - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Telegram Users</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Manage Telegram users across all monitored chats</MudText>

    @* Search and Filter Bar *@
    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_searchText"
                          Label="Search users"
                          Placeholder="Search by name, username, or ID..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          OnKeyUp="@((_) => ApplyFilters())"
                          Clearable="true"
                          OnClearButtonClick="@(() => { _searchText = string.Empty; ApplyFilters(); })" />

            <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                <MudChip T="string"
                         Text="@($"Total: {_allUsers.Count}")"
                         Color="Color.Default"
                         Size="Size.Small" />
                @if (!string.IsNullOrWhiteSpace(_searchText))
                {
                    <MudChip T="string"
                             Text="@($"Filtered: {_filteredCount}")"
                             Color="Color.Primary"
                             Size="Size.Small"
                             OnClose="@(() => { _searchText = string.Empty; ApplyFilters(); })"/>
                }
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Active" Icon="@Icons.Material.Filled.People" BadgeData="@FilteredActiveUsers.Count">
            <MudTable Items="@FilteredActiveUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.DisplayName)">User</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.ChatCount)">Chats</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.WarningCount)">Warnings</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.LastSeenAt)">Last Seen</MudTableSortLabel></MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/media/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                    @if (context.IsTrusted)
                                    {
                                        <MudTooltip Text="Trusted User">
                                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsAdmin)
                                    {
                                        <MudTooltip Text="Admin in at least one chat">
                                            <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Info" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsTagged)
                                    {
                                        <MudTooltip Text="Has tags or notes">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalOffer" Color="Color.Warning" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username 路 </text>
                                    }
                                    ID: @context.TelegramUserId
                                </MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @GetStatusIcon(context.Status) @context.Status.ToString()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Chats">@context.ChatCount</MudTd>
                    <MudTd DataLabel="Warnings">
                        @if (context.WarningCount > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.WarningCount</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">None</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Last Seen">
                        <span class="local-timestamp" data-utc="@context.LastSeenAt.ToString("o")">@context.LastSeenAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                        <MudTooltip Text="@(context.IsTrusted ? "Remove Trust" : "Trust User")">
                            <MudIconButton Icon="@(context.IsTrusted ? Icons.Material.Filled.PersonOff : Icons.Material.Filled.VerifiedUser)"
                                          Size="Size.Small"
                                          Color="@(context.IsTrusted ? Color.Default : Color.Success)"
                                          OnClick="@(() => ToggleTrust(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="[25, 50, 100]" />
                </PagerContent>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Tagged" Icon="@Icons.Material.Filled.LocalOffer" BadgeData="@FilteredTaggedUsers.Count" BadgeColor="Color.Warning">
            <MudTable Items="@FilteredTaggedUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.DisplayName)">User</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.WarningCount)">Warnings</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.LastSeenAt)">Last Seen</MudTableSortLabel></MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/media/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                    @if (context.IsTrusted)
                                    {
                                        <MudTooltip Text="Trusted User">
                                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsAdmin)
                                    {
                                        <MudTooltip Text="Admin in at least one chat">
                                            <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Info" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsTagged)
                                    {
                                        <MudTooltip Text="Has tags or notes">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalOffer" Color="Color.Warning" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username 路 </text>
                                    }
                                    ID: @context.TelegramUserId
                                </MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @GetStatusIcon(context.Status) @context.Status.ToString()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Warnings">
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.WarningCount</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Last Seen">
                        <span class="local-timestamp" data-utc="@context.LastSeenAt.ToString("o")">@context.LastSeenAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Trusted" Icon="@Icons.Material.Filled.VerifiedUser" BadgeData="@FilteredTrustedUsers.Count" BadgeColor="Color.Success">
            <MudTable Items="@FilteredTrustedUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.DisplayName)">User</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.ChatCount)">Chats</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<TelegramUserListItem, object>(x => x.LastSeenAt)">Last Seen</MudTableSortLabel></MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/media/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                    @if (context.IsTrusted)
                                    {
                                        <MudTooltip Text="Trusted User">
                                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsAdmin)
                                    {
                                        <MudTooltip Text="Admin in at least one chat">
                                            <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Info" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsTagged)
                                    {
                                        <MudTooltip Text="Has tags or notes">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalOffer" Color="Color.Warning" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username 路 </text>
                                    }
                                    ID: @context.TelegramUserId
                                </MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Chats">@context.ChatCount</MudTd>
                    <MudTd DataLabel="Last Seen">
                        <span class="local-timestamp" data-utc="@context.LastSeenAt.ToString("o")">@context.LastSeenAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                        <MudTooltip Text="Remove Trust">
                            <MudIconButton Icon="@Icons.Material.Filled.PersonOff" Size="Size.Small" OnClick="@(() => ToggleTrust(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Banned" Icon="@Icons.Material.Filled.Block" BadgeData="@FilteredBannedUsersWithDetails.Count" BadgeColor="Color.Error">
            <MudTable Items="@FilteredBannedUsersWithDetails" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Ban Date</MudTh>
                    <MudTh>Banned By</MudTh>
                    <MudTh>Reason</MudTh>
                    <MudTh>Expires</MudTh>
                    <MudTh>Warnings</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(context.UserPhotoPath))
                            {
                                <img src="@($"/media/{context.UserPhotoPath}")" alt="@context.DisplayName" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                </MudAvatar>
                            }
                            <div>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body2">@context.DisplayName</MudText>
                                    @if (context.IsTrusted)
                                    {
                                        <MudTooltip Text="Trusted User">
                                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsAdmin)
                                    {
                                        <MudTooltip Text="Admin in at least one chat">
                                            <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Info" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                    @if (context.IsTagged)
                                    {
                                        <MudTooltip Text="Has tags or notes">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalOffer" Color="Color.Warning" Size="Size.Small" />
                                        </MudTooltip>
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username 路 </text>
                                    }
                                    ID: @context.TelegramUserId
                                </MudText>
                            </div>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Ban Date">
                        <MudText Typo="Typo.body2">
                            <span class="local-timestamp" data-utc="@context.BanDate.ToString("o")">@context.BanDate.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Banned By">
                        <MudText Typo="Typo.body2">@context.BannedBy</MudText>
                    </MudTd>
                    <MudTd DataLabel="Reason">
                        <MudText Typo="Typo.body2">@(context.BanReason ?? "No reason provided")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Expires">
                        @if (context.IsPermanentBan)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">Permanent</MudChip>
                        }
                        else if (context.BanExpires.HasValue)
                        {
                            var timeRemaining = context.BanExpires.Value - DateTimeOffset.UtcNow;
                            @if (timeRemaining.TotalDays > 1)
                            {
                                <MudText Typo="Typo.body2">@($"{(int)timeRemaining.TotalDays}d {timeRemaining.Hours}h")</MudText>
                            }
                            else if (timeRemaining.TotalHours > 1)
                            {
                                <MudText Typo="Typo.body2">@($"{(int)timeRemaining.TotalHours}h {timeRemaining.Minutes}m")</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">@($"{(int)timeRemaining.TotalMinutes}m")</MudText>
                            }
                        }
                    </MudTd>
                    <MudTd DataLabel="Warnings">
                        @if (context.WarningCount > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.WarningCount</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">None</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudTooltip Text="Unban User">
                            <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                          Size="Size.Small"
                                          Color="Color.Success"
                                          OnClick="@(() => UnbanUser(context))" />
                        </MudTooltip>
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" OnClick="@(() => ViewUserDetail(context.TelegramUserId))" />
                        </MudTooltip>
                        @if (context.TriggerMessageId.HasValue)
                        {
                            <MudTooltip Text="View Trigger Message">
                                <MudIconButton Icon="@Icons.Material.Filled.Message"
                                              Size="Size.Small"
                                              Color="Color.Info"
                                              Href="@($"/messages?messageId={context.TriggerMessageId}")"
                                              Target="_blank" />
                            </MudTooltip>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Tags" Icon="@Icons.Material.Filled.LocalOffer">
            <TagManagement />
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<TelegramUserListItem> _allUsers = [];
    private List<TelegramUserListItem> _taggedUsers = [];
    private List<TelegramUserListItem> _trustedUsers = [];
    private List<TelegramUserListItem> _bannedUsers = [];
    private List<BannedUserListItem> _bannedUsersWithDetails = [];
    private bool _loading = true;

    // Search and filter state
    private string _searchText = string.Empty;
    private int _filteredCount;

    // Filtered lists (computed)
    private List<TelegramUserListItem> FilteredAllUsers => FilterUsers(_allUsers);
    private List<TelegramUserListItem> FilteredActiveUsers => FilterUsers(_allUsers.Where(u => !u.IsBanned).ToList());
    private List<TelegramUserListItem> FilteredTaggedUsers => FilterUsers(_taggedUsers);
    private List<TelegramUserListItem> FilteredTrustedUsers => FilterUsers(_trustedUsers);
    private List<TelegramUserListItem> FilteredBannedUsers => FilterUsers(_bannedUsers);
    private List<BannedUserListItem> FilteredBannedUsersWithDetails => FilterBannedUsers(_bannedUsersWithDetails);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private List<TelegramUserListItem> FilterUsers(List<TelegramUserListItem> users)
    {
        if (string.IsNullOrWhiteSpace(_searchText))
            return users;

        var search = _searchText.Trim().ToLowerInvariant();

        return users.Where(u =>
            (u.Username?.ToLowerInvariant().Contains(search) ?? false) ||
            (u.FirstName?.ToLowerInvariant().Contains(search) ?? false) ||
            (u.LastName?.ToLowerInvariant().Contains(search) ?? false) ||
            u.TelegramUserId.ToString().Contains(search)
        ).ToList();
    }

    private List<BannedUserListItem> FilterBannedUsers(List<BannedUserListItem> users)
    {
        if (string.IsNullOrWhiteSpace(_searchText))
            return users;

        var search = _searchText.Trim().ToLowerInvariant();

        return users.Where(u =>
            (u.Username?.ToLowerInvariant().Contains(search) ?? false) ||
            (u.FirstName?.ToLowerInvariant().Contains(search) ?? false) ||
            (u.LastName?.ToLowerInvariant().Contains(search) ?? false) ||
            u.TelegramUserId.ToString().Contains(search) ||
            (u.BannedBy?.ToLowerInvariant().Contains(search) ?? false) ||
            (u.BanReason?.ToLowerInvariant().Contains(search) ?? false)
        ).ToList();
    }

    private void ApplyFilters()
    {
        // Update filtered count (use "Active" tab as source of truth)
        _filteredCount = FilteredActiveUsers.Count;
        StateHasChanged();
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Get current user's accessible chats
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            var permissionLevel = await AuthHelper.GetCurrentPermissionLevelAsync();

            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Unable to identify current user", Severity.Error);
                return;
            }

            // Get accessible chat IDs for filtering
            var accessibleChats = await ManagedChatsRepository.GetUserAccessibleChatsAsync(
                userId,
                permissionLevel);
            var chatIds = accessibleChats.Select(c => c.ChatId).ToList();

            // Load all user lists in parallel (filtered by accessible chats for Admin users)
            var allUsersTask = UserManagementService.GetAllUsersAsync(chatIds);
            var taggedTask = UserManagementService.GetTaggedUsersAsync();
            var trustedTask = UserManagementService.GetTrustedUsersAsync();
            var bannedTask = UserManagementService.GetBannedUsersAsync();
            var bannedWithDetailsTask = UserManagementService.GetBannedUsersWithDetailsAsync();

            await Task.WhenAll(allUsersTask, taggedTask, trustedTask, bannedTask, bannedWithDetailsTask);

            // Exclude system user (telegram_user_id=0) from all lists
            _allUsers = (await allUsersTask).Where(u => u.TelegramUserId != 0).ToList();
            _taggedUsers = (await taggedTask).Where(u => u.TelegramUserId != 0).ToList();
            _trustedUsers = (await trustedTask).Where(u => u.TelegramUserId != 0).ToList();
            _bannedUsers = (await bannedTask).Where(u => u.TelegramUserId != 0).ToList();
            _bannedUsersWithDetails = (await bannedWithDetailsTask).Where(u => u.TelegramUserId != 0).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ToggleTrust(TelegramUserListItem user)
    {
        try
        {
            // Get current user ID for audit trail
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var executorId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (executorId == null)
            {
                Snackbar.Add("Authentication error: User ID not found", Severity.Error);
                return;
            }
            var executor = Actor.FromWebUser(executorId);

            var action = user.IsTrusted ? "remove trust from" : "trust";
            var success = await UserManagementService.ToggleTrustAsync(user.TelegramUserId, executor);

            if (success)
            {
                Snackbar.Add($"Successfully {action}ed {user.DisplayName}", Severity.Success);
                await LoadUsersAsync();
            }
            else
            {
                Snackbar.Add($"Failed to {action} {user.DisplayName}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error toggling trust: {ex.Message}", Severity.Error);
        }
    }

    private async Task UnbanUser(BannedUserListItem user)
    {
        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.ShowMessageBox(
                "Confirm Unban",
                $"Are you sure you want to unban {user.DisplayName}?",
                yesText: "Unban",
                cancelText: "Cancel");

            if (confirmed != true)
                return;

            // Get current user ID for audit trail
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var executorId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (executorId == null)
            {
                Snackbar.Add("Authentication error: User ID not found", Severity.Error);
                return;
            }
            var executor = Actor.FromWebUser(executorId);

            // Unban the user
            var success = await UserManagementService.UnbanAsync(user.TelegramUserId, executor, reason: "Unbanned from web interface");

            if (success)
            {
                Snackbar.Add($"Successfully unbanned {user.DisplayName}", Severity.Success);
                await LoadUsersAsync();
            }
            else
            {
                Snackbar.Add($"Failed to unban {user.DisplayName}. User may not be banned or does not exist.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error unbanning user: {ex.Message}", Severity.Error);
        }
    }

    private async Task ViewUserDetail(long userId)
    {
        var parameters = new DialogParameters<UserDetailDialog>
        {
            { x => x.UserId, userId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UserDetailDialog>("User Details", parameters, options);
        var result = await dialog.Result;

        // Reload users if dialog made changes
        if (result is { Canceled: false })
        {
            await LoadUsersAsync();
        }
    }

    private static Color GetStatusColor(TelegramUserStatus status) => status switch
    {
        TelegramUserStatus.Trusted => Color.Success,
        TelegramUserStatus.Banned => Color.Error,
        TelegramUserStatus.Warned => Color.Warning,
        TelegramUserStatus.Tagged => Color.Warning,
        TelegramUserStatus.Clean => Color.Info,
        _ => Color.Default
    };

    private static string GetStatusIcon(TelegramUserStatus status) => status switch
    {
        TelegramUserStatus.Trusted => "",
        TelegramUserStatus.Banned => "",
        TelegramUserStatus.Warned => "",
        TelegramUserStatus.Tagged => "",
        TelegramUserStatus.Clean => "",
        _ => ""
    };
}
