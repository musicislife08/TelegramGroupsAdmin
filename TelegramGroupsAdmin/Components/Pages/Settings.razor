@page "/settings"
@page "/settings/{Section?}/{SubSection?}"
@attribute [Authorize(Policy = "GlobalAdminOrOwner")]
@using TelegramGroupsAdmin.Components.Shared.ContentDetection
@using TelegramGroupsAdmin.Components.Shared.Settings
@using TelegramGroupsAdmin.Constants
@using TelegramGroupsAdmin.Core.Models
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Settings</PageTitle>

<MudGrid>
    <MudItem xs="12" md="3" lg="2">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Settings</MudText>
            <MudNavMenu>
                <!-- System Group -->
                <MudNavGroup Title="System" Icon="@Icons.Material.Filled.Computer" Expanded="@_systemExpanded" ExpandedChanged="@((bool expanded) => _systemExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.General)" Icon="@Icons.Material.Filled.Tune" Match="NavLinkMatch.All">@SettingsRoutes.System.GeneralTitle</MudNavLink>
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.Security)" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">@SettingsRoutes.System.SecurityTitle</MudNavLink>
                    }
                    @if (_canManageAdminAccounts)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.Accounts)" Icon="@Icons.Material.Filled.ManageAccounts" Match="NavLinkMatch.All">@SettingsRoutes.System.AccountsTitle</MudNavLink>
                    }
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.AiProviders)" Icon="@Icons.Material.Filled.Psychology" Match="NavLinkMatch.All">@SettingsRoutes.System.AiProvidersTitle</MudNavLink>
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.Email)" Icon="@Icons.Material.Filled.Email" Match="NavLinkMatch.All">@SettingsRoutes.System.EmailTitle</MudNavLink>
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.ClamAv)" Icon="@Icons.Material.Filled.Shield" Match="NavLinkMatch.All">@SettingsRoutes.System.ClamAvTitle</MudNavLink>
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.VirusTotal)" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">@SettingsRoutes.System.VirusTotalTitle</MudNavLink>
                    }
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.Logging)" Icon="@Icons.Material.Filled.Terminal" Match="NavLinkMatch.All">@SettingsRoutes.System.LoggingTitle</MudNavLink>
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.BackgroundJobs)" Icon="@Icons.Material.Filled.Schedule" Match="NavLinkMatch.All">@SettingsRoutes.System.BackgroundJobsTitle</MudNavLink>
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.System.Section, SettingsRoutes.System.BackupConfig)" Icon="@Icons.Material.Filled.Backup" Match="NavLinkMatch.All">@SettingsRoutes.System.BackupConfigTitle</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Telegram Group -->
                <MudNavGroup Title="Telegram" Icon="@Icons.Material.Filled.SmartToy" Expanded="@_telegramExpanded" ExpandedChanged="@((bool expanded) => _telegramExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.Telegram.Section, SettingsRoutes.Telegram.BotConfig)" Icon="@Icons.Material.Filled.Settings" Match="NavLinkMatch.All">@SettingsRoutes.Telegram.BotConfigTitle</MudNavLink>
                    }
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.Telegram.Section, SettingsRoutes.Telegram.ServiceMessages)" Icon="@Icons.Material.Filled.CleaningServices" Match="NavLinkMatch.All">@SettingsRoutes.Telegram.ServiceMessagesTitle</MudNavLink>
                </MudNavGroup>

                <!-- Moderation Group -->
                <MudNavGroup Title="Moderation" Icon="@Icons.Material.Filled.Gavel" Expanded="@_moderationExpanded" ExpandedChanged="@((bool expanded) => _moderationExpanded = expanded)">
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.Moderation.Section, SettingsRoutes.Moderation.BanCelebration)" Icon="@Icons.Material.Filled.Celebration" Match="NavLinkMatch.All">@SettingsRoutes.Moderation.BanCelebrationTitle</MudNavLink>
                </MudNavGroup>

                <!-- Notifications Group -->
                <MudNavGroup Title="Notifications" Icon="@Icons.Material.Filled.Notifications" Expanded="@_notificationsExpanded" ExpandedChanged="@((bool expanded) => _notificationsExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.Notifications.Section, SettingsRoutes.Notifications.WebPush)" Icon="@Icons.Material.Filled.NotificationsActive" Match="NavLinkMatch.All">@SettingsRoutes.Notifications.WebPushTitle</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Content Detection Group -->
                <MudNavGroup Title="Content Detection" Icon="@Icons.Material.Filled.Shield" Expanded="@_contentDetectionExpanded" ExpandedChanged="@((bool expanded) => _contentDetectionExpanded = expanded)">
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.Algorithms)" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">@SettingsRoutes.ContentDetection.AlgorithmsTitle</MudNavLink>
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.Tuning)" Icon="@Icons.Material.Filled.Insights" Match="NavLinkMatch.All">@SettingsRoutes.ContentDetection.TuningTitle</MudNavLink>
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.AiIntegration)" Icon="@Icons.Material.Filled.CloudSync" Match="NavLinkMatch.All">@SettingsRoutes.ContentDetection.AiIntegrationTitle</MudNavLink>
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.UrlFilters)" Icon="@Icons.Material.Filled.Link" Match="NavLinkMatch.All">@SettingsRoutes.ContentDetection.UrlFiltersTitle</MudNavLink>
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.FileScanning)" Icon="@Icons.Material.Filled.Scanner" Match="NavLinkMatch.All">@SettingsRoutes.ContentDetection.FileScanningTitle</MudNavLink>
                </MudNavGroup>

                <!-- Training Data Group -->
                <MudNavGroup Title="Training Data" Icon="@Icons.Material.Filled.School" Expanded="@_trainingDataExpanded" ExpandedChanged="@((bool expanded) => _trainingDataExpanded = expanded)">
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.TrainingData.Section, SettingsRoutes.TrainingData.Stopwords)" Icon="@Icons.Material.Filled.List" Match="NavLinkMatch.All">@SettingsRoutes.TrainingData.StopwordsTitle</MudNavLink>
                    <MudNavLink Href="@SettingsRoutes.BuildPath(SettingsRoutes.TrainingData.Section, SettingsRoutes.TrainingData.Samples)" Icon="@Icons.Material.Filled.Dataset" Match="NavLinkMatch.All">@SettingsRoutes.TrainingData.SamplesTitle</MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9" lg="10">
            @if (!string.IsNullOrEmpty(_pageTitle))
            {
                <MudText Typo="Typo.h4" GutterBottom="true">@_pageTitle</MudText>
            }

            @switch (_currentSection)
            {
                // System subsections
                case SettingsRoutes.System.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.System.General:
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.Security:
                            @if (_canEditInfrastructure)
                            {
                                <SecuritySettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.Accounts:
                            <WebAdminAccounts />
                            break;
                        case SettingsRoutes.System.Logging:
                            <LoggingSettings />
                            break;
                        case SettingsRoutes.System.BackgroundJobs:
                            @if (_canEditInfrastructure)
                            {
                                <BackgroundJobs />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.AiProviders:
                            @if (_canEditInfrastructure)
                            {
                                <AIProviderSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.Email:
                            @if (_canEditInfrastructure)
                            {
                                <EmailInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.ClamAv:
                            @if (_canEditInfrastructure)
                            {
                                <ClamAVInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.VirusTotal:
                            @if (_canEditInfrastructure)
                            {
                                <VirusTotalInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.System.BackupConfig:
                            @if (_canEditInfrastructure)
                            {
                                <BackupRestore />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Telegram subsections
                case SettingsRoutes.Telegram.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.Telegram.BotConfig:
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case SettingsRoutes.Telegram.ServiceMessages:
                            <ServiceMessageDeletionSettings />
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Notifications subsections
                case SettingsRoutes.Notifications.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.Notifications.WebPush:
                            @if (_canEditInfrastructure)
                            {
                                <WebPushSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <WebPushSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Moderation subsections
                case SettingsRoutes.Moderation.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.Moderation.BanCelebration:
                            <BanCelebrationSettings />
                            break;
                        default:
                            <BanCelebrationSettings />
                            break;
                    }
                    break;

                // Content Detection subsections
                case SettingsRoutes.ContentDetection.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.ContentDetection.Algorithms:
                            <DetectionOverview />
                            break;
                        case SettingsRoutes.ContentDetection.Tuning:
                            <AlgorithmTuning />
                            break;
                        case SettingsRoutes.ContentDetection.AiIntegration:
                            <AIIntegrationSettings />
                            break;
                        case SettingsRoutes.ContentDetection.UrlFilters:
                            <UrlFiltersConfig ChatId="0" />
                            break;
                        case SettingsRoutes.ContentDetection.FileScanning:
                            <FileScanningSettings />
                            break;
                        default:
                            <DetectionOverview />
                            break;
                    }
                    break;

                // Training Data subsections
                case SettingsRoutes.TrainingData.Section:
                    @switch (_currentSubSection)
                    {
                        case SettingsRoutes.TrainingData.Stopwords:
                            <StopWords />
                            break;
                        case SettingsRoutes.TrainingData.Samples:
                            <TrainingData />
                            break;
                        default:
                            <StopWords />
                            break;
                    }
                    break;

                default:
                    <DetectionOverview />
                    break;
            }
    </MudItem>
</MudGrid>

@code {
    [CascadingParameter] private WebUserIdentity? WebUser { get; set; }

    [Parameter]
    public string? Section { get; set; }

    [Parameter]
    public string? SubSection { get; set; }

    private bool _systemExpanded;
    private bool _telegramExpanded;
    private bool _moderationExpanded;
    private bool _notificationsExpanded;
    private bool _contentDetectionExpanded;
    private bool _trainingDataExpanded;

    private string _currentSection = "";
    private string _currentSubSection = "";
    private string _pageTitle = "";

    // Permission flags
    private bool _canManageAdminAccounts;
    private bool _canEditInfrastructure;
    private bool _canEditContent;

    protected override void OnInitialized()
    {
        // Load permission flags from cascading WebUser
        _canManageAdminAccounts = WebUser?.IsGlobalAdminOrHigher ?? false;
        _canEditInfrastructure = WebUser?.IsOwner ?? false;
        _canEditContent = WebUser?.IsGlobalAdminOrHigher ?? false;

        UpdateCurrentSection();
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        UpdateCurrentSection();
    }

    private void UpdateCurrentSection()
    {
        _currentSection = Section?.ToLowerInvariant() ?? SettingsRoutes.System.Section;
        _currentSubSection = SubSection?.ToLowerInvariant() ?? SettingsRoutes.System.General;

        // Auto-expand the appropriate group based on current section
        _systemExpanded = _currentSection == SettingsRoutes.System.Section;
        _telegramExpanded = _currentSection == SettingsRoutes.Telegram.Section;
        _moderationExpanded = _currentSection == SettingsRoutes.Moderation.Section;
        _notificationsExpanded = _currentSection == SettingsRoutes.Notifications.Section;
        _contentDetectionExpanded = _currentSection == SettingsRoutes.ContentDetection.Section;
        _trainingDataExpanded = _currentSection == SettingsRoutes.TrainingData.Section;

        // Set page title using constants
        _pageTitle = (_currentSection, _currentSubSection) switch
        {
            // System
            (SettingsRoutes.System.Section, SettingsRoutes.System.General) => SettingsRoutes.System.GeneralTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.Security) => SettingsRoutes.System.SecurityTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.Accounts) => SettingsRoutes.System.AccountsTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.AiProviders) => SettingsRoutes.System.AiProvidersTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.Email) => SettingsRoutes.System.EmailTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.ClamAv) => SettingsRoutes.System.ClamAvTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.VirusTotal) => SettingsRoutes.System.VirusTotalTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.Logging) => SettingsRoutes.System.LoggingTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.BackgroundJobs) => SettingsRoutes.System.BackgroundJobsTitle,
            (SettingsRoutes.System.Section, SettingsRoutes.System.BackupConfig) => SettingsRoutes.System.BackupConfigTitle,

            // Telegram
            (SettingsRoutes.Telegram.Section, SettingsRoutes.Telegram.BotConfig) => SettingsRoutes.Telegram.BotConfigTitle,
            (SettingsRoutes.Telegram.Section, SettingsRoutes.Telegram.ServiceMessages) => SettingsRoutes.Telegram.ServiceMessagesTitle,

            // Notifications
            (SettingsRoutes.Notifications.Section, SettingsRoutes.Notifications.WebPush) => SettingsRoutes.Notifications.WebPushTitle,

            // Moderation
            (SettingsRoutes.Moderation.Section, SettingsRoutes.Moderation.BanCelebration) => SettingsRoutes.Moderation.BanCelebrationTitle,

            // Content Detection
            (SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.Algorithms) => SettingsRoutes.ContentDetection.AlgorithmsTitle,
            (SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.Tuning) => SettingsRoutes.ContentDetection.TuningTitle,
            (SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.AiIntegration) => SettingsRoutes.ContentDetection.AiIntegrationTitle,
            (SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.UrlFilters) => SettingsRoutes.ContentDetection.UrlFiltersTitle,
            (SettingsRoutes.ContentDetection.Section, SettingsRoutes.ContentDetection.FileScanning) => SettingsRoutes.ContentDetection.FileScanningTitle,

            // Training Data
            (SettingsRoutes.TrainingData.Section, SettingsRoutes.TrainingData.Stopwords) => SettingsRoutes.TrainingData.StopwordsTitle,
            (SettingsRoutes.TrainingData.Section, SettingsRoutes.TrainingData.Samples) => SettingsRoutes.TrainingData.SamplesTitle,

            _ => "Settings"
        };
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
