@page "/settings"
@page "/settings/{Section?}/{SubSection?}"
@attribute [Authorize(Policy = "GlobalAdminOrOwner")]
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using TelegramGroupsAdmin.Components.Shared
@using TelegramGroupsAdmin.Components.Shared.Settings
@using TelegramGroupsAdmin.Services
@inject NavigationManager Navigation
@inject BlazorAuthHelper AuthHelper
@implements IDisposable

<PageTitle>Settings</PageTitle>

<MudGrid>
    <MudItem xs="12" md="3" lg="2">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Settings</MudText>
            <MudNavMenu>
                <!-- System Group -->
                <MudNavGroup Title="System" Icon="@Icons.Material.Filled.Computer" Expanded="@_systemExpanded" ExpandedChanged="@((bool expanded) => _systemExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/system/general" Icon="@Icons.Material.Filled.Tune" Match="NavLinkMatch.All">General Settings</MudNavLink>
                        <MudNavLink Href="/settings/system/security" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">Security</MudNavLink>
                    }
                    @if (_canManageAdminAccounts)
                    {
                        <MudNavLink Href="/settings/system/accounts" Icon="@Icons.Material.Filled.ManageAccounts" Match="NavLinkMatch.All">Admin Accounts</MudNavLink>
                    }
                    <MudNavLink Href="/settings/system/logging" Icon="@Icons.Material.Filled.Terminal" Match="NavLinkMatch.All">Logging</MudNavLink>
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/system/background-jobs" Icon="@Icons.Material.Filled.Schedule" Match="NavLinkMatch.All">Background Jobs</MudNavLink>
                        <MudNavLink Href="/settings/system/backup" Icon="@Icons.Material.Filled.Backup" Match="NavLinkMatch.All">Backup & Restore</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Telegram Group -->
                <MudNavGroup Title="Telegram" Icon="@Icons.Material.Filled.SmartToy" Expanded="@_telegramExpanded" ExpandedChanged="@((bool expanded) => _telegramExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/telegram/bot" Icon="@Icons.Material.Filled.Settings" Match="NavLinkMatch.All">Bot Connection</MudNavLink>
                    }
                    <MudNavLink Href="/settings/telegram/notifications" Icon="@Icons.Material.Filled.Notifications" Match="NavLinkMatch.All">Notifications</MudNavLink>
                </MudNavGroup>

                <!-- Protection Group -->
                <MudNavGroup Title="Protection" Icon="@Icons.Material.Filled.Shield" Expanded="@_protectionExpanded" ExpandedChanged="@((bool expanded) => _protectionExpanded = expanded)">
                    <MudNavLink Href="/settings/protection/content-detection" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">Content Detection</MudNavLink>
                    <MudNavLink Href="/settings/protection/external" Icon="@Icons.Material.Filled.CloudSync" Match="NavLinkMatch.All">External Services</MudNavLink>
                    <MudNavLink Href="/settings/protection/url-filters" Icon="@Icons.Material.Filled.Link" Match="NavLinkMatch.All">URL Filtering</MudNavLink>
                    <MudNavLink Href="/settings/protection/file-scanning" Icon="@Icons.Material.Filled.Scanner" Match="NavLinkMatch.All">File Scanning</MudNavLink>
                </MudNavGroup>

                <!-- Content Management Group -->
                <MudNavGroup Title="Content Management" Icon="@Icons.Material.Filled.Inventory" Expanded="@_contentMgmtExpanded" ExpandedChanged="@((bool expanded) => _contentMgmtExpanded = expanded)">
                    <MudNavLink Href="/settings/content/stopwords" Icon="@Icons.Material.Filled.List" Match="NavLinkMatch.All">Stop Words Library</MudNavLink>
                    <MudNavLink Href="/settings/content/training" Icon="@Icons.Material.Filled.School" Match="NavLinkMatch.All">Training Samples</MudNavLink>
                    <MudNavLink Href="/settings/content/tags" Icon="@Icons.Material.Filled.Label" Match="NavLinkMatch.All">Tags</MudNavLink>
                </MudNavGroup>

                <!-- Tools Group -->
                <MudNavGroup Title="Tools & Testing" Icon="@Icons.Material.Filled.Construction" Expanded="@_toolsExpanded" ExpandedChanged="@((bool expanded) => _toolsExpanded = expanded)">
                    <MudNavLink Href="/settings/tools/tester" Icon="@Icons.Material.Filled.BugReport" Match="NavLinkMatch.All">Content Tester</MudNavLink>
                    <MudNavLink Href="/settings/tools/integrations" Icon="@Icons.Material.Filled.Extension" Match="NavLinkMatch.All">Integrations</MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9" lg="10">
            @if (!string.IsNullOrEmpty(_pageTitle))
            {
                <MudText Typo="Typo.h4" GutterBottom="true">@_pageTitle</MudText>
            }

            @switch (_currentSection)
            {
                // System subsections
                case "system":
                    @switch (_currentSubSection)
                    {
                        case "general":
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "security":
                            @if (_canEditInfrastructure)
                            {
                                <SecuritySettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "accounts":
                            <WebAdminAccounts />
                            break;
                        case "logging":
                            <LoggingSettings />
                            break;
                        case "background-jobs":
                            @if (_canEditInfrastructure)
                            {
                                <BackgroundJobs />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "backup":
                            @if (_canEditInfrastructure)
                            {
                                <BackupRestore />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Telegram subsections
                case "telegram":
                    @switch (_currentSubSection)
                    {
                        case "bot":
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "notifications":
                            <NotificationsSettings />
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Protection subsections
                case "protection":
                    @switch (_currentSubSection)
                    {
                        case "content-detection":
                            <DetectionOverview />
                            break;
                        case "external":
                            <ContentDetectionExternal />
                            break;
                        case "url-filters":
                            <UrlFiltersConfig ChatId="0" />
                            break;
                        case "file-scanning":
                            <FileScanningSettings />
                            break;
                        default:
                            <DetectionOverview />
                            break;
                    }
                    break;

                // Content Management subsections
                case "content":
                    @switch (_currentSubSection)
                    {
                        case "stopwords":
                            <StopWords />
                            break;
                        case "training":
                            <TrainingData />
                            break;
                        case "tags":
                            <TagManagement />
                            break;
                        default:
                            <StopWords />
                            break;
                    }
                    break;

                // Tools subsections
                case "tools":
                    @switch (_currentSubSection)
                    {
                        case "tester":
                            <ContentTester />
                            break;
                        case "integrations":
                            <IntegrationsSettings />
                            break;
                        default:
                            <ContentTester />
                            break;
                    }
                    break;

                default:
                    <DetectionOverview />
                    break;
            }
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string? Section { get; set; }

    [Parameter]
    public string? SubSection { get; set; }

    private bool _systemExpanded = false;
    private bool _telegramExpanded = false;
    private bool _protectionExpanded = false;
    private bool _contentMgmtExpanded = false;
    private bool _toolsExpanded = false;

    private string _currentSection = "";
    private string _currentSubSection = "";
    private string _pageTitle = "";

    // Permission flags
    private bool _canManageAdminAccounts = false;
    private bool _canEditInfrastructure = false;
    private bool _canEditContent = false;

    protected override async Task OnInitializedAsync()
    {
        // Load permission flags
        _canManageAdminAccounts = await AuthHelper.CanManageAdminAccountsAsync();
        _canEditInfrastructure = await AuthHelper.CanEditInfrastructureAsync();
        _canEditContent = await AuthHelper.CanEditContentSettingsAsync();

        UpdateCurrentSection();
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        UpdateCurrentSection();
    }

    private void UpdateCurrentSection()
    {
        _currentSection = Section?.ToLowerInvariant() ?? "protection";
        _currentSubSection = SubSection?.ToLowerInvariant() ?? "content-detection";

        // Auto-expand the appropriate group based on current section
        _systemExpanded = _currentSection == "system";
        _telegramExpanded = _currentSection == "telegram";
        _protectionExpanded = _currentSection == "protection";
        _contentMgmtExpanded = _currentSection == "content";
        _toolsExpanded = _currentSection == "tools";

        // Set page title
        _pageTitle = (_currentSection, _currentSubSection) switch
        {
            // System
            ("system", "general") => "General Settings",
            ("system", "security") => "Security Settings",
            ("system", "accounts") => "Admin Accounts",
            ("system", "logging") => "Logging Settings",
            ("system", "background-jobs") => "Background Jobs",
            ("system", "backup") => "Backup & Restore",

            // Telegram
            ("telegram", "bot") => "Telegram Bot Connection",
            ("telegram", "notifications") => "Notification Settings",

            // Protection
            ("protection", "content-detection") => "Content Detection",
            ("protection", "external") => "External Services",
            ("protection", "url-filters") => "URL Filtering",
            ("protection", "file-scanning") => "File Scanning",

            // Content Management
            ("content", "stopwords") => "Stop Words Library",
            ("content", "training") => "Training Samples",
            ("content", "tags") => "Tag Management",

            // Tools
            ("tools", "tester") => "Content Tester",
            ("tools", "integrations") => "Integration Settings",

            _ => "Settings"
        };
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
