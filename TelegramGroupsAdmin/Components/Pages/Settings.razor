@page "/settings"
@page "/settings/{Section?}/{SubSection?}"
@attribute [Authorize(Policy = "GlobalAdminOrOwner")]
@using TelegramGroupsAdmin.Components.Shared.ContentDetection
@using TelegramGroupsAdmin.Components.Shared.Settings
@using TelegramGroupsAdmin.Services
@inject NavigationManager Navigation
@inject BlazorAuthHelper AuthHelper
@implements IDisposable

<PageTitle>Settings</PageTitle>

<MudGrid>
    <MudItem xs="12" md="3" lg="2">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Settings</MudText>
            <MudNavMenu>
                <!-- System Group -->
                <MudNavGroup Title="System" Icon="@Icons.Material.Filled.Computer" Expanded="@_systemExpanded" ExpandedChanged="@((bool expanded) => _systemExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/system/general" Icon="@Icons.Material.Filled.Tune" Match="NavLinkMatch.All">General Settings</MudNavLink>
                        <MudNavLink Href="/settings/system/security" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">Security</MudNavLink>
                    }
                    @if (_canManageAdminAccounts)
                    {
                        <MudNavLink Href="/settings/system/accounts" Icon="@Icons.Material.Filled.ManageAccounts" Match="NavLinkMatch.All">Admin Accounts</MudNavLink>
                    }
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/system/openai" Icon="@Icons.Material.Filled.Psychology" Match="NavLinkMatch.All">OpenAI</MudNavLink>
                        <MudNavLink Href="/settings/system/email" Icon="@Icons.Material.Filled.Email" Match="NavLinkMatch.All">Email</MudNavLink>
                        <MudNavLink Href="/settings/system/clamav" Icon="@Icons.Material.Filled.Shield" Match="NavLinkMatch.All">ClamAV</MudNavLink>
                        <MudNavLink Href="/settings/system/virustotal" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">VirusTotal</MudNavLink>
                    }
                    <MudNavLink Href="/settings/system/logging" Icon="@Icons.Material.Filled.Terminal" Match="NavLinkMatch.All">Logging</MudNavLink>
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/system/background-jobs" Icon="@Icons.Material.Filled.Schedule" Match="NavLinkMatch.All">Background Jobs</MudNavLink>
                        <MudNavLink Href="/settings/system/backup-config" Icon="@Icons.Material.Filled.Backup" Match="NavLinkMatch.All">Backup Configuration</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Telegram Group -->
                <MudNavGroup Title="Telegram" Icon="@Icons.Material.Filled.SmartToy" Expanded="@_telegramExpanded" ExpandedChanged="@((bool expanded) => _telegramExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/telegram/bot-config" Icon="@Icons.Material.Filled.Settings" Match="NavLinkMatch.All">Bot Configuration</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Notifications Group -->
                <MudNavGroup Title="Notifications" Icon="@Icons.Material.Filled.Notifications" Expanded="@_notificationsExpanded" ExpandedChanged="@((bool expanded) => _notificationsExpanded = expanded)">
                    @if (_canEditInfrastructure)
                    {
                        <MudNavLink Href="/settings/notifications/web-push" Icon="@Icons.Material.Filled.NotificationsActive" Match="NavLinkMatch.All">Web Push</MudNavLink>
                    }
                </MudNavGroup>

                <!-- Content Detection Group -->
                <MudNavGroup Title="Content Detection" Icon="@Icons.Material.Filled.Shield" Expanded="@_contentDetectionExpanded" ExpandedChanged="@((bool expanded) => _contentDetectionExpanded = expanded)">
                    <MudNavLink Href="/settings/content-detection/algorithms" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">Detection Algorithms</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/tuning" Icon="@Icons.Material.Filled.Insights" Match="NavLinkMatch.All">Algorithm Tuning</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/ai-integration" Icon="@Icons.Material.Filled.CloudSync" Match="NavLinkMatch.All">AI Integration</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/url-filters" Icon="@Icons.Material.Filled.Link" Match="NavLinkMatch.All">URL Filtering</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/file-scanning" Icon="@Icons.Material.Filled.Scanner" Match="NavLinkMatch.All">File Scanning</MudNavLink>
                </MudNavGroup>

                <!-- Training Data Group -->
                <MudNavGroup Title="Training Data" Icon="@Icons.Material.Filled.School" Expanded="@_trainingDataExpanded" ExpandedChanged="@((bool expanded) => _trainingDataExpanded = expanded)">
                    <MudNavLink Href="/settings/training-data/stopwords" Icon="@Icons.Material.Filled.List" Match="NavLinkMatch.All">Stop Words Library</MudNavLink>
                    <MudNavLink Href="/settings/training-data/samples" Icon="@Icons.Material.Filled.Dataset" Match="NavLinkMatch.All">Training Samples</MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9" lg="10">
            @if (!string.IsNullOrEmpty(_pageTitle))
            {
                <MudText Typo="Typo.h4" GutterBottom="true">@_pageTitle</MudText>
            }

            @switch (_currentSection)
            {
                // System subsections
                case "system":
                    @switch (_currentSubSection)
                    {
                        case "general":
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "security":
                            @if (_canEditInfrastructure)
                            {
                                <SecuritySettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "accounts":
                            <WebAdminAccounts />
                            break;
                        case "logging":
                            <LoggingSettings />
                            break;
                        case "background-jobs":
                            @if (_canEditInfrastructure)
                            {
                                <BackgroundJobs />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "openai":
                            @if (_canEditInfrastructure)
                            {
                                <OpenAIInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "email":
                            @if (_canEditInfrastructure)
                            {
                                <EmailInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "clamav":
                            @if (_canEditInfrastructure)
                            {
                                <ClamAVInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "virustotal":
                            @if (_canEditInfrastructure)
                            {
                                <VirusTotalInfrastructureSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        case "backup-config":
                            @if (_canEditInfrastructure)
                            {
                                <BackupRestore />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <GeneralSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Telegram subsections
                case "telegram":
                    @switch (_currentSubSection)
                    {
                        case "bot-config":
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <TelegramBotSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Notifications subsections
                case "notifications":
                    @switch (_currentSubSection)
                    {
                        case "web-push":
                            @if (_canEditInfrastructure)
                            {
                                <WebPushSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                        default:
                            @if (_canEditInfrastructure)
                            {
                                <WebPushSettings />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">Owner access required for infrastructure settings</MudAlert>
                            }
                            break;
                    }
                    break;

                // Content Detection subsections
                case "content-detection":
                    @switch (_currentSubSection)
                    {
                        case "algorithms":
                            <DetectionOverview />
                            break;
                        case "tuning":
                            <AlgorithmTuning />
                            break;
                        case "ai-integration":
                            <AIIntegrationSettings />
                            break;
                        case "url-filters":
                            <UrlFiltersConfig ChatId="0" />
                            break;
                        case "file-scanning":
                            <FileScanningSettings />
                            break;
                        default:
                            <DetectionOverview />
                            break;
                    }
                    break;

                // Training Data subsections
                case "training-data":
                    @switch (_currentSubSection)
                    {
                        case "stopwords":
                            <StopWords />
                            break;
                        case "samples":
                            <TrainingData />
                            break;
                        default:
                            <StopWords />
                            break;
                    }
                    break;

                default:
                    <DetectionOverview />
                    break;
            }
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string? Section { get; set; }

    [Parameter]
    public string? SubSection { get; set; }

    private bool _systemExpanded;
    private bool _telegramExpanded;
    private bool _notificationsExpanded;
    private bool _contentDetectionExpanded;
    private bool _trainingDataExpanded;

    private string _currentSection = "";
    private string _currentSubSection = "";
    private string _pageTitle = "";

    // Permission flags
    private bool _canManageAdminAccounts;
    private bool _canEditInfrastructure;
    private bool _canEditContent;

    protected override async Task OnInitializedAsync()
    {
        // Load permission flags
        _canManageAdminAccounts = await AuthHelper.CanManageAdminAccountsAsync();
        _canEditInfrastructure = await AuthHelper.CanEditInfrastructureAsync();
        _canEditContent = await AuthHelper.CanEditContentSettingsAsync();

        UpdateCurrentSection();
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        UpdateCurrentSection();
    }

    private void UpdateCurrentSection()
    {
        _currentSection = Section?.ToLowerInvariant() ?? "system";
        _currentSubSection = SubSection?.ToLowerInvariant() ?? "general";

        // Auto-expand the appropriate group based on current section
        _systemExpanded = _currentSection == "system";
        _telegramExpanded = _currentSection == "telegram";
        _notificationsExpanded = _currentSection == "notifications";
        _contentDetectionExpanded = _currentSection == "content-detection";
        _trainingDataExpanded = _currentSection == "training-data";

        // Set page title
        _pageTitle = (_currentSection, _currentSubSection) switch
        {
            // System
            ("system", "general") => "General Settings",
            ("system", "security") => "Security Settings",
            ("system", "accounts") => "Admin Accounts",
            ("system", "openai") => "OpenAI",
            ("system", "email") => "Email",
            ("system", "clamav") => "ClamAV",
            ("system", "virustotal") => "VirusTotal",
            ("system", "logging") => "Logging Settings",
            ("system", "background-jobs") => "Background Jobs",
            ("system", "backup-config") => "Backup Configuration",

            // Telegram
            ("telegram", "bot-config") => "Bot Configuration",

            // Notifications
            ("notifications", "web-push") => "Web Push Notifications",

            // Content Detection
            ("content-detection", "algorithms") => "Detection Algorithms",
            ("content-detection", "tuning") => "Algorithm Tuning",
            ("content-detection", "ai-integration") => "AI Integration",
            ("content-detection", "url-filters") => "URL Filtering",
            ("content-detection", "file-scanning") => "File Scanning",

            // Training Data
            ("training-data", "stopwords") => "Stop Words Library",
            ("training-data", "samples") => "Training Samples",

            _ => "Settings"
        };
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
