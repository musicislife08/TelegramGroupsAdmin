@page "/settings"
@page "/settings/{Section?}/{SubSection?}"
@attribute [Authorize]
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using TelegramGroupsAdmin.Components.Shared
@using TelegramGroupsAdmin.Components.Shared.Settings
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Settings</PageTitle>

<MudGrid>
    <MudItem xs="12" md="3" lg="2">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Settings</MudText>
            <MudNavMenu>
                <!-- Content Detection Group -->
                <MudNavGroup Title="Content Detection" Icon="@Icons.Material.Filled.Shield" Expanded="@_contentDetectionExpanded" ExpandedChanged="@((bool expanded) => _contentDetectionExpanded = expanded)">
                    <MudNavLink Href="/settings/content-detection/general" Icon="@Icons.Material.Filled.Settings" Match="NavLinkMatch.All">General Settings</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/stopwords-config" Icon="@Icons.Material.Filled.Block" Match="NavLinkMatch.All">Stop Words Check</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/similarity" Icon="@Icons.Material.Filled.ContentCopy" Match="NavLinkMatch.All">Similarity</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/cas" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">CAS</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/bayes" Icon="@Icons.Material.Filled.Psychology" Match="NavLinkMatch.All">Bayes</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/advanced" Icon="@Icons.Material.Filled.Tune" Match="NavLinkMatch.All">Advanced</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/external" Icon="@Icons.Material.Filled.CloudSync" Match="NavLinkMatch.All">External Services</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/url-filters" Icon="@Icons.Material.Filled.Link" Match="NavLinkMatch.All">URL Filters</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/critical-checks" Icon="@Icons.Material.Filled.VerifiedUser" Match="NavLinkMatch.All">Critical Checks</MudNavLink>
                    <MudDivider Class="my-2" />
                    <MudNavLink Href="/settings/content-detection/stopwords-mgmt" Icon="@Icons.Material.Filled.List" Match="NavLinkMatch.All">Stop Words Management</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/training" Icon="@Icons.Material.Filled.School" Match="NavLinkMatch.All">Training Data</MudNavLink>
                    <MudNavLink Href="/settings/content-detection/test" Icon="@Icons.Material.Filled.BugReport" Match="NavLinkMatch.All">Spam Tester</MudNavLink>
                </MudNavGroup>

                <!-- Other Settings -->
                <MudNavLink Href="/settings/general" Icon="@Icons.Material.Filled.Tune" Match="NavLinkMatch.All">General</MudNavLink>
                <MudNavLink Href="/settings/telegram" Icon="@Icons.Material.Filled.SmartToy" Match="NavLinkMatch.All">Telegram Bot</MudNavLink>
                <MudNavLink Href="/settings/notifications" Icon="@Icons.Material.Filled.Notifications" Match="NavLinkMatch.All">Notifications</MudNavLink>
                <MudNavLink Href="/settings/security" Icon="@Icons.Material.Filled.Security" Match="NavLinkMatch.All">Security</MudNavLink>
                <MudNavLink Href="/settings/integrations" Icon="@Icons.Material.Filled.Extension" Match="NavLinkMatch.All">Integrations</MudNavLink>
                <MudNavLink Href="/settings/logging" Icon="@Icons.Material.Filled.Terminal" Match="NavLinkMatch.All">Logging</MudNavLink>
                <MudNavLink Href="/settings/tags" Icon="@Icons.Material.Filled.Label" Match="NavLinkMatch.All">Tags</MudNavLink>
                <MudNavLink Href="/settings/backup" Icon="@Icons.Material.Filled.Backup" Match="NavLinkMatch.All">Backup & Restore</MudNavLink>
                <MudNavLink Href="/settings/accounts" Icon="@Icons.Material.Filled.ManageAccounts" Match="NavLinkMatch.All">Admin Accounts</MudNavLink>
            </MudNavMenu>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9" lg="10">
            @if (!string.IsNullOrEmpty(_pageTitle))
            {
                <MudText Typo="Typo.h4" GutterBottom="true">@_pageTitle</MudText>
            }

            @switch (_currentSection)
            {
                // Content Detection subsections
                case "content-detection":
                    @switch (_currentSubSection)
                    {
                        case "general":
                            <ContentDetectionGeneral />
                            break;
                        case "stopwords-config":
                            <ContentDetectionStopWords />
                            break;
                        case "similarity":
                            <ContentDetectionSimilarity />
                            break;
                        case "cas":
                            <ContentDetectionCAS />
                            break;
                        case "bayes":
                            <ContentDetectionBayes />
                            break;
                        case "advanced":
                            <ContentDetectionAdvanced />
                            break;
                        case "external":
                            <ContentDetectionExternal />
                            break;
                        case "url-filters":
                            <UrlFiltersConfig ChatId="null" />
                            break;
                        case "critical-checks":
                            <CriticalChecks />
                            break;
                        case "stopwords-mgmt":
                            <StopWords />
                            break;
                        case "training":
                            <TrainingData />
                            break;
                        case "test":
                            <SpamTester />
                            break;
                        default:
                            <ContentDetectionGeneral />
                            break;
                    }
                    break;

                // Top-level sections
                case "general":
                    <GeneralSettings />
                    break;
                case "telegram":
                    <TelegramBotSettings />
                    break;
                case "notifications":
                    <NotificationsSettings />
                    break;
                case "security":
                    <SecuritySettings />
                    break;
                case "integrations":
                    <IntegrationsSettings />
                    break;
                case "logging":
                    <LoggingSettings />
                    break;
                case "tags":
                    <TagManagement />
                    break;
                case "backup":
                    <BackupRestore />
                    break;
                case "accounts":
                    <WebAdminAccounts />
                    break;

                default:
                    <ContentDetectionGeneral />
                    break;
            }
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string? Section { get; set; }

    [Parameter]
    public string? SubSection { get; set; }

    private bool _contentDetectionExpanded = false;
    private string _currentSection = "";
    private string _currentSubSection = "";
    private string _pageTitle = "";

    protected override void OnInitialized()
    {
        UpdateCurrentSection();
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        UpdateCurrentSection();
    }

    private void UpdateCurrentSection()
    {
        _currentSection = Section?.ToLowerInvariant() ?? "content-detection";
        _currentSubSection = SubSection?.ToLowerInvariant() ?? "general";

        // Auto-expand Content Detection group if we're in it
        _contentDetectionExpanded = _currentSection == "content-detection";

        // Set page title
        _pageTitle = (_currentSection, _currentSubSection) switch
        {
            ("content-detection", "general") => "Content Detection - General Settings",
            ("content-detection", "stopwords-config") => "Content Detection - Stop Words Check",
            ("content-detection", "similarity") => "Content Detection - Similarity",
            ("content-detection", "cas") => "Content Detection - CAS",
            ("content-detection", "bayes") => "Content Detection - Bayes",
            ("content-detection", "advanced") => "Content Detection - Advanced",
            ("content-detection", "external") => "Content Detection - External Services",
            ("content-detection", "url-filters") => "Content Detection - URL Filters",
            ("content-detection", "stopwords-mgmt") => "Content Detection - Stop Words Management",
            ("content-detection", "training") => "Content Detection - Training Data",
            ("content-detection", "test") => "Content Detection - Spam Tester",
            ("general", _) => "General Settings",
            ("telegram", _) => "Telegram Bot Settings",
            ("notifications", _) => "Notification Settings",
            ("security", _) => "Security Settings",
            ("integrations", _) => "Integration Settings",
            ("logging", _) => "Logging Settings",
            ("tags", _) => "Tag Management",
            ("backup", _) => "Backup & Restore",
            ("accounts", _) => "Admin Accounts",
            _ => "Settings"
        };
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
