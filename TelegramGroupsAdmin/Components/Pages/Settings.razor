@page "/settings"
@attribute [Authorize(Roles = "Admin,Owner")]
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using TelegramGroupsAdmin.Components.Shared
@using TelegramGroupsAdmin.Components.Shared.Settings
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Settings</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Settings</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Configure system-wide settings and preferences</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Spam Detection" Icon="@Icons.Material.Filled.Shield">
            <SpamDetectionConfig />
        </MudTabPanel>

        <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Tune">
            <GeneralSettings />
        </MudTabPanel>

        <MudTabPanel Text="Telegram Bot" Icon="@Icons.Material.Filled.SmartToy">
            <TelegramBotSettings />
        </MudTabPanel>

        <MudTabPanel Text="Notifications" Icon="@Icons.Material.Filled.Notifications">
            <NotificationsSettings />
        </MudTabPanel>

        <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Security">
            <SecuritySettings />
        </MudTabPanel>

        <MudTabPanel Text="Integrations" Icon="@Icons.Material.Filled.Extension">
            <IntegrationsSettings />
        </MudTabPanel>

        <MudTabPanel Text="Logging" Icon="@Icons.Material.Filled.Terminal">
            <LoggingSettings />
        </MudTabPanel>

        <MudTabPanel Text="Backup & Restore" Icon="@Icons.Material.Filled.Backup">
            <BackupRestore />
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        // Parse URL fragment to set initial tab
        var fragment = new Uri(Navigation.Uri).Fragment.TrimStart('#');
        _activeTabIndex = fragment switch
        {
            "spam" => 0,
            "general" => 1,
            "telegram" => 2,
            "notifications" => 3,
            "security" => 4,
            "integrations" => 5,
            "logging" => 6,
            "backup" => 7,
            _ => 0
        };

        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var fragment = new Uri(e.Location).Fragment.TrimStart('#');
        var newIndex = fragment switch
        {
            "spam" => 0,
            "general" => 1,
            "telegram" => 2,
            "notifications" => 3,
            "security" => 4,
            "integrations" => 5,
            "logging" => 6,
            "backup" => 7,
            _ => 0
        };

        if (newIndex != _activeTabIndex)
        {
            _activeTabIndex = newIndex;
            StateHasChanged();
        }
    }

    private void OnTabChanged(int index)
    {
        _activeTabIndex = index;

        // Update URL fragment without reload
        var fragment = index switch
        {
            0 => "spam",
            1 => "general",
            2 => "telegram",
            3 => "notifications",
            4 => "security",
            5 => "integrations",
            6 => "logging",
            7 => "backup",
            _ => "spam"
        };

        Navigation.NavigateTo($"/settings#{fragment}", false);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
