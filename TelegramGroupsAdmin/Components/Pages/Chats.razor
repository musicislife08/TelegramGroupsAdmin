@page "/chats"
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Components.Shared.ChatManagement
@using TelegramGroupsAdmin.ContentDetection.Repositories
@inject TelegramAdminBotService BotService
@inject IManagedChatsRepository ManagedChatsRepository
@inject IContentDetectionConfigRepository SpamConfigRepository
@inject TelegramGroupsAdmin.Configuration.Repositories.IConfigRepository ConfigRepository
@inject BlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar
@attribute [Authorize]
@implements IDisposable

<PageTitle>Chat Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Chat Management</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">
        Manage Telegram chats where the bot is active. Configure spam detection settings per chat.
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (_chats.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            <MudText Typo="Typo.h6">No chats available</MudText>
            <MudText Typo="Typo.body2">
                You don't have access to any chats yet. If you're an Admin user, you need to link your Telegram account
                to see chats where you have admin permissions. Visit your Profile page to link your Telegram account.
            </MudText>
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_chats" Dense="true" Hover="true" Striped="true" Filter="new Func<ManagedChatInfo, bool>(FilterFunc)">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Managed Chats</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="_searchString" Placeholder="Search chats" Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Chat Name</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Bot Status</MudTh>
                <MudTh>Health</MudTh>
                <MudTh>Custom Config</MudTh>
                <MudTh>Last Seen</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Chat Name">
                    <ChatInfoCell Chat="@context.Chat" />
                </MudTd>
                <MudTd DataLabel="Type">@context.Chat.ChatType.ToString()</MudTd>
                <MudTd DataLabel="Bot Status">
                    <ChatStatusChip BotStatus="@context.Chat.BotStatus" />
                </MudTd>
                <MudTd DataLabel="Health">
                    <ChatStatusChip HealthStatus="@context.HealthStatus.Status"
                                   Warnings="@context.HealthStatus.Warnings" />
                </MudTd>
                <MudTd DataLabel="Custom Config">
                    @if (context.HasCustomSpamConfig)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                    }
                    else
                    {
                        <span>Global</span>
                    }
                </MudTd>
                <MudTd DataLabel="Last Seen">
                    @if (context.Chat.LastSeenAt.HasValue)
                    {
                        @context.Chat.LastSeenAt.Value.ToString("g")
                    }
                    else
                    {
                        <span>Never</span>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <ChatActionsCell ChatInfo="@context"
                                    OnChatLeft="@LoadChatsAsync"
                                    OnConfigured="@HandleConfigured"
                                    OnHealthRefreshQueued="@StateHasChanged" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="[10, 25, 50, 100]" />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

@code {
    private List<ManagedChatInfo> _chats = [];
    private bool _loading = true;
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to health updates
        BotService.OnHealthUpdate += HandleHealthUpdate;

        await LoadChatsAsync();
    }

    private async Task LoadChatsAsync()
    {
        _loading = true;
        try
        {
            // Get current user and their permission level
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            var permissionLevel = await AuthHelper.GetCurrentPermissionLevelAsync();

            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Unable to identify current user", Severity.Error);
                return;
            }

            // Load chats accessible to this user (filtered by permission level)
            var chats = await ManagedChatsRepository.GetUserAccessibleChatsAsync(
                userId,
                permissionLevel);

            // Check which chats have custom spam configs
            var allConfigs = await SpamConfigRepository.GetAllChatConfigsAsync();
            var customConfigChatIds = allConfigs
                .Where(c => c.ChatId != 0)
                .Select(c => c.ChatId)
                .ToHashSet();

            _chats = [];
            foreach (var chat in chats)
            {
                // Get cached health status from bot service
                var health = BotService.GetCachedHealth(chat.ChatId) ?? new ChatHealthStatus
                {
                    ChatId = chat.ChatId,
                    Status = ChatHealthStatusType.Unknown,
                    IsReachable = true
                };

                // Check if this chat has a custom welcome config
                var configRecord = await ConfigRepository.GetAsync(chat.ChatId);
                var hasWelcomeConfig = !string.IsNullOrEmpty(configRecord?.WelcomeConfig);

                _chats.Add(new ManagedChatInfo
                {
                    Chat = chat,
                    HealthStatus = health,
                    HasCustomSpamConfig = customConfigChatIds.Contains(chat.ChatId),
                    HasCustomWelcomeConfig = hasWelcomeConfig
                });
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load chats: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void HandleHealthUpdate(ChatHealthStatus health)
    {
        // Update health status for the chat in real-time
        var chat = _chats.FirstOrDefault(c => c.Chat.ChatId == health.ChatId);
        if (chat != null)
        {
            chat.HealthStatus = health;
            InvokeAsync(StateHasChanged); // Re-render UI
        }
    }

    private async Task HandleConfigured(bool saved)
    {
        if (saved)
        {
            await LoadChatsAsync();
        }
    }

    public void Dispose()
    {
        // Unsubscribe from events
        BotService.OnHealthUpdate -= HandleHealthUpdate;
    }

    private bool FilterFunc(ManagedChatInfo chat)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (!string.IsNullOrEmpty(chat.Chat.ChatName) &&
            chat.Chat.ChatName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (chat.Chat.ChatId.ToString().Contains(_searchString))
            return true;

        return false;
    }
}
