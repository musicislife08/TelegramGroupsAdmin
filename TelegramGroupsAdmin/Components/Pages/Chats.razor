@page "/chats"
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Components.Shared.ChatManagement
@using TelegramGroupsAdmin.ContentDetection.Repositories
@using TelegramGroupsAdmin.Telegram.Services
@inject ITelegramBotService BotService
@inject IChatManagementService ChatManagementService
@inject IManagedChatsRepository ManagedChatsRepository
@inject IContentDetectionConfigRepository SpamConfigRepository
@inject TelegramGroupsAdmin.Configuration.Repositories.IConfigRepository ConfigRepository
@inject IBlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar
@attribute [Authorize]
@implements IDisposable

<PageTitle>Chat Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Chat Management</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">
        Manage Telegram chats where the bot is active. Configure spam detection settings per chat.
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (_chats.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            <MudText Typo="Typo.h6">No chats available</MudText>
            <MudText Typo="Typo.body2">
                You don't have access to any chats yet. Add the bot to a Telegram group to get started.
                Chats where the bot is added (even without admin permissions) will appear here for pre-configuration.
                Spam detection and moderation only runs when the bot has admin permissions.
            </MudText>
            <MudText Typo="Typo.body2" Class="mt-2">
                If you're an Admin user, you also need to link your Telegram account to see chats where you have admin permissions.
                Visit your Profile page to link your Telegram account.
            </MudText>
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_chats" Dense="true" Hover="true" Striped="true" Filter="new Func<ManagedChatInfo, bool>(FilterFunc)">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Managed Chats</MudText>
                <MudSpacer />
                <MudCheckBox @bind-Value="_showDeletedChats"
                            Label="Show deleted chats"
                            Color="Color.Primary"
                            Dense="true"
                            Class="mr-4" />
                <MudTextField @bind-Value="_searchString" Placeholder="Search chats" Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Chat Name</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Bot Status</MudTh>
                <MudTh>Health</MudTh>
                <MudTh>Custom Config</MudTh>
                <MudTh>Last Seen</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Chat Name">
                    <ChatInfoCell Chat="@context.Chat" />
                </MudTd>
                <MudTd DataLabel="Type">@context.Chat.ChatType.ToString()</MudTd>
                <MudTd DataLabel="Bot Status">
                    <ChatStatusChip BotStatus="@context.Chat.BotStatus" />
                </MudTd>
                <MudTd DataLabel="Health">
                    <ChatStatusChip HealthStatus="@context.HealthStatus.Status"
                                   Warnings="@context.HealthStatus.Warnings" />
                </MudTd>
                <MudTd DataLabel="Custom Config">
                    @if (context.HasCustomSpamConfig)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                    }
                    else
                    {
                        <span>Global</span>
                    }
                </MudTd>
                <MudTd DataLabel="Last Seen">
                    @if (context.Chat.LastSeenAt.HasValue)
                    {
                        @context.Chat.LastSeenAt.Value.ToString("g")
                    }
                    else
                    {
                        <span>Never</span>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <ChatActionsCell ChatInfo="@context"
                                    OnChatLeft="@LoadChatsAsync"
                                    OnConfigured="@HandleConfigured"
                                    OnHealthRefreshQueued="@StateHasChanged" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="[10, 25, 50, 100]" />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

@code {
    private List<ManagedChatInfo> _chats = [];
    private bool _loading = true;
    private string _searchString = "";
    private bool _showDeletedChats;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to health updates
        BotService.OnHealthUpdate += HandleHealthUpdate;

        await LoadChatsAsync();
    }

    private async Task LoadChatsAsync()
    {
        _loading = true;
        try
        {
            // Get current user and their permission level
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            var permissionLevel = await AuthHelper.GetCurrentPermissionLevelAsync();

            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Unable to identify current user", Severity.Error);
                return;
            }

            // Load chats accessible to this user (filtered by permission level)
            // Include deleted chats - UI toggle controls visibility
            var chats = await ManagedChatsRepository.GetUserAccessibleChatsAsync(
                userId,
                permissionLevel,
                includeDeleted: true);

            // Check which chats have custom spam configs
            var allConfigs = await SpamConfigRepository.GetAllChatConfigsAsync();
            var customConfigChatIds = allConfigs
                .Where(c => c.ChatId != 0)
                .Select(c => c.ChatId)
                .ToHashSet();

            _chats = [];
            foreach (var chat in chats)
            {
                // Get cached health status from chat management service
                var health = ChatManagementService.GetCachedHealth(chat.ChatId) ?? new ChatHealthStatus
                {
                    ChatId = chat.ChatId,
                    Status = ChatHealthStatusType.Unknown,
                    IsReachable = true
                };

                // Check if this chat has custom configs
                var configRecord = await ConfigRepository.GetAsync(chat.ChatId);
                var hasWelcomeConfig = !string.IsNullOrEmpty(configRecord?.WelcomeConfig);
                var hasServiceMsgConfig = !string.IsNullOrEmpty(configRecord?.ServiceMessageDeletionConfig);
                var hasBanCelebrationConfig = !string.IsNullOrEmpty(configRecord?.BanCelebrationConfig);

                _chats.Add(new ManagedChatInfo
                {
                    Chat = chat,
                    HealthStatus = health,
                    HasCustomSpamConfig = customConfigChatIds.Contains(chat.ChatId),
                    HasCustomWelcomeConfig = hasWelcomeConfig,
                    HasCustomServiceMsgConfig = hasServiceMsgConfig,
                    HasCustomBanCelebrationConfig = hasBanCelebrationConfig
                });
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load chats: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void HandleHealthUpdate(ChatHealthStatus health)
    {
        // Update health status for the chat in real-time
        var chat = _chats.FirstOrDefault(c => c.Chat.ChatId == health.ChatId);
        if (chat != null)
        {
            chat.HealthStatus = health;
            InvokeAsync(StateHasChanged); // Re-render UI
        }
    }

    private async Task HandleConfigured(bool saved)
    {
        if (saved)
        {
            await LoadChatsAsync();
        }
    }

    public void Dispose()
    {
        // Unsubscribe from events
        BotService.OnHealthUpdate -= HandleHealthUpdate;
    }

    private bool FilterFunc(ManagedChatInfo chat)
    {
        // Filter by deleted status first
        if (!_showDeletedChats && chat.Chat.IsDeleted)
            return false;

        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (!string.IsNullOrEmpty(chat.Chat.ChatName) &&
            chat.Chat.ChatName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (chat.Chat.ChatId.ToString().Contains(_searchString))
            return true;

        return false;
    }
}
