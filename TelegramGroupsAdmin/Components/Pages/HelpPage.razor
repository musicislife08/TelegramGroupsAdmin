@page "/help/{*Slug}"
@using Microsoft.AspNetCore.Authorization
@using TelegramGroupsAdmin.Services.Help
@using TelegramGroupsAdmin.Models.Help
@inject IHelpDocumentService HelpService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>@(_document?.Metadata.Title ?? "Help") - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
    @if (_document != null)
    {
        <!-- Breadcrumbs -->
        <MudBreadcrumbs Items="@_mudBreadcrumbs" Class="mb-4"></MudBreadcrumbs>

        <!-- Header -->
        <MudPaper Class="pa-6 mb-4" Elevation="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                @if (!string.IsNullOrEmpty(_document.Metadata.Icon))
                {
                    <MudIcon Icon="@GetMudIcon(_document.Metadata.Icon)"
                            Color="@GetMudColor(_document.Metadata.Color)"
                            Size="Size.Large" />
                }
                <MudText Typo="Typo.h3" Color="@GetMudColor(_document.Metadata.Color)">
                    @_document.Metadata.Title
                </MudText>
            </MudStack>
            @if (!string.IsNullOrEmpty(_document.Metadata.Description))
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                    @_document.Metadata.Description
                </MudText>
            }
        </MudPaper>

        <!-- Markdown Content -->
        <MudPaper Class="pa-6" Elevation="1">
            <div class="markdown-content">
                @((MarkupString)_document.HtmlContent)
            </div>
        </MudPaper>

        <!-- Back to Help Index -->
        <MudPaper Class="pa-4 mt-4" Elevation="0">
            <MudButton Variant="Variant.Text"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.ArrowBack"
                      Href="/help">
                Back to Help Index
            </MudButton>
        </MudPaper>
    }
    else if (_notFound)
    {
        <!-- 404 Not Found -->
        <MudPaper Class="pa-8" Elevation="1">
            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.HelpOutline" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h4" Color="Color.Secondary">Help Document Not Found</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    The help document "@Slug" could not be found.
                </MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Home"
                          Href="/help">
                    Return to Help Index
                </MudButton>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <!-- Loading -->
        <MudPaper Class="pa-8" Elevation="1">
            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body1">Loading help document...</MudText>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter]
    public string Slug { get; set; } = string.Empty;

    private HelpDocument? _document;
    private bool _notFound;
    private List<MudBlazor.BreadcrumbItem> _mudBreadcrumbs = new();

    protected override void OnParametersSet()
    {
        // Load document when route parameter changes
        LoadDocument();
    }

    private void LoadDocument()
    {
        _document = null;
        _notFound = false;

        if (string.IsNullOrWhiteSpace(Slug))
        {
            _notFound = true;
            return;
        }

        _document = HelpService.GetDocument(Slug);

        if (_document == null)
        {
            _notFound = true;
        }
        else
        {
            // Convert breadcrumbs to MudBlazor format
            _mudBreadcrumbs = _document.Breadcrumbs
                .Select(b => new MudBlazor.BreadcrumbItem(b.Text, b.Href, b.Disabled))
                .ToList();
        }
    }

    private Color GetMudColor(string colorName)
    {
        return colorName.ToLowerInvariant() switch
        {
            "primary" => Color.Primary,
            "secondary" => Color.Secondary,
            "tertiary" => Color.Tertiary,
            "info" => Color.Info,
            "success" => Color.Success,
            "warning" => Color.Warning,
            "error" => Color.Error,
            "dark" => Color.Dark,
            _ => Color.Primary
        };
    }

    private string GetMudIcon(string iconName)
    {
        return iconName.ToLowerInvariant() switch
        {
            "shield" => Icons.Material.Filled.Shield,
            "settings" => Icons.Material.Filled.Settings,
            "autofixhigh" => Icons.Material.Filled.AutoFixHigh,
            "link" => Icons.Material.Filled.Link,
            "security" => Icons.Material.Filled.Security,
            "tipsandupdates" => Icons.Material.Filled.TipsAndUpdates,
            "bugreport" => Icons.Material.Filled.BugReport,
            "menubook" => Icons.Material.Filled.MenuBook,
            "help" => Icons.Material.Filled.Help,
            _ => Icons.Material.Filled.HelpOutline
        };
    }
}
