@page "/login/setup-2fa"
@using System.ComponentModel.DataAnnotations
@using TelegramGroupsAdmin.Core.Models
@using TelegramGroupsAdmin.Helpers
@using TelegramGroupsAdmin.Repositories
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Services.Auth
@using QRCoder
@inject IAuthService AuthService
@inject IIntermediateAuthService IntermediateAuthService
@inject IAuthCookieService AuthCookieService
@inject IHttpContextAccessor HttpContextAccessor
@inject IUserRepository UserRepository
@inject IPendingRecoveryCodesService PendingRecoveryCodesService
@inject ILogger<Setup2FA> Logger
@attribute [AllowAnonymous]
@attribute [ExcludeFromInteractiveRouting]

<PageTitle>Setup Two-Factor Authentication - TelegramGroupsAdmin</PageTitle>

<div class="setup-container">
    <h1 class="setup-title">Two-Factor Authentication Required</h1>
    <p class="setup-subtitle">Protect your account with an extra layer of security</p>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert-error">@_errorMessage</div>
    }

    @if (_showRecoveryCodes)
    {
        <!-- Step 4: Recovery Codes -->
        <div class="recovery-codes-section">
            <h3>‚ö†Ô∏è Save Your Recovery Codes</h3>
            <p class="warning-text">
                <strong>These codes can only be viewed once.</strong> If you lose access to your authenticator app,
                you'll need one of these codes to sign in. Each code can only be used once.
            </p>
            <p class="warning-text">
                Store these codes in a safe place, such as a password manager or printed copy in a secure location.
            </p>
            @if (_recoveryCodes != null)
            {
                <div class="recovery-codes">
                    @foreach (var recoveryCode in _recoveryCodes)
                    {
                        <div class="recovery-code">@recoveryCode</div>
                    }
                </div>
            }
            <EditForm Model="@ConfirmForm" FormName="confirm-form" OnValidSubmit="CompleteSetupAsync" method="post">
                <DataAnnotationsValidator />
                <div class="confirm-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox"
                               id="confirmed"
                               name="ConfirmForm.Confirmed"
                               value="true"
                               checked="@ConfirmForm!.Confirmed" />
                        <span>I have saved my recovery codes in a secure location</span>
                    </label>
                    <ValidationMessage For="@(() => ConfirmForm!.Confirmed)" />
                </div>
                <button type="submit" class="btn-primary">Complete Setup</button>
            </EditForm>
        </div>
    }
    else if (_totpSetupResult == null)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Setting up 2FA...</p>
        </div>
    }
    else
    {
        <div class="setup-steps">
            <div class="step">
                <h3>Step 1: Install an Authenticator App</h3>
                <p>You'll need an authenticator app on your phone. We recommend these free, open-source options:</p>
                <div class="app-recommendations">
                    <div class="app-card">
                        <strong>Aegis Authenticator</strong>
                        <span class="app-platform">(Android)</span>
                        <p>üîì Open source, encrypted vault, offline backup</p>
                    </div>
                    <div class="app-card">
                        <strong>Raivo OTP</strong>
                        <span class="app-platform">(iOS)</span>
                        <p>üîì Open source, encrypted, iCloud sync</p>
                    </div>
                    <div class="app-card">
                        <strong>2FAS</strong>
                        <span class="app-platform">(Android, iOS)</span>
                        <p>üîì Open source, cloud backup, browser extension</p>
                    </div>
                    <div class="app-card">
                        <strong>Google Authenticator</strong>
                        <span class="app-platform">(Android, iOS)</span>
                        <p>Simple, widely supported</p>
                    </div>
                </div>
            </div>

            <div class="step">
                <h3>Step 2: Scan the QR Code</h3>
                <p>Open your authenticator app and scan this code:</p>
                <div class="qr-container">
                    <img src="@GetQrCodeDataUrl()" alt="QR Code" class="qr-code" />
                </div>
                <div class="manual-entry">
                    <p>Can't scan? Enter this code manually:</p>
                    <div class="secret-code">@_totpSetupResult.ManualEntryKey</div>
                </div>
            </div>

            <div class="step">
                <h3>Step 3: Verify Your Code</h3>
                <EditForm Model="@Model" FormName="verify-form" OnValidSubmit="HandleVerifyAsync" method="post">
                    <DataAnnotationsValidator />
                    <div class="form-group">
                        <label class="form-label" for="code">Enter the 6-digit code from your app:</label>
                        <input type="text"
                               id="code"
                               name="Model.Code"
                               class="form-input code-input"
                               value="@Model!.Code"
                               placeholder="000000"
                               maxlength="6"
                               pattern="[0-9]*"
                               inputmode="numeric"
                               required
                               autofocus />
                        <ValidationMessage For="@(() => Model!.Code)" />
                    </div>
                    <button type="submit" class="btn-primary">Verify and Continue</button>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromForm]
    private VerifyModel? Model { get; set; }

    [SupplyParameterFromForm]
    private ConfirmModel? ConfirmForm { get; set; }

    [SupplyParameterFromQuery(Name = "userId")]
    private string? UserId { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    private string? IntermediateToken { get; set; }

    [SupplyParameterFromQuery(Name = "returnUrl")]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery(Name = "step")]
    private string? Step { get; set; }

    private string? _errorMessage;
    private TotpSetupResult? _totpSetupResult;
    private IReadOnlyList<string>? _recoveryCodes;
    private bool _showRecoveryCodes;

    protected override async Task OnInitializedAsync()
    {
        Model ??= new VerifyModel();
        ConfirmForm ??= new ConfirmModel();

        // SECURITY: Validate that user has a valid intermediate authentication token
        // This prevents attackers from accessing /login/setup-2fa?userId=VICTIM_ID
        // and enabling TOTP on someone else's account
        if (string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(IntermediateToken))
        {
            _errorMessage = "Invalid authentication session. Please log in again.";
            HttpContextAccessor.HttpContext?.Response.Redirect("/login");
            return;
        }

        // Validate token (without consuming - we'll consume after successful setup)
        if (!IntermediateAuthService.ValidateToken(IntermediateToken, UserId))
        {
            _errorMessage = "Invalid or expired authentication session. Please log in again.";
            HttpContextAccessor.HttpContext?.Response.Redirect("/login");
            return;
        }

        // Check if we're on the recovery codes step (redirected here after TOTP verification)
        if (Step == "recovery")
        {
            var httpContext = HttpContextAccessor.HttpContext;
            var isPostRequest = httpContext?.Request.Method == "POST";

            if (isPostRequest)
            {
                // This is a form submission (confirm-form) - codes were already shown on GET
                // Just set the flag so the form handler can run
                _showRecoveryCodes = true;
                return;
            }

            // GET request - retrieve recovery codes from temporary cache
            _recoveryCodes = PendingRecoveryCodesService.RetrieveRecoveryCodes(IntermediateToken, UserId);
            if (_recoveryCodes != null)
            {
                _showRecoveryCodes = true;
                Logger.LogInformation("Displaying recovery codes for user {UserId}", UserId);
                return;
            }

            // Codes not found or expired - redirect back to start
            Logger.LogWarning("Recovery codes not found for user {UserId}, redirecting to setup", UserId);
            var setupUrl = UrlHelpers.BuildSetup2FAUrl(UserId, IntermediateToken, ReturnUrl);
            httpContext?.Response.Redirect(setupUrl);
            return;
        }

        try
        {
            // Generate TOTP setup
            var webUser = WebUserIdentity.FromId(UserId);
            _totpSetupResult = await AuthService.EnableTotpAsync(webUser);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error setting up 2FA: {ex.Message}";
            Logger.LogError(ex, "Unexpected error during 2FA setup for user {UserId}", UserId);
        }
    }

    private async Task HandleVerifyAsync()
    {
        _errorMessage = null;

        Logger.LogInformation("TOTP verification attempt for user {UserId}", UserId);

        if (Model == null || string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(IntermediateToken))
        {
            Logger.LogWarning("TOTP verification failed: Missing form data (UserId: {UserId}, HasModel: {HasModel}, HasToken: {HasToken})",
                UserId, Model != null, !string.IsNullOrEmpty(IntermediateToken));
            _errorMessage = "Form data is missing.";
            return;
        }

        // SECURITY: Validate token before allowing TOTP verification
        if (!IntermediateAuthService.ValidateToken(IntermediateToken, UserId))
        {
            Logger.LogWarning("TOTP verification failed: Invalid or expired intermediate auth token for user {UserId}", UserId);
            _errorMessage = "Invalid or expired authentication session. Please log in again.";
            var httpContext = HttpContextAccessor.HttpContext;
            httpContext?.Response.Redirect("/login");
            return;
        }

        if (string.IsNullOrWhiteSpace(Model.Code))
        {
            Logger.LogWarning("TOTP verification failed: Empty code provided for user {UserId}", UserId);
            _errorMessage = "Please enter the 6-digit code from your authenticator app.";
            return;
        }

        Logger.LogInformation("Attempting TOTP verification for user {UserId} (code length: {CodeLength})",
            UserId, Model.Code.Length);

        try
        {
            var webUser = WebUserIdentity.FromId(UserId);
            var result = await AuthService.VerifyAndEnableTotpAsync(webUser, Model.Code);

            if (!result.Success)
            {
                Logger.LogWarning("TOTP verification failed for user {UserId}: {ErrorMessage} (SetupExpired: {SetupExpired})",
                    UserId, result.ErrorMessage, result.SetupExpired);
                _errorMessage = result.ErrorMessage ?? "Invalid verification code. Please try again.";
                Model = new VerifyModel();
                return;
            }

            Logger.LogInformation("TOTP verification successful for user {UserId}, generating recovery codes", UserId);

            // Generate recovery codes - user must save these before completing setup
            var recoveryCodes = await AuthService.GenerateRecoveryCodesAsync(webUser);
            Logger.LogInformation("Generated {Count} recovery codes for user {UserId}", recoveryCodes.Count, UserId);

            // Store recovery codes in temporary cache and redirect to recovery step
            // This enables URL-based state for static SSR (state doesn't persist between form posts)
            PendingRecoveryCodesService.StoreRecoveryCodes(IntermediateToken, UserId, recoveryCodes);

            // Redirect to recovery step - the page will reload and display codes from cache
            var recoveryUrl = UrlHelpers.BuildSetup2FAUrl(UserId, IntermediateToken, ReturnUrl, step: "recovery");
            HttpContextAccessor.HttpContext?.Response.Redirect(recoveryUrl);
            return;
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred. Please try again.";
            Logger.LogError(ex, "Unexpected error during 2FA verification for user {UserId}", UserId);
        }
    }

    private string GetQrCodeDataUrl()
    {
        if (_totpSetupResult == null) return "";

        using var qrGenerator = new QRCodeGenerator();
        using var qrCodeData = qrGenerator.CreateQrCode(_totpSetupResult.QrCodeUri, QRCodeGenerator.ECCLevel.Q);
        using var qrCode = new PngByteQRCode(qrCodeData);
        var qrCodeBytes = qrCode.GetGraphic(20);

        var base64 = Convert.ToBase64String(qrCodeBytes);
        return $"data:image/png;base64,{base64}";
    }

    private async Task CompleteSetupAsync()
    {
        Logger.LogInformation("User {UserId} confirmed recovery codes saved, completing authentication", UserId);

        // SECURITY: Consume token after successful authentication to prevent reuse
        IntermediateAuthService.ConsumeToken(IntermediateToken!);

        // Get user data
        var user = await UserRepository.GetByIdAsync(UserId!);
        if (user == null)
        {
            _errorMessage = "Unable to complete setup.";
            return;
        }

        // Sign in the user
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext == null)
        {
            _errorMessage = "Unable to complete authentication. Please try again.";
            return;
        }

        await AuthCookieService.SignInAsync(httpContext, user.WebUser);

        // Redirect (validate URL to prevent open redirect attacks)
        var safeReturnUrl = UrlHelpers.GetSafeRedirectUrl(ReturnUrl);
        httpContext.Response.Redirect(safeReturnUrl);
    }

    public class VerifyModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be 6 digits")]
        [RegularExpression("^[0-9]{6}$", ErrorMessage = "Code must be 6 digits")]
        public string Code { get; set; } = string.Empty;
    }

    public class ConfirmModel
    {
        [Required(ErrorMessage = "You must confirm you have saved your recovery codes")]
        [Range(typeof(bool), "true", "true", ErrorMessage = "You must confirm you have saved your recovery codes")]
        public bool Confirmed { get; set; }
    }
}
