@page "/login/verify"
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Components.Forms
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.Helpers
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Services.Auth
@inject IAuthService AuthService
@inject IIntermediateAuthService IntermediateAuthService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<LoginVerify> Logger
@attribute [AllowAnonymous]
@attribute [ExcludeFromInteractiveRouting]

<PageTitle>Two-Factor Authentication - Telegram Groups Admin</PageTitle>

<div class="verify-container">
    <h1 class="verify-title">Two-Factor Authentication</h1>
    <p class="verify-subtitle">Enter the 6-digit code from your authenticator app</p>

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert-success">@_successMessage</div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert-error">@_errorMessage</div>
    }

    <EditForm Model="@_model" FormName="verify-form" OnValidSubmit="HandleVerifyAsync" method="post">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label class="form-label" for="code">Verification Code</label>
            <input type="text"
                   id="code"
                   name="_model.Code"
                   class="form-input"
                   value="@_model!.Code"
                   placeholder="000000"
                   maxlength="6"
                   pattern="[0-9]*"
                   inputmode="numeric"
                   required />
            <ValidationMessage For="@(() => _model!.Code)" />
        </div>

        <button type="submit" class="btn-primary">Verify</button>
    </EditForm>

    <div class="divider"></div>

    <p class="text-center">
        Lost access to your authenticator? Contact your administrator to reset 2FA.<br />
        <a href="/login">Back to Login</a>
    </p>
</div>

@code {
    [SupplyParameterFromForm]
    private VerifyModel? _model { get; set; }

    [SupplyParameterFromQuery(Name = "userId")]
    private string? UserId { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    private string? IntermediateToken { get; set; }

    [SupplyParameterFromQuery(Name = "returnUrl")]
    private string? ReturnUrl { get; set; }

    private string? _errorMessage;
    private string? _successMessage;

    protected override void OnInitialized()
    {
        _model ??= new VerifyModel();

        var httpContext = HttpContextAccessor.HttpContext;

        // SECURITY: Validate that user has a valid intermediate authentication token
        // This prevents attackers from directly accessing /login/verify?userId=VICTIM_ID
        // and brute-forcing TOTP codes without knowing the password
        if (string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(IntermediateToken))
        {
            _errorMessage = "Invalid authentication session. Please log in again.";
            httpContext?.Response.Redirect("/login");
            return;
        }

        // Validate token without consuming it yet (we'll consume it when they submit the form)
        // We can't consume here because OnInitialized runs on every page load
    }

    private async Task HandleVerifyAsync()
    {
        _errorMessage = null;
        _successMessage = null;

        if (_model == null || string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(IntermediateToken))
        {
            _errorMessage = "Form data is missing.";
            return;
        }

        try
        {
            // SECURITY: Validate intermediate auth token (without consuming)
            // This allows users to retry if they mistype the TOTP code
            if (!IntermediateAuthService.ValidateToken(IntermediateToken, UserId))
            {
                _errorMessage = "Invalid or expired authentication session. Please log in again.";
                HttpContextAccessor.HttpContext?.Response.Redirect("/login");
                return;
            }

            // Verify TOTP code
            var result = await AuthService.VerifyTotpAsync(UserId, _model.Code);

            if (!result.Success)
            {
                _errorMessage = result.ErrorMessage;
                _model = new VerifyModel();
                return;
            }

            // SECURITY: Consume token after successful authentication to prevent reuse
            IntermediateAuthService.ConsumeToken(IntermediateToken);

            // Sign in the user with cookie authentication (works in static SSR)
            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext == null)
            {
                _errorMessage = "Unable to complete authentication. Please try again.";
                return;
            }

            var claims = new List<Claim>
            {
                new(ClaimTypes.NameIdentifier, result.UserId!),
                new(ClaimTypes.Email, result.Email!),
                new(ClaimTypes.Role, GetRoleName(result.PermissionLevel!.Value)),
                new(CustomClaimTypes.PermissionLevel, result.PermissionLevel.Value.ToString())
            };

            var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);

            var authProperties = new AuthenticationProperties
            {
                IsPersistent = true,
                ExpiresUtc = DateTimeOffset.UtcNow.AddDays(30)
            };

            await httpContext.SignInAsync(
                CookieAuthenticationDefaults.AuthenticationScheme,
                claimsPrincipal,
                authProperties);

            // Redirect using HttpContext (validate URL to prevent open redirect attacks)
            var safeReturnUrl = UrlHelpers.GetSafeRedirectUrl(ReturnUrl);
            httpContext.Response.Redirect(safeReturnUrl);
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred. Please try again.";
            Logger.LogError(ex, "Unexpected error during TOTP verification for user {UserId}", UserId);
        }
    }

    private static string GetRoleName(int permissionLevel) => permissionLevel switch
    {
        0 => "Admin",
        1 => "GlobalAdmin",
        2 => "Owner",
        _ => "Admin"
    };

    public class VerifyModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be 6 digits")]
        [RegularExpression("^[0-9]{6}$", ErrorMessage = "Code must be 6 digits")]
        public string Code { get; set; } = string.Empty;
    }
}
