@page "/debug/notifications"
@using Microsoft.AspNetCore.Authorization
@using TelegramGroupsAdmin.Core.Models
@using TelegramGroupsAdmin.Core.Services
@using TelegramGroupsAdmin.Services
@attribute [Authorize(Policy = "OwnerOnly")]

@inject INotificationService NotificationService
@inject IWebPushNotificationService WebPushService
@inject NotificationStateService NotificationState
@inject BlazorAuthHelper AuthHelper

<PageTitle>Notification Debug</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.BugReport" Size="Size.Large" Color="Color.Warning" />
            <div>
                <MudText Typo="Typo.h5">Notification Debug Page</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Hidden debug page for testing notification delivery. Manually navigate to <code>/debug/notifications</code>.
                </MudText>
            </div>
        </MudStack>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Send" Class="mr-2" />
                    Send Test Notification
                </MudText>

                <MudForm @ref="_form">
                    <MudStack Spacing="3">
                        <MudSelect T="NotificationEventType" Label="Event Type" @bind-Value="_selectedEventType" Required="true">
                            @foreach (var eventType in Enum.GetValues<NotificationEventType>())
                            {
                                <MudSelectItem Value="@eventType">
                                    @GetEventTypeIcon(eventType) @eventType
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudTextField @bind-Value="_subject" Label="Subject" Required="true"
                                      Placeholder="Test notification subject" />

                        <MudTextField @bind-Value="_message" Label="Message" Lines="3" Required="true"
                                      Placeholder="Test notification message body" />

                        <MudSelect T="DeliveryMode" Label="Delivery Mode" @bind-Value="_deliveryMode">
                            <MudSelectItem Value="DeliveryMode.ToCurrentUser">To Current User (Me)</MudSelectItem>
                            <MudSelectItem Value="DeliveryMode.SystemNotification">System Notification (All Owners)</MudSelectItem>
                        </MudSelect>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   OnClick="SendTestNotificationAsync" Disabled="_isSending"
                                   StartIcon="@(_isSending ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Notifications)">
                            @(_isSending ? "Sending..." : "Send Test Notification")
                        </MudButton>
                    </MudStack>
                </MudForm>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                    Delivery Results
                </MudText>

                @if (_deliveryResults.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                        Send a test notification to see delivery results here.
                    </MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        @foreach (var result in _deliveryResults.TakeLast(10).Reverse())
                        {
                            <MudAlert Severity="@(result.Success ? Severity.Success : Severity.Warning)"
                                      Variant="Variant.Outlined" Dense="true">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">
                                        <b>@result.EventType</b> &rarr; @result.Mode
                                    </MudText>
                                    <MudText Typo="Typo.caption">
                                        @result.Timestamp.ToString("HH:mm:ss") - @result.Message
                                    </MudText>
                                </MudStack>
                            </MudAlert>
                        }
                    </MudStack>
                }
            </MudPaper>

            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-2" />
                    State Actions
                </MudText>

                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               OnClick="RefreshNotificationStateAsync"
                               StartIcon="@Icons.Material.Filled.Refresh">
                        Refresh Notification State
                    </MudButton>

                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Current unread count: <b>@NotificationState.UnreadCount</b>
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" />
            Event Type Reference
        </MudText>

        <MudTable Items="@_eventTypeInfo" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Event Type</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Typical Trigger</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Event Type">
                    @GetEventTypeIcon(context.EventType) <b>@context.EventType</b>
                </MudTd>
                <MudTd DataLabel="Description">@context.Description</MudTd>
                <MudTd DataLabel="Typical Trigger">@context.Trigger</MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private MudForm _form = null!;
    private NotificationEventType _selectedEventType = NotificationEventType.SpamDetected;
    private string _subject = "Test Notification";
    private string _message = "This is a test notification triggered from the debug page.";
    private DeliveryMode _deliveryMode = DeliveryMode.ToCurrentUser;
    private bool _isSending;
    private readonly List<DeliveryResult> _deliveryResults = [];
    private string? _currentUserId;

    private readonly List<EventTypeInfo> _eventTypeInfo =
    [
        new(NotificationEventType.SpamDetected, "Spam content detected by ML/rules", "Message processing pipeline"),
        new(NotificationEventType.SpamAutoDeleted, "Spam message auto-deleted", "High confidence spam detection"),
        new(NotificationEventType.UserBanned, "User banned from chat", "Manual or auto-ban action"),
        new(NotificationEventType.MessageReported, "Message reported by user", "Report dialog submission"),
        new(NotificationEventType.ChatHealthWarning, "Chat health metrics degraded", "Analytics monitoring job"),
        new(NotificationEventType.BackupFailed, "Backup job failed", "Scheduled backup failure"),
        new(NotificationEventType.MalwareDetected, "Malware detected in file", "VirusTotal/ClamAV scan"),
        new(NotificationEventType.ChatAdminChanged, "Chat admin promoted/demoted", "Telegram admin sync")
    ];

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = await AuthHelper.GetCurrentUserIdAsync();
    }

    private async Task SendTestNotificationAsync()
    {
        if (string.IsNullOrWhiteSpace(_subject) || string.IsNullOrWhiteSpace(_message))
            return;

        _isSending = true;
        StateHasChanged();

        try
        {
            bool success;
            string resultMessage;

            if (_deliveryMode == DeliveryMode.ToCurrentUser && !string.IsNullOrEmpty(_currentUserId))
            {
                success = await NotificationService.SendNotificationAsync(
                    _currentUserId,
                    _selectedEventType,
                    _subject,
                    _message);

                resultMessage = success
                    ? "Delivered to at least one channel"
                    : "No channels delivered (check preferences)";
            }
            else
            {
                var results = await NotificationService.SendSystemNotificationAsync(
                    _selectedEventType,
                    _subject,
                    _message);

                success = results.Values.Any(v => v);
                resultMessage = $"Sent to {results.Count} owners, {results.Values.Count(v => v)} succeeded";
            }

            _deliveryResults.Add(new DeliveryResult
            {
                EventType = _selectedEventType,
                Mode = _deliveryMode,
                Success = success,
                Message = resultMessage,
                Timestamp = DateTime.Now
            });

            // Refresh the notification state to show the new notification in the bell
            await NotificationState.RefreshAsync();
        }
        catch (Exception ex)
        {
            _deliveryResults.Add(new DeliveryResult
            {
                EventType = _selectedEventType,
                Mode = _deliveryMode,
                Success = false,
                Message = $"Error: {ex.Message}",
                Timestamp = DateTime.Now
            });
        }
        finally
        {
            _isSending = false;
        }
    }

    private async Task RefreshNotificationStateAsync()
    {
        await NotificationState.RefreshAsync();
    }

    private static string GetEventTypeIcon(NotificationEventType eventType) => eventType switch
    {
        NotificationEventType.SpamDetected => "\ud83d\udeab",
        NotificationEventType.SpamAutoDeleted => "\ud83d\uddd1\ufe0f",
        NotificationEventType.UserBanned => "\ud83d\udeab",
        NotificationEventType.MessageReported => "\ud83d\udea9",
        NotificationEventType.ChatHealthWarning => "\u26a0\ufe0f",
        NotificationEventType.BackupFailed => "\ud83d\udcbe",
        NotificationEventType.MalwareDetected => "\ud83e\udda0",
        NotificationEventType.ChatAdminChanged => "\ud83d\udc64",
        _ => "\ud83d\udd14"
    };

    private enum DeliveryMode
    {
        ToCurrentUser,
        SystemNotification
    }

    private record DeliveryResult
    {
        public NotificationEventType EventType { get; init; }
        public DeliveryMode Mode { get; init; }
        public bool Success { get; init; }
        public string Message { get; init; } = "";
        public DateTime Timestamp { get; init; }
    }

    private record EventTypeInfo(NotificationEventType EventType, string Description, string Trigger);
}
