@page "/help"
@using Microsoft.AspNetCore.Authorization
@using TelegramGroupsAdmin.Services.Help
@using TelegramGroupsAdmin.Models.Help
@inject IHelpDocumentService HelpService
@attribute [Authorize]

<PageTitle>Help & Documentation - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Class="pa-6" Elevation="2">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h3" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Help" Class="mr-2" />
                    Help & Documentation
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Comprehensive guides for configuring and using TelegramGroupsAdmin's spam detection and moderation features.
                </MudText>
            </MudStack>
        </MudPaper>

        <!-- Search Box -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudTextField @bind-Value="_searchQuery"
                         Label="Search Documentation"
                         Variant="Variant.Outlined"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Immediate="true"
                         DebounceInterval="300"
                         OnDebounceIntervalElapsed="FilterTopics"
                         Placeholder="Search for topics, algorithms, or configuration help..." />
        </MudPaper>

        <!-- Documentation Topics Grid -->
        <MudGrid>
            @foreach (var doc in _filteredDocuments)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Style="height: 100%;">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    @if (!string.IsNullOrEmpty(doc.Metadata.Icon))
                                    {
                                        <MudIcon Icon="@GetMudIcon(doc.Metadata.Icon)" Color="@GetMudColor(doc.Metadata.Color)" Size="Size.Large" />
                                    }
                                    <MudText Typo="Typo.h6">@doc.Metadata.Title</MudText>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @doc.Metadata.Description
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Primary"
                                      Href="@($"/help/{doc.Slug}")"
                                      EndIcon="@Icons.Material.Filled.ArrowForward">
                                Learn More
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @if (_filteredDocuments.Count == 0)
        {
            <MudPaper Class="pa-8" Elevation="0">
                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">No results found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @if (HelpService.IsInitialized)
                        {
                            <text>Try a different search term</text>
                        }
                        else
                        {
                            <text>No help documents have been loaded. Please check the /Help directory.</text>
                        }
                    </MudText>
                </MudStack>
            </MudPaper>
        }

        <!-- Quick Links -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h6" Color="Color.Primary">Quick Links</MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudChip T="string" Href="/settings/content-detection/algorithms" Color="Color.Primary" Icon="@Icons.Material.Filled.Settings">Configure Algorithms</MudChip>
                    <MudChip T="string" Href="/settings/system/algorithm-tuning" Color="Color.Info" Icon="@Icons.Material.Filled.AutoFixHigh">ML Threshold Tuning</MudChip>
                    <MudChip T="string" Href="/settings/content-detection/url-filters" Color="Color.Warning" Icon="@Icons.Material.Filled.Block">URL Filtering</MudChip>
                    <MudChip T="string" Href="/settings/protection/file-scanning" Color="Color.Error" Icon="@Icons.Material.Filled.Security">File Scanning</MudChip>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private string _searchQuery = string.Empty;
    private IReadOnlyList<HelpDocument> _filteredDocuments = Array.Empty<HelpDocument>();

    protected override void OnInitialized()
    {
        // Load all documents from the help service
        _filteredDocuments = HelpService.GetAllDocuments();
    }

    private void FilterTopics()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            _filteredDocuments = HelpService.GetAllDocuments();
            return;
        }

        _filteredDocuments = HelpService.Search(_searchQuery);
    }

    private Color GetMudColor(string colorName)
    {
        return colorName.ToLowerInvariant() switch
        {
            "primary" => Color.Primary,
            "secondary" => Color.Secondary,
            "tertiary" => Color.Tertiary,
            "info" => Color.Info,
            "success" => Color.Success,
            "warning" => Color.Warning,
            "error" => Color.Error,
            "dark" => Color.Dark,
            _ => Color.Primary
        };
    }

    private string GetMudIcon(string iconName)
    {
        return iconName.ToLowerInvariant() switch
        {
            "shield" => Icons.Material.Filled.Shield,
            "settings" => Icons.Material.Filled.Settings,
            "autofixhigh" => Icons.Material.Filled.AutoFixHigh,
            "link" => Icons.Material.Filled.Link,
            "security" => Icons.Material.Filled.Security,
            "tipsandupdates" => Icons.Material.Filled.TipsAndUpdates,
            "bugreport" => Icons.Material.Filled.BugReport,
            "menubook" => Icons.Material.Filled.MenuBook,
            "help" => Icons.Material.Filled.Help,
            _ => Icons.Material.Filled.HelpOutline
        };
    }
}
