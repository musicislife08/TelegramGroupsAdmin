@page "/help/spam-detection"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Spam Detection Overview - Help</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>

    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Class="pa-6" Elevation="2">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h3" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Shield" Class="mr-2" />
                    Spam Detection Overview
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Understanding how TelegramGroupsAdmin's 9-algorithm spam detection system works
                </MudText>
            </MudStack>
        </MudPaper>

        <!-- How It Works -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">How Spam Detection Works</MudText>

                <MudText Typo="Typo.body1">
                    TelegramGroupsAdmin uses a <strong>multi-algorithm orchestration system</strong> that runs up to 9 different spam detection
                    checks in parallel on each message. Each algorithm analyzes different aspects of the message and returns a confidence score (0-100).
                </MudText>

                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    <strong>Confidence Aggregation:</strong> Individual algorithm scores are combined using weighted averaging to produce a
                    final confidence score. Higher confidence = more likely to be spam.
                </MudAlert>
            </MudStack>
        </MudPaper>

        <!-- The 9 Algorithms -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">The 9 Detection Algorithms</MudText>

                <!-- Algorithm Table -->
                <MudSimpleTable Hover="true" Dense="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Algorithm</th>
                            <th>What It Does</th>
                            <th>Performance</th>
                            <th>Requirements</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Stop Words</strong></td>
                            <td>Matches messages against customizable keyword list</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Fast (~45ms)</MudChip></td>
                            <td>Configure stop words list</td>
                        </tr>
                        <tr>
                            <td><strong>CAS (Combot Anti-Spam)</strong></td>
                            <td>Checks users against public spammer database</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Fast (~12ms)</MudChip></td>
                            <td>None (external API)</td>
                        </tr>
                        <tr>
                            <td><strong>Similarity (TF-IDF)</strong></td>
                            <td>Compares messages to known spam samples</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Warning">Medium (~87ms)</MudChip></td>
                            <td>Training samples needed</td>
                        </tr>
                        <tr>
                            <td><strong>Naive Bayes</strong></td>
                            <td>ML classifier learns word frequency patterns</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Fast</MudChip></td>
                            <td>50+ spam + 50+ ham samples</td>
                        </tr>
                        <tr>
                            <td><strong>Spacing Detection</strong></td>
                            <td>Detects deliberate spacing to evade filters</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Fast</MudChip></td>
                            <td>None</td>
                        </tr>
                        <tr>
                            <td><strong>Invisible Characters</strong></td>
                            <td>Finds zero-width Unicode abuse</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Fast</MudChip></td>
                            <td>None</td>
                        </tr>
                        <tr>
                            <td><strong>Translation</strong></td>
                            <td>Translates foreign messages for analysis</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Warning">Medium</MudChip></td>
                            <td>OpenAI API key</td>
                        </tr>
                        <tr>
                            <td><strong>OpenAI Verification</strong></td>
                            <td>GPT-4 context analysis (veto or detection)</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Error">Slow (~1.2s)</MudChip></td>
                            <td>OpenAI API key</td>
                        </tr>
                        <tr>
                            <td><strong>URL/File Scanning</strong></td>
                            <td>Malicious URL/file detection</td>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Warning">Variable</MudChip></td>
                            <td>ClamAV + VirusTotal</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudStack>
        </MudPaper>

        <!-- Decision Flow -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">Decision Flow</MudText>

                <MudTimeline TimelineAlign="TimelineAlign.Start" TimelinePosition="TimelinePosition.Start">
                    <MudTimelineItem Color="Color.Info" Icon="@Icons.Material.Filled.Message">
                        <MudText Typo="Typo.h6">1. Message Received</MudText>
                        <MudText Typo="Typo.body2">New message arrives in monitored chat</MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Color="Color.Primary" Icon="@Icons.Material.Filled.Speed">
                        <MudText Typo="Typo.h6">2. Fast Algorithms Run</MudText>
                        <MudText Typo="Typo.body2">Stop Words, CAS, Spacing, Invisible Chars execute in parallel (~50ms)</MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Color="Color.Warning" Icon="@Icons.Material.Filled.Psychology">
                        <MudText Typo="Typo.h6">3. ML Algorithms Run</MudText>
                        <MudText Typo="Typo.body2">Similarity and Bayes analyze patterns if trained (~100ms)</MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Color="Color.Secondary" Icon="@Icons.Material.Filled.Functions">
                        <MudText Typo="Typo.h6">4. Scores Aggregated</MudText>
                        <MudText Typo="Typo.body2">Weighted average produces final confidence (0-100)</MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Color="Color.Tertiary" Icon="@Icons.Material.Filled.SmartToy">
                        <MudText Typo="Typo.h6">5. OpenAI Veto (Optional)</MudText>
                        <MudText Typo="Typo.body2">If enabled and confidence &lt; veto threshold, GPT-4 reviews (~1.2s)</MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                        <MudText Typo="Typo.h6">6. Action Taken</MudText>
                        <MudText Typo="Typo.body2">
                            <strong>â‰¥85 (Auto-Ban):</strong> Delete message + ban user<br/>
                            <strong>70-84 (Review):</strong> Send to review queue<br/>
                            <strong>&lt;70 (Pass):</strong> Message allowed
                        </MudText>
                    </MudTimelineItem>
                </MudTimeline>
            </MudStack>
        </MudPaper>

        <!-- OpenAI Veto Mode -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">Understanding OpenAI Veto Mode</MudText>

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.ThumbUp">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Veto Mode ON (Recommended)</strong></MudText>
                            <MudText Typo="Typo.body2">
                                OpenAI acts as <strong>quality control</strong>. Other algorithms flag spam, OpenAI confirms or vetoes.
                                <ul class="mt-2">
                                    <li>Reduces false positives</li>
                                    <li>Lower API costs (only runs on suspicious messages)</li>
                                    <li>Best for most communities</li>
                                </ul>
                            </MudText>
                        </MudAlert>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Warning">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Veto Mode OFF (Detection)</strong></MudText>
                            <MudText Typo="Typo.body2">
                                OpenAI actively searches for spam on <strong>every message</strong>.
                                <ul class="mt-2">
                                    <li>Higher accuracy</li>
                                    <li>Significantly higher API costs</li>
                                    <li>Use only for high-risk communities</li>
                                </ul>
                            </MudText>
                        </MudAlert>
                    </MudItem>
                </MudGrid>
            </MudStack>
        </MudPaper>

        <!-- Training Mode -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">Training Mode</MudText>

                <MudText Typo="Typo.body1">
                    Training Mode sends <strong>all detections</strong> to the review queue instead of auto-banning. Use this when:
                </MudText>

                <MudList T="string">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.NewReleases" IconColor="Color.Primary">
                        <strong>First-time setup:</strong> Test algorithms before enabling auto-ban
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Science" IconColor="Color.Primary">
                        <strong>Testing new algorithms:</strong> Validate accuracy before production use
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Tune" IconColor="Color.Primary">
                        <strong>Threshold tuning:</strong> Observe detection patterns before adjustment
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Build" IconColor="Color.Primary">
                        <strong>Building training samples:</strong> Review queue feeds Similarity and Bayes
                    </MudListItem>
                </MudList>

                <MudAlert Severity="Severity.Info">
                    <strong>Best Practice:</strong> Start with Training Mode enabled for 7-14 days to build training data
                    and validate thresholds, then disable for production use.
                </MudAlert>
            </MudStack>
        </MudPaper>

        <!-- Performance -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">Performance Characteristics</MudText>

                <MudSimpleTable Hover="true" Dense="true">
                    <thead>
                        <tr>
                            <th>Configuration</th>
                            <th>Average Detection Time</th>
                            <th>P95 Detection Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Fast algorithms only (Stop Words, CAS, Spacing)</td>
                            <td>~50ms</td>
                            <td>~120ms</td>
                        </tr>
                        <tr>
                            <td>Fast + ML algorithms (+ Similarity, Bayes)</td>
                            <td>~150ms</td>
                            <td>~400ms</td>
                        </tr>
                        <tr>
                            <td>All algorithms without OpenAI</td>
                            <td>~200ms</td>
                            <td>~600ms</td>
                        </tr>
                        <tr>
                            <td>All algorithms with OpenAI Veto Mode</td>
                            <td>~255ms</td>
                            <td>~821ms</td>
                        </tr>
                        <tr>
                            <td>All algorithms with OpenAI Detection Mode</td>
                            <td>~1.4s</td>
                            <td>~2.5s</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudAlert Severity="Severity.Success">
                    <strong>Measured in Production:</strong> The default configuration (all 9 algorithms + OpenAI Veto)
                    averages 255ms per message with P95 at 821ms. This handles 500-5,000 messages/day easily.
                </MudAlert>
            </MudStack>
        </MudPaper>

        <!-- Next Steps -->
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h5" Color="Color.Primary">Next Steps</MudText>

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudCard>
                            <MudCardContent>
                                <MudText Typo="Typo.h6">Configure Algorithms</MudText>
                                <MudText Typo="Typo.body2">Learn how to configure each of the 9 detection algorithms</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/help/algorithms">View Guide</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudCard>
                            <MudCardContent>
                                <MudText Typo="Typo.h6">Best Practices</MudText>
                                <MudText Typo="Typo.body2">Recommended configurations for different group sizes</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/help/best-practices">View Guide</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Help", href: "/help"),
        new BreadcrumbItem("Spam Detection Overview", href: null, disabled: true)
    };
}
