@page "/resend-verification"
@using System.ComponentModel.DataAnnotations
@inject HttpClient HttpClient
@inject ILogger<ResendVerification> Logger
@attribute [AllowAnonymous]
@attribute [ExcludeFromInteractiveRouting]

<PageTitle>Resend Verification Email - Telegram Groups Admin</PageTitle>

<div class="container">
    <h1 class="title">Resend Verification Email</h1>
    <p class="subtitle">Enter your email to receive a new verification link</p>

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert-success">@_successMessage</div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert-error">@_errorMessage</div>
    }

    <EditForm Model="@Model" FormName="resend-form" OnValidSubmit="HandleResendAsync" method="post">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email"
                   id="email"
                   name="Model.Email"
                   class="form-input"
                   value="@Model!.Email"
                   placeholder="your.email@example.com"
                   required />
            <ValidationMessage For="@(() => Model!.Email)" />
        </div>

        <button type="submit" class="btn-primary">Send Verification Email</button>
    </EditForm>

    <div class="divider"></div>

    <p class="text-center">
        <a href="/login">Back to Login</a>
    </p>
</div>

@code {
    [SupplyParameterFromForm]
    private ResendModel? Model { get; set; }

    private string? _errorMessage;
    private string? _successMessage;

    protected override void OnInitialized()
    {
        Model ??= new ResendModel();
    }

    private async Task HandleResendAsync()
    {
        _errorMessage = null;
        _successMessage = null;

        if (Model == null)
        {
            _errorMessage = "Form data is missing.";
            return;
        }

        try
        {
            var response = await HttpClient.PostAsJsonAsync("/resend-verification", new { Model.Email });

            if (response.IsSuccessStatusCode)
            {
                _successMessage = "Verification email sent! Please check your inbox.";
                Model = new ResendModel();
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Resend verification failed for email {Email}: {Response}", Model.Email, content);
                _errorMessage = "Unable to send verification email. Email may already be verified or invalid.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred. Please try again.";
            Logger.LogError(ex, "Unexpected error during resend verification for email {Email}", Model.Email);
        }
    }

    public class ResendModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;
    }
}
