@page "/analytics"
@attribute [Authorize(Roles = "GlobalAdmin,Owner")]
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using TelegramGroupsAdmin.Components.Shared.Analytics
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Analytics</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Analytics</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">Deep-dive statistics and trends across all managed chats</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Spam Analytics" Icon="@Icons.Material.Filled.Shield">
            <SpamAnalytics />
        </MudTabPanel>

        <MudTabPanel Text="Message Trends" Icon="@Icons.Material.Filled.TrendingUp">
            <MessageTrends />
        </MudTabPanel>

        <MudTabPanel Text="Performance" Icon="@Icons.Material.Filled.Speed">
            <MudAlert Severity="Severity.Info" Class="mb-4">Performance metrics show global statistics across all chats to evaluate overall spam detection effectiveness.</MudAlert>
            <PerformanceMetrics />
        </MudTabPanel>

        <MudTabPanel Text="Welcome Analytics" Icon="@Icons.Material.Filled.People">
            <MudAlert Severity="Severity.Info" Class="mb-4">Welcome system metrics track user onboarding success rates, join trends, and per-chat performance.</MudAlert>
            <WelcomeAnalytics />
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        // Parse URL fragment for tab selection
        var fragment = new Uri(Navigation.Uri).Fragment.TrimStart('#');
        _activeTabIndex = fragment switch
        {
            "spam" => 0,
            "trends" => 1,
            "performance" => 2,
            "welcome" => 3,
            _ => 0
        };

        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var fragment = new Uri(e.Location).Fragment.TrimStart('#');
        var newIndex = fragment switch
        {
            "spam" => 0,
            "trends" => 1,
            "performance" => 2,
            "welcome" => 3,
            _ => 0
        };

        if (newIndex != _activeTabIndex)
        {
            _activeTabIndex = newIndex;
            StateHasChanged();
        }
    }

    private void OnTabChanged(int index)
    {
        _activeTabIndex = index;

        var fragment = index switch
        {
            0 => "spam",
            1 => "trends",
            2 => "performance",
            3 => "welcome",
            _ => "spam"
        };

        Navigation.NavigateTo($"/analytics#{fragment}", false);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
