@page "/audit"
@using TelegramGroupsAdmin.Repositories
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Core.Utilities
@inject IAuditService AuditService
@inject IUserRepository UserRepository
@inject IUserActionsRepository UserActionsRepository
@inject ITelegramUserRepository TelegramUserRepository
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "GlobalAdmin,Owner")]
@implements IDisposable

<PageTitle>Audit Log - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Audit Log</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Web Admin Log" Icon="@Icons.Material.Filled.Security">
            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                              Color="Color.Primary"
                              OnClick="@(async () => await _webAdminTable.ReloadServerData())"
                              title="Refresh Web Admin Log"
                              Size="Size.Medium" />
            </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="AuditEventType?"
                          Label="Event Type"
                          Value="_filterEventType"
                          ValueChanged="OnEventTypeFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="AuditEventType?" Value="null">All Events</MudSelectItem>
                    @foreach (AuditEventType eventType in Enum.GetValues(typeof(AuditEventType)))
                    {
                        <MudSelectItem T="AuditEventType?" Value="eventType">@GetEventTypeName(eventType)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string?"
                          Label="Actor (Who)"
                          Value="_filterActorUserId"
                          ValueChanged="OnActorFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string?" Value="null">All Actors</MudSelectItem>
                    @foreach (var user in _users)
                    {
                        <MudSelectItem T="string?" Value="@user.Id">@user.Email</MudSelectItem>
                    }
                    <MudSelectItem T="string?" Value="@("SYSTEM")">SYSTEM</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string?"
                          Label="Target User"
                          Value="_filterTargetUserId"
                          ValueChanged="OnTargetFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string?" Value="null">All Targets</MudSelectItem>
                    @foreach (var user in _users)
                    {
                        <MudSelectItem T="string?" Value="@user.Id">@user.Email</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Audit Log Table -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudTable T="AuditLogRecord"
                 @ref="_webAdminTable"
                 ServerData="@LoadWebAdminServerDataAsync"
                 Hover="true"
                 Breakpoint="Breakpoint.Sm"
                 Loading="@_loading"
                 LoadingProgressColor="Color.Info"
                 Dense="true">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Event Type</MudTh>
                <MudTh>Actor</MudTh>
                <MudTh>Target</MudTh>
                <MudTh>Details</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@FormatDate(context.Timestamp)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.Timestamp)</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Event Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetEventTypeColor(context.EventType)">
                        @GetEventTypeName(context.EventType)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actor">
                    @if (context.ActorWebUserId != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2">@GetUserEmail(context.ActorWebUserId)</MudText>
                        </MudStack>
                    }
                    else if (context.ActorSystemIdentifier != null)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Computer" Color="Color.Default">
                            @context.ActorSystemIdentifier.ToUpperInvariant()
                        </MudChip>
                    }
                    else if (context.ActorTelegramUserId.HasValue)
                    {
                        @if (_telegramUsersCache.TryGetValue(context.ActorTelegramUserId.Value, out var actorUser))
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                @if (!string.IsNullOrEmpty(actorUser.UserPhotoPath))
                                {
                                    <img src="@($"/media/{actorUser.UserPhotoPath}")" alt="@GetTelegramUserDisplayName(actorUser)" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;" />
                                }
                                else
                                {
                                    <MudAvatar Size="Size.Small" Color="Color.Info" Style="width: 24px; height: 24px;">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                    </MudAvatar>
                                }
                                <MudText Typo="Typo.body2">@GetTelegramUserDisplayName(actorUser)</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.SmartToy" Color="Color.Info">
                                User @context.ActorTelegramUserId
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Unknown</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Target">
                    @if (context.TargetWebUserId != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.PersonOutline" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2">@GetUserEmail(context.TargetWebUserId)</MudText>
                        </MudStack>
                    }
                    else if (context.TargetSystemIdentifier != null)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Computer" Color="Color.Default">
                            @context.TargetSystemIdentifier.ToUpperInvariant()
                        </MudChip>
                    }
                    else if (context.TargetTelegramUserId.HasValue)
                    {
                        @if (_telegramUsersCache.TryGetValue(context.TargetTelegramUserId.Value, out var targetUser))
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                @if (!string.IsNullOrEmpty(targetUser.UserPhotoPath))
                                {
                                    <img src="@($"/media/{targetUser.UserPhotoPath}")" alt="@GetTelegramUserDisplayName(targetUser)" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;" />
                                }
                                else
                                {
                                    <MudAvatar Size="Size.Small" Color="Color.Info" Style="width: 24px; height: 24px;">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                    </MudAvatar>
                                }
                                <MudText Typo="Typo.body2">@GetTelegramUserDisplayName(targetUser)</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.SmartToy" Color="Color.Info">
                                User @context.TargetTelegramUserId
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Details">
                    @if (!string.IsNullOrEmpty(context.Value))
                    {
                        <MudText Typo="Typo.body2" Style="font-family: monospace; font-size: 0.85em;">
                            @context.Value
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="[25, 50, 100]" />
            </PagerContent>
        </MudTable>
    </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Telegram Moderation Log" Icon="@Icons.Material.Filled.SmartToy">
            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                              Color="Color.Primary"
                              OnClick="@(async () => await _moderationTable.ReloadServerData())"
                              title="Refresh Moderation Log"
                              Size="Size.Medium" />
            </MudStack>

    @if (_loadingModerationActions)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="UserActionType?"
                          Label="Action Type"
                          Value="_filterActionType"
                          ValueChanged="OnActionTypeFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="UserActionType?" Value="null">All Actions</MudSelectItem>
                    @foreach (UserActionType actionType in Enum.GetValues(typeof(UserActionType)))
                    {
                        <MudSelectItem T="UserActionType?" Value="actionType">@GetActionTypeName(actionType)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField T="string"
                             Label="Telegram User ID"
                             Value="_filterTelegramUserId"
                             ValueChanged="OnTelegramUserIdFilterChanged"
                             Clearable="true"
                             Placeholder="Enter Telegram ID" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField T="string"
                             Label="Issued By"
                             Value="_filterIssuedBy"
                             ValueChanged="OnIssuedByFilterChanged"
                             Clearable="true"
                             Placeholder="e.g. system_bot_protection" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Moderation Log Table -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudTable T="UserActionRecord"
                 @ref="_moderationTable"
                 ServerData="@LoadModerationServerDataAsync"
                 Hover="true"
                 Breakpoint="Breakpoint.Sm"
                 Loading="@_loadingModerationActions"
                 LoadingProgressColor="Color.Info"
                 Dense="true">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Action Type</MudTh>
                <MudTh>Telegram User</MudTh>
                <MudTh>Issued By</MudTh>
                <MudTh>Reason</MudTh>
                <MudTh>Expires At</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@FormatDate(context.IssuedAt)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.IssuedAt)</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Action Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetActionTypeColor(context.ActionType)">
                        @GetActionTypeName(context.ActionType)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Telegram User">
                    @if (_telegramUsersCache.TryGetValue(context.UserId, out var telegramUser))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(telegramUser.UserPhotoPath))
                            {
                                <img src="@($"/media/{telegramUser.UserPhotoPath}")" alt="@GetTelegramUserDisplayName(telegramUser)" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                </MudAvatar>
                            }
                            <div>
                                <MudText Typo="Typo.body2">@GetTelegramUserDisplayName(telegramUser)</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-family: monospace;">ID: @context.UserId</MudText>
                            </div>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-family: monospace;">@context.UserId</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Issued By">
                    @if (context.IssuedBy.Type == ActorType.System)
                    {
                        @if (context.IssuedBy.SystemIdentifier == "bot_protection")
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Shield" Color="Color.Info">
                                Bot Protection
                            </MudChip>
                        }
                        else if (context.IssuedBy.SystemIdentifier?.Contains("auto") == true)
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.AutoMode" Color="Color.Secondary">
                                @context.IssuedBy.DisplayName
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Computer" Color="Color.Default">
                                @context.IssuedBy.DisplayName
                            </MudChip>
                        }
                    }
                    else if (context.IssuedBy.Type == ActorType.WebUser)
                    {
                        @* Try to show email if we have it cached *@
                        @if (context.IssuedBy.WebUserId != null && _userEmailCache.ContainsKey(context.IssuedBy.WebUserId))
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Person" Color="Color.Primary">
                                @_userEmailCache[context.IssuedBy.WebUserId]
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Person" Color="Color.Primary">
                                @context.IssuedBy.DisplayName
                            </MudChip>
                        }
                    }
                    else if (context.IssuedBy.Type == ActorType.TelegramUser)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.SmartToy" Color="Color.Info">
                            @context.IssuedBy.DisplayName
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Reason">
                    @if (!string.IsNullOrEmpty(context.Reason))
                    {
                        <MudText Typo="Typo.body2" Style="font-size: 0.85em;">@context.Reason</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Expires At">
                    @if (context.ExpiresAt.HasValue)
                    {
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@FormatDate(context.ExpiresAt.Value)</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.ExpiresAt.Value)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">Permanent</MudChip>
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="[25, 50, 100]" />
            </PagerContent>
        </MudTable>
    </MudPaper>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    // Tab navigation
    private int _activeTabIndex;

    // Web Admin Log
    private MudTable<AuditLogRecord> _webAdminTable = null!;
    private List<UserRecord> _users = [];
    private bool _loading;

    // Web Admin Filters
    private AuditEventType? _filterEventType;
    private string? _filterActorUserId;
    private string? _filterTargetUserId;

    // Telegram Moderation Log
    private MudTable<UserActionRecord> _moderationTable = null!;
    private bool _loadingModerationActions;

    // Moderation Filters
    private UserActionType? _filterActionType;
    private string? _filterTelegramUserId;
    private string? _filterIssuedBy;

    // User email cache (web admin users)
    private Dictionary<string, string> _userEmailCache = new();

    // Telegram users cache (for display names and photos)
    private readonly Dictionary<long, TelegramUser> _telegramUsersCache = new();

    protected override async Task OnInitializedAsync()
    {
        // Parse URL fragment to set initial tab
        var fragment = new Uri(Navigation.Uri).Fragment.TrimStart('#');
        _activeTabIndex = fragment switch
        {
            "web" => 0,
            "telegram" => 1,
            _ => 0
        };

        Navigation.LocationChanged += OnLocationChanged;

        // Load users for filter dropdowns
        try
        {
            _users = await UserRepository.GetAllIncludingDeletedAsync();
            _userEmailCache = _users.ToDictionary(u => u.Id, u => u.Email);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }

        // Tables will load data automatically via ServerData
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var fragment = new Uri(e.Location).Fragment.TrimStart('#');
        var newIndex = fragment switch
        {
            "web" => 0,
            "telegram" => 1,
            _ => -1
        };

        if (newIndex >= 0 && newIndex != _activeTabIndex)
        {
            _activeTabIndex = newIndex;
            StateHasChanged();
        }
    }

    private void OnTabChanged(int index)
    {
        _activeTabIndex = index;

        // Update URL fragment without reload
        var fragment = index switch
        {
            0 => "web",
            1 => "telegram",
            _ => "web"
        };

        Navigation.NavigateTo($"/audit#{fragment}", false);
    }

    private async Task<TableData<AuditLogRecord>> LoadWebAdminServerDataAsync(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var (events, totalCount) = await AuditService.GetPagedEventsAsync(
                skip: state.Page * state.PageSize,
                take: state.PageSize,
                eventTypeFilter: _filterEventType,
                actorUserIdFilter: _filterActorUserId,
                targetUserIdFilter: _filterTargetUserId,
                cancellationToken: cancellationToken);

            // Build Telegram users cache for this page (actors and targets)
            var telegramUserIds = events
                .SelectMany(e => new[] { e.ActorTelegramUserId, e.TargetTelegramUserId })
                .Where(id => id.HasValue)
                .Select(id => id!.Value)
                .Distinct()
                .ToList();

            foreach (var userId in telegramUserIds)
            {
                if (!_telegramUsersCache.ContainsKey(userId))
                {
                    var user = await TelegramUserRepository.GetByTelegramIdAsync(userId, cancellationToken);
                    if (user != null)
                    {
                        _telegramUsersCache[userId] = user;
                    }
                }
            }

            return new TableData<AuditLogRecord> { Items = events, TotalItems = totalCount };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading audit log: {ex.Message}", Severity.Error);
            return new TableData<AuditLogRecord> { Items = new List<AuditLogRecord>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task<TableData<UserActionRecord>> LoadModerationServerDataAsync(TableState state, CancellationToken cancellationToken)
    {
        _loadingModerationActions = true;
        StateHasChanged();

        try
        {
            // Parse filter for user ID
            long? userIdFilter = null;
            if (!string.IsNullOrEmpty(_filterTelegramUserId) && long.TryParse(_filterTelegramUserId, out var parsedUserId))
            {
                userIdFilter = parsedUserId;
            }

            var (actions, totalCount) = await UserActionsRepository.GetPagedActionsAsync(
                skip: state.Page * state.PageSize,
                take: state.PageSize,
                actionTypeFilter: _filterActionType,
                userIdFilter: userIdFilter,
                issuedByFilter: _filterIssuedBy,
                cancellationToken: cancellationToken);

            // Build Telegram users cache for this page
            var uniqueUserIds = actions.Select(a => a.UserId).Distinct().ToList();
            foreach (var userId in uniqueUserIds)
            {
                if (!_telegramUsersCache.ContainsKey(userId))
                {
                    var user = await TelegramUserRepository.GetByTelegramIdAsync(userId, cancellationToken);
                    if (user != null)
                    {
                        _telegramUsersCache[userId] = user;
                    }
                }
            }

            return new TableData<UserActionRecord> { Items = actions, TotalItems = totalCount };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading moderation log: {ex.Message}", Severity.Error);
            return new TableData<UserActionRecord> { Items = new List<UserActionRecord>(), TotalItems = 0 };
        }
        finally
        {
            _loadingModerationActions = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private async Task OnEventTypeFilterChanged(AuditEventType? value)
    {
        _filterEventType = value;
        await _webAdminTable.ReloadServerData();
    }

    private async Task OnActorFilterChanged(string? value)
    {
        _filterActorUserId = value;
        await _webAdminTable.ReloadServerData();
    }

    private async Task OnTargetFilterChanged(string? value)
    {
        _filterTargetUserId = value;
        await _webAdminTable.ReloadServerData();
    }

    private string GetUserEmail(string userId)
    {
        return _userEmailCache.TryGetValue(userId, out var email) ? email : $"Unknown ({userId})";
    }

    private static string GetEventTypeName(AuditEventType eventType) => eventType switch
    {
        // Data Operations
        AuditEventType.DataExported => "Data Export",
        AuditEventType.MessageExported => "Message Export",

        // System Events
        AuditEventType.SystemConfigChanged => "Config Changed",

        // User Authentication
        AuditEventType.UserEmailVerificationSent => "Email Verification Sent",
        AuditEventType.UserEmailVerified => "Email Verified",
        AuditEventType.UserLogin => "Login",
        AuditEventType.UserLoginFailed => "Login Failed",
        AuditEventType.UserLogout => "Logout",
        AuditEventType.UserPasswordReset => "Password Reset",
        AuditEventType.UserPasswordResetRequested => "Password Reset Requested",

        // User Invites
        AuditEventType.UserInviteCreated => "Invite Created",
        AuditEventType.UserInviteRevoked => "Invite Revoked",

        // User Lifecycle
        AuditEventType.UserDeleted => "User Deleted",
        AuditEventType.UserRegistered => "User Registered",
        AuditEventType.UserStatusChanged => "Status Changed",

        // User Profile Changes
        AuditEventType.UserEmailChanged => "Email Changed",
        AuditEventType.UserPasswordChanged => "Password Changed",
        AuditEventType.UserPermissionChanged => "Permission Changed",
        AuditEventType.UserTotpReset => "TOTP Reset",
        AuditEventType.UserTotpEnabled => "TOTP Enabled",

        _ => eventType.ToString()
    };

    private static Color GetEventTypeColor(AuditEventType eventType) => eventType switch
    {
        // Success/Positive events
        AuditEventType.UserRegistered => Color.Success,
        AuditEventType.UserLogin => Color.Success,
        AuditEventType.UserTotpEnabled => Color.Success,

        // Warning/Changes
        AuditEventType.UserPermissionChanged => Color.Warning,
        AuditEventType.UserStatusChanged => Color.Warning,
        AuditEventType.UserEmailChanged => Color.Warning,
        AuditEventType.UserPasswordChanged => Color.Warning,
        AuditEventType.UserTotpReset => Color.Warning,

        // Errors/Security events
        AuditEventType.UserLoginFailed => Color.Error,
        AuditEventType.UserDeleted => Color.Error,
        AuditEventType.UserInviteRevoked => Color.Error,

        // Neutral/Info events
        AuditEventType.UserInviteCreated => Color.Info,
        AuditEventType.UserLogout => Color.Default,
        AuditEventType.MessageExported => Color.Info,
        AuditEventType.DataExported => Color.Info,

        _ => Color.Default
    };

    private static string FormatDate(DateTimeOffset timestamp)
    {
        return timestamp.ToString("yyyy-MM-dd");
    }

    private static string FormatTime(DateTimeOffset timestamp)
    {
        return timestamp.ToString("HH:mm:ss");
    }

    // Moderation Log Filter Methods
    private async Task OnActionTypeFilterChanged(UserActionType? value)
    {
        _filterActionType = value;
        await _moderationTable.ReloadServerData();
    }

    private async Task OnTelegramUserIdFilterChanged(string? value)
    {
        _filterTelegramUserId = value;
        await _moderationTable.ReloadServerData();
    }

    private async Task OnIssuedByFilterChanged(string? value)
    {
        _filterIssuedBy = value;
        await _moderationTable.ReloadServerData();
    }

    // Action Type Helper Methods
    private static string GetActionTypeName(UserActionType actionType) => actionType switch
    {
        UserActionType.Ban => "Ban",
        UserActionType.Warn => "Warn",
        UserActionType.Mute => "Mute",
        UserActionType.Trust => "Trust",
        UserActionType.Unban => "Unban",
        _ => actionType.ToString()
    };

    private static Color GetActionTypeColor(UserActionType actionType) => actionType switch
    {
        UserActionType.Ban => Color.Error,
        UserActionType.Warn => Color.Warning,
        UserActionType.Mute => Color.Warning,
        UserActionType.Trust => Color.Success,
        UserActionType.Unban => Color.Info,
        _ => Color.Default
    };

    // Telegram User Display Helper
    private static string GetTelegramUserDisplayName(TelegramUser user)
    {
        return TelegramDisplayName.Format(
            user.FirstName,
            user.LastName,
            user.Username,
            user.TelegramUserId);
    }

    // Telegram User Display Helper by ID (with cache lookup)
    private string GetTelegramUserDisplayNameById(long telegramUserId)
    {
        if (_telegramUsersCache.TryGetValue(telegramUserId, out var user))
        {
            return GetTelegramUserDisplayName(user);
        }
        // Fallback to User {id} format if not in cache
        return $"User {telegramUserId}";
    }
}
