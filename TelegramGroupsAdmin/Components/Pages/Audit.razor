@page "/audit"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Telegram.Repositories
@using TelegramGroupsAdmin.Telegram.Models
@inject IAuditService AuditService
@inject UserRepository UserRepository
@inject IUserActionsRepository UserActionsRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Admin,Owner")]
@implements IDisposable

<PageTitle>Audit Log - TelegramGroupsAdmin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Audit Log</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" ActivePanelIndex="_activeTabIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="Web Admin Log" Icon="@Icons.Material.Filled.Security">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudChip T="string" Icon="@Icons.Material.Filled.Security" Color="Color.Primary">
                    @_events.Count events
                </MudChip>
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                              Color="Color.Primary"
                              OnClick="LoadWebAdminDataAsync"
                              title="Refresh Web Admin Log"
                              Size="Size.Medium" />
            </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="AuditEventType?"
                          Label="Event Type"
                          Value="_filterEventType"
                          ValueChanged="OnEventTypeFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="AuditEventType?" Value="null">All Events</MudSelectItem>
                    @foreach (AuditEventType eventType in Enum.GetValues(typeof(AuditEventType)))
                    {
                        <MudSelectItem T="AuditEventType?" Value="eventType">@GetEventTypeName(eventType)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string?"
                          Label="Actor (Who)"
                          Value="_filterActorUserId"
                          ValueChanged="OnActorFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string?" Value="null">All Actors</MudSelectItem>
                    @foreach (var user in _users)
                    {
                        <MudSelectItem T="string?" Value="@user.Id">@user.Email</MudSelectItem>
                    }
                    <MudSelectItem T="string?" Value="@("SYSTEM")">SYSTEM</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="string?"
                          Label="Target User"
                          Value="_filterTargetUserId"
                          ValueChanged="OnTargetFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string?" Value="null">All Targets</MudSelectItem>
                    @foreach (var user in _users)
                    {
                        <MudSelectItem T="string?" Value="@user.Id">@user.Email</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Audit Log Table -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudTable Items="@_filteredEvents"
                 Hover="true"
                 Breakpoint="Breakpoint.Sm"
                 Loading="@_loading"
                 LoadingProgressColor="Color.Info"
                 Dense="true">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Event Type</MudTh>
                <MudTh>Actor</MudTh>
                <MudTh>Target</MudTh>
                <MudTh>Details</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@FormatDate(context.Timestamp)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.Timestamp)</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Event Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetEventTypeColor(context.EventType)">
                        @GetEventTypeName(context.EventType)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actor">
                    @if (context.ActorUserId == null)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Computer" Color="Color.Default">
                            SYSTEM
                        </MudChip>
                    }
                    else
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@GetUserEmail(context.ActorUserId)</MudText>
                        </MudStack>
                    }
                </MudTd>
                <MudTd DataLabel="Target">
                    @if (!string.IsNullOrEmpty(context.TargetUserId))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.PersonOutline" Size="Size.Small" />
                            <MudText Typo="Typo.body2">@GetUserEmail(context.TargetUserId)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Details">
                    @if (!string.IsNullOrEmpty(context.Value))
                    {
                        <MudText Typo="Typo.body2" Style="font-family: monospace; font-size: 0.85em;">
                            @context.Value
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Telegram Moderation Log" Icon="@Icons.Material.Filled.SmartToy">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudChip T="string" Icon="@Icons.Material.Filled.Shield" Color="Color.Primary">
                    @_userActions.Count actions
                </MudChip>
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                              Color="Color.Primary"
                              OnClick="LoadModerationDataAsync"
                              title="Refresh Moderation Log"
                              Size="Size.Medium" />
            </MudStack>

    @if (_loadingModerationActions)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="UserActionType?"
                          Label="Action Type"
                          Value="_filterActionType"
                          ValueChanged="OnActionTypeFilterChanged"
                          Clearable="true"
                          AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="UserActionType?" Value="null">All Actions</MudSelectItem>
                    @foreach (UserActionType actionType in Enum.GetValues(typeof(UserActionType)))
                    {
                        <MudSelectItem T="UserActionType?" Value="actionType">@GetActionTypeName(actionType)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField T="string"
                             Label="Telegram User ID"
                             Value="_filterTelegramUserId"
                             ValueChanged="OnTelegramUserIdFilterChanged"
                             Clearable="true"
                             Placeholder="Enter Telegram ID" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField T="string"
                             Label="Issued By"
                             Value="_filterIssuedBy"
                             ValueChanged="OnIssuedByFilterChanged"
                             Clearable="true"
                             Placeholder="e.g. system_bot_protection" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Moderation Log Table -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudTable Items="@_filteredUserActions"
                 Hover="true"
                 Breakpoint="Breakpoint.Sm"
                 Loading="@_loadingModerationActions"
                 LoadingProgressColor="Color.Info"
                 Dense="true">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Action Type</MudTh>
                <MudTh>Telegram User ID</MudTh>
                <MudTh>Issued By</MudTh>
                <MudTh>Reason</MudTh>
                <MudTh>Expires At</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@FormatDate(context.IssuedAt)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.IssuedAt)</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Action Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetActionTypeColor(context.ActionType)">
                        @GetActionTypeName(context.ActionType)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Telegram User ID">
                    <MudText Typo="Typo.body2" Style="font-family: monospace;">@context.UserId</MudText>
                </MudTd>
                <MudTd DataLabel="Issued By">
                    @if (context.IssuedBy == "system_bot_protection")
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Shield" Color="Color.Info">
                            Bot Protection
                        </MudChip>
                    }
                    else if (context.IssuedBy != null && _userEmailCache.ContainsKey(context.IssuedBy))
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Person" Color="Color.Primary">
                            @_userEmailCache[context.IssuedBy]
                        </MudChip>
                    }
                    else if (context.IssuedBy == "Auto-Detection" || context.IssuedBy?.StartsWith("Auto-") == true)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.AutoMode" Color="Color.Secondary">
                            @context.IssuedBy
                        </MudChip>
                    }
                    else if (context.IssuedBy?.StartsWith("telegram:") == true)
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.SmartToy" Color="Color.Info">
                            @context.IssuedBy.Substring("telegram:".Length)
                        </MudChip>
                    }
                    else if (string.IsNullOrEmpty(context.IssuedBy) || context.IssuedBy == "Unknown")
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.QuestionMark" Color="Color.Default">
                            Unknown
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.AdminPanelSettings" Color="Color.Default">
                            @context.IssuedBy
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Reason">
                    @if (!string.IsNullOrEmpty(context.Reason))
                    {
                        <MudText Typo="Typo.body2" Style="font-size: 0.85em;">@context.Reason</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Expires At">
                    @if (context.ExpiresAt.HasValue)
                    {
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@FormatDate(context.ExpiresAt.Value)</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTime(context.ExpiresAt.Value)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">Permanent</MudChip>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    // Tab navigation
    private int _activeTabIndex = 0;

    // Web Admin Log
    private List<AuditLogRecord> _events = new();
    private List<AuditLogRecord> _filteredEvents = new();
    private List<UserRecord> _users = new();
    private bool _loading = true;

    // Web Admin Filters
    private AuditEventType? _filterEventType;
    private string? _filterActorUserId;
    private string? _filterTargetUserId;

    // Telegram Moderation Log
    private List<TelegramGroupsAdmin.Telegram.Models.UserActionRecord> _userActions = new();
    private List<TelegramGroupsAdmin.Telegram.Models.UserActionRecord> _filteredUserActions = new();
    private bool _loadingModerationActions = true;

    // Moderation Filters
    private UserActionType? _filterActionType;
    private string? _filterTelegramUserId;
    private string? _filterIssuedBy;

    // User email cache
    private Dictionary<string, string> _userEmailCache = new();

    protected override async Task OnInitializedAsync()
    {
        // Parse URL fragment to set initial tab
        var fragment = new Uri(Navigation.Uri).Fragment.TrimStart('#');
        _activeTabIndex = fragment switch
        {
            "web" => 0,
            "telegram" => 1,
            _ => 0
        };

        Navigation.LocationChanged += OnLocationChanged;

        // Load data for initial tab
        if (_activeTabIndex == 0)
        {
            await LoadWebAdminDataAsync();
        }
        else
        {
            await LoadModerationDataAsync();
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var fragment = new Uri(e.Location).Fragment.TrimStart('#');
        var newIndex = fragment switch
        {
            "web" => 0,
            "telegram" => 1,
            _ => -1
        };

        if (newIndex >= 0 && newIndex != _activeTabIndex)
        {
            _activeTabIndex = newIndex;
            StateHasChanged();
        }
    }

    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;

        // Update URL fragment without reload
        var fragment = index switch
        {
            0 => "web",
            1 => "telegram",
            _ => "web"
        };

        Navigation.NavigateTo($"/audit#{fragment}", false);

        // Load data if not already loaded
        if (index == 0 && _events.Count == 0)
        {
            await LoadWebAdminDataAsync();
        }
        else if (index == 1 && _userActions.Count == 0)
        {
            await LoadModerationDataAsync();
        }
    }

    private async Task LoadWebAdminDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Load both audit events and users for filtering/display
            // Use GetAllIncludingDeletedAsync to show emails for deleted users in audit log
            var eventsTask = AuditService.GetRecentEventsAsync(limit: 500);
            var usersTask = UserRepository.GetAllIncludingDeletedAsync();

            await Task.WhenAll(eventsTask, usersTask);

            _events = eventsTask.Result;
            _users = usersTask.Result;

            // Build email cache for fast lookups
            _userEmailCache = _users.ToDictionary(u => u.Id, u => u.Email);

            // Apply initial filters (no filters = show all)
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading audit log: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadModerationDataAsync()
    {
        _loadingModerationActions = true;
        StateHasChanged();

        try
        {
            // Load moderation actions (recent 500)
            _userActions = await UserActionsRepository.GetRecentAsync(limit: 500);

            // Load users for email cache (if not already loaded)
            if (_users.Count == 0)
            {
                _users = await UserRepository.GetAllIncludingDeletedAsync();
                _userEmailCache = _users.ToDictionary(u => u.Id, u => u.Email);
            }

            // Apply initial filters (no filters = show all)
            ApplyModerationFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading moderation log: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingModerationActions = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private void OnEventTypeFilterChanged(AuditEventType? value)
    {
        _filterEventType = value;
        ApplyFilters();
    }

    private void OnActorFilterChanged(string? value)
    {
        _filterActorUserId = value;
        ApplyFilters();
    }

    private void OnTargetFilterChanged(string? value)
    {
        _filterTargetUserId = value;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filtered = _events.AsEnumerable();

        if (_filterEventType.HasValue)
        {
            filtered = filtered.Where(e => e.EventType == _filterEventType.Value);
        }

        if (!string.IsNullOrEmpty(_filterActorUserId))
        {
            if (_filterActorUserId == "SYSTEM")
            {
                filtered = filtered.Where(e => e.ActorUserId == null);
            }
            else
            {
                filtered = filtered.Where(e => e.ActorUserId == _filterActorUserId);
            }
        }

        if (!string.IsNullOrEmpty(_filterTargetUserId))
        {
            filtered = filtered.Where(e => e.TargetUserId == _filterTargetUserId);
        }

        _filteredEvents = filtered.ToList();

        StateHasChanged();
    }

    private string GetUserEmail(string userId)
    {
        return _userEmailCache.TryGetValue(userId, out var email) ? email : $"Unknown ({userId})";
    }

    private static string GetEventTypeName(AuditEventType eventType) => eventType switch
    {
        // Data Operations
        AuditEventType.DataExported => "Data Export",
        AuditEventType.MessageExported => "Message Export",

        // System Events
        AuditEventType.SystemConfigChanged => "Config Changed",

        // User Authentication
        AuditEventType.UserEmailVerificationSent => "Email Verification Sent",
        AuditEventType.UserEmailVerified => "Email Verified",
        AuditEventType.UserLogin => "Login",
        AuditEventType.UserLoginFailed => "Login Failed",
        AuditEventType.UserLogout => "Logout",
        AuditEventType.UserPasswordReset => "Password Reset",
        AuditEventType.UserPasswordResetRequested => "Password Reset Requested",

        // User Invites
        AuditEventType.UserInviteCreated => "Invite Created",
        AuditEventType.UserInviteRevoked => "Invite Revoked",

        // User Lifecycle
        AuditEventType.UserDeleted => "User Deleted",
        AuditEventType.UserRegistered => "User Registered",
        AuditEventType.UserStatusChanged => "Status Changed",

        // User Profile Changes
        AuditEventType.UserEmailChanged => "Email Changed",
        AuditEventType.UserPasswordChanged => "Password Changed",
        AuditEventType.UserPermissionChanged => "Permission Changed",
        AuditEventType.UserTotpReset => "TOTP Reset",
        AuditEventType.UserTotpEnabled => "TOTP Enabled",

        _ => eventType.ToString()
    };

    private static Color GetEventTypeColor(AuditEventType eventType) => eventType switch
    {
        // Success/Positive events
        AuditEventType.UserRegistered => Color.Success,
        AuditEventType.UserLogin => Color.Success,
        AuditEventType.UserTotpEnabled => Color.Success,

        // Warning/Changes
        AuditEventType.UserPermissionChanged => Color.Warning,
        AuditEventType.UserStatusChanged => Color.Warning,
        AuditEventType.UserEmailChanged => Color.Warning,
        AuditEventType.UserPasswordChanged => Color.Warning,
        AuditEventType.UserTotpReset => Color.Warning,

        // Errors/Security events
        AuditEventType.UserLoginFailed => Color.Error,
        AuditEventType.UserDeleted => Color.Error,
        AuditEventType.UserInviteRevoked => Color.Error,

        // Neutral/Info events
        AuditEventType.UserInviteCreated => Color.Info,
        AuditEventType.UserLogout => Color.Default,
        AuditEventType.MessageExported => Color.Info,
        AuditEventType.DataExported => Color.Info,

        _ => Color.Default
    };

    private static string FormatDate(DateTimeOffset timestamp)
    {
        return timestamp.ToString("yyyy-MM-dd");
    }

    private static string FormatTime(DateTimeOffset timestamp)
    {
        return timestamp.ToString("HH:mm:ss");
    }

    // Moderation Log Filter Methods
    private void OnActionTypeFilterChanged(UserActionType? value)
    {
        _filterActionType = value;
        ApplyModerationFilters();
    }

    private void OnTelegramUserIdFilterChanged(string? value)
    {
        _filterTelegramUserId = value;
        ApplyModerationFilters();
    }

    private void OnIssuedByFilterChanged(string? value)
    {
        _filterIssuedBy = value;
        ApplyModerationFilters();
    }

    private void ApplyModerationFilters()
    {
        var filtered = _userActions.AsEnumerable();

        if (_filterActionType.HasValue)
        {
            filtered = filtered.Where(a => a.ActionType == _filterActionType.Value);
        }

        if (!string.IsNullOrEmpty(_filterTelegramUserId))
        {
            if (long.TryParse(_filterTelegramUserId, out var userId))
            {
                filtered = filtered.Where(a => a.UserId == userId);
            }
        }

        if (!string.IsNullOrEmpty(_filterIssuedBy))
        {
            filtered = filtered.Where(a => a.IssuedBy != null && a.IssuedBy.Contains(_filterIssuedBy, StringComparison.OrdinalIgnoreCase));
        }

        _filteredUserActions = filtered.ToList();
        StateHasChanged();
    }

    // Action Type Helper Methods
    private static string GetActionTypeName(UserActionType actionType) => actionType switch
    {
        UserActionType.Ban => "Ban",
        UserActionType.Warn => "Warn",
        UserActionType.Mute => "Mute",
        UserActionType.Trust => "Trust",
        UserActionType.Unban => "Unban",
        _ => actionType.ToString()
    };

    private static Color GetActionTypeColor(UserActionType actionType) => actionType switch
    {
        UserActionType.Ban => Color.Error,
        UserActionType.Warn => Color.Warning,
        UserActionType.Mute => Color.Warning,
        UserActionType.Trust => Color.Success,
        UserActionType.Unban => Color.Info,
        _ => Color.Default
    };
}
