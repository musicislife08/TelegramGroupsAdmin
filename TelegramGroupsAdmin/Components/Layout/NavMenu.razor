@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@inject AuthenticationStateProvider AuthStateProvider

<MudNavMenu>
    @if (_isAuthenticated)
    {
        <!-- Main Navigation (all authenticated users) -->
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Home</MudNavLink>
        <MudNavLink Href="/analytics" Icon="@Icons.Material.Filled.Insights">Analytics</MudNavLink>
        <MudNavLink Href="/messages" Icon="@Icons.Material.Filled.Message">Messages</MudNavLink>
        <MudNavLink Href="/tools" Icon="@Icons.Material.Filled.Build">Tools</MudNavLink>

        <!-- Admin+ can see Reports/Users (content is chat-scoped for Admin role) -->
        <MudNavLink Href="/reports" Icon="@Icons.Material.Filled.Flag">Reports</MudNavLink>
        <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">Users</MudNavLink>

        @if (_isGlobalAdminOrOwner)
        {
            <!-- GlobalAdmin/Owner only -->
            <MudNavLink Href="/chats" Icon="@Icons.Material.Filled.Forum">Chat Management</MudNavLink>
            <MudNavLink Href="/audit" Icon="@Icons.Material.Filled.Security">Audit Log</MudNavLink>
            <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
        }

        <!-- User Section (Bottom) -->
        <MudSpacer />
        <MudDivider Class="my-2" />
        <MudNavLink Href="/docs" Icon="@Icons.Material.Filled.MenuBook">Documentation</MudNavLink>
        <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.AccountCircle">Profile</MudNavLink>
        <MudNavLink OnClick="@LogoutAsync" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
    }
</MudNavMenu>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    private bool _isAuthenticated;
    private bool _isGlobalAdminOrOwner;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            var permissionClaim = user.FindFirst(CustomClaimTypes.PermissionLevel);
            if (permissionClaim != null && int.TryParse(permissionClaim.Value, out var level))
            {
                // Admin=0, GlobalAdmin=1, Owner=2
                // GlobalAdmin and Owner can see Settings, Audit, Chat Management
                _isGlobalAdminOrOwner = level >= 1;
            }
        }
    }

    private void LogoutAsync()
    {
        Navigation.NavigateTo("/logout", forceLoad: true);
    }
}

