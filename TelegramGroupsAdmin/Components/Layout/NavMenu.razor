@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@inject AuthenticationStateProvider AuthStateProvider

<MudNavMenu>
    @if (_isAuthenticated)
    {
        <!-- Main Navigation -->
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Home</MudNavLink>
        <MudNavLink Href="/analytics" Icon="@Icons.Material.Filled.Insights">Analytics</MudNavLink>
        <MudNavLink Href="/messages" Icon="@Icons.Material.Filled.Message">Messages</MudNavLink>

        @if (_isAdminOrOwner)
        {
            <MudNavLink Href="/spam" Icon="@Icons.Material.Filled.Shield">Spam Management</MudNavLink>
            <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">Users</MudNavLink>
            <MudNavLink Href="/audit" Icon="@Icons.Material.Filled.Security">Audit Log</MudNavLink>
            <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
        }

        <!-- User Section (Bottom) -->
        <MudSpacer />
        <MudDivider Class="my-2" />
        <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.AccountCircle">Profile</MudNavLink>
        <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
    }
</MudNavMenu>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private bool _isAuthenticated;
    private bool _isAdminOrOwner;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            var permissionClaim = user.FindFirst(CustomClaimTypes.PermissionLevel);
            if (permissionClaim != null && int.TryParse(permissionClaim.Value, out var level))
            {
                _isAdminOrOwner = level >= 1; // Admin=1, Owner=2
            }
        }
    }

    private void LogoutAsync()
    {
        Navigation.NavigateTo("/logout", forceLoad: true);
    }
}

