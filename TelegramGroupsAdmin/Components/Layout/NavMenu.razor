@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@inject AuthenticationStateProvider AuthStateProvider

<MudNavMenu>
    @if (_isAuthenticated)
    {
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
        <MudNavLink Href="/messages" Icon="@Icons.Material.Filled.Message">Messages</MudNavLink>

        @if (_isAdminOrOwner)
        {
            <MudNavLink Href="/audit" Icon="@Icons.Material.Filled.Security">Audit Log</MudNavLink>
            <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">Users</MudNavLink>

            <MudNavGroup Title="Spam Detection" Icon="@Icons.Material.Filled.Shield" Expanded="false">
                <MudNavLink Href="/spam/stopwords" Icon="@Icons.Material.Filled.Block">Stop Words</MudNavLink>
                <MudNavLink Href="/spam/training" Icon="@Icons.Material.Filled.School">Training Data</MudNavLink>
                <MudNavLink Href="/spam/config" Icon="@Icons.Material.Filled.Settings">Configuration</MudNavLink>
                <MudNavLink Href="/spam/analytics" Icon="@Icons.Material.Filled.Analytics">Analytics</MudNavLink>
            </MudNavGroup>
        }

        <MudDivider Class="my-2" />
        <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.AccountCircle">Profile</MudNavLink>
        <MudNavLink OnClick="LogoutAsync" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
    }
</MudNavMenu>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private bool _isAuthenticated;
    private bool _isAdminOrOwner;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            var permissionClaim = user.FindFirst(CustomClaimTypes.PermissionLevel);
            if (permissionClaim != null && int.TryParse(permissionClaim.Value, out var level))
            {
                _isAdminOrOwner = level >= 1; // Admin=1, Owner=2
            }
        }
    }

    private void LogoutAsync()
    {
        Navigation.NavigateTo("/logout", forceLoad: true);
    }
}

