@using TelegramGroupsAdmin.Data.Models
@using TelegramGroupsAdmin.ContentDetection.Models
@using TelegramGroupsAdmin.Telegram.Repositories
@using TelegramGroupsAdmin.Telegram.Models
@using TelegramGroupsAdmin.Core
@using TelegramGroupsAdmin.Core.Utilities
@using TelegramGroupsAdmin.Telegram.Constants

@inject ITelegramUserRepository TelegramUserRepository
@inject IMessageHistoryRepository MessageRepository
@inject IManagedChatsRepository ManagedChatsRepository

<MudCard Elevation="2" Class="mb-3" Style="@GetCardStyle()">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="@GetIconColor()" Size="Size.Small" />
                <MudText Typo="Typo.h6">Impersonation Alert</MudText>
                <MudSpacer />
                <MudChip T="string" Size="Size.Small" Color="@GetRiskColor()">
                    @Alert.RiskLevel.ToString()
                </MudChip>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    <span class="local-timestamp" data-utc="@Alert.DetectedAt.ToString("o")">@Alert.DetectedAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                </MudText>
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudStack Spacing="3">
            @* Score Summary *@
            <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Row="true" Spacing="4" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Score</MudText>
                        <MudText Typo="Typo.h5" Color="@GetScoreColor()"><b>@Alert.TotalScore/100</b></MudText>
                    </MudStack>
                    @if (Alert.NameMatch)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Check">
                            Name Match
                        </MudChip>
                    }
                    @if (Alert.PhotoMatch)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Check">
                            Photo @Alert.PhotoSimilarityScore?.ToString("P0")
                        </MudChip>
                    }
                </MudStack>
            </MudPaper>

            @* Side-by-side comparison *@
            <MudGrid Spacing="3">
                @* Suspected User *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2" Color="Color.Error"><b>Suspected Impersonator</b></MudText>

                            @if (Alert.SuspectedPhotoPath != null)
                            {
                                <MudImage Src="@GetPhotoUrl(Alert.SuspectedPhotoPath)"
                                          Alt="Suspected user photo"
                                          Elevation="2"
                                          Class="rounded-lg"
                                          Style="width: 100px; height: 100px; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                                </MudAvatar>
                            }

                            <MudText Typo="Typo.body1"><b>@Alert.SuspectedUser.DisplayName</b></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@(Alert.SuspectedUser.Username != null ? $"@{Alert.SuspectedUser.Username}" : "No username")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @Alert.SuspectedUser.Id</MudText>

                            <MudDivider Class="my-1" Style="width: 80%;" />

                            @* Suspected user context *@
                            @if (_suspectedUser != null)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    First seen: @DateTimeUtilities.FormatRelativeTimeVerbose(_suspectedUser.FirstSeenAt)
                                </MudText>
                            }
                            @if (_suspectedMessageCount == 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                                    No messages in chat
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @_suspectedMessageCount message(s) in chat
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Target Admin *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2" Color="Color.Success"><b>Target Being Copied</b></MudText>

                            @if (Alert.TargetPhotoPath != null)
                            {
                                <MudImage Src="@GetPhotoUrl(Alert.TargetPhotoPath)"
                                          Alt="Target admin photo"
                                          Elevation="2"
                                          Class="rounded-lg"
                                          Style="width: 100px; height: 100px; object-fit: cover;" />
                            }
                            else
                            {
                                <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                                </MudAvatar>
                            }

                            <MudText Typo="Typo.body1"><b>@Alert.TargetUser.DisplayName</b></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@(Alert.TargetUser.Username != null ? $"@{Alert.TargetUser.Username}" : "No username")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @Alert.TargetUser.Id</MudText>

                            <MudDivider Class="my-1" Style="width: 80%;" />

                            @* Target user context *@
                            @if (_targetUser != null)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    First seen: @DateTimeUtilities.FormatRelativeTimeVerbose(_targetUser.FirstSeenAt)
                                </MudText>
                            }
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                Admin
                            </MudChip>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @* Context section *@
            <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudText Typo="Typo.subtitle2" Class="mb-2"><b>Context</b></MudText>
                <MudStack Spacing="1">
                    @* Trust status *@
                    @if (_suspectedUser?.IsTrusted == true)
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.body2" Color="Color.Success">User is trusted</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Not trusted</MudText>
                        </MudStack>
                    }

                    @* Ban status *@
                    @if (_suspectedUser?.IsBanned == true)
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Color="Color.Error" />
                            <MudText Typo="Typo.body2" Color="Color.Error">User is banned</MudText>
                        </MudStack>
                    }

                    @* Other managed groups *@
                    @if (_otherManagedChats.Count > 0)
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.body2">
                                Member of: @string.Join(", ", _otherManagedChats.Take(3))@(_otherManagedChats.Count > 3 ? $" +{_otherManagedChats.Count - 3} more" : "")
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.GroupOff" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Not in other managed groups</MudText>
                        </MudStack>
                    }

                    @* Chat *@
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Color="Color.Secondary" />
                        <MudText Typo="Typo.body2">Chat: @Alert.Chat.DisplayName</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>

            @* Review info *@
            @if (Alert.ReviewedAt.HasValue)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <b>Reviewed:</b> @Alert.Verdict by @(Alert.ReviewedByEmail ?? Alert.ReviewedByUserId ?? "Unknown")
                    on <span class="local-timestamp" data-utc="@Alert.ReviewedAt.Value.ToString("o")">@Alert.ReviewedAt.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                </MudAlert>
            }
        </MudStack>
    </MudCardContent>
    <MudCardActions>
        @if (!Alert.ReviewedAt.HasValue)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.Block"
                       OnClick="@OnConfirm"
                       Disabled="@_actionInProgress">
                Confirm
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.Close"
                       OnClick="@OnDismiss"
                       Disabled="@_actionInProgress">
                Dismiss
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.VerifiedUser"
                       OnClick="@OnTrust"
                       Disabled="@_actionInProgress">
                Trust
            </MudButton>
        }
        else
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Verdict: <b>@Alert.Verdict</b>
            </MudText>
        }
    </MudCardActions>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public required ImpersonationAlertRecord Alert { get; set; }

    [Parameter]
    public EventCallback<(ImpersonationAlertRecord Alert, ImpersonationAction Action)> OnAction { get; set; }

    private bool _actionInProgress;
    private TelegramUser? _suspectedUser;
    private TelegramUser? _targetUser;
    private int _suspectedMessageCount;
    private List<string> _otherManagedChats = [];

    protected override async Task OnParametersSetAsync()
    {
        // Load user details
        _suspectedUser = await TelegramUserRepository.GetByTelegramIdAsync(Alert.SuspectedUser.Id);
        _targetUser = await TelegramUserRepository.GetByTelegramIdAsync(Alert.TargetUser.Id);

        // Get message count in this chat
        _suspectedMessageCount = await MessageRepository.GetMessageCountAsync(Alert.SuspectedUser.Id, Alert.Chat.Id);

        // Get other managed chats this user is in (excluding current chat)
        await LoadOtherManagedChatsAsync();
    }

    private async Task LoadOtherManagedChatsAsync()
    {
        try
        {
            var userMessages = await MessageRepository.GetUserMessagesAsync(Alert.SuspectedUser.Id);
            var distinctChatIds = userMessages
                .Select(m => m.ChatId)
                .Where(chatId => chatId != Alert.Chat.Id)
                .Distinct()
                .ToList();

            if (distinctChatIds.Count > 0)
            {
                var allManagedChats = await ManagedChatsRepository.GetActiveChatsAsync();
                _otherManagedChats = allManagedChats
                    .Where(c => distinctChatIds.Contains(c.Identity.Id))
                    .Select(c => c.Identity.ChatName ?? $"Chat {c.Identity.Id}")
                    .ToList();
            }
        }
        catch
        {
            // Non-critical - leave empty
            _otherManagedChats = [];
        }
    }

    private string GetCardStyle()
    {
        if (Alert.RiskLevel == ImpersonationRiskLevel.Critical)
        {
            return "border-left: 4px solid var(--mud-palette-error);";
        }
        return "";
    }

    private Color GetIconColor()
    {
        return Alert.RiskLevel == ImpersonationRiskLevel.Critical ? Color.Error : Color.Warning;
    }

    private Color GetRiskColor()
    {
        return Alert.RiskLevel switch
        {
            ImpersonationRiskLevel.Critical => Color.Error,
            ImpersonationRiskLevel.Medium => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetScoreColor()
    {
        return Alert.TotalScore >= 100 ? Color.Error :
               Alert.TotalScore >= 50 ? Color.Warning :
               Color.Default;
    }

    private string GetPhotoUrl(string photoPath)
    {
        var fileName = Path.GetFileName(photoPath);
        return $"/api/photos/{fileName}";
    }

    private async Task OnConfirm()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, ImpersonationAction.Confirm));
        _actionInProgress = false;
    }

    private async Task OnDismiss()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, ImpersonationAction.Dismiss));
        _actionInProgress = false;
    }

    private async Task OnTrust()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, ImpersonationAction.Trust));
        _actionInProgress = false;
    }
}
