@using TelegramGroupsAdmin.Data.Models
@using TelegramGroupsAdmin.ContentDetection.Models

<MudCard Elevation="2" Class="mb-3" Style="@GetCardStyle()">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="@GetIconColor()" Size="Size.Small" />
                <MudText Typo="Typo.h6">Impersonation Alert</MudText>
                <MudSpacer />
                @if (Alert.AutoBanned)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">AUTO-BANNED</MudChip>
                }
                <MudChip T="string" Size="Size.Small" Color="@GetRiskColor()">
                    @Alert.RiskLevel.ToString()
                </MudChip>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    <span class="local-timestamp" data-utc="@Alert.DetectedAt.ToString("o")">@Alert.DetectedAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                </MudText>
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudStack Spacing="3">
            @* Score Summary *@
            <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Row="true" Spacing="4" Justify="Justify.SpaceBetween">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Total Score</MudText>
                        <MudText Typo="Typo.h5" Color="@GetScoreColor()"><b>@Alert.TotalScore/100</b></MudText>
                    </MudStack>
                    @if (Alert.NameMatch)
                    {
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Name Match</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Check">
                                50 points
                            </MudChip>
                        </MudStack>
                    }
                    @if (Alert.PhotoMatch)
                    {
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Photo Match</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Check">
                                50 points (@Alert.PhotoSimilarityScore?.ToString("P0"))
                            </MudChip>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>

            @* Side-by-side comparison *@
            <MudGrid Spacing="3">
                @* Suspected User *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2" Color="Color.Error"><b>Suspected Impersonator</b></MudText>

                            @if (Alert.SuspectedPhotoPath != null)
                            {
                                <MudImage Src="@GetPhotoUrl(Alert.SuspectedPhotoPath)"
                                          Alt="Suspected user photo"
                                          Elevation="2"
                                          Class="rounded-lg"
                                          Style="width: 128px; height: 128px; object-fit: cover;" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person"
                                         Size="Size.Large"
                                         Style="width: 128px; height: 128px;" />
                            }

                            <MudText Typo="Typo.body1"><b>@GetDisplayName(Alert.SuspectedFirstName, Alert.SuspectedUserName)</b></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@(Alert.SuspectedUserName ?? "No username")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @Alert.SuspectedUserId</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Target Admin *@
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle2" Color="Color.Success"><b>Target Admin</b></MudText>

                            @if (Alert.TargetPhotoPath != null)
                            {
                                <MudImage Src="@GetPhotoUrl(Alert.TargetPhotoPath)"
                                          Alt="Target admin photo"
                                          Elevation="2"
                                          Class="rounded-lg"
                                          Style="width: 128px; height: 128px; object-fit: cover;" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person"
                                         Size="Size.Large"
                                         Style="width: 128px; height: 128px;" />
                            }

                            <MudText Typo="Typo.body1"><b>@GetDisplayName(Alert.TargetFirstName, Alert.TargetUserName)</b></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@(Alert.TargetUserName ?? "No username")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @Alert.TargetUserId</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @* Chat context *@
            @if (Alert.ChatName != null)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    <b>Chat:</b> @Alert.ChatName
                </MudText>
            }

            @* Review info *@
            @if (Alert.ReviewedAt.HasValue)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <b>Reviewed:</b> @Alert.Verdict by @(Alert.ReviewedByUserId ?? "Unknown") on <span class="local-timestamp" data-utc="@Alert.ReviewedAt.Value.ToString("o")">@Alert.ReviewedAt.Value.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                </MudAlert>
            }
        </MudStack>
    </MudCardContent>
    <MudCardActions>
        @if (!Alert.ReviewedAt.HasValue)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.Filled.Block"
                       OnClick="@OnConfirmBan"
                       Disabled="@_actionInProgress">
                Confirm Ban
            </MudButton>

            @if (Alert.AutoBanned)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="@OnUnban"
                           Disabled="@_actionInProgress">
                    Unban (False Positive)
                </MudButton>
            }

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.Close"
                       OnClick="@OnDismiss"
                       Disabled="@_actionInProgress">
                Dismiss
            </MudButton>
        }
        else
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Verdict: <b>@Alert.Verdict</b>
            </MudText>
        }
    </MudCardActions>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public required ImpersonationAlertRecord Alert { get; set; }

    [Parameter]
    public EventCallback<(ImpersonationAlertRecord Alert, string Action)> OnAction { get; set; }

    private bool _actionInProgress;

    private string GetCardStyle()
    {
        if (Alert.RiskLevel == ImpersonationRiskLevel.Critical)
        {
            return "border-left: 4px solid var(--mud-palette-error);";
        }
        return "";
    }

    private Color GetIconColor()
    {
        return Alert.RiskLevel == ImpersonationRiskLevel.Critical ? Color.Error : Color.Warning;
    }

    private Color GetRiskColor()
    {
        return Alert.RiskLevel switch
        {
            ImpersonationRiskLevel.Critical => Color.Error,
            ImpersonationRiskLevel.Medium => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetScoreColor()
    {
        return Alert.TotalScore >= 100 ? Color.Error :
               Alert.TotalScore >= 50 ? Color.Warning :
               Color.Default;
    }

    private string GetDisplayName(string? firstName, string? userName)
    {
        if (!string.IsNullOrWhiteSpace(firstName))
            return firstName;
        if (!string.IsNullOrWhiteSpace(userName))
            return userName;
        return "Unknown";
    }

    private string GetPhotoUrl(string photoPath)
    {
        // Convert absolute path to URL (served via /data endpoint or similar)
        // For now, assume photos are accessible via /api/photos/{filename}
        var fileName = Path.GetFileName(photoPath);
        return $"/api/photos/{fileName}";
    }

    private async Task OnConfirmBan()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, "confirm"));
        _actionInProgress = false;
    }

    private async Task OnUnban()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, "unban"));
        _actionInProgress = false;
    }

    private async Task OnDismiss()
    {
        _actionInProgress = true;
        await OnAction.InvokeAsync((Alert, "dismiss"));
        _actionInProgress = false;
    }
}
