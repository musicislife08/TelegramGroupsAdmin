@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.ContentDetection.Repositories
@using TelegramGroupsAdmin.Components.Shared.ContentDetection
@using TelegramGroupsAdmin.Components.Shared.Settings
@using TelegramGroupsAdmin.Configuration
@inject ISnackbar Snackbar
@inject IContentDetectionConfigRepository SpamConfigRepository
@inject IChatAdminsRepository ChatAdminsRepository
@inject ITelegramUserMappingRepository TelegramMappingsRepository
@inject IUserManagementService UserManagementService
@inject TelegramGroupsAdmin.Core.Services.IConfigService ConfigService
@inject TelegramGroupsAdmin.Configuration.Repositories.IConfigRepository ConfigRepository

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <!-- Health & Status Tab -->
            <MudTabPanel Text="Health & Status" Icon="@Icons.Material.Filled.HealthAndSafety">
                @if (_healthStatus == null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                    <MudStack Spacing="3">
                        <!-- Overall Status -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Overall Status</MudText>
                            <MudChip T="string" Color="@GetHealthColor(_healthStatus.Status)">@_healthStatus.Status.ToString()</MudChip>

                            @if (!_healthStatus.IsReachable)
                            {
                                <MudAlert Severity="Severity.Error" Class="mt-2">
                                    Bot cannot reach this chat. The bot may have been removed or the chat may be deleted.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Bot Status & Permissions -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Bot Permissions</MudText>
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>Bot Status:</strong></td>
                                        <td>@_healthStatus.BotStatus</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Is Admin:</strong></td>
                                        <td>@(_healthStatus.IsAdmin ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Delete Messages:</strong></td>
                                        <td>@(_healthStatus.CanDeleteMessages ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Ban Users:</strong></td>
                                        <td>@(_healthStatus.CanRestrictMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Promote Members:</strong></td>
                                        <td>@(_healthStatus.CanPromoteMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Invite Users:</strong></td>
                                        <td>@(_healthStatus.CanInviteUsers ? "Yes" : "No")</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>

                        <!-- Warnings -->
                        @if (_healthStatus.Warnings.Count > 0)
                        {
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" GutterBottom="true">Warnings</MudText>
                                @foreach (var warning in _healthStatus.Warnings)
                                {
                                    <MudAlert Severity="Severity.Warning" Class="mb-2">@warning</MudAlert>
                                }
                            </MudPaper>
                        }

                        <!-- Cached Invite Link -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Cached Invite Link</MudText>
                            @if (!string.IsNullOrEmpty(_cachedInviteLink))
                            {
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Used for "Return to Chat" buttons in DM notifications (welcome, tempban, etc.)
                                    </MudText>
                                    <MudTextField @bind-Value="_cachedInviteLink"
                                                  Label="Current Cached Link"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@Icons.Material.Filled.Link" />
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Warning"
                                               StartIcon="@Icons.Material.Filled.Refresh"
                                               OnClick="@ClearCachedInviteLink"
                                               Disabled="_clearingLink">
                                        @if (_clearingLink)
                                        {
                                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                            <span>Clearing...</span>
                                        }
                                        else
                                        {
                                            <span>Clear Cached Link</span>
                                        }
                                    </MudButton>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Clear this if admins regenerated the invite link in Telegram. The next health check will fetch and cache the fresh link.
                                    </MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info">
                                    No invite link cached yet. The next health check will fetch and cache it automatically.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Info message about automatic updates -->
                        <MudAlert Severity="Severity.Info">
                            Health status updates automatically on a schedule (configurable in Settings â†’ Background Jobs) and when bot permissions change.
                        </MudAlert>
                    </MudStack>
                }
            </MudTabPanel>

            <!-- Spam Detection Tab -->
            <MudTabPanel Text="Spam Detection" Icon="@Icons.Material.Filled.Shield">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomConfig" @bind-Value:after="OnConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has a custom configuration. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomConfig)
                    {
                        <!-- Reusable DetectionOverview component for per-chat configuration -->
                        <DetectionOverview Chat="@ChatInfo.Record.Identity" />
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global content detection configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Welcome System Tab -->
            <MudTabPanel Text="Welcome System" Icon="@Icons.Material.Filled.Handshake">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomWelcomeConfig" @bind-Value:after="OnWelcomeConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has a custom welcome configuration. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomWelcomeConfig)
                    {
                        <!-- Reusable WelcomeSystemConfig component for per-chat configuration -->
                        <WelcomeSystemConfig @ref="_welcomeConfigComponent" Chat="@ChatInfo.Record" OnSaved="OnWelcomeConfigSaved" />

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="@SaveWelcomeConfigAsync" Disabled="@_savingWelcomeConfig" FullWidth="true">
                            @if (_savingWelcomeConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global welcome system configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Service Message Deletion Tab -->
            <MudTabPanel Text="Service Messages" Icon="@Icons.Material.Filled.CleaningServices">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomServiceMsgConfig" @bind-Value:after="OnServiceMsgConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomServiceMsgConfig && ChatInfo.HasCustomServiceMsgConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has custom service message settings. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomServiceMsgConfig)
                    {
                        <!-- Reusable ServiceMessageDeletionSettings component for per-chat configuration -->
                        <ServiceMessageDeletionSettings @ref="_serviceMsgConfigComponent" Chat="@ChatInfo.Record.Identity" OnSaved="OnServiceMsgConfigSaved" />

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="@SaveServiceMsgConfigAsync" Disabled="@_savingServiceMsgConfig" FullWidth="true">
                            @if (_savingServiceMsgConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global service message deletion configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Ban Celebration Tab -->
            <MudTabPanel Text="Ban Celebration" Icon="@Icons.Material.Filled.Celebration">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomBanCelebrationConfig" @bind-Value:after="OnBanCelebrationConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomBanCelebrationConfig && ChatInfo.HasCustomBanCelebrationConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has custom ban celebration settings. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomBanCelebrationConfig)
                    {
                        <!-- Reusable BanCelebrationChatSettings component for per-chat configuration -->
                        <BanCelebrationChatSettings @ref="_banCelebrationConfigComponent" Chat="@ChatInfo.Record.Identity" OnSaved="OnBanCelebrationConfigSaved" />

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="@SaveBanCelebrationConfigAsync" Disabled="@_savingBanCelebrationConfig" FullWidth="true">
                            @if (_savingBanCelebrationConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global ban celebration configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Admins Tab -->
            <MudTabPanel Text="Admins" Icon="@Icons.Material.Filled.AdminPanelSettings">
                @if (_loadingAdmins)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (_admins == null || !_admins.Any())
                {
                    <MudAlert Severity="Severity.Info">No admin information available for this chat.</MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body1">
                            This chat has <strong>@_admins.Count admin(s)</strong> cached. Last refresh: <span class="local-timestamp" data-utc="@((ChatInfo.Record.LastSeenAt ?? DateTimeOffset.MinValue).ToString("o"))">@(ChatInfo.Record.LastSeenAt ?? DateTimeOffset.MinValue).ToLocalTime().ToString("MMM d, yyyy h:mm tt")</span>
                        </MudText>

                        <MudTable Items="@_admins" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Username</MudTh>
                                <MudTh>Telegram ID</MudTh>
                                <MudTh>Role</MudTh>
                                <MudTh>Web App User</MudTh>
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Username">
                                    @if (!string.IsNullOrEmpty(context.User.Username))
                                    {
                                        <text>@@@context.User.Username</text>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">No username</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Telegram ID">@context.User.Id</MudTd>
                                <MudTd DataLabel="Role">
                                    @if (context.IsCreator)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Creator</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small">Admin</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Web App User">
                                    @{
                                        var linkedEmail = _adminLinkages.GetValueOrDefault(context.User.Id);
                                        if (!string.IsNullOrEmpty(linkedEmail))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Color="Color.Success" />
                                                <MudText Typo="Typo.body2">@linkedEmail</MudText>
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Dark">Not linked</MudText>
                                        }
                                    }
                                </MudTd>
                                <MudTd DataLabel="Status">
                                    @if (context.IsActive)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudStack>
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public ManagedChatInfo ChatInfo { get; set; } = null!;

    private ChatHealthStatus? _healthStatus;

    // Spam Detection Config
    private bool _useCustomConfig;

    // Welcome System Config
    private bool _savingWelcomeConfig;
    private bool _useCustomWelcomeConfig;
    private WelcomeSystemConfig? _welcomeConfigComponent;

    // Service Message Deletion Config
    private bool _savingServiceMsgConfig;
    private bool _useCustomServiceMsgConfig;
    private ServiceMessageDeletionSettings? _serviceMsgConfigComponent;

    // Ban Celebration Config
    private bool _savingBanCelebrationConfig;
    private bool _useCustomBanCelebrationConfig;
    private BanCelebrationChatSettings? _banCelebrationConfigComponent;

    // Admins Tab
    private bool _loadingAdmins = true;
    private List<ChatAdmin>? _admins;
    private readonly Dictionary<long, string> _adminLinkages = new();

    // Invite Link
    private string? _cachedInviteLink;
    private bool _clearingLink;

    protected override async Task OnInitializedAsync()
    {
        _healthStatus = ChatInfo.HealthStatus;
        _useCustomConfig = ChatInfo.HasCustomSpamConfig;
        _useCustomWelcomeConfig = ChatInfo.HasCustomWelcomeConfig;
        _useCustomServiceMsgConfig = ChatInfo.HasCustomServiceMsgConfig;
        _useCustomBanCelebrationConfig = ChatInfo.HasCustomBanCelebrationConfig;
        await Task.WhenAll(LoadAdminsAsync(), LoadCachedInviteLinkAsync());
    }

    private async Task LoadAdminsAsync()
    {
        _loadingAdmins = true;
        try
        {
            _admins = await ChatAdminsRepository.GetChatAdminsAsync(ChatInfo.Record.Identity.Id);

            // Load linkage information for each admin
            _adminLinkages.Clear();
            foreach (var admin in _admins)
            {
                var userId = await TelegramMappingsRepository.GetUserIdByTelegramIdAsync(admin.User.Id);
                if (!string.IsNullOrEmpty(userId))
                {
                    var user = await UserManagementService.GetUserByIdAsync(userId);
                    if (user != null)
                    {
                        _adminLinkages[admin.User.Id] = user.Email;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load admins: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingAdmins = false;
        }
    }

    private async Task OnConfigModeChanged()
    {
        if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
        {
            // User switched from custom to global - delete custom config
            try
            {
                await SpamConfigRepository.DeleteChatConfigAsync(ChatInfo.Record.Identity.Id);
                ChatInfo.HasCustomSpamConfig = false;
                Snackbar.Add("Reverted to global spam detection configuration", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to revert to global config: {ex.Message}", Severity.Error);
            }
        }
        else if (_useCustomConfig && !ChatInfo.HasCustomSpamConfig)
        {
            // User switched to custom - mark as having custom config
            // DetectionOverview will handle creating it on first save
            ChatInfo.HasCustomSpamConfig = true;
        }
    }

    private async Task OnWelcomeConfigModeChanged()
    {
        if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveWelcomeConfigModeAsync();
        }
    }

    private async Task SaveWelcomeConfigAsync()
    {
        if (_welcomeConfigComponent != null)
        {
            _savingWelcomeConfig = true;
            try
            {
                await _welcomeConfigComponent.SaveConfiguration();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to save welcome config: {ex.Message}", Severity.Error);
            }
            finally
            {
                _savingWelcomeConfig = false;
            }
        }
    }

    private Task OnWelcomeConfigSaved()
    {
        // Config was saved by WelcomeSystemConfig component
        ChatInfo.HasCustomWelcomeConfig = true;
        return Task.CompletedTask;
    }

    private async Task SaveWelcomeConfigModeAsync()
    {
        _savingWelcomeConfig = true;
        try
        {
            if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
            {
                // Delete custom config (revert to global)
                await ConfigService.DeleteAsync(ConfigType.Welcome, ChatInfo.Record.Identity);
                ChatInfo.HasCustomWelcomeConfig = false;
                Snackbar.Add("Reverted to global welcome configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save welcome config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingWelcomeConfig = false;
        }
    }

    // Service Message Deletion Config Methods
    private async Task OnServiceMsgConfigModeChanged()
    {
        if (!_useCustomServiceMsgConfig && ChatInfo.HasCustomServiceMsgConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveServiceMsgConfigModeAsync();
        }
    }

    private async Task SaveServiceMsgConfigAsync()
    {
        if (_serviceMsgConfigComponent != null)
        {
            _savingServiceMsgConfig = true;
            try
            {
                await _serviceMsgConfigComponent.SaveConfiguration();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to save service message config: {ex.Message}", Severity.Error);
            }
            finally
            {
                _savingServiceMsgConfig = false;
            }
        }
    }

    private Task OnServiceMsgConfigSaved()
    {
        // Config was saved by ServiceMessageDeletionSettings component
        ChatInfo.HasCustomServiceMsgConfig = true;
        return Task.CompletedTask;
    }

    private async Task SaveServiceMsgConfigModeAsync()
    {
        _savingServiceMsgConfig = true;
        try
        {
            if (!_useCustomServiceMsgConfig && ChatInfo.HasCustomServiceMsgConfig)
            {
                // Delete custom config (revert to global)
                await ConfigService.DeleteAsync(ConfigType.ServiceMessageDeletion, ChatInfo.Record.Identity);
                ChatInfo.HasCustomServiceMsgConfig = false;
                Snackbar.Add("Reverted to global service message deletion configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save service message config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingServiceMsgConfig = false;
        }
    }

    // Ban Celebration Config Methods
    private async Task OnBanCelebrationConfigModeChanged()
    {
        if (!_useCustomBanCelebrationConfig && ChatInfo.HasCustomBanCelebrationConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveBanCelebrationConfigModeAsync();
        }
    }

    private async Task SaveBanCelebrationConfigAsync()
    {
        if (_banCelebrationConfigComponent != null)
        {
            _savingBanCelebrationConfig = true;
            try
            {
                await _banCelebrationConfigComponent.SaveConfiguration();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to save ban celebration config: {ex.Message}", Severity.Error);
            }
            finally
            {
                _savingBanCelebrationConfig = false;
            }
        }
    }

    private Task OnBanCelebrationConfigSaved()
    {
        // Config was saved by BanCelebrationChatSettings component
        ChatInfo.HasCustomBanCelebrationConfig = true;
        return Task.CompletedTask;
    }

    private async Task SaveBanCelebrationConfigModeAsync()
    {
        _savingBanCelebrationConfig = true;
        try
        {
            if (!_useCustomBanCelebrationConfig && ChatInfo.HasCustomBanCelebrationConfig)
            {
                // Delete custom config (revert to global)
                await ConfigService.DeleteAsync(ConfigType.BanCelebration, ChatInfo.Record.Identity);
                ChatInfo.HasCustomBanCelebrationConfig = false;
                Snackbar.Add("Reverted to global ban celebration configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save ban celebration config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingBanCelebrationConfig = false;
        }
    }

    private async Task LoadCachedInviteLinkAsync()
    {
        try
        {
            var config = await ConfigRepository.GetByChatIdAsync(ChatInfo.Record.Identity.Id);
            _cachedInviteLink = config?.InviteLink;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load cached invite link: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearCachedInviteLink()
    {
        _clearingLink = true;
        try
        {
            await ConfigRepository.ClearInviteLinkAsync(ChatInfo.Record.Identity.Id);
            _cachedInviteLink = null;
            Snackbar.Add(
                "Cleared cached invite link for this chat. The next health check will fetch a fresh link from Telegram.",
                Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to clear invite link: {ex.Message}", Severity.Error);
        }
        finally
        {
            _clearingLink = false;
        }
    }

    private Color GetHealthColor(ChatHealthStatusType status)
    {
        return status switch
        {
            ChatHealthStatusType.Healthy => Color.Success,
            ChatHealthStatusType.Warning => Color.Warning,
            ChatHealthStatusType.Error => Color.Error,
            _ => Color.Default
        };
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }
}
