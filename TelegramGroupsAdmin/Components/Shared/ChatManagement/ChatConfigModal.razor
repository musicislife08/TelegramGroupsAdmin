@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.ContentDetection.Repositories
@using TelegramGroupsAdmin.ContentDetection.Configuration
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using TelegramGroupsAdmin.Components.Shared
@using TelegramGroupsAdmin.Configuration
@using global::Telegram.Bot
@inject TelegramAdminBotService BotService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ISpamDetectionConfigRepository SpamConfigRepository
@inject IChatAdminsRepository ChatAdminsRepository
@inject ITelegramUserMappingRepository TelegramMappingsRepository
@inject IUserManagementService UserManagementService
@inject TelegramGroupsAdmin.Configuration.Services.IConfigService ConfigService
@inject TelegramGroupsAdmin.Configuration.Repositories.IConfigRepository ConfigRepository

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <!-- Health & Status Tab -->
            <MudTabPanel Text="Health & Status" Icon="@Icons.Material.Filled.HealthAndSafety">
                @if (_healthStatus == null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                    <MudStack Spacing="3">
                        <!-- Overall Status -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Overall Status</MudText>
                            <MudChip T="string" Color="@GetHealthColor(_healthStatus.Status)">@_healthStatus.Status</MudChip>

                            @if (!_healthStatus.IsReachable)
                            {
                                <MudAlert Severity="Severity.Error" Class="mt-2">
                                    Bot cannot reach this chat. The bot may have been removed or the chat may be deleted.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Bot Status & Permissions -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Bot Permissions</MudText>
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>Bot Status:</strong></td>
                                        <td>@_healthStatus.BotStatus</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Is Admin:</strong></td>
                                        <td>@(_healthStatus.IsAdmin ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Delete Messages:</strong></td>
                                        <td>@(_healthStatus.CanDeleteMessages ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Ban Users:</strong></td>
                                        <td>@(_healthStatus.CanRestrictMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Promote Members:</strong></td>
                                        <td>@(_healthStatus.CanPromoteMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Invite Users:</strong></td>
                                        <td>@(_healthStatus.CanInviteUsers ? "Yes" : "No")</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>

                        <!-- Warnings -->
                        @if (_healthStatus.Warnings.Count > 0)
                        {
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" GutterBottom="true">Warnings</MudText>
                                @foreach (var warning in _healthStatus.Warnings)
                                {
                                    <MudAlert Severity="Severity.Warning" Class="mb-2">@warning</MudAlert>
                                }
                            </MudPaper>
                        }

                        <!-- Cached Invite Link -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Cached Invite Link</MudText>
                            @if (!string.IsNullOrEmpty(_cachedInviteLink))
                            {
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Used for "Return to Chat" buttons in DM notifications (welcome, tempban, etc.)
                                    </MudText>
                                    <MudTextField @bind-Value="_cachedInviteLink"
                                                  Label="Current Cached Link"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Adornment="Adornment.End"
                                                  AdornmentIcon="@Icons.Material.Filled.Link" />
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Warning"
                                               StartIcon="@Icons.Material.Filled.Refresh"
                                               OnClick="ClearCachedInviteLink"
                                               Disabled="_clearingLink">
                                        @if (_clearingLink)
                                        {
                                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                            <span>Clearing...</span>
                                        }
                                        else
                                        {
                                            <span>Clear Cached Link</span>
                                        }
                                    </MudButton>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Clear this if admins regenerated the invite link in Telegram. The next health check (within 1 minute) will fetch and cache the fresh link.
                                    </MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info">
                                    No invite link cached yet. The health check will fetch and cache it within 1 minute.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Info message about automatic updates -->
                        <MudAlert Severity="Severity.Info">
                            Health status updates automatically every minute and when bot permissions change.
                        </MudAlert>
                    </MudStack>
                }
            </MudTabPanel>

            <!-- Spam Detection Tab -->
            <MudTabPanel Text="Spam Detection" Icon="@Icons.Material.Filled.Shield">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomConfig" @bind-Value:after="OnConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has a custom configuration. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomConfig)
                    {
                        <MudTabs Elevation="1" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                            <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
                                <ContentDetectionGeneral @ref="_generalComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="CAS" Icon="@Icons.Material.Filled.Security">
                                <ContentDetectionCAS @ref="_casComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="Stop Words" Icon="@Icons.Material.Filled.Block">
                                <ContentDetectionStopWords @ref="_stopWordsComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="Similarity" Icon="@Icons.Material.Filled.CompareArrows">
                                <ContentDetectionSimilarity @ref="_similarityComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="Bayes" Icon="@Icons.Material.Filled.Psychology">
                                <ContentDetectionBayes @ref="_bayesComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="Advanced" Icon="@Icons.Material.Filled.Tune">
                                <ContentDetectionAdvanced @ref="_advancedComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="External" Icon="@Icons.Material.Filled.CloudQueue">
                                <ContentDetectionExternal @ref="_externalComponent" ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                            <MudTabPanel Text="URL Filters" Icon="@Icons.Material.Filled.Link">
                                <UrlFiltersConfig ChatId="@ChatInfo.Chat.ChatId" />
                            </MudTabPanel>
                        </MudTabs>

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="SaveSpamConfigAsync" Disabled="@_savingSpamConfig" FullWidth="true" Class="mt-4">
                            @if (_savingSpamConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global content detection configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Welcome System Tab -->
            <MudTabPanel Text="Welcome System" Icon="@Icons.Material.Filled.Handshake">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomWelcomeConfig" @bind-Value:after="OnWelcomeConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has a custom welcome configuration. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomWelcomeConfig)
                    {
                        <!-- Reusable WelcomeSystemConfig component for per-chat configuration -->
                        <WelcomeSystemConfig @ref="_welcomeConfigComponent" ChatId="@ChatInfo.Chat.ChatId" OnSaved="OnWelcomeConfigSaved" />

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="SaveWelcomeConfigAsync" Disabled="@_savingWelcomeConfig" FullWidth="true">
                            @if (_savingWelcomeConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global welcome system configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Admins Tab -->
            <MudTabPanel Text="Admins" Icon="@Icons.Material.Filled.AdminPanelSettings">
                @if (_loadingAdmins)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (_admins == null || !_admins.Any())
                {
                    <MudAlert Severity="Severity.Info">No admin information available for this chat.</MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body1">
                            This chat has <strong>@_admins.Count admin(s)</strong> cached. Last refresh: @FormatTimestamp(ChatInfo.Chat.LastSeenAt ?? DateTimeOffset.MinValue)
                        </MudText>

                        <MudTable Items="@_admins" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Username</MudTh>
                                <MudTh>Telegram ID</MudTh>
                                <MudTh>Role</MudTh>
                                <MudTh>Web App User</MudTh>
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Username">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username</text>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">No username</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Telegram ID">@context.TelegramId</MudTd>
                                <MudTd DataLabel="Role">
                                    @if (context.IsCreator)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Creator</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small">Admin</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Web App User">
                                    @{
                                        var linkedEmail = _adminLinkages.GetValueOrDefault(context.TelegramId);
                                        if (!string.IsNullOrEmpty(linkedEmail))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Color="Color.Success" />
                                                <MudText Typo="Typo.body2">@linkedEmail</MudText>
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Dark">Not linked</MudText>
                                        }
                                    }
                                </MudTd>
                                <MudTd DataLabel="Status">
                                    @if (context.IsActive)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudStack>
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public ManagedChatInfo ChatInfo { get; set; } = null!;

    private ChatHealthStatus? _healthStatus;

    // Spam Detection Config
    private bool _useCustomConfig;
    private bool _savingSpamConfig;
    private ContentDetectionGeneral? _generalComponent;
    private ContentDetectionCAS? _casComponent;
    private ContentDetectionStopWords? _stopWordsComponent;
    private ContentDetectionSimilarity? _similarityComponent;
    private ContentDetectionBayes? _bayesComponent;
    private ContentDetectionAdvanced? _advancedComponent;
    private ContentDetectionExternal? _externalComponent;

    // Welcome System Config
    private bool _savingWelcomeConfig;
    private bool _useCustomWelcomeConfig;
    private WelcomeSystemConfig? _welcomeConfigComponent;

    // Admins Tab
    private bool _loadingAdmins = true;
    private List<ChatAdmin>? _admins;
    private Dictionary<long, string> _adminLinkages = new();

    // Invite Link
    private string? _cachedInviteLink;
    private bool _clearingLink;

    protected override async Task OnInitializedAsync()
    {
        _healthStatus = ChatInfo.HealthStatus;
        _useCustomConfig = ChatInfo.HasCustomSpamConfig;
        _useCustomWelcomeConfig = ChatInfo.HasCustomWelcomeConfig;
        await Task.WhenAll(LoadAdminsAsync(), LoadCachedInviteLinkAsync());
    }

    private async Task LoadAdminsAsync()
    {
        _loadingAdmins = true;
        try
        {
            _admins = await ChatAdminsRepository.GetChatAdminsAsync(ChatInfo.Chat.ChatId);

            // Load linkage information for each admin
            _adminLinkages.Clear();
            foreach (var admin in _admins)
            {
                var userId = await TelegramMappingsRepository.GetUserIdByTelegramIdAsync(admin.TelegramId);
                if (!string.IsNullOrEmpty(userId))
                {
                    var user = await UserManagementService.GetUserByIdAsync(userId);
                    if (user != null)
                    {
                        _adminLinkages[admin.TelegramId] = user.Email;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load admins: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingAdmins = false;
        }
    }

    private string FormatTimestamp(DateTimeOffset? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value == DateTimeOffset.MinValue) return "Never";
        return timestamp.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm");
    }

    private async Task OnConfigModeChanged()
    {
        if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveConfigAsync();
        }
    }



    private async Task SaveConfigAsync()
    {
        try
        {
            if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
            {
                // Delete custom config (revert to global)
                await SpamConfigRepository.DeleteChatConfigAsync(ChatInfo.Chat.ChatId);
                ChatInfo.HasCustomSpamConfig = false;
                Snackbar.Add("Reverted to global configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save config: {ex.Message}", Severity.Error);
        }
        finally
        {
        }
    }

    private async Task SaveSpamConfigAsync()
    {
        _savingSpamConfig = true;
        try
        {
            // Collect configs from all components
            var mergedConfig = new SpamDetectionConfig();

            if (_generalComponent != null)
            {
                var generalConfig = _generalComponent.GetConfig();
                // Copy top-level properties from General tab
                mergedConfig.FirstMessageOnly = generalConfig.FirstMessageOnly;
                mergedConfig.FirstMessagesCount = generalConfig.FirstMessagesCount;
                mergedConfig.MinMessageLength = generalConfig.MinMessageLength;
                mergedConfig.AutoBanThreshold = generalConfig.AutoBanThreshold;
                mergedConfig.ReviewQueueThreshold = generalConfig.ReviewQueueThreshold;
                mergedConfig.MaxConfidenceVetoThreshold = generalConfig.MaxConfidenceVetoThreshold;
                mergedConfig.TrainingMode = generalConfig.TrainingMode;
            }

            // Collect sub-configs from each component
            if (_casComponent != null)
            {
                mergedConfig.Cas = _casComponent.GetConfig().Cas;
            }

            if (_stopWordsComponent != null)
            {
                mergedConfig.StopWords = _stopWordsComponent.GetConfig().StopWords;
            }

            if (_similarityComponent != null)
            {
                mergedConfig.Similarity = _similarityComponent.GetConfig().Similarity;
            }

            if (_bayesComponent != null)
            {
                mergedConfig.Bayes = _bayesComponent.GetConfig().Bayes;
            }

            if (_advancedComponent != null)
            {
                var advancedConfig = _advancedComponent.GetConfig();
                mergedConfig.InvisibleChars = advancedConfig.InvisibleChars;
                mergedConfig.Translation = advancedConfig.Translation;
                mergedConfig.Spacing = advancedConfig.Spacing;
                mergedConfig.OpenAI = advancedConfig.OpenAI;
            }

            if (_externalComponent != null)
            {
                var externalConfig = _externalComponent.GetConfig();
                mergedConfig.UrlBlocklist = externalConfig.UrlBlocklist;
                mergedConfig.ThreatIntel = externalConfig.ThreatIntel;
                mergedConfig.SeoScraping = externalConfig.SeoScraping;
                mergedConfig.ImageSpam = externalConfig.ImageSpam;
            }

            // Save the merged configuration
            await SpamConfigRepository.UpdateChatConfigAsync(ChatInfo.Chat.ChatId, mergedConfig);
            ChatInfo.HasCustomSpamConfig = true;
            Snackbar.Add("Chat spam detection configuration saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save spam detection config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingSpamConfig = false;
        }
    }

    private async Task OnWelcomeConfigModeChanged()
    {
        if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveWelcomeConfigModeAsync();
        }
    }

    private async Task SaveWelcomeConfigAsync()
    {
        if (_welcomeConfigComponent != null)
        {
            _savingWelcomeConfig = true;
            await _welcomeConfigComponent.SaveConfiguration();
            _savingWelcomeConfig = false;
        }
    }

    private Task OnWelcomeConfigSaved()
    {
        // Config was saved by WelcomeSystemConfig component
        ChatInfo.HasCustomWelcomeConfig = true;
        return Task.CompletedTask;
    }

    private async Task SaveWelcomeConfigModeAsync()
    {
        _savingWelcomeConfig = true;
        try
        {
            if (!_useCustomWelcomeConfig && ChatInfo.HasCustomWelcomeConfig)
            {
                // Delete custom config (revert to global)
                await ConfigService.DeleteAsync(ConfigType.Welcome, ChatInfo.Chat.ChatId);
                ChatInfo.HasCustomWelcomeConfig = false;
                Snackbar.Add("Reverted to global welcome configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save welcome config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingWelcomeConfig = false;
        }
    }

    private async Task LoadCachedInviteLinkAsync()
    {
        try
        {
            var config = await ConfigRepository.GetByChatIdAsync(ChatInfo.Chat.ChatId);
            _cachedInviteLink = config?.InviteLink;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load cached invite link: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearCachedInviteLink()
    {
        _clearingLink = true;
        try
        {
            await ConfigRepository.ClearInviteLinkAsync(ChatInfo.Chat.ChatId);
            _cachedInviteLink = null;
            Snackbar.Add(
                "Cleared cached invite link for this chat. The next health check (within 1 minute) will fetch a fresh link from Telegram.",
                Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to clear invite link: {ex.Message}", Severity.Error);
        }
        finally
        {
            _clearingLink = false;
        }
    }

    private Color GetHealthColor(string status)
    {
        return status switch
        {
            "Healthy" => Color.Success,
            "Warning" => Color.Warning,
            "Error" => Color.Error,
            _ => Color.Default
        };
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }
}
