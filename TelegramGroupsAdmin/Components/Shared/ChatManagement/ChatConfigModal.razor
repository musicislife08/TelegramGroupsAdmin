@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.SpamDetection.Repositories
@using TelegramGroupsAdmin.SpamDetection.Configuration
@using TelegramGroupsAdmin.Components.Shared.SpamManagement
@using global::Telegram.Bot
@inject TelegramAdminBotService BotService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ISpamDetectionConfigRepository SpamConfigRepository
@inject IChatAdminsRepository ChatAdminsRepository
@inject ITelegramUserMappingRepository TelegramMappingsRepository
@inject IUserManagementService UserManagementService

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <!-- Health & Status Tab -->
            <MudTabPanel Text="Health & Status" Icon="@Icons.Material.Filled.HealthAndSafety">
                @if (_healthStatus == null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                    <MudStack Spacing="3">
                        <!-- Overall Status -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Overall Status</MudText>
                            <MudChip T="string" Color="@GetHealthColor(_healthStatus.Status)">@_healthStatus.Status</MudChip>

                            @if (!_healthStatus.IsReachable)
                            {
                                <MudAlert Severity="Severity.Error" Class="mt-2">
                                    Bot cannot reach this chat. The bot may have been removed or the chat may be deleted.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Bot Status & Permissions -->
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" GutterBottom="true">Bot Permissions</MudText>
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr>
                                        <td><strong>Bot Status:</strong></td>
                                        <td>@_healthStatus.BotStatus</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Is Admin:</strong></td>
                                        <td>@(_healthStatus.IsAdmin ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Delete Messages:</strong></td>
                                        <td>@(_healthStatus.CanDeleteMessages ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Ban Users:</strong></td>
                                        <td>@(_healthStatus.CanRestrictMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Promote Members:</strong></td>
                                        <td>@(_healthStatus.CanPromoteMembers ? "Yes" : "No")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Can Invite Users:</strong></td>
                                        <td>@(_healthStatus.CanInviteUsers ? "Yes" : "No")</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudPaper>

                        <!-- Warnings -->
                        @if (_healthStatus.Warnings.Count > 0)
                        {
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" GutterBottom="true">Warnings</MudText>
                                @foreach (var warning in _healthStatus.Warnings)
                                {
                                    <MudAlert Severity="Severity.Warning" Class="mb-2">@warning</MudAlert>
                                }
                            </MudPaper>
                        }

                        <!-- Info message about automatic updates -->
                        <MudAlert Severity="Severity.Info">
                            Health status updates automatically every minute and when bot permissions change.
                        </MudAlert>
                    </MudStack>
                }
            </MudTabPanel>

            <!-- Spam Detection Tab -->
            <MudTabPanel Text="Spam Detection" Icon="@Icons.Material.Filled.Shield">
                <MudStack Spacing="3">
                    <!-- Configuration Mode Selection -->
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Configuration Mode</MudText>
                        <MudRadioGroup @bind-Value="_useCustomConfig" @bind-Value:after="OnConfigModeChanged" T="bool">
                            <MudRadio Value="false" T="bool">Use Global Configuration</MudRadio>
                            <MudRadio Value="true" T="bool">Use Custom Configuration for this Chat</MudRadio>
                        </MudRadioGroup>

                        @if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                This chat currently has a custom configuration. Switching to global will delete the custom settings.
                            </MudAlert>
                        }
                    </MudPaper>

                    @if (_useCustomConfig)
                    {
                        <!-- Reusable SpamDetectionConfig component for per-chat configuration -->
                        <SpamDetectionConfig @ref="_spamConfigComponent" ChatId="@ChatInfo.Chat.ChatId" OnSaved="OnConfigSaved" />

                        <!-- Save Button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  OnClick="SaveSpamConfigAsync" Disabled="@_savingConfig" FullWidth="true">
                            @if (_savingConfig)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Saving...</MudText>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            This chat is using the global spam detection configuration.
                            To customize settings for this chat specifically, enable "Use Custom Configuration" above.
                        </MudAlert>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Admins Tab -->
            <MudTabPanel Text="Admins" Icon="@Icons.Material.Filled.AdminPanelSettings">
                @if (_loadingAdmins)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (_admins == null || !_admins.Any())
                {
                    <MudAlert Severity="Severity.Info">No admin information available for this chat.</MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body1">
                            This chat has <strong>@_admins.Count admin(s)</strong> cached. Last refresh: @FormatTimestamp(ChatInfo.Chat.LastSeenAt ?? DateTimeOffset.MinValue)
                        </MudText>

                        <MudTable Items="@_admins" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Username</MudTh>
                                <MudTh>Telegram ID</MudTh>
                                <MudTh>Role</MudTh>
                                <MudTh>Web App User</MudTh>
                                <MudTh>Status</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Username">
                                    @if (!string.IsNullOrEmpty(context.Username))
                                    {
                                        <text>@@@context.Username</text>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">No username</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Telegram ID">@context.TelegramId</MudTd>
                                <MudTd DataLabel="Role">
                                    @if (context.IsCreator)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Creator</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small">Admin</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Web App User">
                                    @{
                                        var linkedEmail = _adminLinkages.GetValueOrDefault(context.TelegramId);
                                        if (!string.IsNullOrEmpty(linkedEmail))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Color="Color.Success" />
                                                <MudText Typo="Typo.body2">@linkedEmail</MudText>
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Dark">Not linked</MudText>
                                        }
                                    }
                                </MudTd>
                                <MudTd DataLabel="Status">
                                    @if (context.IsActive)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudStack>
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public ManagedChatInfo ChatInfo { get; set; } = null!;

    private ChatHealthStatus? _healthStatus;

    // Spam Detection Config
    private bool _savingConfig;
    private bool _useCustomConfig;
    private SpamManagement.SpamDetectionConfig? _spamConfigComponent;

    // Admins Tab
    private bool _loadingAdmins = true;
    private List<ChatAdmin>? _admins;
    private Dictionary<long, string> _adminLinkages = new();

    protected override async Task OnInitializedAsync()
    {
        _healthStatus = ChatInfo.HealthStatus;
        _useCustomConfig = ChatInfo.HasCustomSpamConfig;
        await LoadAdminsAsync();
    }

    private async Task LoadAdminsAsync()
    {
        _loadingAdmins = true;
        try
        {
            _admins = await ChatAdminsRepository.GetChatAdminsAsync(ChatInfo.Chat.ChatId);

            // Load linkage information for each admin
            _adminLinkages.Clear();
            foreach (var admin in _admins)
            {
                var userId = await TelegramMappingsRepository.GetUserIdByTelegramIdAsync(admin.TelegramId);
                if (!string.IsNullOrEmpty(userId))
                {
                    var user = await UserManagementService.GetUserByIdAsync(userId);
                    if (user != null)
                    {
                        _adminLinkages[admin.TelegramId] = user.Email;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load admins: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingAdmins = false;
        }
    }

    private string FormatTimestamp(DateTimeOffset? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value == DateTimeOffset.MinValue) return "Never";
        return timestamp.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm");
    }

    private async Task OnConfigModeChanged()
    {
        if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
        {
            // User switched from custom to global - delete custom config
            await SaveConfigAsync();
        }
    }

    private async Task SaveSpamConfigAsync()
    {
        if (_spamConfigComponent != null)
        {
            _savingConfig = true;
            await _spamConfigComponent.SaveConfiguration();
            _savingConfig = false;
        }
    }

    private Task OnConfigSaved()
    {
        // Config was saved by SpamDetectionConfig component
        ChatInfo.HasCustomSpamConfig = true;
        return Task.CompletedTask;
    }

    private async Task SaveConfigAsync()
    {
        _savingConfig = true;
        try
        {
            var chatIdStr = ChatInfo.Chat.ChatId.ToString();

            if (!_useCustomConfig && ChatInfo.HasCustomSpamConfig)
            {
                // Delete custom config (revert to global)
                await SpamConfigRepository.DeleteChatConfigAsync(chatIdStr);
                ChatInfo.HasCustomSpamConfig = false;
                Snackbar.Add("Reverted to global configuration", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save config: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingConfig = false;
        }
    }

    private Color GetHealthColor(string status)
    {
        return status switch
        {
            "Healthy" => Color.Success,
            "Warning" => Color.Warning,
            "Error" => Color.Error,
            _ => Color.Default
        };
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }
}
