@using TelegramGroupsAdmin.Configuration
@using Microsoft.Extensions.Options
@inject IOptions<OpenAIOptions> OpenAiOptionsAccessor
@inject IOptions<SendGridOptions> SendGridOptionsAccessor
@inject IOptions<SpamDetectionOptions> SpamDetectionOptionsAccessor

<MudStack Spacing="4">
    <!-- OpenAI Integration -->
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div>
                <MudText Typo="Typo.h6">OpenAI Integration</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    GPT-4 for spam detection and content translation
                </MudText>
            </div>
            <MudChip Color="_openAiConfigured ? Color.Success : Color.Error" Size="Size.Small" T="string">
                @(_openAiConfigured ? "Configured" : "Not Configured")
            </MudChip>
        </MudStack>

        <MudStack Spacing="3">
            <MudTextField Value="@MaskApiKey(_openAiSettings.ApiKey)"
                         Label="API Key"
                         Variant="Variant.Outlined"
                         HelperText="OpenAI API key (from platform.openai.com)"
                         Disabled="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Key" />

            <MudTextField Value="_openAiSettings.Model"
                         Label="Model"
                         Variant="Variant.Outlined"
                         HelperText="GPT model to use (default: gpt-4o-mini)"
                         Disabled="true" />

            <MudNumericField Value="_openAiSettings.MaxTokens"
                           Label="Max Tokens"
                           Variant="Variant.Outlined"
                           Min="100"
                           Max="4000"
                           HelperText="Maximum tokens per request"
                           Disabled="true" />

            <MudAlert Severity="Severity.Info" Dense="true">
                OpenAI settings are configured via environment variables:
                OPENAI__APIKEY, OPENAI__MODEL, OPENAI__MAXTOKENS
            </MudAlert>
        </MudStack>
    </MudPaper>

    <!-- SendGrid Integration -->
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div>
                <MudText Typo="Typo.h6">SendGrid Email Service</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Email delivery for user verification and password resets
                </MudText>
            </div>
            <MudChip Color="_sendGridConfigured ? Color.Success : Color.Error" Size="Size.Small" T="string">
                @(_sendGridConfigured ? "Configured" : "Not Configured")
            </MudChip>
        </MudStack>

        <MudStack Spacing="3">
            <MudSwitch Value="_sendGridSettings.Enabled"
                      Label="Enable SendGrid"
                      Color="Color.Primary"
                      Disabled="true" />

            <MudTextField Value="@MaskApiKey(_sendGridSettings.ApiKey)"
                         Label="API Key"
                         Variant="Variant.Outlined"
                         HelperText="SendGrid API key (from app.sendgrid.com)"
                         Disabled="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Key" />

            <MudTextField Value="_sendGridSettings.FromAddress"
                         Label="From Email"
                         Variant="Variant.Outlined"
                         HelperText="Verified sender email address"
                         Disabled="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Email" />

            <MudTextField Value="_sendGridSettings.FromName"
                         Label="From Name"
                         Variant="Variant.Outlined"
                         HelperText="Display name for emails"
                         Disabled="true" />

            <MudAlert Severity="Severity.Info" Dense="true">
                SendGrid settings are configured via environment variables:
                SENDGRID__ENABLED, SENDGRID__APIKEY, SENDGRID__FROMEMAIL, SENDGRID__FROMNAME
            </MudAlert>
        </MudStack>
    </MudPaper>

    <!-- VirusTotal Integration -->
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div>
                <MudText Typo="Typo.h6">VirusTotal Integration</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    URL threat intelligence scanning (optional, disabled by default)
                </MudText>
            </div>
            <MudChip Color="_virusTotalConfigured ? Color.Success : Color.Warning" Size="Size.Small" T="string">
                @(_virusTotalConfigured ? "Configured" : "Optional")
            </MudChip>
        </MudStack>

        <MudStack Spacing="3">
            <MudTextField Value="@MaskApiKey(_virusTotalApiKey)"
                         Label="API Key"
                         Variant="Variant.Outlined"
                         HelperText="VirusTotal API key (from virustotal.com)"
                         Disabled="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Key" />

            <MudAlert Severity="Severity.Warning" Dense="true">
                VirusTotal is disabled by default (slow for URL checks, rate limited to 4 req/min).
                Enable in Spam Detection â†’ Threat Intel settings if needed.
            </MudAlert>

            <MudAlert Severity="Severity.Info" Dense="true">
                VirusTotal API key is configured via environment variable: VIRUSTOTAL__APIKEY
            </MudAlert>
        </MudStack>
    </MudPaper>

    <!-- Telegram Bot Integration -->
    <MudPaper Class="pa-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div>
                <MudText Typo="Typo.h6">Telegram Bot</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Core bot configuration for group management
                </MudText>
            </div>
            <MudChip Color="_telegramConfigured ? Color.Success : Color.Error" Size="Size.Small" T="string">
                @(_telegramConfigured ? "Configured" : "Not Configured")
            </MudChip>
        </MudStack>

        <MudStack Spacing="3">
            <MudTextField Value="@MaskApiKey(_telegramBotToken)"
                         Label="Bot Token"
                         Variant="Variant.Outlined"
                         HelperText="@_telegramBotHelperText"
                         Disabled="true"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Key" />

            <MudAlert Severity="Severity.Info" Dense="true">
                Telegram bot token is configured via environment variable: TELEGRAM__BOTTOKEN
            </MudAlert>

            <MudAlert Severity="Severity.Success" Dense="true">
                Configure welcome messages, auto-ban, and other bot behavior in the "Telegram Bot" tab.
            </MudAlert>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private OpenAIOptions _openAiSettings = new() { ApiKey = "" };
    private SendGridOptions _sendGridSettings = new();
    private string _virusTotalApiKey = string.Empty;
    private string _telegramBotToken = string.Empty;

    private bool _openAiConfigured;
    private bool _sendGridConfigured;
    private bool _virusTotalConfigured;
    private bool _telegramConfigured;
    private readonly string _telegramBotHelperText = "Telegram bot token (from @BotFather)";

    protected override void OnInitialized()
    {
        // Load OpenAI settings
        _openAiSettings = new OpenAIOptions
        {
            ApiKey = OpenAiOptionsAccessor.Value.ApiKey,
            Model = OpenAiOptionsAccessor.Value.Model,
            MaxTokens = OpenAiOptionsAccessor.Value.MaxTokens
        };
        _openAiConfigured = !string.IsNullOrWhiteSpace(_openAiSettings.ApiKey);

        // Load SendGrid settings
        _sendGridSettings = new SendGridOptions
        {
            Enabled = SendGridOptionsAccessor.Value.Enabled,
            ApiKey = SendGridOptionsAccessor.Value.ApiKey,
            FromAddress = SendGridOptionsAccessor.Value.FromAddress,
            FromName = SendGridOptionsAccessor.Value.FromName
        };
        _sendGridConfigured = !string.IsNullOrWhiteSpace(_sendGridSettings.ApiKey);

        // Load VirusTotal settings (from SpamDetectionOptions)
        _virusTotalApiKey = SpamDetectionOptionsAccessor.Value.ApiKey ?? string.Empty;
        _virusTotalConfigured = !string.IsNullOrWhiteSpace(_virusTotalApiKey);

        // Telegram bot token (we don't have TelegramOptions in DI, so we'll show placeholder)
        _telegramBotToken = "***configured***"; // Placeholder - actual token not exposed to UI
        _telegramConfigured = true; // Assume configured if app is running
    }

    private string MaskApiKey(string? apiKey)
    {
        if (string.IsNullOrWhiteSpace(apiKey))
            return "(not configured)";

        if (apiKey.Length <= 8)
            return new string('*', apiKey.Length);

        return $"{apiKey[..4]}{'*'.ToString().PadLeft(apiKey.Length - 8, '*')}{apiKey[^4..]}";
    }
}
