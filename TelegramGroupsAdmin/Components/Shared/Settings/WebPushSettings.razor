@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.Services
@inject ISystemConfigRepository ConfigRepository
@inject IAuditService AuditService
@inject BlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar

<MudGrid>
    <!-- Info Alert -->
    <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
            <MudText Typo="Typo.subtitle2"><strong>Web Push Notifications</strong></MudText>
            <MudText Typo="Typo.body2">
                Browser push notifications allow users to receive alerts even when the browser tab is closed.
                Requires HTTPS in production. VAPID keys are auto-generated on first startup.
            </MudText>
        </MudAlert>
    </MudItem>

    <!-- Main Configuration -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <div>
                        <MudText Typo="Typo.h6">Web Push Configuration</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            VAPID authentication for browser push notifications
                        </MudText>
                    </div>
                    <MudChip Color="@(_isConfigured ? Color.Success : Color.Warning)" Size="Size.Small" T="string">
                        @(_isConfigured ? "Configured" : "Keys Not Generated")
                    </MudChip>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- Enable/Disable Toggle -->
                <MudSwitch @bind-Value="_config.Enabled"
                          Label="Enable Browser Push Notifications"
                          Color="Color.Primary" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    When disabled, in-app bell notifications still work, but browser push is skipped.
                </MudText>

                <MudDivider Class="my-2" />

                <!-- Contact Email -->
                <MudTextField @bind-Value="_config.ContactEmail"
                             Label="Contact Email (VAPID Subject)"
                             Variant="Variant.Outlined"
                             HelperText="Email address for push service operators to contact. Falls back to primary Owner's email if not set."
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Email"
                             Placeholder="admin@example.com">
                </MudTextField>

                <MudAlert Severity="Severity.Info" Dense="true">
                    <strong>VAPID Subject:</strong> The Web Push specification requires identifying who operates the push service.
                    This email is sent to push providers (Google, Mozilla, etc.) in case they need to contact you about abuse.
                </MudAlert>

                <MudDivider Class="my-2" />

                <!-- VAPID Public Key (read-only) -->
                <MudStack Spacing="1">
                    <MudText Typo="Typo.subtitle2">VAPID Public Key</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Auto-generated on startup. Used by browsers to verify push messages. Not a secret.
                    </MudText>
                    <MudTextField Value="@_config.VapidPublicKey"
                                 Variant="Variant.Outlined"
                                 ReadOnly="true"
                                 FullWidth="true"
                                 Lines="2">
                    </MudTextField>
                </MudStack>

                @if (!_isConfigured)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        <strong>VAPID keys not yet generated.</strong> They will be auto-generated on next application startup.
                        If this persists, check the application logs for errors.
                    </MudAlert>
                }

                <MudDivider Class="my-2" />

                <!-- Save Button -->
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              OnClick="@SaveConfigAsync"
                              Disabled="@_isSaving"
                              StartIcon="@Icons.Material.Filled.Save">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <text>&nbsp;Saving...</text>
                        }
                        else
                        {
                            <text>Save Settings</text>
                        }
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Secondary"
                              OnClick="@LoadConfig"
                              Disabled="@_isSaving"
                              StartIcon="@Icons.Material.Filled.Refresh">
                        Reset
                    </MudButton>
                </MudStack>

                <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Info">
                    Changes to Enabled/Contact Email apply immediately. VAPID keys cannot be changed
                    (regenerating would invalidate all existing browser subscriptions).
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- How It Works -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">How Web Push Works</MudText>

                <MudTimeline>
                    <MudTimelineItem Color="Color.Primary" Size="Size.Medium">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2">1. User Subscribes</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                User clicks "Enable notifications" in their profile. Browser prompts for permission.
                            </MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Primary" Size="Size.Medium">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2">2. Subscription Created</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Browser creates a push subscription with a unique endpoint. This is stored in the database.
                            </MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Primary" Size="Size.Medium">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2">3. Event Occurs</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Something happens (spam detected, report resolved, etc.) that the user subscribed to.
                            </MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Success" Size="Size.Medium">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2">4. Push Sent</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Server signs the message with VAPID private key and sends to push service (FCM/Mozilla).
                                Browser receives and displays the notification.
                            </MudText>
                        </ItemContent>
                    </MudTimelineItem>
                </MudTimeline>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private WebPushConfig _config = new();
    private bool _isSaving;
    private bool _isConfigured;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
        await CheckConfiguration();
    }

    private async Task LoadConfig()
    {
        try
        {
            var config = await ConfigRepository.GetWebPushConfigAsync();
            _config = config ?? new WebPushConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new WebPushConfig();
        }
    }

    private async Task CheckConfiguration()
    {
        try
        {
            _isConfigured = await ConfigRepository.HasVapidKeysAsync();
        }
        catch
        {
            _isConfigured = false;
        }
    }

    private async Task SaveConfigAsync()
    {
        _isSaving = true;
        try
        {
            // Save Web Push configuration
            await ConfigRepository.SaveWebPushConfigAsync(_config);

            // Create audit log entry
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(userId))
            {
                await AuditService.LogEventAsync(
                    AuditEventType.ConfigurationChanged,
                    Actor.FromWebUser(userId),
                    Actor.FromWebUser(userId),
                    $"webpush:enabled={_config.Enabled}:contact={_config.ContactEmail ?? "(fallback to owner)"}");
            }

            Snackbar.Add("Web Push settings saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }
}
