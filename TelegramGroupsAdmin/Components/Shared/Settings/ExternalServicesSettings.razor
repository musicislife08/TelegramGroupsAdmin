@using TelegramGroupsAdmin.Services
@inject IFeatureAvailabilityService FeatureService
@inject NavigationManager Navigation

<MudStack Spacing="4">
    <!-- Overview Alert -->
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
        <MudText Typo="Typo.subtitle2"><strong>External Services Integration</strong></MudText>
        <MudText Typo="Typo.body2">
            Configure third-party service integrations for enhanced functionality. All settings support hot-reload (no restart required).
            Click on each service card below to manage detailed configuration.
        </MudText>
    </MudAlert>

    <!-- OpenAI Integration -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div style="flex: 1;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Primary" Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h6">OpenAI Integration</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            GPT-4 for spam detection, translation, and image analysis
                        </MudText>
                    </div>
                </MudStack>
            </div>
            <MudStack AlignItems="AlignItems.End" Spacing="2">
                <MudChip Color="@(_openAIConfigured ? Color.Success : Color.Error)" Size="Size.Small" T="string">
                    @(_openAIConfigured ? "Configured" : "Not Configured")
                </MudChip>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          Size="Size.Small"
                          StartIcon="@Icons.Material.Filled.Settings"
                          Href="/settings/openai">
                    Configure
                </MudButton>
            </MudStack>
        </MudStack>

        <MudDivider Class="my-2" />

        <MudText Typo="Typo.subtitle2" Class="mb-2">Powered Features:</MudText>
        <MudStack Row="true" Spacing="1">
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Shield">Custom Spam Detection</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Translate">Translation Service</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Image">Image Spam Detection</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.VideoLibrary">Video Spam Detection</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Gavel">OpenAI Veto Mode</MudChip>
        </MudStack>

        @if (!_openAIConfigured)
        {
            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3">
                OpenAI features are unavailable. Click "Configure" to add your API key.
            </MudAlert>
        }
    </MudPaper>

    <!-- SendGrid Email Service -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div style="flex: 1;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Primary" Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h6">SendGrid Email Service</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Email delivery for authentication and notifications
                        </MudText>
                    </div>
                </MudStack>
            </div>
            <MudStack AlignItems="AlignItems.End" Spacing="2">
                <MudChip Color="@(_emailConfigured ? Color.Success : Color.Error)" Size="Size.Small" T="string">
                    @(_emailConfigured ? "Configured" : "Not Configured")
                </MudChip>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          Size="Size.Small"
                          StartIcon="@Icons.Material.Filled.Settings"
                          Href="/settings/sendgrid">
                    Configure
                </MudButton>
            </MudStack>
        </MudStack>

        <MudDivider Class="my-2" />

        <MudText Typo="Typo.subtitle2" Class="mb-2">Powered Features:</MudText>
        <MudStack Row="true" Spacing="1">
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.LockReset">Password Reset</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.VerifiedUser">Email Verification</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Mail">Welcome Emails</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.PersonAdd">User Invitations</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Notifications">Account Notifications</MudChip>
        </MudStack>

        @if (!_emailConfigured)
        {
            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3">
                Email features are unavailable. Password reset and email verification are disabled.
            </MudAlert>
        }
    </MudPaper>

    <!-- VirusTotal Integration -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div style="flex: 1;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h6">VirusTotal Integration</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Cloud file scanning with 70+ antivirus engines (optional)
                        </MudText>
                    </div>
                </MudStack>
            </div>
            <MudStack AlignItems="AlignItems.End" Spacing="2">
                <MudChip Color="@(_virusTotalConfigured ? Color.Success : Color.Warning)" Size="Size.Small" T="string">
                    @(_virusTotalConfigured ? "Configured" : "Optional")
                </MudChip>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          Size="Size.Small"
                          StartIcon="@Icons.Material.Filled.Settings"
                          Href="/settings/file-scanning">
                    Configure
                </MudButton>
            </MudStack>
        </MudStack>

        <MudDivider Class="my-2" />

        <MudText Typo="Typo.subtitle2" Class="mb-2">Powered Features:</MudText>
        <MudStack Row="true" Spacing="1">
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.CloudQueue">Cloud File Scanning</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.BugReport">Multi-Engine Detection</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.Link">URL Threat Intelligence</MudChip>
        </MudStack>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
            VirusTotal is optional. ClamAV (always-on local scanner) provides primary malware protection.
            VirusTotal adds cloud-based fallback with 70+ engines when ClamAV finds nothing.
        </MudAlert>
    </MudPaper>

    <!-- Telegram Bot -->
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <div style="flex: 1;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Primary" Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h6">Telegram Bot</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Core bot configuration for group management
                        </MudText>
                    </div>
                </MudStack>
            </div>
            <MudStack AlignItems="AlignItems.End" Spacing="2">
                <MudChip Color="Color.Success" Size="Size.Small" T="string">
                    Configured
                </MudChip>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          Size="Size.Small"
                          StartIcon="@Icons.Material.Filled.Settings"
                          Href="/settings/telegram">
                    Configure
                </MudButton>
            </MudStack>
        </MudStack>

        <MudDivider Class="my-2" />

        <MudAlert Severity="Severity.Success" Dense="true">
            Telegram bot is running. Token configured via database (migrated from environment variable on first startup).
            Configure bot behavior, dual-mode settings, and permissions in Telegram â†’ Bot Configuration.
        </MudAlert>
    </MudPaper>

    <!-- Hot-Reload Info -->
    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
        <MudText Typo="Typo.subtitle2"><strong>Hot-Reload Configuration</strong></MudText>
        <MudText Typo="Typo.body2" Class="mt-2">
            All service configurations support hot-reload - changes take effect immediately without restarting the application.
            Settings are stored in the database and loaded on-demand by each service.
        </MudText>
    </MudAlert>
</MudStack>

@code {
    private bool _openAIConfigured;
    private bool _emailConfigured;
    private bool _virusTotalConfigured;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeatureStatus();
    }

    private async Task LoadFeatureStatus()
    {
        try
        {
            _openAIConfigured = await FeatureService.IsOpenAIConfiguredAsync();
            _emailConfigured = await FeatureService.IsEmailConfiguredAsync();
            _virusTotalConfigured = await FeatureService.IsVirusTotalConfiguredAsync();
        }
        catch (Exception)
        {
            // Graceful degradation - if feature check fails, assume not configured
            _openAIConfigured = false;
            _emailConfigured = false;
            _virusTotalConfigured = false;
        }
    }
}
