@using TelegramGroupsAdmin.BackgroundJobs.Services
@using TelegramGroupsAdmin.Telegram.Services.Media
@using TelegramGroupsAdmin.Core.BackgroundJobs
@using TelegramGroupsAdmin.Core.Utilities
@using TelegramGroupsAdmin.Telegram.Abstractions
@using TelegramGroupsAdmin.Telegram.Abstractions.Jobs
@using System.Text.Json
@using Microsoft.JSInterop
@using TimeZoneConverter
@inject IBackgroundJobConfigService JobConfigService
@inject IMediaRefetchQueueService QueueService
@inject IJobTriggerService JobTriggerService
@inject ISnackbar Snackbar
@inject ILogger<BackgroundJobs> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@implements IDisposable

<MudStack Spacing="4">
    <!-- Media Refetch Queue Status -->
    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.CloudDownload" />
            <MudText>
                <strong>Media Refetch Queue:</strong> @_queueDepth @(_queueDepth == 1 ? "file" : "files") queued for download
            </MudText>
        </MudStack>
    </MudAlert>

    <!-- Background Jobs Table -->
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-2" />
            Background Jobs
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
            Configure and monitor scheduled background tasks
        </MudText>

        @if (_jobs == null)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else
        {
            <MudTable Items="@_jobs.Values.OrderBy(j => j.DisplayName)" Elevation="0" Dense="true">
                <HeaderContent>
                    <MudTh>Job</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Schedule</MudTh>
                    <MudTh>Last Run</MudTh>
                    <MudTh>Next Run</MudTh>
                    <MudTh Style="text-align: right">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Job">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2"><strong>@context.DisplayName</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@(context.Enabled ? Color.Success : Color.Default)">
                            @(context.Enabled ? "Enabled" : "Disabled")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Schedule">
                        <!-- TODO: Reimplement schedule display with friendly format → cron conversion -->
                        <MudText Typo="Typo.caption">@FormatCronSchedule(context.CronExpression)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Last Run">
                        @if (context.LastRunAt.HasValue)
                        {
                            <MudText Typo="Typo.caption">@context.LastRunAt.Value.ToLocalTime().ToString("MMM d, h:mm tt")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Never</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Next Run">
                        @if (context.NextRunAt.HasValue && context.Enabled)
                        {
                            <MudText Typo="Typo.caption">@context.NextRunAt.Value.ToLocalTime().ToString("MMM d, h:mm tt")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">—</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: right">
                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                            <MudSwitch T="bool"
                                      Value="@context.Enabled"
                                      ValueChanged="@(async (bool enabled) => await ToggleJobAsync(context.JobName, enabled))"
                                      Color="Color.Success"
                                      Size="Size.Small" />
                            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                          Size="Size.Small"
                                          OnClick="@(() => OpenConfigDialog(context))"
                                          title="Configure" />
                            <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                          Size="Size.Small"
                                          Color="Color.Primary"
                                          Disabled="@(!context.Enabled || context.JobName == BackgroundJobNames.MessageCleanup)"
                                          OnClick="@(() => RunNowAsync(context.JobName))"
                                          title="@(context.JobName == BackgroundJobNames.MessageCleanup ? "Background Service (always running)" : "Run Now")" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
            </MudTable>

            @if (_jobs.Values.Any(j => !string.IsNullOrEmpty(j.LastError)))
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4" Dense="true">
                    <MudText Typo="Typo.body2">One or more jobs have errors. Check the logging page for details.</MudText>
                </MudAlert>
            }
        }
    </MudPaper>
</MudStack>

<!-- Configuration Dialog -->
<MudDialog @bind-Visible="_showConfigDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Configure @_editingJob?.DisplayName</MudText>
    </TitleContent>
    <DialogContent>
        @if (_editingJob != null)
        {
            <MudStack Spacing="3">
                <MudText Typo="Typo.body2" Color="Color.Secondary">@_editingJob.Description</MudText>

                <!-- Schedule Configuration -->
                <MudTextField @bind-Value="_editScheduleInterval"
                             Label="Interval"
                             Variant="Variant.Outlined"
                             HelperText="Examples: 30m, 1h, 6h, 1d, 1w (minutes/hours/days/weeks)"
                             Immediate="true" />

                <MudTextField Value="@GetCronPreview()"
                             Label="Cron Expression (UTC)"
                             Variant="Variant.Outlined"
                             ReadOnly="true"
                             HelperText="Generated cron expression (in UTC)" />

                <!-- Job-Specific Settings -->
                @if (_editingJob.JobName == BackgroundJobNames.ScheduledBackup)
                {
                    <MudDivider />
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <strong>Note:</strong> Backup retention and directory settings are configured in <strong>Settings → System → Backup Configuration</strong>
                    </MudAlert>
                }
                else if (_editingJob.JobName == BackgroundJobNames.DatabaseMaintenance)
                {
                    <MudDivider />
                    <MudText Typo="Typo.subtitle2">Maintenance Settings</MudText>

                    <MudCheckBox @bind-Value="_editRunVacuum" Color="Color.Primary" Dense="true">
                        Run VACUUM (reclaim storage from deleted rows)
                    </MudCheckBox>

                    <MudCheckBox @bind-Value="_editRunAnalyze" Color="Color.Primary" Dense="true">
                        Run ANALYZE (update query planner statistics)
                    </MudCheckBox>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseConfigDialog">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@SaveConfigAsync">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private Dictionary<string, BackgroundJobConfig>? _jobs;
    private int _queueDepth;
    private Timer? _refreshTimer;

    // Dialog state
    private bool _showConfigDialog;
    private BackgroundJobConfig? _editingJob;
    private string? _editCronExpression;

    // Schedule editing state
    private string _editScheduleInterval = "1d"; // Default: daily
    private string _userTimeZone = "UTC";

    // Database maintenance settings
    private bool _editRunVacuum = true;
    private bool _editRunAnalyze = true;

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    protected override async Task OnInitializedAsync()
    {
        // Get user's timezone from browser
        try
        {
            _userTimeZone = await JsRuntime.InvokeAsync<string>("getUserTimeZone");
        }
        catch
        {
            _userTimeZone = "UTC"; // Fallback if JS interop fails
        }

        // Ensure default job configs exist before loading
        await JobConfigService.EnsureDefaultConfigsAsync();

        await LoadJobsAsync();
        UpdateQueueDepth();

        // Refresh queue depth every 5 seconds
        _refreshTimer = new Timer(_ =>
        {
            UpdateQueueDepth();
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadJobsAsync()
    {
        _jobs = await JobConfigService.GetAllJobsAsync();
    }

    private void UpdateQueueDepth()
    {
        _queueDepth = QueueService.GetQueueDepth();
    }

    private async Task ToggleJobAsync(string jobName, bool enabled)
    {
        if (_jobs == null || !_jobs.TryGetValue(jobName, out var job))
            return;

        job.Enabled = enabled;
        await JobConfigService.UpdateJobConfigAsync(jobName, job);

        Snackbar.Add($"{job.DisplayName} {(enabled ? "enabled" : "disabled")}",
            enabled ? Severity.Success : Severity.Info);
    }

    private async Task RunNowAsync(string jobName)
    {
        if (_jobs == null || !_jobs.TryGetValue(jobName, out var job))
            return;

        try
        {
            // Build payload based on job type
            object payload = jobName switch
            {
                BackgroundJobNames.ScheduledBackup => BuildBackupPayload(job),
                BackgroundJobNames.DatabaseMaintenance => BuildMaintenancePayload(job),
                BackgroundJobNames.UserPhotoRefresh => BuildUserPhotoRefreshPayload(job),
                BackgroundJobNames.BlocklistSync => BuildBlocklistSyncPayload(),
                _ => new { } // Empty object for jobs without payloads
            };

            // Trigger job immediately via Quartz.NET
            var triggerId = await JobTriggerService.TriggerNowAsync(jobName, payload);
            Snackbar.Add($"{job.DisplayName} queued for execution", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to trigger job: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Failed to trigger job {JobName}", jobName);
        }
    }

    private void OpenConfigDialog(BackgroundJobConfig job)
    {
        _editingJob = job;
        _editCronExpression = job.CronExpression;

        // Parse existing cron expression into friendly format
        ParseCronToFriendlyFormat(job.CronExpression);

        // Load job-specific settings
        if (job.Settings != null)
        {
            if (job.JobName == BackgroundJobNames.DatabaseMaintenance)
            {
                if (job.Settings.TryGetValue(BackgroundJobSettings.RunVacuum, out var vacuum))
                    _editRunVacuum = ((JsonElement)vacuum).GetBoolean();
                if (job.Settings.TryGetValue(BackgroundJobSettings.RunAnalyze, out var analyze))
                    _editRunAnalyze = ((JsonElement)analyze).GetBoolean();
            }
        }

        _showConfigDialog = true;
    }

    private void CloseConfigDialog()
    {
        _showConfigDialog = false;
        _editingJob = null;
    }

    private async Task SaveConfigAsync()
    {
        if (_editingJob == null || _jobs == null)
            return;

        try
        {
            // Generate cron expression from friendly UI format (converts to UTC)
            var newCronExpression = GetCronPreview();
            if (newCronExpression.StartsWith("Invalid"))
            {
                Snackbar.Add("Invalid schedule configuration", Severity.Error);
                return;
            }

            _editingJob.CronExpression = newCronExpression;

            // Update job-specific settings (retention/directory for backups managed in Backup Configuration page)
            _editingJob.Settings ??= new Dictionary<string, object>();

            if (_editingJob.JobName == BackgroundJobNames.DatabaseMaintenance)
            {
                _editingJob.Settings[BackgroundJobSettings.RunVacuum] = _editRunVacuum;
                _editingJob.Settings[BackgroundJobSettings.RunAnalyze] = _editRunAnalyze;
            }

            await JobConfigService.UpdateJobConfigAsync(_editingJob.JobName, _editingJob);
            await LoadJobsAsync(); // Refresh

            Snackbar.Add($"{_editingJob.DisplayName} configuration saved", Severity.Success);
            CloseConfigDialog();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save configuration: {ex.Message}", Severity.Error);
        }
    }

    private object BuildBackupPayload(BackgroundJobConfig job)
    {
        // Granular retention settings (5-tier)
        var retainHourly = 24;
        var retainDaily = 7;
        var retainWeekly = 4;
        var retainMonthly = 12;
        var retainYearly = 3;
        string? backupDir = null;

        if (job.Settings != null)
        {
            if (job.Settings.TryGetValue(BackgroundJobSettings.RetainHourlyBackups, out var hourly))
                retainHourly = Convert.ToInt32(((JsonElement)hourly).GetInt32());
            if (job.Settings.TryGetValue(BackgroundJobSettings.RetainDailyBackups, out var daily))
                retainDaily = Convert.ToInt32(((JsonElement)daily).GetInt32());
            if (job.Settings.TryGetValue(BackgroundJobSettings.RetainWeeklyBackups, out var weekly))
                retainWeekly = Convert.ToInt32(((JsonElement)weekly).GetInt32());
            if (job.Settings.TryGetValue(BackgroundJobSettings.RetainMonthlyBackups, out var monthly))
                retainMonthly = Convert.ToInt32(((JsonElement)monthly).GetInt32());
            if (job.Settings.TryGetValue(BackgroundJobSettings.RetainYearlyBackups, out var yearly))
                retainYearly = Convert.ToInt32(((JsonElement)yearly).GetInt32());
            if (job.Settings.TryGetValue(BackgroundJobSettings.BackupDirectory, out var dir))
                backupDir = ((JsonElement)dir).GetString();
        }

        return new ScheduledBackupPayload
        {
            RetainHourlyBackups = retainHourly,
            RetainDailyBackups = retainDaily,
            RetainWeeklyBackups = retainWeekly,
            RetainMonthlyBackups = retainMonthly,
            RetainYearlyBackups = retainYearly,
            BackupDirectory = backupDir
        };
    }

    private object BuildMaintenancePayload(BackgroundJobConfig job)
    {
        var runVacuum = true;
        var runAnalyze = true;

        if (job.Settings != null)
        {
            if (job.Settings.TryGetValue(BackgroundJobSettings.RunVacuum, out var vacuum))
                runVacuum = ((JsonElement)vacuum).GetBoolean();
            if (job.Settings.TryGetValue(BackgroundJobSettings.RunAnalyze, out var analyze))
                runAnalyze = ((JsonElement)analyze).GetBoolean();
        }

        return new DatabaseMaintenancePayload
        {
            RunVacuum = runVacuum,
            RunAnalyze = runAnalyze,
            RunVacuumFull = false
        };
    }

    private object BuildUserPhotoRefreshPayload(BackgroundJobConfig job)
    {
        var daysBack = 7;

        if (job.Settings != null)
        {
            if (job.Settings.TryGetValue(BackgroundJobSettings.DaysBack, out var days))
                daysBack = Convert.ToInt32(((JsonElement)days).GetInt32());
        }

        return new RefreshUserPhotosPayload
        {
            DaysBack = daysBack
        };
    }

    private object BuildBlocklistSyncPayload()
    {
        return new BlocklistSyncJobPayload(
            SubscriptionId: null, // Sync all
            ChatId: 0, // Global
            ForceRebuild: false
        );
    }

    private static string FormatCronSchedule(string? cron)
    {
        if (string.IsNullOrEmpty(cron))
            return "Not configured";

        // Parse common Quartz cron patterns for user-friendly display
        // Quartz format: second minute hour day month dayOfWeek
        return cron switch
        {
            "0 0 2 * * ?" => "Daily at 2:00 AM",
            "0 0 3 * * ?" => "Daily at 3:00 AM",
            "0 0 4 * * ?" => "Daily at 4:00 AM",
            "0 0 0 * * ?" => "Daily at midnight",
            "0 0 3 ? * SUN" => "Sundays at 3:00 AM",
            "0 0 4 ? * SUN" => "Sundays at 4:00 AM",
            "0 0 * * * ?" => "Every hour",
            "0 0 */6 * * ?" => "Every 6 hours",
            "0 0 */12 * * ?" => "Every 12 hours",
            "0 0 0 1 * ?" => "First of month at midnight",
            "0 0/30 * * * ?" => "Every 30 minutes",
            _ => cron
        };
    }

    /// <summary>
    /// Parse existing Quartz cron expression into friendly interval format (e.g., "30m", "6h", "1d")
    /// </summary>
    private void ParseCronToFriendlyFormat(string? cronExpression)
    {
        if (string.IsNullOrEmpty(cronExpression))
        {
            _editScheduleInterval = "1d";
            return;
        }

        // Parse Quartz cron (format: "second minute hour day month dayOfWeek")
        var parts = cronExpression.Split(' ');
        if (parts.Length != 6)
        {
            _editScheduleInterval = "1d";
            return;
        }

        var second = parts[0];
        var minute = parts[1];
        var hour = parts[2];
        var day = parts[3];
        var month = parts[4];
        var dayOfWeek = parts[5];

        // Detect interval patterns and convert to friendly format
        if (minute.StartsWith("*/") || minute.Contains("/"))
        {
            // Every N minutes: "0 */30 * * * ?" → "30m"
            var minuteInterval = minute.Replace("*/", "").Replace("/", "");
            if (int.TryParse(minuteInterval, out var mins))
            {
                _editScheduleInterval = $"{mins}m";
                return;
            }
        }

        if (hour.StartsWith("*/") || hour.Contains("/"))
        {
            // Every N hours: "0 0 */6 * * ?" → "6h"
            var hourInterval = hour.Replace("*/", "").Replace("/", "");
            if (int.TryParse(hourInterval, out var hrs))
            {
                _editScheduleInterval = $"{hrs}h";
                return;
            }
        }

        // Daily: "0 0 2 * * ?" → "1d"
        if (day == "*" && dayOfWeek == "?")
        {
            _editScheduleInterval = "1d";
            return;
        }

        // Weekly: "0 0 2 ? * SUN" → "1w"
        if (dayOfWeek == "SUN" || dayOfWeek == "0")
        {
            _editScheduleInterval = "1w";
            return;
        }

        // Default
        _editScheduleInterval = "1d";
    }

    /// <summary>
    /// Generate Quartz cron expression from interval string (e.g., "30m", "6h", "1d", "1w")
    /// </summary>
    private string GetCronPreview()
    {
        if (string.IsNullOrWhiteSpace(_editScheduleInterval))
            return "Invalid interval";

        // Parse the interval using TimeSpanUtilities
        if (!TimeSpanUtilities.TryParseDuration(_editScheduleInterval, out var duration))
        {
            return "Invalid format (use: 30m, 6h, 1d, 1w)";
        }

        // Convert TimeSpan to Quartz cron expression
        // Quartz format: second minute hour day month dayOfWeek

        if (duration.TotalMinutes < 60)
        {
            // Minutes: "0 */30 * * * ?" (every 30 minutes)
            var mins = (int)duration.TotalMinutes;
            return $"0 */{mins} * * * ?";
        }
        else if (duration.TotalHours < 24)
        {
            // Hours: "0 0 */6 * * ?" (every 6 hours)
            var hours = (int)duration.TotalHours;
            return $"0 0 */{hours} * * ?";
        }
        else if (duration.TotalDays < 7)
        {
            // Days: "0 0 2 * * ?" (daily at 2 AM UTC)
            return "0 0 2 * * ?";
        }
        else if (duration.TotalDays < 30)
        {
            // Weeks: "0 0 2 ? * SUN" (weekly on Sunday at 2 AM UTC)
            return "0 0 2 ? * SUN";
        }
        else
        {
            // Monthly or longer: "0 0 2 1 * ?" (monthly on 1st at 2 AM UTC)
            return "0 0 2 1 * ?";
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
