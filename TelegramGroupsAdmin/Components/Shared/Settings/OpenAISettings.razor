@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.Services
@inject IFileScanningConfigRepository ConfigRepository
@inject IAuditService AuditService
@inject BlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar

<MudGrid>
    <!-- Info Alert -->
    <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
            <MudText Typo="Typo.subtitle2"><strong>OpenAI Integration</strong></MudText>
            <MudText Typo="Typo.body2">
                GPT-4 powers spam detection (custom prompts per chat), content translation (foreign language detection),
                image spam detection (vision API), and video spam detection. Configuration changes apply immediately (hot-reload).
            </MudText>
        </MudAlert>
    </MudItem>

    <!-- Main Configuration -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <div>
                        <MudText Typo="Typo.h6">OpenAI Configuration</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Configure OpenAI API settings for AI-powered spam detection
                        </MudText>
                    </div>
                    <MudChip Color="@(_isConfigured ? Color.Success : Color.Error)" Size="Size.Small" T="string">
                        @(_isConfigured ? "Configured" : "Not Configured")
                    </MudChip>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- Enable/Disable Toggle -->
                <MudSwitch @bind-Value="_config.Enabled"
                          Label="Enable OpenAI Integration"
                          Color="Color.Primary" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    When disabled, all OpenAI features (spam detection, translation, image analysis) are skipped
                </MudText>

                <!-- API Key -->
                <MudTextField @bind-Value="_apiKeys.OpenAI"
                             Label="API Key"
                             Variant="Variant.Outlined"
                             InputType="@(_showApiKey ? InputType.Text : InputType.Password)"
                             HelperText="Get your API key from https://platform.openai.com/api-keys"
                             Adornment="Adornment.End"
                             AdornmentIcon="@(_showApiKey ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                             OnAdornmentClick="@(() => _showApiKey = !_showApiKey)">
                </MudTextField>

                <!-- Model Selection -->
                <MudSelect @bind-Value="_config.Model"
                          Label="Model"
                          Variant="Variant.Outlined"
                          HelperText="GPT model to use (gpt-4o-mini recommended for cost/performance balance)"
                          Disabled="@(!_config.Enabled)">
                    <MudSelectItem Value="@("gpt-4o-mini")">gpt-4o-mini (Recommended - Fast & Economical)</MudSelectItem>
                    <MudSelectItem Value="@("gpt-4o")">gpt-4o (Advanced)</MudSelectItem>
                    <MudSelectItem Value="@("gpt-4-turbo")">gpt-4-turbo (Legacy)</MudSelectItem>
                    <MudSelectItem Value="@("gpt-3.5-turbo")">gpt-3.5-turbo (Budget)</MudSelectItem>
                </MudSelect>

                <!-- Max Tokens -->
                <MudNumericField @bind-Value="_config.MaxTokens"
                                Label="Max Tokens"
                                Variant="Variant.Outlined"
                                Min="100"
                                Max="4000"
                                HelperText="Maximum tokens per request (100-4000). Higher = longer responses but higher cost."
                                Disabled="@(!_config.Enabled)" />

                <!-- Temperature -->
                <MudNumericField @bind-Value="_config.Temperature"
                                Label="Temperature"
                                Variant="Variant.Outlined"
                                Min="0"
                                Max="2"
                                Step="0.1"
                                Format="N1"
                                HelperText="Creativity (0.0-2.0). Lower = more consistent, higher = more creative. Spam detection uses 0.0-0.3 for consistency."
                                Disabled="@(!_config.Enabled)" />

                <!-- Save Button -->
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              OnClick="@SaveConfigAsync"
                              Disabled="@_isSaving"
                              StartIcon="@Icons.Material.Filled.Save">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <text>&nbsp;Saving...</text>
                        }
                        else
                        {
                            <text>Save Settings</text>
                        }
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Secondary"
                              OnClick="@LoadConfig"
                              Disabled="@_isSaving"
                              StartIcon="@Icons.Material.Filled.Refresh">
                        Reset
                    </MudButton>
                </MudStack>

                <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Info">
                    Changes apply immediately (hot-reload). No app restart required.
                </MudAlert>

                @if (!_isConfigured)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        <strong>Not Configured:</strong> Add your OpenAI API key and enable the integration above.
                        Until configured, OpenAI spam detection, translation, and image analysis will be skipped.
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Feature Status -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Features Powered by OpenAI</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    These features will be available when OpenAI is configured and enabled
                </MudText>

                <MudDivider Class="my-2" />

                <MudSimpleTable Hover="true" Dense="true">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Custom Spam Detection</strong></td>
                            <td>Per-chat custom prompts using AI to configure AI (Phase 4.X meta-AI)</td>
                            <td>
                                @if (_config.Enabled && _isConfigured)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Translation Service</strong></td>
                            <td>Automatic foreign language detection and translation before spam analysis</td>
                            <td>
                                @if (_config.Enabled && _isConfigured)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Image Spam Detection</strong></td>
                            <td>Vision API analyzes images for spam indicators (text overlays, promotional content)</td>
                            <td>
                                @if (_config.Enabled && _isConfigured)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Video Spam Detection</strong></td>
                            <td>Analyzes video thumbnails for promotional content and spam patterns</td>
                            <td>
                                @if (_config.Enabled && _isConfigured)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>OpenAI Veto Mode</strong></td>
                            <td>AI double-checks other detectors' spam verdicts to reduce false positives</td>
                            <td>
                                @if (_config.Enabled && _isConfigured)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                }
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudAlert Severity="Severity.Info" Dense="true">
                    Configure feature-specific settings (veto mode, image detection, etc.) in <strong>Content Detection â†’ External Services</strong>.
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Cost Optimization Tips -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Cost Optimization Tips</MudText>

                <MudAlert Severity="Severity.Info" Dense="true">
                    <strong>Recommended Settings:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Model: <strong>gpt-4o-mini</strong> (20x cheaper than gpt-4, excellent spam detection)</li>
                        <li>Max Tokens: <strong>500-1000</strong> (sufficient for spam analysis)</li>
                        <li>Temperature: <strong>0.0-0.3</strong> (consistent detection, minimal creativity)</li>
                    </ul>
                </MudAlert>

                <MudAlert Severity="Severity.Warning" Dense="true">
                    <strong>Expensive Operations:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Vision API calls (image/video spam detection) - ~100x cost of text-only</li>
                        <li>High MaxTokens values - Cost scales linearly with tokens</li>
                        <li>gpt-4 models - 20x more expensive than gpt-4o-mini</li>
                    </ul>
                </MudAlert>

                <MudAlert Severity="Severity.Success" Dense="true">
                    <strong>Free Optimizations:</strong>
                    Translation results are cached globally (spam is spam regardless of chat).
                    OpenAI spam checks use veto mode by default (only called when other detectors find spam).
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private OpenAIConfig _config = new();
    private ApiKeysConfig _apiKeys = new();
    private bool _isSaving;
    private bool _isConfigured;
    private bool _showApiKey;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
        await LoadApiKeys();
        CheckConfiguration();
    }

    private async Task LoadConfig()
    {
        try
        {
            var config = await ConfigRepository.GetOpenAIConfigAsync();
            _config = config ?? new OpenAIConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new OpenAIConfig();
        }
    }

    private async Task LoadApiKeys()
    {
        try
        {
            var apiKeys = await ConfigRepository.GetApiKeysAsync();
            _apiKeys = apiKeys ?? new ApiKeysConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading API keys: {ex.Message}", Severity.Error);
            _apiKeys = new ApiKeysConfig();
        }
    }

    private void CheckConfiguration()
    {
        _isConfigured = !string.IsNullOrWhiteSpace(_apiKeys.OpenAI);
    }

    private async Task SaveConfigAsync()
    {
        _isSaving = true;
        try
        {
            // Save OpenAI configuration
            await ConfigRepository.SaveOpenAIConfigAsync(_config);

            // Save API keys
            await ConfigRepository.SaveApiKeysAsync(_apiKeys);

            // Create audit log entry
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(userId))
            {
                await AuditService.LogEventAsync(
                    AuditEventType.ConfigurationChanged,
                    Actor.FromWebUser(userId),
                    Actor.FromWebUser(userId),
                    $"openai:enabled={_config.Enabled}:model={_config.Model}:max_tokens={_config.MaxTokens}:temperature={_config.Temperature}");
            }

            // Update configuration status
            CheckConfiguration();

            Snackbar.Add("OpenAI settings saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }
}
