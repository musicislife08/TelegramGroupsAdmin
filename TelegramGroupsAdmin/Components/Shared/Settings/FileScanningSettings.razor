@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.ContentDetection.Repositories
@using TelegramGroupsAdmin.ContentDetection.Models
@using TelegramGroupsAdmin.ContentDetection.Services
@using TelegramGroupsAdmin.Core.Extensions
@using TelegramGroupsAdmin.Core.Models
@inject ISystemConfigRepository ConfigRepository
@inject IFileScanQuotaRepository QuotaRepository
@inject IDetectionResultsRepository DetectionResultsRepository
@inject IFileScanResultRepository FileScanResultRepository
@inject IFileScannerService FileScannerService
@inject IAuditService AuditService
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<MudGrid>
    <!-- Info Alert -->
    <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
            <MudText Typo="Typo.subtitle2"><strong>File Scanning</strong></MudText>
            <MudText Typo="Typo.body2">
                Two-tier malware detection: <strong>ClamAV</strong> (10M+ signatures, unlimited) scans all files first, <strong>VirusTotal</strong> (70+ engines, 500/day) provides cloud fallback.
                All document attachments shared in Telegram are automatically scanned. Media files (GIFs, videos, audio) are excluded from scanning.
            </MudText>
        </MudAlert>
    </MudItem>

    <!-- Infrastructure Link Alert -->
    <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Dense="true">
            Configure connection settings in <MudLink Href="/settings/system/clamav" Style="text-decoration: underline;"><strong>System → ClamAV</strong></MudLink>
            and API key in <MudLink Href="/settings/system/virustotal" Style="text-decoration: underline;"><strong>System → VirusTotal</strong></MudLink>.
        </MudAlert>
    </MudItem>

    <!-- Tier 1: Local Scanners (Phase 1 - ACTIVE) -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Computer" Color="Color.Success" />
                    <MudText Typo="Typo.h6">Tier 1: Local Scanners</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Phase 1 - Active</MudChip>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Local scanners run in parallel with unlimited capacity. Any scanner detecting a threat = file is infected.
                </MudText>

                <MudDivider Class="my-2" />

                <!-- ClamAV Scanner -->
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel>
                        <TitleContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSwitch T="bool" Value="@_config.Tier1.ClamAV.Enabled" Color="Color.Success" Disabled="true" />
                                <MudText Typo="Typo.h6">ClamAV</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Required</MudChip>
                                <MudSpacer />
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                <MudText Typo="Typo.caption" Color="Color.Success">8.7M Signatures</MudText>
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Spacing="2" Class="mt-2">
                                <MudText Typo="Typo.body2">Industry-standard open-source antivirus engine with 10M+ virus signatures</MudText>

                                <MudAlert Severity="Severity.Info" Dense="true">
                                    ClamAV connection settings (host, port, timeout) are managed in <MudLink Href="/settings/system/clamav" Style="text-decoration: underline;"><strong>System → ClamAV</strong></MudLink>.
                                </MudAlert>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>

            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Tier 2: Cloud Scanners (VirusTotal Active) -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="Color.Success" />
                    <MudText Typo="Typo.h6">Tier 2: Cloud Scanners</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">VirusTotal Active</MudChip>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    VirusTotal provides multi-engine scanning with 70+ antivirus engines. Used as fallback when Tier 1 finds nothing.
                </MudText>

                <MudDivider Class="my-2" />

                <!-- VirusTotal Scanner -->
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel>
                        <TitleContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSwitch T="bool" Value="@_config.Tier2.VirusTotal.Enabled" ValueChanged="OnVirusTotalEnabledChanged" Color="Color.Success" />
                                <MudText Typo="Typo.h6">VirusTotal</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">70+ Engines</MudChip>
                                <MudSpacer />
                                @if (_virusTotalConfigured)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Title="API Key Configured" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Title="API Key Missing" />
                                }
                                @if (_isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                }
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                            <MudStack Spacing="2" Class="mt-2">
                                <MudText Typo="Typo.body2">Multi-engine cloud scanning with 70+ antivirus engines</MudText>

                                <MudAlert Severity="Severity.Info" Dense="true">
                                    VirusTotal API key is managed in <MudLink Href="/settings/system/virustotal" Style="text-decoration: underline;"><strong>System → VirusTotal</strong></MudLink>.
                                </MudAlert>

                                <MudDivider Class="my-2" />

                                <MudText Typo="Typo.subtitle2">Rate Limiting & Quotas</MudText>

                                <MudStack Row="true" Spacing="2">
                                    <FieldWithHelp HelpText="Daily quota limit (Free tier: 500/day). When exceeded, VirusTotal is skipped for remaining files. System uses fail-open design - files are allowed when quota exhausted (logged as warning). Resets daily at midnight UTC.">
                                        <MudNumericField T="int" Label="Daily Limit" Value="@_config.Tier2.VirusTotal.DailyLimit" ValueChanged="OnDailyLimitChanged" Variant="Variant.Outlined" HelperText="Free tier: 500 requests/day" />
                                    </FieldWithHelp>
                                    <FieldWithHelp HelpText="Rate limit per minute (Free tier: 4/min). Enforced via Polly rate limiter. Requests exceeding limit are queued briefly, then skipped if still at limit. Monitor quota usage below to track consumption.">
                                        <MudNumericField T="int" Label="Rate Limit (/min)" Value="@_config.Tier2.VirusTotal.PerMinuteLimit" ValueChanged="OnPerMinuteLimitChanged" Variant="Variant.Outlined" HelperText="Free tier: 4 requests/minute" />
                                    </FieldWithHelp>
                                </MudStack>

                                <MudAlert Severity="_virusTotalConfigured ? Severity.Success : Severity.Info" Dense="true">
                                    @if (_virusTotalConfigured)
                                    {
                                        <text><strong>API Key Status:</strong> Configured and ready to use.</text>
                                    }
                                    else
                                    {
                                        <text><strong>API Key Status:</strong> Not configured. Add your VirusTotal API key in <MudLink Href="/settings/system/virustotal" Style="text-decoration: underline;">System → VirusTotal</MudLink>.</text>
                                    }
                                </MudAlert>
                            </MudStack>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>

                <MudDivider Class="my-2" />

                <!-- Quota Usage -->
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText Typo="Typo.subtitle2">Quota Usage</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Text" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadQuotas" Disabled="@_isLoadingQuotas">
                            Refresh
                        </MudButton>
                    </MudStack>

                    @if (_isLoadingQuotas)
                    {
                        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                    }
                    else if (_quotas.Count > 0)
                    {
                        <MudStack Spacing="1">
                            @foreach (var quota in _quotas.Where(q => q.Service == "VirusTotal"))
                            {
                                var percentage = quota.LimitValue > 0 ? (double)quota.Count / quota.LimitValue * 100 : 0;
                                var progressColor = percentage < 50 ? Color.Success : (percentage < 80 ? Color.Warning : Color.Error);

                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Style="min-width: 120px;">VirusTotal (@quota.QuotaType)</MudText>
                                    <MudProgressLinear Value="@percentage" Color="@progressColor" Size="Size.Large" Style="flex: 1;" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="min-width: 80px;">@quota.Count / @quota.LimitValue</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="min-width: 120px;">Resets: @FormatTimeUntilReset(quota.QuotaWindowEnd)</MudText>
                                </MudStack>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true">
                            No quota usage yet. Quotas will appear after first file scan using VirusTotal.
                        </MudAlert>
                    }
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- General Settings -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">General Settings</MudText>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- Cache Settings -->
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.subtitle2">Result Caching</MudText>
                            <HelpTooltip Text="Scan results are cached by file hash (SHA-256). Identical files shared multiple times are not re-scanned, saving API quota and improving performance. Cache invalidates after 24 hours to catch new malware signatures." />
                        </MudStack>
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Warning"
                                  Size="Size.Small"
                                  StartIcon="@Icons.Material.Filled.DeleteSweep"
                                  OnClick="@ClearCache"
                                  Disabled="@_isClearingCache">
                            @(_isClearingCache ? "Clearing..." : "Clear Cache")
                        </MudButton>
                    </MudStack>

                    <MudSwitch T="bool" Value="@_config.General.CacheEnabled" Disabled="true" Color="Color.Success" Label="Enable result caching (24hr TTL)" />
                    <FieldWithHelp HelpText="24 hours balances performance (cache hits are <10ms) with security (daily updates catch new threats). Longer TTL = faster, but older signatures. Shorter = more API calls.">
                        <MudNumericField T="int" Label="Cache TTL (hours)" Value="@_config.General.CacheTtlHours" Disabled="true" Variant="Variant.Outlined" HelperText="How long to cache scan results" />
                    </FieldWithHelp>

                    <MudAlert Severity="Severity.Success" Dense="true">
                        Hash-based caching prevents re-scanning identical files. Cache hits take &lt;10ms vs ~55ms for fresh scans.
                        Use Clear Cache button to force re-scanning of files during testing.
                    </MudAlert>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- File Size Limits -->
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">File Size Limits</MudText>
                    <MudTextField T="string"
                                 Label="Maximum File Size"
                                 Value="@FormatBytes(_config.General.MaxFileSizeBytes)"
                                 Disabled="true"
                                 Variant="Variant.Outlined"
                                 HelperText="Files exceeding this limit are skipped (fail-open)" />

                    <MudAlert Severity="Severity.Info" Dense="true">
                        Current limit: <strong>4.5 GB</strong> - Supports Telegram Premium (4GB files) with safety margin.
                        Telegram free users can upload up to 2GB.
                    </MudAlert>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- File Types -->
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2">File Types to Scan</MudText>
                    <MudChipSet T="string" ReadOnly="true">
                        @foreach (var ext in _config.General.ScanFileTypes)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@ext</MudChip>
                        }
                    </MudChipSet>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Empty list = scan all file types</MudText>
                </MudStack>

                <MudDivider Class="my-2" />

                <!-- Critical Check Integration -->
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.subtitle2">Critical Check Integration</MudText>
                        <HelpTooltip Text="Critical checks bypass trust/admin exemptions because malware threats apply to everyone. Even admins can accidentally share infected files. This setting ensures comprehensive security without false trust assumptions." />
                    </MudStack>
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Configure file scanning as a critical check in <MudLink Href="/settings/detection/critical" Style="text-decoration: underline;"><strong>Content Detection → Critical Checks</strong></MudLink>.
                        Critical checks run for <strong>ALL users</strong> (including trusted users and admins) but do not apply bans/warns.
                    </MudAlert>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Scan Results Log (Active) -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.ListAlt" Color="Color.Success" />
                    <MudText Typo="Typo.h6">Recent Scan Results</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Text" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadScanResults" Disabled="@_isLoadingScanResults">
                        Refresh
                    </MudButton>
                </MudStack>

                <MudDivider Class="my-2" />

                @if (_isLoadingScanResults)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else if (_scanResults.Count > 0)
                {
                    <MudTable Items="@_scanResults" Hover="true" Dense="true" Striped="true">
                        <HeaderContent>
                            <MudTh>Timestamp</MudTh>
                            <MudTh>User</MudTh>
                            <MudTh>Scanner</MudTh>
                            <MudTh>Result</MudTh>
                            <MudTh>Details</MudTh>
                            <MudTh>Confidence</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Timestamp">
                                <MudText Typo="Typo.body2">@context.DetectedAt.ToLocalTime().ToString("MMM dd, HH:mm:ss")</MudText>
                            </MudTd>
                            <MudTd DataLabel="User">
                                <MudText Typo="Typo.body2">@context.AddedBy.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.UserId</MudText>
                            </MudTd>
                            <MudTd DataLabel="Scanner">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.DetectionMethod</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Result">
                                @if (context.IsSpam)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Dangerous">Infected</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Clean</MudChip>
                                }
                            </MudTd>
                            <MudTd DataLabel="Details">
                                <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @context.Reason
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Confidence">
                                <MudText Typo="Typo.body2">@context.Confidence%</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <!-- Pagination -->
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mt-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Showing @((_currentPage - 1) * _pageSize + 1)-@Math.Min(_currentPage * _pageSize, _totalScanResults) of @_totalScanResults results
                        </MudText>
                        <MudPagination Count="@TotalPages" Selected="@_currentPage" SelectedChanged="OnPageChanged" BoundaryCount="1" MiddleCount="3" />
                    </MudStack>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        No scan results found. File scanning results will appear here after files are scanned.
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- Scanner Health & Statistics (Active) -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Insights" Color="Color.Success" />
                    <MudText Typo="Typo.h6">Scanner Health & Statistics</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Text" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadHealthData" Disabled="@_isLoadingHealth">
                        Refresh
                    </MudButton>
                </MudStack>

                <MudDivider Class="my-2" />

                @if (_isLoadingHealth)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else
                {
                    <MudSimpleTable Hover="true" Dense="true">
                        <thead>
                            <tr>
                                <th>Scanner</th>
                                <th>Status</th>
                                <th>Version/Info</th>
                                <th>Detections (7d)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>ClamAV</strong></td>
                                <td>
                                    @if (_clamAvHealth?.IsHealthy == true)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Healthy</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Error">Offline</MudChip>
                                    }
                                </td>
                                <td>
                                    @if (_clamAvHealth?.IsHealthy == true)
                                    {
                                        <MudText Typo="Typo.body2">@_clamAvHealth.Version</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@_clamAvHealth.Host:@_clamAvHealth.Port</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Error">@(_clamAvHealth?.ErrorMessage ?? "Not available")</MudText>
                                    }
                                </td>
                                <td>
                                    @if (_scanStats.TryGetValue("FileScanningCheck", out var stat))
                                    {
                                        <MudText Typo="Typo.body2">@stat infections</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">0 infections</MudText>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>VirusTotal</strong></td>
                                <td>
                                    @if (_virusTotalConfigured && _config.Tier2.VirusTotal.Enabled)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                                    }
                                    else if (!_virusTotalConfigured)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">No API Key</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.PowerOff">Disabled</MudChip>
                                    }
                                </td>
                                <td>
                                    <MudText Typo="Typo.body2">70+ Antivirus Engines</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Cloud-based (Tier 2 fallback)</MudText>
                                </td>
                                <td>
                                    @if (_scanStats.TryGetValue("VirusTotal", out var scanStat))
                                    {
                                        <MudText Typo="Typo.body2">@scanStat infections</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">0 infections</MudText>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>

                    <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Info">
                        Detection statistics show files flagged as infected in the last 7 days. ClamAV runs first (Tier 1), VirusTotal is used only if ClamAV finds nothing (Tier 2 fallback).
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [CascadingParameter] private WebUserIdentity? WebUser { get; set; }

    private FileScanningConfig _config = new();
    private ApiKeysConfig _apiKeys = new();
    private List<FileScanQuotaModel> _quotas = [];
    private FileScannerHealthResult? _clamAvHealth;
    private Dictionary<string, int> _scanStats = new();
    private List<DetectionResultRecord> _scanResults = [];
    private bool _isSaving;
    private bool _isLoadingQuotas;
    private bool _isLoadingHealth;
    private bool _isLoadingScanResults;
    private bool _isClearingCache;
    private bool _virusTotalConfigured;

    // Pagination for scan results
    private int _currentPage = 1;
    private readonly int _pageSize = 20;
    private int _totalScanResults;
    private int TotalPages => (_totalScanResults + _pageSize - 1) / _pageSize;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
        await LoadApiKeysForStatusCheck(); // Only for checking VirusTotal configured status
        await LoadQuotas();
        await LoadHealthData();
        await LoadScanResults();
        CheckVirusTotalConfiguration();
    }

    private async Task LoadConfig()
    {
        try
        {
            _config = await ConfigRepository.GetAsync(chatId: null); // Global config
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new FileScanningConfig(); // Fallback to defaults
        }
    }

    private async Task LoadQuotas()
    {
        _isLoadingQuotas = true;
        try
        {
            _quotas = await QuotaRepository.GetAllActiveQuotasAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading quota data: {ex.Message}", Severity.Error);
            _quotas = [];
        }
        finally
        {
            _isLoadingQuotas = false;
        }
    }

    private async Task LoadApiKeysForStatusCheck()
    {
        try
        {
            var apiKeys = await ConfigRepository.GetApiKeysAsync();
            _apiKeys = apiKeys ?? new ApiKeysConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading API keys: {ex.Message}", Severity.Error);
            _apiKeys = new ApiKeysConfig();
        }
    }

    private void CheckVirusTotalConfiguration()
    {
        // Check database first, fallback to env var
        _virusTotalConfigured = !string.IsNullOrWhiteSpace(_apiKeys.VirusTotal) ||
                                !string.IsNullOrWhiteSpace(Configuration["VirusTotal:ApiKey"]);
    }

    private async Task SaveConfigAsync()
    {
        _isSaving = true;
        try
        {
            await ConfigRepository.SaveAsync(_config, chatId: null); // Save global config

            // Create audit log entry
            var actor = WebUser!.ToActor();
            await AuditService.LogEventAsync(
                AuditEventType.ConfigurationChanged,
                actor,
                actor,
                $"file_scanning:vt_enabled={_config.Tier2.VirusTotal.Enabled}:daily={_config.Tier2.VirusTotal.DailyLimit}:permin={_config.Tier2.VirusTotal.PerMinuteLimit}");

            Snackbar.Add("Settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task OnVirusTotalEnabledChanged(bool enabled)
    {
        _config.Tier2.VirusTotal.Enabled = enabled;
        await SaveConfigAsync();
    }

    private async Task OnDailyLimitChanged(int limit)
    {
        _config.Tier2.VirusTotal.DailyLimit = limit;
        await SaveConfigAsync();
    }

    private async Task OnPerMinuteLimitChanged(int limit)
    {
        _config.Tier2.VirusTotal.PerMinuteLimit = limit;
        await SaveConfigAsync();
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB", "TB"];
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async Task LoadHealthData()
    {
        _isLoadingHealth = true;
        try
        {
            // Load ClamAV health check
            _clamAvHealth = await FileScannerService.GetHealthAsync();

            // Load scan statistics (7-day window, infected files only)
            _scanStats = await DetectionResultsRepository.GetFileScanStatsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading health data: {ex.Message}", Severity.Error);
            _clamAvHealth = null;
            _scanStats = new Dictionary<string, int>();
        }
        finally
        {
            _isLoadingHealth = false;
        }
    }

    private async Task LoadScanResults()
    {
        _isLoadingScanResults = true;
        try
        {
            // Get total count first
            _totalScanResults = await DetectionResultsRepository.GetFileScanResultsCountAsync();

            // Load current page
            var offset = (_currentPage - 1) * _pageSize;
            _scanResults = await DetectionResultsRepository.GetFileScanResultsAsync(_pageSize, offset);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scan results: {ex.Message}", Severity.Error);
            _scanResults = [];
            _totalScanResults = 0;
        }
        finally
        {
            _isLoadingScanResults = false;
        }
    }

    private async Task OnPageChanged(int newPage)
    {
        _currentPage = newPage;
        await LoadScanResults();
    }

    private async Task ClearCache()
    {
        _isClearingCache = true;
        try
        {
            var count = await FileScanResultRepository.ClearAllCacheAsync();
            Snackbar.Add($"Cleared {count} cached scan results", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error clearing cache: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isClearingCache = false;
        }
    }

    private string FormatTimeUntilReset(DateTimeOffset windowEnd)
    {
        var timeUntil = windowEnd - DateTimeOffset.UtcNow;
        if (timeUntil.TotalHours < 1)
            return $"{(int)timeUntil.TotalMinutes}m";
        if (timeUntil.TotalDays < 1)
            return $"{(int)timeUntil.TotalHours}h {timeUntil.Minutes}m";
        return $"{(int)timeUntil.TotalDays}d {timeUntil.Hours}h";
    }
}
