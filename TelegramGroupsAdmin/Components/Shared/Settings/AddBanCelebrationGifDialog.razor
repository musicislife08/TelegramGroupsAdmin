@using ByteSizeLib
@using TelegramGroupsAdmin.Telegram.Models
@using TelegramGroupsAdmin.Telegram.Repositories
@using TelegramGroupsAdmin.Telegram.Services
@inject IBanCelebrationGifRepository GifRepository
@inject IThumbnailService ThumbnailService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Gif" Class="mr-2" />
            Add Ban Celebration GIF
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs @bind-ActivePanelIndex="_activeTabIndex" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4">
            <MudTabPanel Text="Upload File">
                <MudStack Spacing="3" Class="mt-4">
                    <MudTextField @bind-Value="_name"
                                 Label="Name (optional)"
                                 Variant="Variant.Outlined"
                                 HelperText="A friendly name for this GIF" />

                    <MudFileUpload T="IBrowserFile"
                                  Accept=".gif,.mp4"
                                  FilesChanged="OnFileSelected"
                                  MaximumFileCount="1">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.CloudUpload"
                                      FullWidth="true">
                                @(_selectedFile == null ? "Select GIF or MP4 file" : _selectedFile.Name)
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>

                    @if (_selectedFile != null)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Selected: @_selectedFile.Name (@ByteSize.FromBytes(_selectedFile.Size))
                        </MudText>
                    }
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="From URL">
                <MudStack Spacing="3" Class="mt-4">
                    <MudTextField @bind-Value="_name"
                                 Label="Name (optional)"
                                 Variant="Variant.Outlined"
                                 HelperText="A friendly name for this GIF" />

                    <MudTextField @bind-Value="_url"
                                 Label="GIF URL"
                                 Variant="Variant.Outlined"
                                 Placeholder="https://example.com/animation.gif"
                                 HelperText="Direct link to a GIF or MP4 file" />
                </MudStack>
            </MudTabPanel>
        </MudTabs>

        @if (_isProcessing)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="@_isProcessing">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                  Variant="Variant.Filled"
                  OnClick="Submit"
                  Disabled="@(!CanSubmit || _isProcessing)">
            @(_isProcessing ? "Adding..." : "Add GIF")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private int _activeTabIndex;
    private string _name = string.Empty;
    private string _url = string.Empty;
    private IBrowserFile? _selectedFile;
    private bool _isProcessing;
    private string? _errorMessage;

    private bool CanSubmit => _activeTabIndex switch
    {
        0 => _selectedFile != null,
        1 => !string.IsNullOrWhiteSpace(_url),
        _ => false
    };

    private void OnFileSelected(IBrowserFile file)
    {
        _selectedFile = file;
        _errorMessage = null;

        // Auto-set name from filename if not specified
        if (string.IsNullOrWhiteSpace(_name))
        {
            _name = Path.GetFileNameWithoutExtension(file.Name);
        }
    }

    private async Task Submit()
    {
        _isProcessing = true;
        _errorMessage = null;

        try
        {
            BanCelebrationGif gif;

            if (_activeTabIndex == 0 && _selectedFile != null)
            {
                // Upload file
                await using var stream = _selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50MB max
                gif = await GifRepository.AddFromFileAsync(stream, _selectedFile.Name, _name);
            }
            else if (_activeTabIndex == 1 && !string.IsNullOrWhiteSpace(_url))
            {
                // Download from URL
                gif = await GifRepository.AddFromUrlAsync(_url, _name);
            }
            else
            {
                return;
            }

            // Generate thumbnail from first frame
            await GenerateThumbnailAsync(gif);

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add($"Error adding GIF: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task GenerateThumbnailAsync(BanCelebrationGif gif)
    {
        try
        {
            // Build paths for thumbnail generation
            var sourcePath = GifRepository.GetFullPath(gif.FilePath);
            var thumbnailRelativePath = gif.FilePath.Replace(Path.GetExtension(gif.FilePath), "_thumb.png");
            var thumbnailFullPath = GifRepository.GetFullPath(thumbnailRelativePath);

            // Generate thumbnail (extracts first frame for GIFs)
            var success = await ThumbnailService.GenerateThumbnailAsync(sourcePath, thumbnailFullPath);

            if (success)
            {
                // Update the GIF record with thumbnail path
                await GifRepository.UpdateThumbnailPathAsync(gif.Id, thumbnailRelativePath);
            }
        }
        catch (Exception ex)
        {
            // Thumbnail generation is non-critical - log but don't fail the upload
            Snackbar.Add($"Note: Thumbnail generation failed: {ex.Message}", Severity.Warning);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
