@using TelegramGroupsAdmin.Core.Models
@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.Services.Auth
@inject IUserManagementService UserManagementService
@inject IInviteService InviteService
@inject IAuthService AuthService
@inject IAccountLockoutService AccountLockoutService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

@* Web admin user management - moved from /users page *@
<div>
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">User Management</MudText>
        @if (WebUser!.PermissionLevel >= PermissionLevel.GlobalAdmin)
        {
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.List"
                          OnClick="@ManageInvites">
                    Manage Invites
                </MudButton>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.PersonAdd"
                          OnClick="@CreateUser">
                    Create User
                </MudButton>
            </MudStack>
        }
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
            <MudText Typo="Typo.subtitle1">Filter by Status:</MudText>
            <MudSelect T="UserStatus"
                       MultiSelection="true"
                       SelectedValues="_selectedStatuses"
                       SelectedValuesChanged="OnStatusFilterChanged"
                       Label="Status Filter"
                       Variant="Variant.Outlined"
                       AnchorOrigin="Origin.BottomCenter"
                       Style="min-width: 300px;">
                <MudSelectItem T="UserStatus" Value="UserStatus.Active">Active</MudSelectItem>
                <MudSelectItem T="UserStatus" Value="UserStatus.Pending">Pending</MudSelectItem>
                <MudSelectItem T="UserStatus" Value="UserStatus.Disabled">Disabled</MudSelectItem>
                <MudSelectItem T="UserStatus" Value="UserStatus.Deleted">Deleted</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-4" Elevation="2">
        <MudTable Items="@_filteredUsers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
            <HeaderContent>
                <MudTh>Email</MudTh>
                <MudTh>Permission Level</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>TOTP Enabled</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Last Login</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Email">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                        <MudText>@context.WebUser.Email</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Permission Level">
                    <MudChip T="string" Size="Size.Small" Color="@GetPermissionColor((PermissionLevel)context.PermissionLevelInt)">
                        @GetPermissionName((PermissionLevel)context.PermissionLevelInt)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @context.Status.ToString()
                        </MudChip>
                        @if (context.IsLocked)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Lock">
                                Locked
                            </MudChip>
                        }
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="TOTP">
                    @if (context.TotpEnabled)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Success" Size="Size.Small" Title="2FA Enabled" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.SecurityUpdateWarning" Color="Color.Warning" Size="Size.Small" Title="2FA Not Enabled" />
                    }
                </MudTd>
                <MudTd DataLabel="Created">@FormatDate(context.CreatedAt)</MudTd>
                <MudTd DataLabel="Last Login">@FormatDate(context.LastLoginAt)</MudTd>
                <MudTd DataLabel="Actions">
                    @if (WebUser!.PermissionLevel >= PermissionLevel.GlobalAdmin && context.WebUser.Id != WebUser?.Id)
                    {
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true" AnchorOrigin="Origin.BottomRight">
                            @if (WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                            IconColor="Color.Primary"
                                            OnClick="@(() => EditUserPermission(context))">
                                    Edit Permission
                                </MudMenuItem>
                            }
                            @if (!context.EmailVerified)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Email"
                                            IconColor="Color.Info"
                                            OnClick="@(() => ResendVerificationEmail(context))">
                                    Resend Verification Email
                                </MudMenuItem>
                            }
                            @if (WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                @if (context.TotpEnabled)
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.LockOpen"
                                                IconColor="Color.Warning"
                                                OnClick="@(() => DisableTotp(context))">
                                        Disable TOTP
                                    </MudMenuItem>
                                }
                                else
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.Lock"
                                                IconColor="Color.Success"
                                                OnClick="@(() => EnableTotp(context))">
                                        Enable TOTP
                                    </MudMenuItem>
                                }
                                @if (!string.IsNullOrEmpty(context.TotpSecret))
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.RestartAlt"
                                                IconColor="Color.Error"
                                                OnClick="@(() => ResetTotp(context))">
                                        Reset TOTP
                                    </MudMenuItem>
                                }
                            }
                            @if (context.IsLocked)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.LockOpen"
                                            IconColor="Color.Warning"
                                            OnClick="@(() => UnlockAccount(context))">
                                    Unlock Account
                                </MudMenuItem>
                            }
                            @if (context.Status == UserStatus.Active && WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Block"
                                            IconColor="Color.Error"
                                            OnClick="@(() => DisableUser(context))">
                                    Disable User
                                </MudMenuItem>
                            }
                            else if (context.Status == UserStatus.Disabled && WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle"
                                            IconColor="Color.Success"
                                            OnClick="@(() => EnableUser(context))">
                                    Enable User
                                </MudMenuItem>
                            }
                            @if (context.Status == UserStatus.Deleted && WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.RestoreFromTrash"
                                            IconColor="Color.Success"
                                            OnClick="@(() => RestoreUser(context))">
                                    Restore User
                                </MudMenuItem>
                            }
                            else if (WebUser!.PermissionLevel >= PermissionLevel.Owner)
                            {
                                <MudDivider />
                                <MudMenuItem Icon="@Icons.Material.Filled.DeleteForever"
                                            IconColor="Color.Error"
                                            OnClick="@(() => DeleteUser(context))">
                                    Delete User
                                </MudMenuItem>
                            }
                        </MudMenu>
                    }
                    else if (context.WebUser.Id == WebUser?.Id)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">(You)</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">No permissions</MudText>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</div>

@code {
    [CascadingParameter] private WebUserIdentity? WebUser { get; set; }

    private List<UserRecord> _users = [];
    private List<UserRecord> _filteredUsers = [];
    private bool _loading = true;
    private IEnumerable<UserStatus>? _selectedStatuses = [UserStatus.Active, UserStatus.Pending, UserStatus.Disabled];

    protected override async Task OnInitializedAsync()
    {
        if (WebUser is null) return;

        await LoadUsersAsync();
    }

    private void OnStatusFilterChanged(IEnumerable<UserStatus>? selectedValues)
    {
        _selectedStatuses = selectedValues;
        FilterUsers();
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _users = await UserManagementService.GetAllUsersAsync();
            FilterUsers();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void FilterUsers()
    {
        if (_selectedStatuses == null || !_selectedStatuses.Any())
        {
            _filteredUsers = [];
        }
        else
        {
            _filteredUsers = _users
                .Where(u => _selectedStatuses.Contains(u.Status))
                .ToList();
        }
        StateHasChanged();
    }

    private async Task EditUserPermission(UserRecord user)
    {
        var parameters = new DialogParameters<PermissionDialog>
        {
            { p => p.CurrentPermissionLevel, (PermissionLevel)user.PermissionLevelInt },
            { p => p.UserEmail, user.WebUser.Email },
            { p => p.MaxPermissionLevel, WebUser!.PermissionLevel }
        };

        var dialog = await DialogService.ShowAsync<PermissionDialog>("Edit Permission Level", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: PermissionLevel newLevel })
        {
            // Validate that user isn't trying to escalate beyond their own permission level
            if (newLevel > WebUser!.PermissionLevel)
            {
                Snackbar.Add("You cannot assign a permission level higher than your own", Severity.Error);
                return;
            }

            try
            {
                await UserManagementService.UpdatePermissionLevelAsync(user.WebUser.Id, (int)newLevel, WebUser!.Id, (int)WebUser!.PermissionLevel);
                Snackbar.Add($"Updated {user.WebUser.Email} to {GetPermissionName(newLevel)}", Severity.Success);
                await LoadUsersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating permission: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DisableUser(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Disable User",
            $"Are you sure you want to disable {user.WebUser.Email}? They will not be able to log in.",
            yesText: "Disable", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await UserManagementService.UpdateStatusAsync(user.WebUser.Id, UserStatus.Disabled, WebUser!.Id);
                Snackbar.Add($"Disabled user {user.WebUser.Email}", Severity.Success);
                await LoadUsersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error disabling user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EnableUser(UserRecord user)
    {
        try
        {
            await UserManagementService.UpdateStatusAsync(user.WebUser.Id, UserStatus.Active, WebUser!.Id);
            Snackbar.Add($"Enabled user {user.WebUser.Email}", Severity.Success);
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error enabling user: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateUser()
    {
        if (WebUser == null)
        {
            Snackbar.Add("Unable to identify current user", Severity.Error);
            return;
        }

        var parameters = new DialogParameters<CreateInviteDialog> { { p => p.MaxPermissionLevel, WebUser!.PermissionLevel } };

        var dialog = await DialogService.ShowAsync<CreateInviteDialog>("Create User", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: not null })
        {
            try
            {
                // Extract validDays and permissionLevel from anonymous object
                var data = result.Data;
                var dataType = data.GetType();
                var validDaysProperty = dataType.GetProperty("ValidDays");
                var permissionLevelProperty = dataType.GetProperty("PermissionLevel");

                var validDays = validDaysProperty?.GetValue(data) as int? ?? 7;
                var permissionLevelEnum = permissionLevelProperty?.GetValue(data) as PermissionLevel? ?? PermissionLevel.Admin;
                var permissionLevel = (int)permissionLevelEnum; // Cast enum to int for service layer

                var token = await InviteService.CreateInviteWithPermissionAsync(WebUser!.Id, permissionLevel, (int)WebUser.PermissionLevel, validDays);
                var inviteLink = $"{Navigation.BaseUri}register?invite={token}";
                var expiresAt = DateTimeOffset.UtcNow.AddDays(validDays);

                // Show the invite link in a new dialog
                var linkParameters = new DialogParameters<CreateInviteDialog>
                {
                    { p => p.InviteLink, inviteLink },
                    { p => p.ExpiresAt, expiresAt }
                };

                await DialogService.ShowAsync<CreateInviteDialog>("Invite Link Created", linkParameters);
                Snackbar.Add("Invite created successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error creating invite: {ex.Message}", Severity.Error);
            }
        }
    }

    private static string GetPermissionName(PermissionLevel level) => level switch
    {
        PermissionLevel.Admin => "Admin",
        PermissionLevel.GlobalAdmin => "GlobalAdmin",
        PermissionLevel.Owner => "Owner",
        _ => "Unknown"
    };

    private static Color GetPermissionColor(PermissionLevel level) => level switch
    {
        PermissionLevel.Admin => Color.Default,
        PermissionLevel.GlobalAdmin => Color.Primary,
        PermissionLevel.Owner => Color.Secondary,
        _ => Color.Error
    };

    private static Color GetStatusColor(UserStatus status) => status switch
    {
        UserStatus.Pending => Color.Warning,
        UserStatus.Active => Color.Success,
        UserStatus.Disabled => Color.Error,
        UserStatus.Deleted => Color.Dark,
        _ => Color.Default
    };

    private async Task DeleteUser(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete User",
            $"Are you sure you want to permanently delete {user.WebUser.Email}? This action marks the user as deleted for audit purposes but keeps the record.",
            yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await UserManagementService.UpdateStatusAsync(user.WebUser.Id, UserStatus.Deleted, WebUser!.Id);
                Snackbar.Add($"Deleted user {user.WebUser.Email}", Severity.Success);
                await LoadUsersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DisableTotp(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Disable TOTP",
            $"Are you sure you want to disable TOTP for {user.WebUser.Email}?\n\n" +
            "This sets TotpEnabled=false, allowing them to bypass 2FA at login. " +
            "Their TOTP secret is preserved.",
            yesText: "Disable TOTP",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var success = await AuthService.AdminDisableTotpAsync(user.WebUser, WebUser!);
                if (success)
                {
                    Snackbar.Add($"Disabled TOTP for {user.WebUser.Email}", Severity.Success);
                    await LoadUsersAsync();
                }
                else
                {
                    Snackbar.Add($"Failed to disable TOTP for {user.WebUser.Email}. You may not have permission.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error disabling TOTP: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EnableTotp(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Enable TOTP",
            $"Are you sure you want to enable TOTP for {user.WebUser.Email}?\n\n" +
            "This sets TotpEnabled=true. If they have a TOTP secret, they'll need to verify. " +
            "If not, they'll be redirected to setup 2FA on next login.",
            yesText: "Enable TOTP",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var success = await AuthService.AdminEnableTotpAsync(user.WebUser, WebUser!);
                if (success)
                {
                    Snackbar.Add($"Enabled TOTP for {user.WebUser.Email}", Severity.Success);
                    await LoadUsersAsync();
                }
                else
                {
                    Snackbar.Add($"Failed to enable TOTP for {user.WebUser.Email}. You may not have permission.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error enabling TOTP: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ResetTotp(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Reset TOTP",
            $"Are you sure you want to reset TOTP for {user.WebUser.Email}?\n\n" +
            "This will:\n" +
            "• Wipe their TOTP secret and setup timestamp\n" +
            "• Set TotpEnabled=false (bypass 2FA)\n" +
            "• Invalidate their current session\n\n" +
            "User can log in normally until you re-enable TOTP.",
            yesText: "Reset TOTP", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var success = await AuthService.AdminResetTotpAsync(user.WebUser, WebUser!);
                if (success)
                {
                    Snackbar.Add($"Reset TOTP for {user.WebUser.Email}", Severity.Success);
                    await LoadUsersAsync();
                }
                else
                {
                    Snackbar.Add($"Failed to reset TOTP for {user.WebUser.Email}. You may not have permission.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error resetting TOTP: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task UnlockAccount(UserRecord user)
    {
        var timeRemaining = user.LockedUntil.HasValue
            ? (user.LockedUntil.Value - DateTimeOffset.UtcNow).TotalMinutes
            : 0;

        var confirmed = await DialogService.ShowMessageBox(
            "Unlock Account",
            $"Are you sure you want to manually unlock {user.WebUser.Email}?\n\n" +
            $"This account is currently locked until {user.LockedUntil:yyyy-MM-dd HH:mm:ss UTC} " +
            $"({Math.Ceiling(timeRemaining)} minutes remaining) due to failed login attempts.\n\n" +
            "Unlocking will:\n" +
            "• Clear the account lockout\n" +
            "• Reset failed login attempt counter\n" +
            "• Send an unlock notification email\n" +
            "• Allow the user to log in immediately",
            yesText: "Unlock Account", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await AccountLockoutService.UnlockAccountAsync(user.WebUser, WebUser!);
                Snackbar.Add($"Unlocked account for {user.WebUser.Email}", Severity.Success);
                await LoadUsersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error unlocking account: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ResendVerificationEmail(UserRecord user)
    {
        try
        {
            var success = await AuthService.ResendVerificationEmailAsync(user.WebUser.Email!);
            if (success)
            {
                Snackbar.Add($"Verification email sent to {user.WebUser.Email}", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Email already verified or user not found", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending verification email: {ex.Message}", Severity.Error);
        }
    }

    private async Task RestoreUser(UserRecord user)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Restore User",
            $"Are you sure you want to restore {user.WebUser.Email}? The user will be set to Active status and can log in again.",
            yesText: "Restore", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await UserManagementService.UpdateStatusAsync(user.WebUser.Id, UserStatus.Active, WebUser!.Id);
                Snackbar.Add($"Restored user {user.WebUser.Email}", Severity.Success);
                await LoadUsersAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error restoring user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ManageInvites()
    {
        var parameters = new DialogParameters<InviteManagementDialog>
        {
            { p => p.CurrentUserPermissionLevel, WebUser!.PermissionLevel }
        };
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };
        var dialog = await DialogService.ShowAsync<InviteManagementDialog>("Manage Invites", parameters, options);
        await dialog.Result;
    }

    private static string FormatDate(DateTimeOffset? timestamp)
    {
        if (!timestamp.HasValue) return "Never";
        return timestamp.Value.ToString("yyyy-MM-dd HH:mm");
    }
}
