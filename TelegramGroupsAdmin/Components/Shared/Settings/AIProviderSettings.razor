@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.Core.Services.AI
@using TelegramGroupsAdmin.Services
@inject ISystemConfigRepository ConfigRepository
@inject IAIServiceFactory AIServiceFactory
@inject IAuditService AuditService
@inject BlazorAuthHelper AuthHelper
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudGrid>
    <!-- Info Alert -->
    <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
            <MudText Typo="Typo.subtitle2"><strong>AI Provider Connections</strong></MudText>
            <MudText Typo="Typo.body2">
                Configure AI provider connections for spam detection, content translation,
                image/video analysis, and AI veto mode. Create multiple connections of the same type
                if needed (e.g., separate OpenAI accounts for different features).
            </MudText>
        </MudAlert>
    </MudItem>

    <!-- Add Connection Button -->
    <MudItem xs="12">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h6">Connections (@_config.Connections.Count)</MudText>
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                }
            </MudStack>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@OpenAddConnectionDialog">
                Add Connection
            </MudButton>
        </MudStack>
    </MudItem>

    <!-- Connection List -->
    @if (_config.Connections.Count == 0)
    {
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.CloudOff" Size="Size.Large" Color="Color.Default" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary">No AI connections configured</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Click "Add Connection" to configure your first AI provider.
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    }
    else
    {
        @foreach (var connection in _config.Connections)
        {
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Spacing="3">
                        <!-- Header -->
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetProviderIcon(connection.Provider)" Color="Color.Primary" />
                                <div>
                                    <MudText Typo="Typo.subtitle1"><strong>@connection.Id</strong></MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@GetProviderDisplayName(connection.Provider)</MudText>
                                </div>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudSwitch T="bool"
                                          Value="@connection.Enabled"
                                          ValueChanged="@((bool enabled) => ToggleConnectionAsync(connection, enabled))"
                                          Color="Color.Primary"
                                          Size="Size.Small" />
                                <MudChip T="string"
                                        Color="@(connection.Enabled ? Color.Success : Color.Default)"
                                        Size="Size.Small">
                                    @(connection.Enabled ? "Enabled" : "Disabled")
                                </MudChip>
                            </MudStack>
                        </MudStack>

                        <MudDivider />

                        <!-- Provider-specific fields -->
                        @if (connection.Provider == AIProviderType.AzureOpenAI)
                        {
                            <MudTextField Value="@connection.AzureEndpoint"
                                         ValueChanged="@((string val) => OnAzureEndpointChanged(connection, val))"
                                         Label="Azure Endpoint"
                                         Variant="Variant.Outlined"
                                         Placeholder="https://your-resource.openai.azure.com/"
                                         HelperText="Azure OpenAI Service endpoint URL"
                                         DebounceInterval="500"
                                         OnDebounceIntervalElapsed="@SaveConfigAsync" />
                            <MudTextField Value="@connection.AzureApiVersion"
                                         ValueChanged="@((string val) => OnAzureApiVersionChanged(connection, val))"
                                         Label="API Version"
                                         Variant="Variant.Outlined"
                                         HelperText="e.g., 2024-02-01"
                                         DebounceInterval="500"
                                         OnDebounceIntervalElapsed="@SaveConfigAsync" />
                        }
                        else if (connection.Provider == AIProviderType.LocalOpenAI)
                        {
                            <MudTextField Value="@connection.LocalEndpoint"
                                         ValueChanged="@((string val) => OnLocalEndpointChanged(connection, val))"
                                         Label="Endpoint URL"
                                         Variant="Variant.Outlined"
                                         Placeholder="http://localhost:11434/v1"
                                         HelperText="OpenAI-compatible API endpoint (Ollama, LM Studio, vLLM)"
                                         DebounceInterval="500"
                                         OnDebounceIntervalElapsed="@SaveConfigAsync" />
                            <MudSwitch T="bool"
                                      Value="@connection.LocalRequiresApiKey"
                                      ValueChanged="@((bool val) => OnLocalRequiresApiKeyChanged(connection, val))"
                                      Label="Requires API Key"
                                      Color="Color.Primary" />
                        }

                        <!-- API Key -->
                        @{
                            var apiKeyValue = GetApiKey(connection.Id);
                            var showKey = _visibleApiKeys.Contains(connection.Id);
                        }
                        <MudTextField Value="@apiKeyValue"
                                     ValueChanged="@((string val) => SetApiKey(connection.Id, val))"
                                     Label="API Key"
                                     Variant="Variant.Outlined"
                                     InputType="@(showKey ? InputType.Text : InputType.Password)"
                                     Placeholder="@GetApiKeyPlaceholder(connection.Provider)"
                                     HelperText="@GetApiKeyHelperText(connection.Provider)"
                                     Disabled="@(connection.Provider == AIProviderType.LocalOpenAI && !connection.LocalRequiresApiKey)"
                                     Adornment="Adornment.End"
                                     AdornmentIcon="@(showKey ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                     OnAdornmentClick="@(() => ToggleKeyVisibility(connection.Id))"
                                     DebounceInterval="500"
                                     OnDebounceIntervalElapsed="@SaveApiKeysAsync" />

                        <!-- Status -->
                        @{
                            var hasKey = !string.IsNullOrWhiteSpace(apiKeyValue);
                            var isReady = connection.Enabled && (hasKey || (connection.Provider == AIProviderType.LocalOpenAI && !connection.LocalRequiresApiKey));
                        }
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudChip T="string"
                                    Color="@(isReady ? Color.Success : Color.Warning)"
                                    Size="Size.Small"
                                    Icon="@(isReady ? Icons.Material.Filled.Check : Icons.Material.Filled.Warning)">
                                @(isReady ? "Ready" : (hasKey ? "Disabled" : "Needs API Key"))
                            </MudChip>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Error"
                                      Size="Size.Small"
                                      StartIcon="@Icons.Material.Filled.Delete"
                                      OnClick="@(() => DeleteConnectionAsync(connection))">
                                Delete
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }
    }

    <!-- Warning if no active connections -->
    @if (_config.Connections.Count > 0 && !_config.Connections.Any(c => c.Enabled))
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Warning" Dense="true">
                <strong>No Active Connections:</strong> Enable at least one connection with an API key.
                Until configured, AI spam detection, translation, and image analysis will be skipped.
            </MudAlert>
        </MudItem>
    }

    <!-- Feature Configuration Link -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h6">Feature Configuration</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Configure which connection to use for each feature (model selection, per-feature settings)
                    in <MudLink Href="/settings/content-detection/ai-integration">Content Detection â†’ AI Integration</MudLink>.
                </MudText>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private AIProviderConfig _config = new();
    private ApiKeysConfig _apiKeys = new();
    private bool _isSaving;
    private HashSet<string> _visibleApiKeys = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigAsync();
    }

    private async Task LoadConfigAsync()
    {
        try
        {
            var config = await ConfigRepository.GetAIProviderConfigAsync();
            _config = config ?? new AIProviderConfig();

            var apiKeys = await ConfigRepository.GetApiKeysAsync();
            _apiKeys = apiKeys ?? new ApiKeysConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new AIProviderConfig();
            _apiKeys = new ApiKeysConfig();
        }
    }

    private async Task SaveConfigAsync()
    {
        if (_isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            await ConfigRepository.SaveAIProviderConfigAsync(_config);
            await LogAuditAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SaveApiKeysAsync()
    {
        if (_isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            await ConfigRepository.SaveApiKeysAsync(_apiKeys);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving API keys: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SaveAllAsync()
    {
        if (_isSaving) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            await ConfigRepository.SaveAIProviderConfigAsync(_config);
            await ConfigRepository.SaveApiKeysAsync(_apiKeys);
            await LogAuditAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task LogAuditAsync()
    {
        var userId = await AuthHelper.GetCurrentUserIdAsync();
        if (!string.IsNullOrEmpty(userId))
        {
            var enabledCount = _config.Connections.Count(c => c.Enabled);
            await AuditService.LogEventAsync(
                AuditEventType.ConfigurationChanged,
                Actor.FromWebUser(userId),
                Actor.FromWebUser(userId),
                $"ai_providers:connections={_config.Connections.Count}:enabled={enabledCount}");
        }
    }

    private async Task OpenAddConnectionDialog()
    {
        var parameters = new DialogParameters<AddAIConnectionDialog>
        {
            { x => x.ExistingIds, _config.Connections.Select(c => c.Id).ToList() }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<AddAIConnectionDialog>("Add AI Connection", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AIConnection newConnection })
        {
            _config.Connections.Add(newConnection);
            await SaveConfigAsync();
        }
    }

    private async Task ToggleConnectionAsync(AIConnection connection, bool enabled)
    {
        connection.Enabled = enabled;
        await SaveConfigAsync();
    }

    private void OnAzureEndpointChanged(AIConnection connection, string value)
    {
        connection.AzureEndpoint = value;
    }

    private void OnAzureApiVersionChanged(AIConnection connection, string value)
    {
        connection.AzureApiVersion = value;
    }

    private void OnLocalEndpointChanged(AIConnection connection, string value)
    {
        connection.LocalEndpoint = value;
    }

    private async Task OnLocalRequiresApiKeyChanged(AIConnection connection, bool value)
    {
        connection.LocalRequiresApiKey = value;
        await SaveConfigAsync();
    }

    private async Task DeleteConnectionAsync(AIConnection connection)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Connection",
            $"Are you sure you want to delete the connection '{connection.Id}'? This cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            _config.Connections.Remove(connection);
            _apiKeys.AIConnectionKeys.Remove(connection.Id);
            await SaveAllAsync();
        }
    }

    private string GetApiKey(string connectionId)
    {
        return _apiKeys.GetAIConnectionKey(connectionId) ?? "";
    }

    private void SetApiKey(string connectionId, string value)
    {
        _apiKeys.SetAIConnectionKey(connectionId, value);
    }

    private void ToggleKeyVisibility(string connectionId)
    {
        if (_visibleApiKeys.Contains(connectionId))
            _visibleApiKeys.Remove(connectionId);
        else
            _visibleApiKeys.Add(connectionId);
    }

    private static string GetProviderDisplayName(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => "OpenAI (api.openai.com)",
        AIProviderType.AzureOpenAI => "Azure OpenAI Service",
        AIProviderType.LocalOpenAI => "Local / OpenAI-compatible",
        _ => provider.ToString()
    };

    private static string GetProviderIcon(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => Icons.Material.Filled.Cloud,
        AIProviderType.AzureOpenAI => Icons.Material.Filled.CloudQueue,
        AIProviderType.LocalOpenAI => Icons.Material.Filled.Computer,
        _ => Icons.Material.Filled.Psychology
    };

    private static string GetApiKeyPlaceholder(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => "sk-...",
        AIProviderType.AzureOpenAI => "Azure API key",
        AIProviderType.LocalOpenAI => "Optional API key",
        _ => "API key"
    };

    private static string GetApiKeyHelperText(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => "Get your API key from https://platform.openai.com/api-keys",
        AIProviderType.AzureOpenAI => "Azure OpenAI Service API key from Azure Portal",
        AIProviderType.LocalOpenAI => "Leave empty if your provider doesn't require authentication",
        _ => ""
    };
}
