@* TODO: Playwright E2E tests needed for:
   - Verifying dropdown shows correct options based on MaxPermissionLevel
   - Testing option selection changes the selected value
   - Testing form submission returns correct permission level
   bUnit cannot fully test MudSelect dropdown items (rendered via JS popover)
*@
<MudDialog>
    <DialogContent>
        @if (string.IsNullOrEmpty(_inviteLink))
        {
            <MudText Class="mb-4">Invite a new user to register</MudText>

            <MudSelect @bind-Value="_permissionLevel"
                      Label="Permission Level"
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      HelperText="Access level for the new user">
                <MudSelectItem Value="PermissionLevel.Admin">Admin - Chat-scoped moderation</MudSelectItem>
                @if (MaxPermissionLevel >= PermissionLevel.GlobalAdmin)
                {
                    <MudSelectItem Value="PermissionLevel.GlobalAdmin">GlobalAdmin - Global moderation</MudSelectItem>
                }
                @if (MaxPermissionLevel >= PermissionLevel.Owner)
                {
                    <MudSelectItem Value="PermissionLevel.Owner">Owner - Full system access</MudSelectItem>
                }
            </MudSelect>

            <MudNumericField @bind-Value="_validDays"
                            Label="Invite valid for (days)"
                            Min="1"
                            Max="365"
                            Variant="Variant.Outlined"
                            HelperText="How long until the invite link expires" />
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mb-4">Invite Link Created</MudText>

            <MudAlert Severity="Severity.Success" Class="mb-4">
                Send this link to the new user to complete registration:
            </MudAlert>

            <MudTextField @bind-Value="_inviteLink"
                         Label="Invite Link"
                         Variant="Variant.Outlined"
                         ReadOnly="true"
                         Adornment="Adornment.End"
                         AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                         OnAdornmentClick="CopyToClipboard" />

            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                Expires: @_expiresAt
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        @if (string.IsNullOrEmpty(_inviteLink))
        {
            <MudButton OnClick="@Cancel">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@Submit">Generate Invite</MudButton>
        }
        else
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@Close">Done</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public string? InviteLink { get; set; }

    [Parameter]
    public DateTimeOffset? ExpiresAt { get; set; }

    /// <summary>
    /// The maximum permission level that can be granted via this invite.
    /// Defaults to Admin (lowest) for security - callers must explicitly set higher levels.
    /// </summary>
    [Parameter]
    public PermissionLevel MaxPermissionLevel { get; set; } = PermissionLevel.Admin;

    private int _validDays = 7;
    private PermissionLevel _permissionLevel = PermissionLevel.Admin; // Default to Admin (chat-scoped)
    private string? _inviteLink;
    private string? _expiresAt;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(InviteLink))
        {
            _inviteLink = InviteLink;
            if (ExpiresAt.HasValue)
            {
                _expiresAt = ExpiresAt.Value.ToString("yyyy-MM-dd HH:mm");
            }
        }

        // Ensure permission level defaults to Admin and doesn't exceed max
        if (_permissionLevel > MaxPermissionLevel)
        {
            _permissionLevel = PermissionLevel.Admin;
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private void Submit()
    {
        // Validate permission level doesn't exceed max (defense in depth)
        var safePermissionLevel = _permissionLevel > MaxPermissionLevel ? PermissionLevel.Admin : _permissionLevel;

        // Return both validDays and permissionLevel (as enum)
        MudDialog?.Close(DialogResult.Ok(new { ValidDays = _validDays, PermissionLevel = safePermissionLevel }));
    }

    private void Close()
    {
        MudDialog?.Close(DialogResult.Ok(true));
    }

    private void CopyToClipboard()
    {
        // Note: Actual clipboard copying requires JS interop
        // For now just show it's been "copied"
    }
}
