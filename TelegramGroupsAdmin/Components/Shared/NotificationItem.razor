@using TelegramGroupsAdmin.Core.Models

<MudPaper Class="@GetItemClass()" Elevation="0">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
        <MudIcon Icon="@GetIcon()" Size="Size.Small" Color="@GetIconColor()" Class="mt-1" />
        <MudStack Spacing="0" Style="flex: 1; min-width: 0;">
            <MudText Typo="Typo.body2"><b>@Notification.Subject</b></MudText>
            <MudText Typo="Typo.caption" Class="text-truncate-multiline">@TruncateMessage(Notification.Message, 100)</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">@FormatTimeAgo(Notification.CreatedAt)</MudText>
        </MudStack>
        <MudStack Row="true" Spacing="0">
            @if (!Notification.IsRead)
            {
                <MudTooltip Text="Mark as read">
                    <MudIconButton Icon="@Icons.Material.Filled.Check"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   OnClick="@OnMarkRead" />
                </MudTooltip>
            }
            <MudTooltip Text="Delete">
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Size="Size.Small"
                               Color="Color.Default"
                               OnClick="@OnDelete" />
            </MudTooltip>
        </MudStack>
    </MudStack>
</MudPaper>

<style>
    .text-truncate-multiline {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
    }
</style>

@code {
    [Parameter, EditorRequired]
    public WebNotification Notification { get; set; } = null!;

    [Parameter]
    public EventCallback OnMarkRead { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    private string GetItemClass()
    {
        var baseClass = "pa-2 cursor-pointer notification-item";
        return Notification.IsRead
            ? baseClass
            : $"{baseClass} notification-unread";
    }

    private string GetIcon() => Notification.EventType switch
    {
        NotificationEventType.SpamDetected => Icons.Material.Filled.Warning,
        NotificationEventType.SpamAutoDeleted => Icons.Material.Filled.DeleteSweep,
        NotificationEventType.UserBanned => Icons.Material.Filled.Block,
        NotificationEventType.MessageReported => Icons.Material.Filled.Report,
        NotificationEventType.MalwareDetected => Icons.Material.Filled.BugReport,
        NotificationEventType.ChatAdminChanged => Icons.Material.Filled.AdminPanelSettings,
        NotificationEventType.ChatHealthWarning => Icons.Material.Filled.HealthAndSafety,
        NotificationEventType.BackupFailed => Icons.Material.Filled.CloudOff,
        _ => Icons.Material.Filled.Notifications
    };

    private Color GetIconColor() => Notification.EventType switch
    {
        NotificationEventType.SpamDetected => Color.Warning,
        NotificationEventType.SpamAutoDeleted => Color.Warning,
        NotificationEventType.UserBanned => Color.Error,
        NotificationEventType.MalwareDetected => Color.Error,
        NotificationEventType.BackupFailed => Color.Error,
        NotificationEventType.ChatHealthWarning => Color.Warning,
        _ => Color.Default
    };

    private static string TruncateMessage(string message, int maxLength)
    {
        if (string.IsNullOrEmpty(message) || message.Length <= maxLength)
            return message;

        return message[..(maxLength - 3)] + "...";
    }

    private static string FormatTimeAgo(DateTimeOffset timestamp)
    {
        var span = DateTimeOffset.UtcNow - timestamp;

        if (span.TotalMinutes < 1)
            return "just now";
        if (span.TotalMinutes < 60)
            return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24)
            return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays}d ago";

        return timestamp.ToString("MMM d");
    }
}
