@using TelegramGroupsAdmin.Configuration
@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Services
@using TelegramGroupsAdmin.Configuration.Repositories
@inject IConfigService ConfigService
@inject IConfigRepository ConfigRepository
@inject IMessageHistoryService MessageHistoryService
@inject ISnackbar Snackbar

<!-- Bot Service Control (Global Only) -->
<MudPaper Class="pa-4 mb-4" Elevation="1">
    <MudText Typo="Typo.h6" GutterBottom="true">Bot Service Control</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Enable or disable the Telegram bot polling service. When disabled, the bot stops responding to all updates.
    </MudText>

    @if (_loadingBotConfig)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_botConfig != null)
    {
        <MudGrid>
            <MudItem xs="12">
                <MudSwitch @bind-Value="_botConfig.BotEnabled"
                           Color="Color.Primary"
                           Label="Enable Telegram Bot Service" />
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Master switch for the entire bot service (applies globally to all chats)
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="_botConfig.ApiServerUrl"
                              Label="Bot API Server URL (Optional)"
                              Variant="Variant.Outlined"
                              Placeholder="http://bot-api-server:8081"
                              HelperText="Leave empty for standard api.telegram.org (20MB file limit)"
                              Clearable="true" />
                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                    Configure a self-hosted Bot API server to download files >20MB. See documentation below.
                </MudText>
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-start gap-2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveBotConfig"
                           Disabled="_savingBotConfig">
                    @if (_savingBotConfig)
                    {
                        <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Bot Service Settings</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-4">
            <MudText Typo="Typo.body2">
                <strong>Note:</strong> Changes take effect immediately. The bot will start or stop automatically without requiring an application restart.
            </MudText>
        </MudAlert>

        <MudExpansionPanels Class="mt-4">
            <MudExpansionPanel Text="Self-Hosted Bot API Server Setup" Icon="@Icons.Material.Filled.CloudUpload">
                <MudText Typo="Typo.body2" Class="mb-2">
                    <strong>Why use a self-hosted Bot API server?</strong><br/>
                    • Download files larger than 20MB (up to 2GB)<br/>
                    • Improved file download performance<br/>
                    • Full control over file storage and processing
                </MudText>

                <MudDivider Class="my-3" />

                <MudText Typo="Typo.subtitle2" Class="mb-2">Quick Start with Docker Compose</MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    1. Add to your docker-compose.yml:
                </MudText>
                <MudPaper Class="pa-3 mb-3" Style="background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto;">
<pre>services:
  telegram-bot-api:
    image: aiogram/telegram-bot-api:latest
    environment:
      - TELEGRAM_API_ID=YOUR_API_ID
      - TELEGRAM_API_HASH=YOUR_API_HASH
    volumes:
      - telegram-bot-api-data:/var/lib/telegram-bot-api
    ports:
      - "8081:8081"
    restart: unless-stopped
    command: --local

volumes:
  telegram-bot-api-data:</pre>
                </MudPaper>

                <MudText Typo="Typo.body2" Class="mb-2">
                    2. Get API credentials from <a href="https://my.telegram.org/apps" target="_blank">https://my.telegram.org/apps</a><br/>
                    3. Set API Server URL above to: <code>http://telegram-bot-api:8081</code><br/>
                    4. Save configuration and restart the bot service
                </MudText>

                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-3">
                    <strong>Important:</strong> The <code>--local</code> flag is required for unlimited file downloads. Without it, the 20MB limit still applies.
                </MudAlert>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudPaper>

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h6" GutterBottom="true">Bot Protection Settings</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Configure bot protection features to prevent unauthorized bots from joining chats.
    </MudText>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_config != null)
    {
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudGrid>
                <!-- Bot Protection Section -->
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Bot Protection</MudText>
                    <MudDivider Class="mb-3" />
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_config.Enabled" Color="Color.Primary" Label="Enable Bot Protection" />
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Master switch for all bot protection features
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_config.AutoBanBots"
                               Color="Color.Primary"
                               Label="Auto-Ban Unauthorized Bots"
                               Disabled="!_config.Enabled" />
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Automatically ban bots that join without admin invitation
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_config.AllowAdminInvitedBots"
                               Color="Color.Primary"
                               Label="Allow Admin-Invited Bots"
                               Disabled="!_config.Enabled || !_config.AutoBanBots" />
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Allow bots that are invited by chat administrators
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudSwitch @bind-Value="_config.LogBotEvents"
                               Color="Color.Primary"
                               Label="Log Bot Events"
                               Disabled="!_config.Enabled" />
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Log all bot join/ban events to the audit trail
                    </MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Whitelisted Bots</MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                        Bots on this list will always be allowed to join (one username per line, with or without @@)
                    </MudText>
                    <MudTextField @bind-Value="_whitelistText"
                                  Label="Whitelisted Bot Usernames"
                                  Lines="5"
                                  Variant="Variant.Outlined"
                                  Disabled="!_config.Enabled || !_config.AutoBanBots"
                                  HelperText="Example: RoseBot or GroupButlerBot" />
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-space-between">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveConfig"
                               Disabled="!_isValid || _saving">
                        @if (_saving)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Configuration</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               OnClick="LoadDefaults"
                               Disabled="_saving">
                        Reset to Defaults
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>

        <MudDivider Class="my-4" />

        <MudAlert Severity="Severity.Info" Class="mt-4">
            <MudText Typo="Typo.body2">
                <strong>How Bot Protection Works:</strong><br/>
                • When a bot attempts to join, it's checked against the whitelist<br/>
                • If not whitelisted, it checks if the bot was invited by a chat admin<br/>
                • Unauthorized bots are automatically banned and logged to the audit trail<br/>
                • This protects against profile-based spam attacks and bot raids
            </MudText>
        </MudAlert>
    }
    else
    {
        <MudAlert Severity="Severity.Error">Failed to load configuration</MudAlert>
    }
</MudPaper>

<MudPaper Class="pa-4 mt-4" Elevation="1">
    <MudText Typo="Typo.h6" GutterBottom="true">Cached Invite Links (Global)</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Bulk clear all cached invite links across all managed chats.
    </MudText>

    <MudButton Variant="Variant.Outlined"
               Color="Color.Warning"
               StartIcon="@Icons.Material.Filled.DeleteSweep"
               OnClick="ClearAllInviteLinks"
               Disabled="_clearingLinks">
        @if (_clearingLinks)
        {
            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
            <span>Clearing...</span>
        }
        else
        {
            <span>Clear All Cached Links</span>
        }
    </MudButton>

    <MudAlert Severity="Severity.Info" Class="mt-4">
        <MudText Typo="Typo.body2">
            <strong>Per-Chat Management:</strong><br/>
            • To clear a single chat's cached link, go to that chat's configuration dialog (Health & Status tab)<br/>
            • Use this global button only when regenerating all invite links at once<br/>
            <br/>
            <strong>Note:</strong> The next health check (within 1 minute) will automatically cache new links.
        </MudText>
    </MudAlert>
</MudPaper>

@code {
    private MudForm? _form;
    private bool _isValid = true;
    private bool _loading = true;
    private bool _saving;
    private bool _clearingLinks;
    private BotProtectionConfig? _config;
    private string _whitelistText = "";

    // Bot service control
    private bool _loadingBotConfig = true;
    private bool _savingBotConfig;
    private TelegramBotConfig? _botConfig;

    protected override async Task OnInitializedAsync()
    {
        // Load sequentially to avoid DbContext threading issues
        await LoadBotConfig();
        await LoadConfig();
    }

    private async Task LoadBotConfig()
    {
        _loadingBotConfig = true;
        try
        {
            // Load global bot config (chat_id = 0 for global config)
            _botConfig = await ConfigService.GetAsync<TelegramBotConfig>(ConfigType.TelegramBot, 0)
                         ?? TelegramBotConfig.Default;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load bot service configuration: {ex.Message}", Severity.Error);
            _botConfig = TelegramBotConfig.Default;
        }
        finally
        {
            _loadingBotConfig = false;
        }
    }

    private async Task SaveBotConfig()
    {
        if (_botConfig == null) return;

        _savingBotConfig = true;
        try
        {
            // Save as global config (chat_id = 0)
            await ConfigService.SaveAsync(ConfigType.TelegramBot, 0, _botConfig);

            // Notify bot service to check config and start/stop immediately
            MessageHistoryService.NotifyConfigChange();

            Snackbar.Add("Bot service configuration saved. Changes will take effect immediately.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save bot service configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingBotConfig = false;
        }
    }

    private async Task LoadConfig()
    {
        _loading = true;
        try
        {
            _config = await ConfigService.GetEffectiveAsync<BotProtectionConfig>(ConfigType.UrlFilter, null)
                      ?? BotProtectionConfig.Default;

            // Convert whitelist to text (one per line)
            _whitelistText = string.Join(Environment.NewLine, _config.WhitelistedBots);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveConfig()
    {
        if (_config == null || !_isValid) return;

        _saving = true;
        try
        {
            // Parse whitelist text into list (split by newlines, trim, remove empties)
            _config.WhitelistedBots = _whitelistText
                .Split(['\r', '\n'], StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .ToList();

            await ConfigService.SaveAsync(ConfigType.UrlFilter, null, _config);
            Snackbar.Add("Bot protection configuration saved globally", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void LoadDefaults()
    {
        _config = BotProtectionConfig.Default;
        _whitelistText = "";
        Snackbar.Add("Defaults loaded. Click 'Save Configuration' to apply.", Severity.Info);
    }

    private async Task ClearAllInviteLinks()
    {
        _clearingLinks = true;
        try
        {
            await ConfigRepository.ClearAllInviteLinksAsync();

            Snackbar.Add(
                "Cleared all cached invite links. The next health check (within 1 minute) will fetch fresh links from Telegram.",
                Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to clear invite links: {ex.Message}", Severity.Error);
        }
        finally
        {
            _clearingLinks = false;
        }
    }
}
