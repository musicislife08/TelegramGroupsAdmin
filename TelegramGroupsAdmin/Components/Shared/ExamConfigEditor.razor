@using TelegramGroupsAdmin.Telegram.Models
@using TelegramGroupsAdmin.Telegram.Extensions
@using TelegramGroupsAdmin.Telegram.Services.Welcome
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="0">
    @* Multiple Choice Questions Section *@
    <MudGrid>
        <MudItem xs="12">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckBox" Size="Size.Small" />
                <MudText Typo="Typo.subtitle2">Multiple Choice Questions</MudText>
                @if (Config?.HasMcQuestions == true)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">
                        @Config.McQuestions.Count question(s)
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Optional</MudChip>
                }
            </MudStack>
            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                Add 1-4 questions. The first answer is always correct; others are wrong. Answers are shuffled when shown to users.
            </MudText>
        </MudItem>

        <MudItem xs="12" lg="6">
            @if (Config != null)
            {
                @for (var i = 0; i < Config.McQuestions.Count; i++)
                {
                    var questionIndex = i;
                    var question = Config.McQuestions[questionIndex];

                    <MudPaper Class="pa-3 mb-3" Elevation="1" Outlined="true">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Question @(questionIndex + 1)</MudText>
                            <MudTooltip Text="Remove question">
                                <MudIconButton Icon="@Icons.Material.Filled.Close"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveQuestion(questionIndex))" />
                            </MudTooltip>
                        </MudStack>

                        <MudTextField @bind-Value="question.Question"
                                      Label="Question"
                                      Variant="Variant.Outlined"
                                      Class="mb-3"
                                      Immediate="true"
                                      Placeholder="e.g., What is this group about?" />

                        @for (var j = 0; j < question.Answers.Count; j++)
                        {
                            var answerIndex = j;
                            var isCorrect = answerIndex == 0;

                            <MudTextField Value="@question.Answers[answerIndex]"
                                          ValueChanged="@((string val) => UpdateAnswer(questionIndex, answerIndex, val))"
                                          Label="@(isCorrect ? "Correct Answer" : $"Wrong Answer {answerIndex + 1}")"
                                          Variant="Variant.Outlined"
                                          Class="mb-2"
                                          Immediate="true"
                                          Adornment="@(isCorrect ? Adornment.Start : Adornment.None)"
                                          AdornmentIcon="@Icons.Material.Filled.Check"
                                          AdornmentColor="Color.Success"
                                          Placeholder="@(isCorrect ? "The correct answer" : "A wrong answer")" />
                        }

                        <MudStack Row="true" Spacing="2" Class="mt-2">
                            @if (question.Answers.Count < 4)
                            {
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="@(() => AddAnswer(questionIndex))">
                                    Add Wrong Answer
                                </MudButton>
                            }
                            @if (question.Answers.Count > 2)
                            {
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Remove"
                                           OnClick="@(() => RemoveLastAnswer(questionIndex))">
                                    Remove Last Answer
                                </MudButton>
                            }
                        </MudStack>
                    </MudPaper>
                }

                @if (Config.McQuestions.Count < 4)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="AddQuestion"
                               Class="mb-3">
                        Add Question
                    </MudButton>
                }

                @if (Config.HasMcQuestions)
                {
                    <MudNumericField @bind-Value="Config.McPassingThreshold"
                                     Label="Passing Threshold (%)"
                                     Min="1"
                                     Max="100"
                                     HelperText="Percentage of questions that must be answered correctly (e.g., 80% means 4 out of 5)" />
                }
            }
        </MudItem>

        @* MC Preview *@
        <MudItem xs="12" lg="6">
            @if (Config?.HasMcQuestions == true)
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                    Preview (In DM):
                </MudText>
                <TelegramMessagePreview
                    PreviewText="@GetMcQuestionPreview()"
                    ShowUserCommand="false"
                    ShowWarning="false"
                    Buttons="@GetMcAnswerButtons()" />
            }
            else
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Add a question to see the preview
                </MudText>
            }
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-4" />

    @* Open-Ended Question Section *@
    <MudGrid>
        <MudItem xs="12">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.TextFields" Size="Size.Small" />
                <MudText Typo="Typo.subtitle2">Open-Ended Question</MudText>
                @if (Config?.HasOpenEndedQuestion == true)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Configured</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Optional</MudChip>
                }
            </MudStack>
            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                Ask a question that requires a text response. AI evaluates the answer based on criteria you define.
            </MudText>
        </MudItem>

        <MudItem xs="12" lg="6">
            @if (Config != null)
            {
                <MudTextField @bind-Value="Config.OpenEndedQuestion"
                              Label="Question"
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              Immediate="true"
                              Placeholder="e.g., Why do you want to join this group?" />

                <MudTextField @bind-Value="Config.GroupTopic"
                              Label="Group Topic (for AI context)"
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              Immediate="true"
                              HelperText="Describe what your group is about so AI can evaluate answers appropriately"
                              Placeholder="e.g., Technology support community for developers" />

                <MudTextField @bind-Value="Config.EvaluationCriteria"
                              Label="Evaluation Criteria"
                              Variant="Variant.Outlined"
                              Lines="6"
                              Class="mb-3"
                              Immediate="true"
                              HelperText="Define what makes an answer pass or fail. Leave blank to auto-generate."
                              Placeholder="PASS if answer:&#10;- Shows genuine interest in the topic&#10;- Demonstrates understanding of group purpose&#10;&#10;FAIL if answer:&#10;- Generic or very short response&#10;- Off-topic or promotional" />

                @if (!string.IsNullOrWhiteSpace(Config.OpenEndedQuestion) && !string.IsNullOrWhiteSpace(Config.GroupTopic))
                {
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.AutoAwesome"
                                   OnClick="GenerateCriteria">
                            @if (string.IsNullOrWhiteSpace(Config.EvaluationCriteria))
                            {
                                <span>Generate Criteria with AI</span>
                            }
                            else
                            {
                                <span>Edit Criteria with AI</span>
                            }
                        </MudButton>
                    </MudStack>
                }
            }
        </MudItem>

        @* Open-Ended Preview *@
        <MudItem xs="12" lg="6">
            @if (Config?.HasOpenEndedQuestion == true)
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                    Preview (In DM):
                </MudText>
                <TelegramMessagePreview
                    PreviewText="@GetOpenEndedPreview()"
                    ShowUserCommand="false"
                    ShowWarning="false"
                    Buttons="@(Array.Empty<string[]>())" />
                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-2">
                    User sends their answer as a message
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Add a question to see the preview
                </MudText>
            }
        </MudItem>
    </MudGrid>

    @* Validation Warning *@
    @if (Config != null && !Config.IsValid)
    {
        <MudAlert Severity="Severity.Warning" Class="mt-3">
            At least one question type (multiple choice or open-ended) must be configured for the entrance exam.
        </MudAlert>
    }

    @* Passing Requirements Info *@
    @if (Config != null && Config.HasMcQuestions && Config.HasOpenEndedQuestion)
    {
        <MudAlert Severity="Severity.Info" Class="mt-3" Icon="@Icons.Material.Filled.Info">
            When both question types are configured, users must pass <strong>both</strong> to gain access.
        </MudAlert>
    }
</MudPaper>

@code {
    /// <summary>
    /// The chat this configuration is for. Null for global default.
    /// </summary>
    [Parameter]
    public ManagedChatRecord? Chat { get; set; }

    [Parameter]
    public ExamConfig? Config { get; set; }

    [Parameter]
    public EventCallback<ExamConfig?> ConfigChanged { get; set; }

    protected override void OnParametersSet()
    {
        // Ensure we have a config object to work with
        if (Config == null)
        {
            Config = new ExamConfig();
            ConfigChanged.InvokeAsync(Config);
        }
    }

    private void AddQuestion()
    {
        if (Config == null || Config.McQuestions.Count >= 4) return;

        Config.McQuestions.Add(new ExamMcQuestion
        {
            Question = "",
            Answers = ["", ""] // Start with correct + 1 wrong
        });
        NotifyConfigChanged();
    }

    private void RemoveQuestion(int index)
    {
        if (Config == null || index < 0 || index >= Config.McQuestions.Count) return;

        Config.McQuestions.RemoveAt(index);
        NotifyConfigChanged();
    }

    private void AddAnswer(int questionIndex)
    {
        if (Config == null) return;
        var question = Config.McQuestions[questionIndex];
        if (question.Answers.Count >= 4) return;

        question.Answers.Add("");
        NotifyConfigChanged();
    }

    private void RemoveLastAnswer(int questionIndex)
    {
        if (Config == null) return;
        var question = Config.McQuestions[questionIndex];
        if (question.Answers.Count <= 2) return;

        question.Answers.RemoveAt(question.Answers.Count - 1);
        NotifyConfigChanged();
    }

    private void UpdateAnswer(int questionIndex, int answerIndex, string value)
    {
        if (Config == null) return;
        Config.McQuestions[questionIndex].Answers[answerIndex] = value;
        NotifyConfigChanged();
    }

    private async Task GenerateCriteria()
    {
        if (Config == null || string.IsNullOrWhiteSpace(Config.OpenEndedQuestion) || string.IsNullOrWhiteSpace(Config.GroupTopic))
            return;

        var parameters = new DialogParameters<ExamCriteriaBuilderDialog>
        {
            { x => x.Chat, Chat },
            { x => x.Question, Config.OpenEndedQuestion },
            { x => x.GroupTopic, Config.GroupTopic },
            { x => x.ExistingCriteria, Config.EvaluationCriteria }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<ExamCriteriaBuilderDialog>(
            "Generate Evaluation Criteria",
            parameters,
            options);

        var result = await dialog.Result;

        if (result is { Canceled: false, Data: string generatedCriteria })
        {
            Config.EvaluationCriteria = generatedCriteria;
            NotifyConfigChanged();

            var chatContext = Chat != null ? $" for {Chat.Chat.ToLogInfo()}" : "";
            Snackbar.Add($"Evaluation criteria saved{chatContext}!", Severity.Success);
        }
    }

    private void NotifyConfigChanged()
    {
        ConfigChanged.InvokeAsync(Config);
        StateHasChanged();
    }

    // Preview helper methods - use ExamMessageBuilder to ensure preview matches actual messages
    private string GetMcQuestionPreview()
    {
        if (Config?.McQuestions == null || Config.McQuestions.Count == 0)
            return "(No questions configured)";

        var q = Config.McQuestions[0];
        var questionText = string.IsNullOrEmpty(q.Question) ? "(Question text)" : q.Question;
        return ExamMessageBuilder.FormatMcQuestion("@SampleUser", 1, Config.McQuestions.Count, questionText);
    }

    private string[][] GetMcAnswerButtons()
    {
        if (Config?.McQuestions == null || Config.McQuestions.Count == 0)
            return [];

        var answers = Config.McQuestions[0].Answers;
        return answers.Select((a, i) => new[] { $"{(char)('A' + i)}) {(string.IsNullOrEmpty(a) ? "(Answer)" : a)}" }).ToArray();
    }

    private string GetOpenEndedPreview()
    {
        if (string.IsNullOrEmpty(Config?.OpenEndedQuestion))
            return "(No question configured)";

        return ExamMessageBuilder.FormatOpenEndedQuestion("@SampleUser", Config.OpenEndedQuestion);
    }
}
