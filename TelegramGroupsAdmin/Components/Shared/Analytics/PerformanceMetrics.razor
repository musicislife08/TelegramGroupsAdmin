@using TelegramGroupsAdmin.Telegram.Repositories
@using TelegramGroupsAdmin.Telegram.Models
@using ApexCharts
@using Microsoft.JSInterop
@using MudColor = MudBlazor.Color
@using MudSize = MudBlazor.Size
@using MudAlign = MudBlazor.Align
@inject IAnalyticsRepository AnalyticsRepository
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudStack Spacing="4">
    @* Date Range Selector *@
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">Performance Metrics</MudText>
            <MudStack Row="true" Spacing="2">
                <MudButtonGroup Variant="Variant.Outlined" Color="MudColor.Primary">
                    <MudButton OnClick="() => LoadLast7Days()">Last 7 Days</MudButton>
                    <MudButton OnClick="() => LoadLast30Days()">Last 30 Days</MudButton>
                    <MudButton OnClick="() => LoadAllTime()">All Time</MudButton>
                </MudButtonGroup>
                <MudButton Variant="Variant.Filled"
                          Color="MudColor.Primary"
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="LoadData"
                          Disabled="@_loading">
                    Refresh
                </MudButton>
            </MudStack>
        </MudStack>

        @if (_startDate.HasValue && _endDate.HasValue)
        {
            <MudText Typo="Typo.caption" Color="MudColor.Secondary" Class="mt-2">
                Showing data from @_startDate.Value.ToString("MMM dd, yyyy") to @_endDate.Value.ToString("MMM dd, yyyy")
            </MudText>
        }
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Color="MudColor.Primary" Indeterminate="true" />
    }

    @* Key Metrics - Single Wide Card with Stacked Rows *@
    @if (_accuracyStats != null && _responseTimeStats != null && _dailyTrends != null)
    {
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Color="MudColor.Primary">Performance Overview</MudText>

                <!-- Overall Accuracy (with bar) -->
                <MudStack Spacing="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="@GetAccuracyColor()" />
                        <MudText Typo="Typo.body1" Style="flex: 1;">Overall Accuracy</MudText>
                        <MudText Typo="Typo.h6">@_accuracyStats.OverallAccuracy.ToString("F1")%</MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="padding-left: 40px;">
                        <MudProgressLinear Color="@GetAccuracyColor()"
                                          Value="@_accuracyStats.OverallAccuracy"
                                          Size="MudSize.Medium"
                                          Style="flex: 1;" />
                        <MudText Typo="Typo.body2" Color="MudColor.Secondary" Style="min-width: 150px; text-align: right;">
                            @_accuracyStats.TotalCorrect / @_accuracyStats.TotalDetections correct
                        </MudText>
                    </MudStack>
                </MudStack>

                <MudDivider />

                <!-- False Positive Rate (with bar) -->
                <MudStack Spacing="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="@GetErrorRateColor(_accuracyStats.FalsePositivePercentage)" />
                        <MudText Typo="Typo.body1" Style="flex: 1;">False Positive Rate</MudText>
                        <MudText Typo="Typo.h6">@_accuracyStats.FalsePositivePercentage.ToString("F2")%</MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="padding-left: 40px;">
                        <MudProgressLinear Color="@GetErrorRateColor(_accuracyStats.FalsePositivePercentage)"
                                          Value="@Math.Min(_accuracyStats.FalsePositivePercentage, 100)"
                                          Size="MudSize.Medium"
                                          Style="flex: 1;" />
                        <MudText Typo="Typo.body2" Color="MudColor.Secondary" Style="min-width: 150px; text-align: right;">
                            @_accuracyStats.TotalFalsePositives (said spam, was ham)
                        </MudText>
                    </MudStack>
                </MudStack>

                <MudDivider />

                <!-- False Negative Rate (with bar) -->
                <MudStack Spacing="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.VisibilityOff" Color="@GetErrorRateColor(_accuracyStats.FalseNegativePercentage)" />
                        <MudText Typo="Typo.body1" Style="flex: 1;">False Negative Rate</MudText>
                        <MudText Typo="Typo.h6">@_accuracyStats.FalseNegativePercentage.ToString("F2")%</MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="padding-left: 40px;">
                        <MudProgressLinear Color="@GetErrorRateColor(_accuracyStats.FalseNegativePercentage)"
                                          Value="@Math.Min(_accuracyStats.FalseNegativePercentage, 100)"
                                          Size="MudSize.Medium"
                                          Style="flex: 1;" />
                        <MudText Typo="Typo.body2" Color="MudColor.Secondary" Style="min-width: 150px; text-align: right;">
                            @_accuracyStats.TotalFalseNegatives (missed spam)
                        </MudText>
                    </MudStack>
                </MudStack>

                <MudDivider />

                <!-- Average Response Time (no bar - not a ratio metric) -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Timer" Color="@GetResponseTimeColor()" />
                    <MudText Typo="Typo.body1" Style="flex: 1;">Average Response Time</MudText>
                    <MudText Typo="Typo.h6">@FormatResponseTime(_responseTimeStats.AverageMs)</MudText>
                    <MudText Typo="Typo.body2" Color="MudColor.Secondary">
                        (P95: @FormatResponseTime(_responseTimeStats.P95Ms))
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>

        @* Detection Method Comparison Table *@
        @if (_methodStats?.Any() == true)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true" Color="MudColor.Primary">Individual Algorithm Performance</MudText>
                <MudText Typo="Typo.body2" Class="mb-3" Color="MudColor.Secondary">
                    Effectiveness and error contribution of each spam detection algorithm
                </MudText>

                <MudTable Items="@_methodStats" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Algorithm</MudTh>
                        <MudTh><MudTableSortLabel T="DetectionMethodStats" SortBy="x => x.TotalChecks">Total Checks</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="DetectionMethodStats" SortBy="x => x.SpamPercentage">Hit Rate</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="DetectionMethodStats" SortBy="x => x.AverageSpamConfidence">Avg Spam Conf</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="DetectionMethodStats" SortBy="x => x.ContributedToFalsePositives">Contrib. to FPs</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="DetectionMethodStats" SortBy="x => x.ContributedToFalseNegatives">Contrib. to FNs</MudTableSortLabel></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Algorithm">
                            <MudChip T="string" Size="MudSize.Small" Color="MudColor.Default">@context.MethodName</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Total Checks">@context.TotalChecks</MudTd>
                        <MudTd DataLabel="Hit Rate">
                            <MudChip T="string" Size="MudSize.Small" Color="@GetSpamRateColor(context.SpamPercentage)">
                                @context.SpamPercentage.ToString("F1")% (@context.SpamDetected)
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Avg Spam Conf">
                            @if (context.AverageSpamConfidence.HasValue)
                            {
                                <MudChip T="string" Size="MudSize.Small" Color="@GetConfidenceColor(context.AverageSpamConfidence.Value)">
                                    @context.AverageSpamConfidence.Value.ToString("F0")
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="MudColor.Secondary">N/A</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Contrib. to FPs">
                            @if (context.ContributedToFalsePositives > 0)
                            {
                                <MudChip T="string" Size="MudSize.Small" Color="MudColor.Warning">
                                    @context.ContributedToFalsePositives
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="MudColor.Success">0</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Contrib. to FNs">
                            @if (context.ContributedToFalseNegatives > 0)
                            {
                                <MudChip T="string" Size="MudSize.Small" Color="MudColor.Warning">
                                    @context.ContributedToFalseNegatives
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="MudColor.Success">0</MudText>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }

        @* Daily Trends Chart *@
        @if (_dailyTrends?.Any() == true && _dailyTrendsChart != null)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true" Color="MudColor.Primary">Daily Detection Trends</MudText>
                <MudText Typo="Typo.body2" Class="mb-3" Color="MudColor.Secondary">
                    Number of spam and ham detections per day
                </MudText>
                <ApexChart TItem="DailyDetectionTrend"
                          Title=""
                          Options="_dailyTrendsChart"
                          Height="250">
                    <ApexPointSeries TItem="DailyDetectionTrend"
                                    Items="_dailyTrends"
                                    Name="Spam Detections"
                                    SeriesType="SeriesType.Line"
                                    XValue="@(e => DateToUnixMs(e.Date))"
                                    YAggregate="@(e => e.Sum(x => x.SpamCount))"
                                    OrderBy="e => e.X" />
                    <ApexPointSeries TItem="DailyDetectionTrend"
                                    Items="_dailyTrends"
                                    Name="Ham Detections"
                                    SeriesType="SeriesType.Line"
                                    XValue="@(e => DateToUnixMs(e.Date))"
                                    YAggregate="@(e => e.Sum(x => x.HamCount))"
                                    OrderBy="e => e.X" />
                </ApexChart>
            </MudPaper>
        }

        @* Response Time Chart *@
        @if (_responseTimeStats?.DailyAverages?.Any() == true && _responseTimeChart != null)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true" Color="MudColor.Primary">Response Time Trends</MudText>
                <MudText Typo="Typo.body2" Class="mb-3" Color="MudColor.Secondary">
                    Average time from spam detection to moderation action (ban/warn)
                </MudText>
                <ApexChart TItem="DailyResponseTime"
                          Title=""
                          Options="_responseTimeChart"
                          Height="200">
                    <ApexPointSeries TItem="DailyResponseTime"
                                    Items="_responseTimeStats.DailyAverages"
                                    Name="Response Time (seconds)"
                                    SeriesType="SeriesType.Bar"
                                    XValue="@(e => DateToUnixMs(e.Date))"
                                    YAggregate="@(e => (decimal)e.Sum(x => x.AverageMs / 1000.0))"
                                    OrderBy="e => e.X" />
                </ApexChart>
            </MudPaper>
        }
    }
    else if (!_loading && _dataLoaded)
    {
        <MudAlert Severity="Severity.Info">
            No detection data available for the selected time range. Detection data will appear here once spam checks are performed.
        </MudAlert>
    }
</MudStack>

@code {
    [Parameter] public List<long> SelectedChatIds { get; set; } = new();

    private bool _loading = true;
    private bool _dataLoaded = false;
    private DateTimeOffset? _startDate;
    private DateTimeOffset? _endDate;
    private string _userTimeZone = "UTC"; // Default to UTC until detected

    // Analytics data
    private DetectionAccuracyStats? _accuracyStats;
    private ResponseTimeStats? _responseTimeStats;
    private List<DetectionMethodStats>? _methodStats;
    private List<DailyDetectionTrend>? _dailyTrends;

    // Chart options (ApexCharts)
    private ApexChartOptions<DailyDetectionTrend>? _dailyTrendsChart;
    private ApexChartOptions<DailyResponseTime>? _responseTimeChart;

    // Helper to convert DateOnly to Unix timestamp (milliseconds) for ApexCharts
    private static long DateToUnixMs(DateOnly date) =>
        new DateTimeOffset(date.ToDateTime(TimeOnly.MinValue), TimeSpan.Zero).ToUnixTimeMilliseconds();

    protected override async Task OnInitializedAsync()
    {
        // Detect user's timezone from browser
        try
        {
            _userTimeZone = await JSRuntime.InvokeAsync<string>("getUserTimeZone");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to detect timezone, using UTC: {ex.Message}");
            _userTimeZone = "UTC";
        }

        await LoadLast30Days();
    }

    private async Task LoadLast7Days()
    {
        _endDate = DateTimeOffset.UtcNow;
        _startDate = _endDate.Value.AddDays(-7);
        await LoadData();
    }

    private async Task LoadLast30Days()
    {
        _endDate = DateTimeOffset.UtcNow;
        _startDate = _endDate.Value.AddDays(-30);
        await LoadData();
    }

    private async Task LoadAllTime()
    {
        _endDate = DateTimeOffset.UtcNow;
        _startDate = DateTimeOffset.MinValue;
        await LoadData();
    }

    private async Task LoadData()
    {
        if (!_startDate.HasValue || !_endDate.HasValue)
            return;

        _loading = true;
        try
        {
            // Load all analytics data in parallel
            var accuracyTask = AnalyticsRepository.GetDetectionAccuracyStatsAsync(_startDate.Value, _endDate.Value, _userTimeZone);
            var responseTimeTask = AnalyticsRepository.GetResponseTimeStatsAsync(_startDate.Value, _endDate.Value, _userTimeZone);
            var methodComparisonTask = AnalyticsRepository.GetDetectionMethodComparisonAsync(_startDate.Value, _endDate.Value, _userTimeZone);
            var dailyTrendsTask = AnalyticsRepository.GetDailyDetectionTrendsAsync(_startDate.Value, _endDate.Value, _userTimeZone);

            await Task.WhenAll(accuracyTask, responseTimeTask, methodComparisonTask, dailyTrendsTask);

            _accuracyStats = await accuracyTask;
            _responseTimeStats = await responseTimeTask;
            _methodStats = await methodComparisonTask;
            _dailyTrends = await dailyTrendsTask;

            PrepareCharts();
            _dataLoaded = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading analytics: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void PrepareCharts()
    {
        if (_dailyTrends == null || !_dailyTrends.Any())
            return;

        // Daily trends chart (spam vs ham) - matching MessageTrends style
        _dailyTrendsChart = new ApexChartOptions<DailyDetectionTrend>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = false }
            },
            Stroke = new Stroke { Curve = Curve.Smooth, Width = 3 },
            Colors = new List<string> { "#F44336", "#4CAF50" }, // Red for spam, green for ham
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels { Format = "MMM dd" }
            },
            Yaxis = new List<YAxis> { new YAxis { Title = new AxisTitle { Text = "Number of Detections" } } },
            Legend = new Legend { Position = LegendPosition.Top }
        };

        // Response time chart
        if (_responseTimeStats?.DailyAverages?.Any() == true)
        {
            _responseTimeChart = new ApexChartOptions<DailyResponseTime>
            {
                Chart = new Chart
                {
                    Toolbar = new Toolbar { Show = false }
                },
                Colors = new List<string> { "#2196F3" }, // Blue
                Xaxis = new XAxis
                {
                    Type = XAxisType.Datetime,
                    Labels = new XAxisLabels { Format = "MMM dd" }
                },
                Yaxis = new List<YAxis>
                {
                    new YAxis
                    {
                        Title = new AxisTitle { Text = "Response Time (seconds)" },
                        DecimalsInFloat = 2
                    }
                },
                PlotOptions = new PlotOptions
                {
                    Bar = new PlotOptionsBar
                    {
                        Horizontal = false,
                        ColumnWidth = "70%"
                    }
                },
                Tooltip = new Tooltip
                {
                    Y = new TooltipY
                    {
                        Formatter = "function(value) { return value.toFixed(2) + ' sec'; }"
                    }
                }
            };
        }
    }

    private string FormatResponseTime(double ms)
    {
        if (ms < 1000)
            return $"{ms:F0} ms";
        if (ms < 60000)
            return $"{ms / 1000:F1} sec";
        return $"{ms / 60000:F1} min";
    }

    private MudColor GetAccuracyColor()
    {
        if (_accuracyStats == null) return MudColor.Default;

        if (_accuracyStats.OverallAccuracy >= 95.0) return MudColor.Success;
        if (_accuracyStats.OverallAccuracy >= 90.0) return MudColor.Warning;
        return MudColor.Error;
    }

    private MudColor GetErrorRateColor(double rate)
    {
        if (rate < 1.0) return MudColor.Success;
        if (rate < 5.0) return MudColor.Warning;
        return MudColor.Error;
    }

    private MudColor GetResponseTimeColor()
    {
        if (_responseTimeStats == null) return MudColor.Default;

        var avgSeconds = _responseTimeStats.AverageMs / 1000.0;
        if (avgSeconds < 60) return MudColor.Success;      // Under 1 minute
        if (avgSeconds < 300) return MudColor.Warning;     // Under 5 minutes
        return MudColor.Error;                              // Over 5 minutes
    }

    private MudColor GetSpamRateColor(double percentage)
    {
        if (percentage > 50) return MudColor.Error;
        if (percentage > 20) return MudColor.Warning;
        return MudColor.Info;
    }

    private MudColor GetConfidenceColor(double confidence)
    {
        if (confidence >= 80) return MudColor.Success;
        if (confidence >= 60) return MudColor.Warning;
        return MudColor.Error;
    }
}
