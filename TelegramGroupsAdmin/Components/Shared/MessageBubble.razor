
<MudCard Class="@GetBubbleClass()" Elevation="1">
    <MudCardContent Class="pa-3">
        @* Chat and User Info Header *@
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                @* Chat icon - larger (24px) *@
                @if (!string.IsNullOrEmpty(Message.ChatIconPath))
                {
                    <img src="@GetImagePath(Message.ChatIconPath)"
                         alt="Chat icon"
                         style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;"
                         title="@Message.ChatName" />
                }
                else
                {
                    @* Fallback avatar for chat when no icon *@
                    <MudAvatar Color="Color.Info" Size="Size.Small" Style="width: 24px; height: 24px;">
                        <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" />
                    </MudAvatar>
                }

                <MudStack Spacing="0">
                    @* Chat name - primary (larger, bold) *@
                    @if (!string.IsNullOrEmpty(Message.ChatName))
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: var(--mud-palette-primary);">
                                @Message.ChatName
                            </MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           title="Filter by this chat"
                                           OnClick="@(() => OnFilterByChat.InvokeAsync(Message.ChatId))"
                                           Style="width: 20px; height: 20px; padding: 0;" />
                        </MudStack>
                    }

                    @* User name - secondary (smaller, lighter) *@
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @(Message.UserName ?? $"User {Message.UserId}")
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
                                       Size="Size.Small"
                                       Color="Color.Default"
                                       title="Filter by this user"
                                       OnClick="@(() => OnFilterByUser.InvokeAsync(Message.UserId))"
                                       Style="width: 16px; height: 16px; padding: 0; font-size: 12px;" />
                    </MudStack>
                </MudStack>
                @if (Message.EditDate.HasValue)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text" Icon="@Icons.Material.Filled.Edit">
                        Edited
                    </MudChip>
                }
            </MudStack>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @FormatTimestamp(Message.Timestamp)
            </MudText>
        </MudStack>

        @* Image Thumbnail *@
        @if (!string.IsNullOrEmpty(Message.PhotoThumbnailPath))
        {
            <MudImage Src="@GetImagePath(Message.PhotoThumbnailPath)"
                      Alt="Message image"
                      Class="rounded mb-2"
                      ObjectFit="ObjectFit.Cover"
                      Height="200"
                      Style="cursor: pointer;"
                      @onclick="() => OnImageClick.InvokeAsync(Message)" />
        }

        @* Message Text *@
        @if (!string.IsNullOrEmpty(Message.MessageText))
        {
            <MudText Typo="Typo.body2" Class="message-text">
                @Message.MessageText
            </MudText>
        }

        @* URLs (non-clickable for security - prevents accidental clicks on spam URLs) *@
        @if (!string.IsNullOrEmpty(Message.Urls))
        {
            <MudStack Class="mt-2" Spacing="1">
                @foreach (var url in GetUrls())
                {
                    <MudText Typo="Typo.caption" Color="Color.Primary" Class="url-display" title="@url">
                        ðŸ”— @TruncateUrl(url)
                    </MudText>
                }
            </MudStack>
        }

        @* Spam Indicator *@
        @if (SpamCheck != null)
        {
            <MudAlert Severity="@(SpamCheck.IsSpam ? Severity.Error : Severity.Success)"
                      Dense="true"
                      Class="mt-3"
                      Icon="@(SpamCheck.IsSpam ? Icons.Material.Filled.Warning : Icons.Material.Filled.CheckCircle)">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.caption">
                        @(SpamCheck.IsSpam ? "SPAM DETECTED" : "Clean") - @SpamCheck.CheckType
                    </MudText>
                    <MudChip T="string" Size="Size.Small" Color="@(SpamCheck.IsSpam ? Color.Error : Color.Success)">
                        @SpamCheck.Confidence%
                    </MudChip>
                </MudStack>
                @if (!string.IsNullOrEmpty(SpamCheck.Reason))
                {
                    <MudText Typo="Typo.caption" Class="mt-1">
                        @SpamCheck.Reason
                    </MudText>
                }
            </MudAlert>
        }

        @* Edit History Indicator *@
        @if (EditCount > 0)
        {
            <MudButton Variant="Variant.Text"
                       Color="Color.Warning"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.History"
                       Class="mt-2"
                       OnClick="() => OnViewEdits.InvokeAsync(Message)">
                View @EditCount @(EditCount == 1 ? "Edit" : "Edits")
            </MudButton>
        }

        @* Phase 2.6: Spam/Ham Action Buttons (Admin+ only) *@
        @if (ShowSpamActions)
        {
            <MudStack Row="true" Spacing="2" Class="mt-3">
                @if (SpamCheck?.IsSpam != true)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Report"
                               OnClick="() => OnMarkAsSpam.InvokeAsync(Message)"
                               Disabled="@_actionInProgress">
                        Mark as Spam
                    </MudButton>
                }
                @if (SpamCheck?.IsSpam == true)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Success"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.CheckCircle"
                               OnClick="() => OnMarkAsHam.InvokeAsync(Message)"
                               Disabled="@_actionInProgress">
                        Mark as Ham (Not Spam)
                    </MudButton>
                }
                @if (DetectionHistory?.Count > 0)
                {
                    <MudButton Variant="Variant.Text"
                               Color="Color.Info"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.History"
                               OnClick="() => OnViewDetections.InvokeAsync(Message)">
                        Detection History (@DetectionHistory.Count)
                    </MudButton>
                }
                @* Delete message button *@
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="() => OnDeleteMessage.InvokeAsync(Message)"
                           Disabled="@_actionInProgress">
                    Delete Message
                </MudButton>
            </MudStack>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public MessageRecord Message { get; set; } = default!;

    [Parameter]
    public SpamCheckRecord? SpamCheck { get; set; }

    [Parameter]
    public int EditCount { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnImageClick { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnViewEdits { get; set; }

    // Phase 2.6: Spam action parameters
    [Parameter]
    public bool ShowSpamActions { get; set; }

    [Parameter]
    public List<DetectionResultRecord>? DetectionHistory { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnMarkAsSpam { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnMarkAsHam { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnViewDetections { get; set; }

    [Parameter]
    public EventCallback<long> OnFilterByUser { get; set; }

    [Parameter]
    public EventCallback<long> OnFilterByChat { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnDeleteMessage { get; set; }

    private bool _actionInProgress = false;

    private string GetBubbleClass()
    {
        var baseClass = "message-bubble mb-3";
        if (SpamCheck?.IsSpam == true)
            return $"{baseClass} spam-message";
        return baseClass;
    }

    private string GetUserInitials()
    {
        var name = Message.UserName ?? $"U{Message.UserId}";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatTimestamp(DateTimeOffset timestamp)
    {
        var dt = timestamp.ToLocalTime();
        var now = DateTimeOffset.Now;

        if (dt.Date == now.Date)
            return dt.ToString("HH:mm");
        if (dt.Date == now.AddDays(-1).Date)
            return $"Yesterday {dt:HH:mm}";
        if (dt.Year == now.Year)
            return dt.ToString("MMM dd HH:mm");
        return dt.ToString("MMM dd yyyy HH:mm");
    }

    private string[] GetUrls()
    {
        if (string.IsNullOrEmpty(Message.Urls))
            return Array.Empty<string>();
        return Message.Urls.Split(',', StringSplitOptions.RemoveEmptyEntries);
    }

    private string TruncateUrl(string url)
    {
        const int maxLength = 50;
        if (url.Length <= maxLength)
            return url;
        return url.Substring(0, maxLength - 3) + "...";
    }

    private string GetImagePath(string? path)
    {
        if (string.IsNullOrEmpty(path))
            return string.Empty;

        // Path may already include subdirectory (e.g., "chat_icons/file.jpg" or "thumbnails/file.jpg")
        // or just filename for legacy messages (e.g., "file.jpg")
        // If it contains a directory separator, preserve it; otherwise just use filename
        var relativePath = path.Contains('/') || path.Contains('\\')
            ? path.Replace('\\', '/')  // Normalize path separators
            : Path.GetFileName(path);   // Legacy: just filename

        return $"/images/{relativePath}";
    }
}
