@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.BackgroundJobs.Services.Backup
@using TelegramGroupsAdmin.Core.Models
@using TelegramGroupsAdmin.Core.Services
@inject IBackupService BackupService
@inject IBackupRetentionService RetentionService
@inject ISnackbar Snackbar
@inject IJSRuntime Js
@inject IAuditService AuditService
@inject AuthenticationStateProvider AuthStateProvider

<MudPaper Class="pa-4" Elevation="0" Outlined="true">
    <MudStack Spacing="3">
        <div>
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Class="mr-2" />
                Backup Browser
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Browse and manage backups in @BackupDirectory
            </MudText>
        </div>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (!_backups.Any())
        {
            <MudAlert Severity="Severity.Info">
                No backups found in @BackupDirectory
            </MudAlert>
        }
        else
        {
            @* Latest Backup - Quick Access *@
            @if (_backups.Any())
            {
                var latestBackup = _backups.First(); // Already sorted by CreatedAt descending
                var willBeKept = _backupRetentionInfo.TryGetValue(latestBackup.FilePath, out var info) && info.WillBeKept;
                var tier = _backupRetentionInfo.TryGetValue(latestBackup.FilePath, out var tierInfo) ? tierInfo.PrimaryTier : BackupTier.Hourly;

                <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-primary);">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.NewReleases" Color="Color.Primary" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.h6" Color="Color.Primary">Latest Backup</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Most recent backup for quick download</MudText>
                            </div>
                        </MudStack>

                        <MudDivider />

                        <MudGrid>
                            <MudItem xs="12" md="8">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="flex-wrap: wrap;">
                                        <MudIcon Icon="@Icons.Material.Filled.Archive" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Typo="Typo.body1"><strong>@latestBackup.FileName</strong></MudText>

                                        @if (latestBackup.IsEncrypted)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Lock">Encrypted</MudChip>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.LockOpen">Unencrypted</MudChip>
                                        }

                                        <MudChip T="string" Size="Size.Small" Color="@GetTierColor(tier)" Icon="@GetTierIcon(tier)">@tier</MudChip>

                                        @if (!willBeKept)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.DeleteSweep" title="Will be deleted on next cleanup">
                                                Will be deleted
                                            </MudChip>
                                        }
                                    </MudStack>

                                    <MudStack Row="true" Spacing="4">
                                        <MudText Typo="Typo.body2">
                                            <strong>Created:</strong> @latestBackup.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                        </MudText>
                                        <MudText Typo="Typo.body2">
                                            <strong>Size:</strong> @FormatBytes(latestBackup.FileSizeBytes)
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudItem>

                            <MudItem xs="12" md="4" Class="d-flex justify-end align-center">
                                <MudButtonGroup Variant="Variant.Filled">
                                    <MudButton StartIcon="@Icons.Material.Filled.Download"
                                               Color="Color.Primary"
                                               OnClick="@(() => DownloadBackup(latestBackup))">
                                        Download
                                    </MudButton>
                                    <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => ViewMetadata(latestBackup))"
                                                   title="View Metadata" />
                                    <MudIconButton Icon="@Icons.Material.Filled.SettingsBackupRestore"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => OnRestoreRequested.InvokeAsync(latestBackup))"
                                                   title="Wipe & Restore from this Backup" />
                                </MudButtonGroup>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudPaper>
            }

            @* Grouped by retention tier *@
            @foreach (var tierGroup in _tierGroups.OrderByDescending(g => g.Tier))
            {
                var tierBackups = tierGroup.Backups.OrderByDescending(b => b.CreatedAt).ToList();
                var tierSize = tierBackups.Sum(b => b.FileSizeBytes);
                var tierColor = GetTierColor(tierGroup.Tier);

                <MudExpansionPanel Class="mb-2">
                    <TitleContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@GetTierIcon(tierGroup.Tier)" Color="@tierColor" />
                            <MudText Typo="Typo.subtitle1"><strong>@tierGroup.Tier</strong></MudText>
                            <MudChip T="string" Size="Size.Small" Color="@tierColor" Variant="Variant.Text">
                                @tierBackups.Count backup@(tierBackups.Count != 1 ? "s" : "")
                            </MudChip>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @FormatBytes(tierSize)
                            </MudText>
                        </MudStack>
                    </TitleContent>
                    <ChildContent>
                        <MudStack Spacing="2" Class="pa-2">
                            @foreach (var backup in tierBackups)
                            {
                                var willBeKept = _backupRetentionInfo.TryGetValue(backup.FilePath, out var info) && info.WillBeKept;

                                <MudPaper Class="pa-3" Elevation="1">
                                    <MudGrid>
                                        <MudItem xs="12" md="8">
                                            <MudStack Spacing="1">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Archive" Size="Size.Small" Color="Color.Primary" />
                                                    <MudText Typo="Typo.body2"><strong>@backup.FileName</strong></MudText>

                                                    @if (backup.IsEncrypted)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Lock">Encrypted</MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.LockOpen">Unencrypted</MudChip>
                                                    }

                                                    @if (!willBeKept)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.DeleteSweep" title="Will be deleted on next cleanup">
                                                            Will be deleted
                                                        </MudChip>
                                                    }
                                                </MudStack>

                                                <MudStack Row="true" Spacing="4">
                                                    <MudText Typo="Typo.caption">
                                                        <strong>Created:</strong> @backup.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                                    </MudText>
                                                    <MudText Typo="Typo.caption">
                                                        <strong>Size:</strong> @FormatBytes(backup.FileSizeBytes)
                                                    </MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudItem>

                                        <MudItem xs="12" md="4" Class="d-flex justify-end align-center">
                                            <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                                                <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(() => ViewMetadata(backup))"
                                                               title="View Metadata" />
                                                <MudIconButton Icon="@Icons.Material.Filled.SettingsBackupRestore"
                                                               Color="Color.Secondary"
                                                               Size="Size.Small"
                                                               OnClick="@(() => OnRestoreRequested.InvokeAsync(backup))"
                                                               title="Wipe & Restore from this Backup" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Download"
                                                               Color="Color.Info"
                                                               Size="Size.Small"
                                                               OnClick="@(() => DownloadBackup(backup))"
                                                               title="Download" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Color="Color.Error"
                                                               Size="Size.Small"
                                                               OnClick="@(() => DeleteBackup(backup))"
                                                               title="Delete" />
                                            </MudButtonGroup>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            }
                        </MudStack>
                    </ChildContent>
                </MudExpansionPanel>
            }

            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Right" Class="mt-2">
                @_backups.Count backup(s) total | @FormatBytes(_backups.Sum(b => b.FileSizeBytes))
            </MudText>
        }

        <MudButton Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="@LoadBackupsAsync"
                   Size="Size.Small">
            Refresh List
        </MudButton>
    </MudStack>
</MudPaper>

<!-- Metadata Dialog -->
<MudDialog @bind-Visible="_showMetadataDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
            Backup Metadata
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_viewingBackup != null && _viewingMetadata != null)
        {
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle2">File Information</MudText>
                <MudSimpleTable Dense="true" Bordered="true">
                    <tbody>
                        <tr>
                            <td><strong>Filename:</strong></td>
                            <td>@_viewingBackup.FileName</td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>@_viewingBackup.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                        <tr>
                            <td><strong>Size:</strong></td>
                            <td>@FormatBytes(_viewingBackup.FileSizeBytes)</td>
                        </tr>
                        <tr>
                            <td><strong>Encrypted:</strong></td>
                            <td>
                                @if (_viewingBackup.IsEncrypted)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Lock">Yes</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.LockOpen">No</MudChip>
                                }
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudDivider />

                <MudText Typo="Typo.subtitle2">Backup Contents</MudText>
                <MudSimpleTable Dense="true" Bordered="true">
                    <tbody>
                        <tr>
                            <td><strong>Version:</strong></td>
                            <td>@_viewingMetadata.Version</td>
                        </tr>
                        <tr>
                            <td><strong>Tables:</strong></td>
                            <td>@_viewingMetadata.TableCount</td>
                        </tr>
                        <tr>
                            <td><strong>Created At:</strong></td>
                            <td><span class="local-timestamp" data-utc="@_viewingMetadata.CreatedAt.ToString("o")">@_viewingMetadata.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</span></td>
                        </tr>
                        <tr>
                            <td><strong>App Version:</strong></td>
                            <td>@_viewingMetadata.AppVersion</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudStack>
        }
        else
        {
            <MudAlert Severity="Severity.Error">Failed to load backup metadata</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showMetadataDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string BackupDirectory { get; set; } = "/data/backups";
    [Parameter] public EventCallback<BackupFileInfo> OnRestoreRequested { get; set; }

    private List<BackupFileInfo> _backups = [];
    private List<TierGroup> _tierGroups = [];
    private readonly Dictionary<string, BackupRetentionInfo> _backupRetentionInfo = new();
    private bool _isLoading;
    private readonly RetentionConfig _retentionConfig = new(); // Default retention policy

    // Metadata dialog
    private bool _showMetadataDialog;
    private BackupFileInfo? _viewingBackup;
    private BackupMetadata? _viewingMetadata;

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    private class TierGroup
    {
        public BackupTier Tier { get; init; }
        public List<BackupFileInfo> Backups { get; init; } = [];
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBackupsAsync();
    }

    public async Task LoadBackupsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Ensure directory exists
            if (!Directory.Exists(BackupDirectory))
            {
                Directory.CreateDirectory(BackupDirectory);
                _backups = [];
                return;
            }

            // Get all .tar.gz backup files
            var files = Directory.GetFiles(BackupDirectory, "*.tar.gz")
                .Select(async filepath =>
                {
                    var fileInfo = new FileInfo(filepath);
                    var bytes = await File.ReadAllBytesAsync(filepath);
                    var isEncrypted = await BackupService.IsEncryptedAsync(bytes);

                    return new BackupFileInfo
                    {
                        FilePath = filepath,
                        CreatedAt = new DateTimeOffset(fileInfo.CreationTimeUtc),
                        FileSizeBytes = fileInfo.Length,
                        IsEncrypted = isEncrypted
                    };
                })
                .ToList();

            _backups = (await Task.WhenAll(files))
                .OrderByDescending(b => b.CreatedAt)
                .ToList();

            // Calculate retention info for each backup
            _backupRetentionInfo.Clear();
            foreach (var backup in _backups)
            {
                var info = RetentionService.GetBackupRetentionInfo(backup, _backups, _retentionConfig);
                _backupRetentionInfo[backup.FilePath] = info;
            }

            // Group backups by primary tier
            _tierGroups = _backups
                .GroupBy(b => _backupRetentionInfo[b.FilePath].PrimaryTier)
                .Select(g => new TierGroup
                {
                    Tier = g.Key,
                    Backups = g.ToList()
                })
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load backups: {ex.Message}", Severity.Error);
            _backups = [];
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ViewMetadata(BackupFileInfo backup)
    {
        try
        {
            var bytes = await File.ReadAllBytesAsync(backup.FilePath);

            // GetMetadataAsync will automatically use stored passphrase for encrypted backups
            _viewingMetadata = await BackupService.GetMetadataAsync(bytes);
            _viewingBackup = backup;
            _showMetadataDialog = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to read metadata: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadBackup(BackupFileInfo backup)
    {
        try
        {
            var bytes = await File.ReadAllBytesAsync(backup.FilePath);
            await Js.InvokeVoidAsync("downloadFile", backup.FileName, Convert.ToBase64String(bytes));
            Snackbar.Add($"Downloading {backup.FileName}", Severity.Success);

            // Audit log the backup download (security-sensitive action)
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            await AuditService.LogEventAsync(
                AuditEventType.DataExported,
                actor: userId != null ? Actor.FromWebUser(userId) : Actor.Unknown,
                target: null,
                value: $"Downloaded backup: {backup.FileName} ({FormatBytes(backup.FileSizeBytes)})");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Download failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteBackup(BackupFileInfo backup)
    {
        try
        {
            File.Delete(backup.FilePath);
            Snackbar.Add($"Deleted {backup.FileName}", Severity.Success);
            await LoadBackupsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }

    private static string FormatBytes(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private Color GetTierColor(BackupTier tier)
    {
        return tier switch
        {
            BackupTier.Yearly => Color.Secondary,  // Purple/dark
            BackupTier.Monthly => Color.Warning,   // Yellow
            BackupTier.Weekly => Color.Success,    // Green
            BackupTier.Daily => Color.Info,        // Blue
            BackupTier.Hourly => Color.Default,    // Gray
            _ => Color.Default
        };
    }

    private string GetTierIcon(BackupTier tier)
    {
        return tier switch
        {
            BackupTier.Yearly => Icons.Material.Filled.CalendarMonth,
            BackupTier.Monthly => Icons.Material.Filled.CalendarToday,
            BackupTier.Weekly => Icons.Material.Filled.DateRange,
            BackupTier.Daily => Icons.Material.Filled.Today,
            BackupTier.Hourly => Icons.Material.Filled.Schedule,
            _ => Icons.Material.Filled.Archive
        };
    }
}
