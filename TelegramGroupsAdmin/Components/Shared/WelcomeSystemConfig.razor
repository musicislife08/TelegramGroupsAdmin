@using Humanizer
@using TelegramGroupsAdmin.Configuration
@using TelegramGroupsAdmin.Configuration.Models.Welcome
@using TelegramGroupsAdmin.Core.Services
@using TelegramGroupsAdmin.Telegram.Extensions
@using TelegramGroupsAdmin.Telegram.Models
@inject IConfigService ConfigService
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

<MudPaper Class="pa-4" Elevation="@(Chat != null ? 0 : 1)">
    @if (Chat == null)
    {
        <MudText Typo="Typo.h6" GutterBottom="true">Welcome Message System</MudText>
        <MudText Typo="Typo.body2" Class="mb-4">
            Configure automatic welcome messages for new members joining your Telegram groups.
        </MudText>
    }

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_config != null)
    {
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudSwitch @bind-Value="_config.Enabled" Color="Color.Primary" Label="Enable Welcome System" />
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        When enabled, new members will be restricted until they accept the rules
                    </MudText>
                </MudItem>

                @* Security on Join Section - These run REGARDLESS of welcome system enabled state *@
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" Class="mr-1" />
                        Security on Join
                    </MudText>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                        Security checks run for ALL new members, regardless of welcome system state. Users are muted during verification.
                    </MudText>
                </MudItem>

                @* CAS Check Configuration *@
                <MudItem xs="12">
                    <MudExpansionPanels>
                        <MudExpansionPanel Text="CAS (Combot Anti-Spam)" Expanded="false">
                            <TitleContent>
                                <div class="d-flex align-center gap-2">
                                    <MudSwitch @bind-Value="_config.JoinSecurity.Cas.Enabled"
                                               Color="Color.Primary"
                                               @onclick:stopPropagation="true" />
                                    <MudText>CAS (Combot Anti-Spam)</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(_config.JoinSecurity.Cas.Enabled ? Color.Success : Color.Default)">
                                        @(_config.JoinSecurity.Cas.Enabled ? "Enabled" : "Disabled")
                                    </MudChip>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                                    Automatically bans users listed in the Combot Anti-Spam database (known spammers).
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_config.JoinSecurity.Cas.ApiUrl"
                                                      Label="API URL"
                                                      HelperText="CAS API endpoint (default: https://api.cas.chat)"
                                                      Disabled="!_config.JoinSecurity.Cas.Enabled" />
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudNumericField T="int"
                                                         Value="@((int)_config.JoinSecurity.Cas.Timeout.TotalSeconds)"
                                                         ValueChanged="@(v => _config.JoinSecurity.Cas.Timeout = TimeSpan.FromSeconds(v))"
                                                         Label="Timeout (seconds)"
                                                         Min="1"
                                                         Max="30"
                                                         HelperText="API request timeout"
                                                         Disabled="!_config.JoinSecurity.Cas.Enabled" />
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudTextField @bind-Value="_config.JoinSecurity.Cas.UserAgent"
                                                      Label="User Agent"
                                                      HelperText="Optional UA header"
                                                      Disabled="!_config.JoinSecurity.Cas.Enabled" />
                                    </MudItem>
                                </MudGrid>
                            </ChildContent>
                        </MudExpansionPanel>

                        <MudExpansionPanel Text="Impersonation Detection" Expanded="false">
                            <TitleContent>
                                <div class="d-flex align-center gap-2">
                                    <MudSwitch @bind-Value="_config.JoinSecurity.Impersonation.Enabled"
                                               Color="Color.Primary"
                                               @onclick:stopPropagation="true" />
                                    <MudText>Impersonation Detection</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(_config.JoinSecurity.Impersonation.Enabled ? Color.Success : Color.Default)">
                                        @(_config.JoinSecurity.Impersonation.Enabled ? "Enabled" : "Disabled")
                                    </MudChip>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    Detects users trying to impersonate chat admins by comparing names and profile photos.
                                    Auto-bans high-confidence matches (score 100+), flags medium-confidence for review (score 50-99).
                                </MudText>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" GutterBottom="true">Welcome Mode</MudText>
                    <MudRadioGroup @bind-Value="_config.Mode" Disabled="!_config.Enabled">
                        <MudRadio Value="@WelcomeMode.DmWelcome" Color="Color.Primary">
                            <MudText>
                                <strong>DM Welcome</strong> - Rules sent privately via bot DM
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary ml-6">
                                Clean group chat, forces users to interact with bot privately. Shows "Read Rules" button.
                            </MudText>
                        </MudRadio>

                        <MudRadio Value="@WelcomeMode.ChatAcceptDeny" Color="Color.Primary" Class="mt-2">
                            <MudText>
                                <strong>Chat Accept/Deny</strong> - Rules shown in group with buttons
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary ml-6">
                                Faster onboarding, rules visible to all. Shows Accept/Deny buttons in chat.
                            </MudText>
                        </MudRadio>

                        <MudRadio Value="@WelcomeMode.EntranceExam" Color="Color.Primary" Class="mt-2">
                            <MudText>
                                <strong>Entrance Exam</strong> - User must pass a quiz to join
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary ml-6">
                                Strongest protection against spam. Multiple choice questions and/or AI-evaluated open-ended response.
                            </MudText>
                        </MudRadio>
                    </MudRadioGroup>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_config.TimeoutSeconds"
                                     Label="Timeout (seconds)"
                                     Min="10"
                                     Max="300"
                                     HelperText="Time before auto-kicking non-responsive users (10-300s)" />
                </MudItem>

                @* DM Chat Teaser - Shown for DmWelcome and EntranceExam modes - appears FIRST because it's shown first in actual flow *@
                @if (_config.Mode is WelcomeMode.DmWelcome or WelcomeMode.EntranceExam)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Class="mr-1" />
                            DM Chat Teaser
                        </MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                            Short message shown in group chat when user joins. Clicking the button opens the DM and sends the main message.
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Class="mb-2 mud-text-secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                            Available variables - click to insert:
                        </MudText>
                        <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mb-2">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{username}"))">
                                {username}
                            </MudChip>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{chat_name}"))">
                                {chat_name}
                            </MudChip>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{timeout}"))">
                                {timeout}
                            </MudChip>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" lg="6">
                        <MudTextField @bind-Value="_config.DmChatTeaserMessage"
                                      id="dmTeaserInput"
                                      Label="DM Chat Teaser"
                                      Lines="6"
                                      FullWidth="true"
                                      Immediate="true"
                                      @onfocus="@(() => _lastFocusedInputId = "dmTeaserInput")"
                                      HelperText="Prompt users to click button. Don't say 'I've sent you...' - clicking initiates the DM!" />
                    </MudItem>
                    <MudItem xs="12" lg="6">
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">Live Preview (In Chat):</MudText>
                        <TelegramMessagePreview PreviewText="@GetPreviewText(_config.DmChatTeaserMessage)"
                                               ShowUserCommand="false"
                                               ShowWarning="true"
                                               Buttons="@GetDmTeaserButtons()" />
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mt-2">
                            Button text: "@_config.DmButtonText"
                        </MudText>
                    </MudItem>

                    @* For Exam mode, put button text field right here where the button is used *@
                    @if (_config.Mode == WelcomeMode.EntranceExam)
                    {
                        <MudItem xs="12" lg="6">
                            <MudTextField @bind-Value="_config.DmButtonText"
                                          Label="Start Exam Button Text"
                                          FullWidth="true"
                                          Immediate="true"
                                          HelperText="Button shown on the teaser message above" />
                        </MudItem>
                    }
                }

                @* Main Welcome Message - Always Visible *@
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Small" Class="mr-1" />
                        @(_config.Mode == WelcomeMode.EntranceExam ? "Rules / Guidelines" : "Main Welcome Message")
                    </MudText>
                    @if (_config.Mode == WelcomeMode.EntranceExam)
                    {
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                            Sent in DM before exam questions. No buttons - just your rules/guidelines. Remove any "click below to accept" language.
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                            Complete message shown to users. Used in Chat mode (posted to chat), DM mode (sent in DM), and DM fallback (if DM fails).
                        </MudText>
                    }
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Class="mb-2 mud-text-secondary">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                        Available variables - click to insert:
                    </MudText>
                    <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mb-2">
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{username}"))">
                            {username}
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{chat_name}"))">
                            {chat_name}
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClick="@(() => InsertVariable("{timeout}"))">
                            {timeout}
                        </MudChip>
                    </MudStack>
                </MudItem>
                <MudItem xs="12" lg="6">
                    <MudTextField @bind-Value="_config.MainWelcomeMessage"
                                  id="mainWelcomeInput"
                                  Label="Main Welcome Message"
                                  Lines="8"
                                  FullWidth="true"
                                  Immediate="true"
                                  @onfocus="@(() => _lastFocusedInputId = "mainWelcomeInput")"
                                  HelperText="Complete message with greeting, rules/guidelines, and instructions." />
                </MudItem>
                <MudItem xs="12" lg="6">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
                        Live Preview (@(_config.Mode == WelcomeMode.ChatAcceptDeny ? "In Chat" : "In DM")):
                    </MudText>
                    <TelegramMessagePreview PreviewText="@GetPreviewText(_config.MainWelcomeMessage)"
                                           ShowUserCommand="@(_config.Mode != WelcomeMode.ChatAcceptDeny)"
                                           ShowWarning="true"
                                           Buttons="@GetMainWelcomeButtons()" />
                </MudItem>

                @* Button Customization - NOT shown for EntranceExam (button is in teaser section above) *@
                @if (_config.Mode != WelcomeMode.EntranceExam)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Small" Class="mr-1" />
                            Button Customization
                        </MudText>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_config.AcceptButtonText"
                                      Label="Accept Button Text"
                                      Immediate="true"
                                      HelperText="Text shown on the accept button" />
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_config.DenyButtonText"
                                      Label="Deny Button Text"
                                      Immediate="true"
                                      HelperText="Text shown on the deny button" />
                    </MudItem>

                    @* DM teaser button - only for DmWelcome mode *@
                    @if (_config.Mode == WelcomeMode.DmWelcome)
                    {
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="_config.DmButtonText"
                                          Label="DM Button Text"
                                          Immediate="true"
                                          HelperText="Button text in chat teaser" />
                        </MudItem>
                    }
                }

                @* Entrance Exam Configuration - Only shown for EntranceExam mode *@
                @if (_config.Mode == WelcomeMode.EntranceExam)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Quiz" Size="Size.Small" Class="mr-1" />
                            Entrance Exam Configuration
                        </MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
                            Configure questions that new members must answer correctly to join. At least one question type is required.
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <ExamConfigEditor Chat="Chat" @bind-Config="_config.ExamConfig" />
                    </MudItem>
                }

                @if (Chat == null)
                {
                    <MudItem xs="12" Class="d-flex justify-space-between">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="SaveConfig"
                                   Disabled="!_isValid || _saving">
                            @if (_saving)
                            {
                                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Configuration</span>
                            }
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   OnClick="LoadDefaults"
                                   Disabled="_saving">
                            Reset to Defaults
                        </MudButton>
                    </MudItem>
                }
            </MudGrid>
        </MudForm>
    }
    else
    {
        <MudAlert Severity="Severity.Error">Failed to load configuration</MudAlert>
    }
</MudPaper>

@code {
    /// <summary>
    /// Optional chat for per-chat configuration. If null, uses global configuration.
    /// </summary>
    [Parameter]
    public ManagedChatRecord? Chat { get; set; }

    /// <summary>
    /// Optional callback when configuration is saved (for per-chat mode)
    /// </summary>
    [Parameter]
    public EventCallback OnSaved { get; set; }

    private WelcomeConfig? _config;
    private MudForm? _form;
    private bool _isValid = true;
    private bool _loading = true;
    private bool _saving;
    private string? _lastFocusedInputId;


    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // No special initialization needed for now
            // JS interop for cursor position will be called on-demand
        }
        return Task.CompletedTask;
    }

    private async Task LoadConfig()
    {
        _loading = true;
        try
        {
            // Normalize null to 0 for global config (SQL NULL comparison doesn't work with ==)
            var config = await ConfigService.GetAsync<WelcomeConfig>(ConfigType.Welcome, Chat?.Chat.Id ?? 0);

            if (config == null)
            {
                // No config exists - use defaults
                _config = WelcomeConfig.Default;
            }
            else if (string.IsNullOrEmpty(config.MainWelcomeMessage))
            {
                // Old config format detected (missing new fields) - migrate to defaults
                _config = WelcomeConfig.Default;

                // Preserve old settings
                _config.Enabled = config.Enabled;
                _config.Mode = config.Mode;
                _config.TimeoutSeconds = config.TimeoutSeconds;
                _config.AcceptButtonText = !string.IsNullOrEmpty(config.AcceptButtonText)
                    ? config.AcceptButtonText
                    : _config.AcceptButtonText;
                _config.DenyButtonText = !string.IsNullOrEmpty(config.DenyButtonText)
                    ? config.DenyButtonText
                    : _config.DenyButtonText;

                Snackbar.Add(
                    "Welcome system updated! Template structure has changed. Please review and save the new configuration.",
                    Severity.Info);
            }
            else
            {
                // New config format - load as-is
                _config = config;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load configuration: {ex.Message}", Severity.Error);
            _config = null;
        }
        finally
        {
            _loading = false;
        }
    }

    /// <summary>
    /// Public method to allow parent components to trigger save
    /// </summary>
    public async Task SaveConfiguration()
    {
        await SaveConfig();
    }

    private async Task SaveConfig()
    {
        if (_config == null || !_isValid) return;

        _saving = true;
        try
        {
            await ConfigService.SaveAsync(ConfigType.Welcome, Chat?.Chat ?? ChatIdentity.FromId(0), _config);
            Snackbar.Add($"Welcome configuration saved {(Chat != null ? $"for {Chat.Chat.ToLogInfo()}" : "globally")}", Severity.Success);

            // Invoke callback if provided
            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void LoadDefaults()
    {
        _config = WelcomeConfig.Default;
        Snackbar.Add("Defaults loaded. Click 'Save Configuration' to apply.", Severity.Info);
    }

    private string GetPreviewText(string? template)
    {
        if (string.IsNullOrEmpty(template)) return "(empty template)";

        var preview = template;

        // Replace valid variables with sample data
        var timeoutSeconds = _config?.TimeoutSeconds ?? 60;
        var formattedTimeout = TimeSpan.FromSeconds(timeoutSeconds).Humanize(precision: 2);

        preview = preview.Replace("{username}", "@SampleUser");
        preview = preview.Replace("{chat_name}", "Sample Chat Group");
        preview = preview.Replace("{timeout}", formattedTimeout);

        // Highlight invalid/incomplete variables
        var invalidVariablePattern = System.Text.RegularExpressions.Regex.Matches(preview, @"\{[^}]*\}");
        if (invalidVariablePattern.Count > 0)
        {
            preview += "\n\n‚ö†Ô∏è Warning: Invalid variables remain in preview";
        }

        return preview;
    }

    private async Task InsertVariable(string variable)
    {
        try
        {
            if (string.IsNullOrEmpty(_lastFocusedInputId))
            {
                Snackbar.Add("Please click in a text field first, then click the variable chip.", Severity.Info);
                return;
            }

            // Call JavaScript to insert variable at cursor position in the last focused input
            await JsRuntime.InvokeVoidAsync("insertTextAtCursor", variable, _lastFocusedInputId);

            Snackbar.Add($"Inserted {variable}", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to insert variable: {ex.Message}. Please copy/paste manually.", Severity.Warning);
        }
    }

    /// <summary>
    /// Get button configuration for Main Welcome Message preview.
    /// Shows Accept/Decline buttons in both modes:
    /// - Chat mode: Buttons appear in chat below the message
    /// - DM mode: Buttons appear in DM below the message (user accepts there)
    /// </summary>
    private string[][] GetMainWelcomeButtons()
    {
        // EntranceExam mode: no buttons on welcome message (exam questions sent separately in DM)
        if (_config?.Mode == WelcomeMode.EntranceExam)
            return [];

        // DmWelcome and ChatAcceptDeny show Accept/Decline buttons on the main welcome message
        return
        [
            [_config?.AcceptButtonText ?? "‚úÖ I Accept", _config?.DenyButtonText ?? "‚ùå Decline"]
        ];
    }

    /// <summary>
    /// Get button configuration for DM Chat Teaser preview.
    /// Shows the deep link button that opens the DM.
    /// </summary>
    private string[][] GetDmTeaserButtons()
    {
        // Single button in one row
        return
        [
            [_config?.DmButtonText ?? "üìã Read Guidelines"]
        ];
    }

    public ValueTask DisposeAsync()
    {
        // Cleanup if needed
        return ValueTask.CompletedTask;
    }
}
