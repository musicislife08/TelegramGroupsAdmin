@using TelegramGroupsAdmin.ContentDetection.Configuration
@using TelegramGroupsAdmin.ContentDetection.Repositories
@inject ISpamDetectionConfigRepository ConfigRepository
@inject ISnackbar Snackbar

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Color="Color.Primary">Detection Scope</MudText>

                <MudSwitch T="bool" @bind-Value="_config.FirstMessageOnly"
                          Label="Check First Messages Only"
                          Color="Color.Primary" />

                @if (_config.FirstMessageOnly)
                {
                    <MudNumericField @bind-Value="_config.FirstMessagesCount"
                                    Label="First Messages Count"
                                    Min="1" Max="10"
                                    helperText="Number of first messages to check from each user" />
                }

                <MudNumericField @bind-Value="_config.MinMessageLength"
                                Label="Minimum Message Length"
                                Min="10" Max="1000"
                                helperText="Skip expensive checks for messages shorter than this" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="1">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Color="Color.Primary">Action Thresholds</MudText>

                <MudSwitch T="bool" @bind-Value="_config.TrainingMode"
                          Label="Training Mode"
                          Color="Color.Warning">
                    <MudText Typo="Typo.caption" Color="@(_config.TrainingMode ? Color.Warning : Color.Default)">
                        @if (_config.TrainingMode)
                        {
                            <text>⚠️ All spam detections sent to review queue (no auto-ban)</text>
                        }
                        else
                        {
                            <text>Use this to validate detection before enabling auto-ban</text>
                        }
                    </MudText>
                </MudSwitch>

                <MudNumericField @bind-Value="_config.AutoBanThreshold"
                                Label="Auto-Ban Threshold"
                                Min="50" Max="100"
                                Disabled="@_config.TrainingMode"
                                HelperText="@(_config.TrainingMode ? "Disabled in training mode" : "Confidence >= this value triggers automatic ban")" />

                <MudNumericField @bind-Value="_config.ReviewQueueThreshold"
                                Label="Review Queue Threshold"
                                Min="20" Max="80"
                                HelperText="Confidence >= this value goes to review queue" />
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private SpamDetectionConfig _config = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            _config = ChatId.HasValue
                ? await ConfigRepository.GetEffectiveConfigAsync(ChatId.Value)
                : await ConfigRepository.GetGlobalConfigAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new SpamDetectionConfig();
        }
    }

    public SpamDetectionConfig GetConfig() => _config;
}
