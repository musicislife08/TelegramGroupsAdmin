@using Microsoft.AspNetCore.Components.Authorization
@inject IDetectionResultsRepository DetectionResultsRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Training Data Management</MudText>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@AddTrainingSample">
                Add Training Sample
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        <!-- Statistics Cards -->
        @if (_stats != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Dataset" Size="Size.Large" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">@_stats.TotalSamples</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Total Samples</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Color="Color.Error" />
                            <MudText Typo="Typo.h6">@_stats.SpamSamples</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Spam Samples</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Large" Color="Color.Success" />
                            <MudText Typo="Typo.h6">@_stats.HamSamples</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Ham Samples</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Percent" Size="Size.Large" Color="@(_stats.SpamPercentage > 60 ? Color.Warning : Color.Info)" />
                            <MudText Typo="Typo.h6">@_stats.SpamPercentage.ToString("F1")%</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Spam Ratio</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Color="@(_conflictedMessageIds.Count > 0 ? Color.Error : Color.Success)" />
                            <MudText Typo="Typo.h6">@_conflictedMessageIds.Count</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Cross-Class Conflicts</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }

        <!-- Main Data Table -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="_searchText"
                                 Placeholder="Search training samples..."
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search"
                                 Immediate="true"
                                 OnKeyUp="@OnSearchChanged"
                                 Style="max-width: 300px;" />

                    <MudSelect T="string" Value="_typeFilter" ValueChanged="OnTypeFilterChanged" Label="Type Filter" Style="max-width: 150px;">
                        <MudSelectItem Value="@("all")">All</MudSelectItem>
                        <MudSelectItem Value="@("spam")">Spam Only</MudSelectItem>
                        <MudSelectItem Value="@("ham")">Ham Only</MudSelectItem>
                        <MudSelectItem Value="@("conflicts")">
                            <span style="color: var(--mud-palette-error);">‚ö†Ô∏è Conflicts Only</span>
                        </MudSelectItem>
                    </MudSelect>

                    <MudSelect T="string" Value="_sourceFilter" ValueChanged="OnSourceFilterChanged" Label="Source Filter" Style="max-width: 150px;">
                        <MudSelectItem Value="@("all")">All Sources</MudSelectItem>
                        @foreach (var source in _stats?.SamplesBySource.Keys ?? Enumerable.Empty<string>())
                        {
                            <MudSelectItem Value="@source">@source</MudSelectItem>
                        }
                    </MudSelect>

                    <MudText Typo="Typo.body2" Class="ml-auto">
                        Showing @_filteredSamples.Count() of @_allSamples.Count() samples
                    </MudText>
                </MudStack>

                <MudTable Items="@_filteredSamples"
                         Hover="true"
                         Breakpoint="Breakpoint.Sm"
                         Loading="@_loading"
                         LoadingProgressColor="Color.Info"
                         Dense="true">
                    <HeaderContent>
                        <MudTh>Type</MudTh>
                        <MudTh>Message Text</MudTh>
                        <MudTh>Source</MudTh>
                        <MudTh>Method</MudTh>
                        <MudTh>Confidence</MudTh>
                        <MudTh>Detected At</MudTh>
                        <MudTh>Added By</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Type">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudChip T="string" Size="Size.Small" Color="@(context.IsSpam ? Color.Error : Color.Success)">
                                    @(context.IsSpam ? "SPAM" : "HAM")
                                </MudChip>
                                @if (context.MessageId > 0 && _conflictedMessageIds.Contains(context.MessageId))
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" title="This message has both SPAM and HAM training samples">
                                        ‚ö†Ô∏è CONFLICT
                                    </MudChip>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Message Text">
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                @if (context.Translation != null)
                                {
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="tg-badge tg-badge-translation" title="Detected language: @context.Translation.DetectedLanguage" style="font-size: 0.75rem; padding: 2px 6px;">
                                            üåê @context.Translation.DetectedLanguage.ToUpper()‚ÜíEN
                                        </span>
                                        <MudIconButton Icon="@(GetShowTranslation(context.Id) ? Icons.Material.Filled.Translate : Icons.Material.Outlined.Translate)"
                                                       Size="Size.Small"
                                                       title="@(GetShowTranslation(context.Id) ? "Show original" : "Show translation")"
                                                       OnClick="@(() => ToggleTranslation(context.Id))" />
                                    </div>
                                }
                                <MudText Typo="Typo.body2" Style="max-width: 500px; word-wrap: break-word; white-space: pre-wrap;">
                                    @if (GetShowTranslation(context.Id) && context.Translation != null)
                                    {
                                        @context.Translation.TranslatedText
                                    }
                                    else
                                    {
                                        @context.MessageText
                                    }
                                </MudText>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Source">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                @context.DetectionSource
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Method">
                            <MudText Typo="Typo.body2">@context.DetectionMethod</MudText>
                        </MudTd>
                        <MudTd DataLabel="Confidence">
                            <MudText Typo="Typo.body2">@context.Confidence%</MudText>
                        </MudTd>
                        <MudTd DataLabel="Detected At">@context.DetectedAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd DataLabel="Added By">@(context.AddedBy.DisplayName ?? "System")</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudStack Row="true" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                             Color="Color.Primary"
                                             Size="Size.Small"
                                             OnClick="@(() => EditTrainingSample(context))"
                                             title="Edit" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                             Color="Color.Error"
                                             Size="Size.Small"
                                             OnClick="@(() => DeleteTrainingSample(context))"
                                             title="Remove from training (preserves history)" />
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                            @if (string.IsNullOrEmpty(_searchText) && _typeFilter == "all" && _sourceFilter == "all")
                            {
                                <span>No training samples found. Add some to get started!</span>
                            }
                            else
                            {
                                <span>No training samples match your search criteria.</span>
                            }
                        </MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private List<DetectionResultRecord> _allSamples = [];
    private IEnumerable<DetectionResultRecord> _filteredSamples = new List<DetectionResultRecord>();
    private TrainingDataStats? _stats;
    private bool _loading = true;
    private string _searchText = string.Empty;
    private string _typeFilter = "all";
    private string _sourceFilter = "all";
    private string? _currentUserId;
    private HashSet<long> _conflictedMessageIds = [];

    // Translation toggle state per sample (Phase 4.20+: Show translations in training samples)
    private readonly Dictionary<long, bool> _showTranslationState = new();

    /// <summary>
    /// Get translation display state for a sample (default: show translation if exists)
    /// </summary>
    private bool GetShowTranslation(long sampleId)
    {
        // Default to true (show translation), allow per-sample override
        return _showTranslationState.GetValueOrDefault(sampleId, true);
    }

    /// <summary>
    /// Toggle between showing translation and original text for a sample
    /// </summary>
    private void ToggleTranslation(long sampleId)
    {
        if (_showTranslationState.ContainsKey(sampleId))
        {
            _showTranslationState[sampleId] = !_showTranslationState[sampleId];
        }
        else
        {
            _showTranslationState[sampleId] = false; // Toggle from default (true) to false
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            var samplesTask = DetectionResultsRepository.GetAllTrainingDataAsync();
            var statsTask = DetectionResultsRepository.GetTrainingDataStatsAsync();

            await Task.WhenAll(samplesTask, statsTask);

            _allSamples = (await samplesTask).ToList();
            _stats = await statsTask;

            // Identify cross-class conflicts: message_ids with both spam and ham training samples
            // Only check positive message_ids (actual messages, not manual samples with negative IDs)
            _conflictedMessageIds = _allSamples
                .Where(s => s.MessageId > 0)
                .GroupBy(s => s.MessageId)
                .Where(g => g.Select(s => s.IsSpam).Distinct().Count() > 1) // Has both true and false
                .Select(g => g.Key)
                .ToHashSet();

            FilterSamples();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading training data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void FilterSamples()
    {
        var filtered = _allSamples.AsEnumerable();

        // Filter by search text
        if (!string.IsNullOrEmpty(_searchText))
        {
            filtered = filtered.Where(s =>
                (s.MessageText != null && s.MessageText.Contains(_searchText, StringComparison.OrdinalIgnoreCase)) ||
                s.DetectionSource.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                (s.AddedBy.DisplayName != null && s.AddedBy.DisplayName.Contains(_searchText, StringComparison.OrdinalIgnoreCase)));
        }

        // Filter by type
        filtered = _typeFilter switch
        {
            "spam" => filtered.Where(s => s.IsSpam),
            "ham" => filtered.Where(s => !s.IsSpam),
            "conflicts" => filtered.Where(s => s.MessageId > 0 && _conflictedMessageIds.Contains(s.MessageId)),
            _ => filtered
        };

        // Filter by source
        if (_sourceFilter != "all")
        {
            filtered = filtered.Where(s => s.DetectionSource == _sourceFilter);
        }

        _filteredSamples = filtered;
    }

    private void OnSearchChanged()
    {
        FilterSamples();
    }

    private void OnTypeFilterChanged(string value)
    {
        _typeFilter = value;
        FilterSamples();
    }

    private void OnSourceFilterChanged(string value)
    {
        _sourceFilter = value;
        FilterSamples();
    }

    private async Task AddTrainingSample()
    {
        var dialog = await DialogService.ShowAsync<AddTrainingSampleDialog>("Add Training Sample");
        var result = await dialog.Result;

        if (result is not null && result is { Canceled: false, Data: AddTrainingSampleData data })
        {
            try
            {
                await DetectionResultsRepository.AddManualTrainingSampleAsync(
                    data.MessageText,
                    data.IsSpam,
                    data.Source,
                    data.Confidence,
                    _currentUserId,
                    data.TranslatedText,
                    data.DetectedLanguage);

                var translationNote = data.TranslatedText != null ? $" (with {data.DetectedLanguage?.ToUpper()} translation)" : "";
                Snackbar.Add($"Training sample added successfully{translationNote}", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding training sample: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EditTrainingSample(DetectionResultRecord sample)
    {
        var parameters = new DialogParameters<EditTrainingSampleDialog>
        {
            { x => x.Sample, sample }
        };

        var dialog = await DialogService.ShowAsync<EditTrainingSampleDialog>("Edit Training Sample", parameters);
        var result = await dialog.Result;

        if (result is not null && result is { Canceled: false, Data: EditTrainingSampleData data })
        {
            try
            {
                await DetectionResultsRepository.UpdateDetectionResultAsync(
                    data.Id,
                    data.IsSpam,
                    usedForTraining: true);

                Snackbar.Add("Training sample updated successfully", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating training sample: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteTrainingSample(DetectionResultRecord sample)
    {
        var messagePreview = sample.MessageText ?? "";
        var confirmed = await DialogService.ShowMessageBox(
            "Remove from Training Data",
            $"Remove this {(sample.IsSpam ? "SPAM" : "HAM")} sample from training data?\n\n" +
            $"\"{messagePreview[..Math.Min(messagePreview.Length, 100)]}{(messagePreview.Length > 100 ? "..." : "")}\"\n\n" +
            $"Note: This preserves detection history but excludes the sample from future Bayes training.",
            yesText: "Remove", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                // Soft delete: Mark as not used for training (preserves detection history)
                await DetectionResultsRepository.UpdateDetectionResultAsync(
                    sample.Id,
                    sample.IsSpam,
                    usedForTraining: false);

                Snackbar.Add("Training sample removed (detection history preserved)", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error removing training sample: {ex.Message}", Severity.Error);
            }
        }
    }
}