@using TelegramGroupsAdmin.ContentDetection.Models
@using TelegramGroupsAdmin.Services
@inject IConfigService ConfigService
@inject IPromptVersionRepository PromptVersionRepository
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject BlazorAuthHelper AuthHelper

<MudPaper Class="pa-4" Elevation="1">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h6" Color="Color.Primary">AI Veto Check</MudText>
            <HelpTooltip Text="Uses AI to verify spam detected by other algorithms. Acts as quality control to reduce false positives - only runs on messages already flagged as potential spam. Slow (~1.2s avg) but high quality." />
        </MudStack>

        @if (!IsGlobalView)
        {
            <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                <MudSwitch T="bool" @bind-Value="_config.AIVeto.UseGlobal"
                          Label="@(_config.AIVeto.UseGlobal ? "Using Global Settings" : "Using Custom Settings")"
                          Color="@(_config.AIVeto.UseGlobal ? Color.Default : Color.Primary)" />
            </MudPaper>
        }

        @{
            var aiVetoConfig = (IsGlobalView || !_config.AIVeto.UseGlobal) ? _config.AIVeto : _globalConfig.AIVeto;
            var aiVetoReadOnly = !IsGlobalView && _config.AIVeto.UseGlobal;
        }

        <MudSwitch T="bool" @bind-Value="aiVetoConfig.Enabled"
                  Label="Enable AI Veto Check"
                  Color="Color.Primary"
                  Disabled="@aiVetoReadOnly" />

        @if (aiVetoConfig.Enabled)
        {
            <ConceptualAlert Severity="Severity.Success" Dense="true">
                <strong>AI Veto Mode:</strong> AI acts as quality control for spam detection.
                Other algorithms flag potential spam, AI confirms or vetoes the detection.
                This reduces false positives while keeping API costs low (only runs on suspicious messages).
            </ConceptualAlert>

            <MudSwitch T="bool" @bind-Value="aiVetoConfig.CheckShortMessages"
                      Label="Check Short Messages"
                      Color="Color.Primary"
                      Disabled="@aiVetoReadOnly" />

            <FieldWithHelp HelpText="Number of recent messages to include as context for AI analysis. Higher values provide more conversation context but increase API costs. 0 = no history, 3-5 recommended for most groups.">
                <MudNumericField @bind-Value="aiVetoConfig.MessageHistoryCount"
                                Label="Message History Count"
                                Min="0" Max="10"
                                Disabled="@aiVetoReadOnly"
                                HelperText="@(aiVetoReadOnly ? $"Using global value: {aiVetoConfig.MessageHistoryCount}" : "Recent messages sent to AI for context (0-10)")" />
            </FieldWithHelp>

            @* Active prompt from prompt_versions table (use AI Prompt Builder below to create/modify) *@
            @if (!string.IsNullOrEmpty(_activePromptText))
            {
                <MudTextField Value="@_activePromptText"
                             Label="Active System Prompt"
                             Lines="4"
                             AutoGrow="true"
                             Variant="Variant.Outlined"
                             ReadOnly="true"
                             HelperText="Use AI Prompt Builder below to generate or modify prompts" />
            }
            else
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                    No custom prompt configured. Use the AI Prompt Builder below to generate one, or the default prompt will be used.
                </MudAlert>
            }

            <MudNumericField @bind-Value="aiVetoConfig.ConfidenceThreshold"
                            Label="Confidence Threshold"
                            Min="1" Max="100"
                            Disabled="@aiVetoReadOnly"
                            HelperText="@(aiVetoReadOnly ? $"Using global value: {aiVetoConfig.ConfidenceThreshold}" : "Confidence level for AI spam classification")" />

            @* AI Prompt Builder - NOW AVAILABLE FOR BOTH GLOBAL AND PER-CHAT *@
            @if (!aiVetoReadOnly)
            {
                <MudDivider Class="my-2" />
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary">AI Prompt Builder</MudText>
                    <MudSpacer />
                    <MudButton Color="Color.Primary"
                              Variant="Variant.Filled"
                              Size="Size.Small"
                              StartIcon="@Icons.Material.Filled.AutoAwesome"
                              OnClick="@OpenPromptBuilder">
                        Generate with AI
                    </MudButton>
                </MudStack>

                @if (_promptVersions.Any())
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        Version History (@_promptVersions.Count versions)
                    </MudText>

                    <MudList T="string" Dense="true">
                        @foreach (var version in _promptVersions.Take(5))
                        {
                            <MudListItem T="string">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudChip T="string"
                                            Size="Size.Small"
                                            Color="@(version.IsActive ? Color.Success : Color.Default)"
                                            Variant="@(version.IsActive ? Variant.Filled : Variant.Outlined)">
                                        v@(version.Version)
                                    </MudChip>
                                    <MudText Typo="Typo.caption" Class="flex-grow-1">
                                        @version.CreatedAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")
                                        @if (!string.IsNullOrEmpty(version.CreatedBy))
                                        {
                                            <text> by @version.CreatedBy</text>
                                        }
                                    </MudText>
                                    @if (!version.IsActive)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.RestorePage"
                                                      Size="Size.Small"
                                                      Color="Color.Primary"
                                                      OnClick="@(() => RestoreVersion(version.Id))"
                                                      title="Restore this version" />
                                    }
                                    <MudIconButton Icon="@Icons.Material.Filled.AutoFixHigh"
                                                  Size="Size.Small"
                                                  Color="Color.Secondary"
                                                  OnClick="@(() => OpenImproveDialog(version))"
                                                  title="Improve with AI" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                  Size="Size.Small"
                                                  Color="Color.Default"
                                                  OnClick="@(() => ViewVersion(version))"
                                                  title="View prompt" />
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>

                    @if (_promptVersions.Count > 5)
                    {
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            Showing 5 of @_promptVersions.Count versions
                        </MudText>
                    }
                }
            }
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private ContentDetectionConfig _config = new();
    private ContentDetectionConfig _globalConfig = new();
    private List<PromptVersion> _promptVersions = [];
    private string? _activePromptText; // Current active prompt from prompt_versions table
    private bool IsGlobalView => ChatId is null or 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
        await LoadPromptVersions();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            // Always load global config for comparison/fallback
            _globalConfig = await ConfigService.GetAsync<ContentDetectionConfig>(ConfigType.ContentDetection, 0)
                            ?? new ContentDetectionConfig();

            if (IsGlobalView)
            {
                // Editing global config directly
                _config = _globalConfig;
            }
            else
            {
                // Load chat-specific config (which may have UseGlobal flags set)
                var chatConfig = await ConfigService.GetAsync<ContentDetectionConfig>(ConfigType.ContentDetection, ChatId!.Value);
                _config = chatConfig ?? new ContentDetectionConfig();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new ContentDetectionConfig();
            _globalConfig = new ContentDetectionConfig();
        }
    }

    public ContentDetectionConfig GetConfig()
    {
        // Ensure global configs always have UseGlobal=true
        if (IsGlobalView)
        {
            _config.AIVeto.UseGlobal = true;
        }

        return _config;
    }

    private async Task LoadPromptVersions()
    {
        // Load prompt versions for the current scope (global or chat-specific)
        long targetChatId = IsGlobalView ? 0 : (ChatId ?? 0);

        try
        {
            _promptVersions = await PromptVersionRepository.GetVersionHistoryByChatIdAsync(targetChatId);
            // Set active prompt text for display
            _activePromptText = _promptVersions.FirstOrDefault(v => v.IsActive)?.PromptText;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading prompt versions: {ex.Message}", Severity.Warning);
            _promptVersions = [];
        }
    }

    private async Task OpenPromptBuilder()
    {
        long targetChatId = IsGlobalView ? 0 : (ChatId ?? 0);

        var parameters = new DialogParameters<PromptBuilderDialog>
        {
            { x => x.ChatId, targetChatId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<PromptBuilderDialog>("AI Prompt Builder", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: string generatedPrompt })
        {
            try
            {
                var userEmail = await AuthHelper.GetCurrentUserEmailAsync();

                // Save as new version
                var newVersion = await PromptVersionRepository.CreateVersionAsync(
                    targetChatId,
                    generatedPrompt,
                    userEmail,
                    null
                );

                // Prompt saved to prompt_versions table - reload versions to show the new one
                await LoadPromptVersions();

                Snackbar.Add($"Prompt v{newVersion.Version} created and activated!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving prompt: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RestoreVersion(long versionId)
    {
        try
        {
            var restoredVersion = await PromptVersionRepository.RestoreVersionAsync(versionId);

            // Reload versions to update UI (prompt stored in prompt_versions table)
            await LoadPromptVersions();

            Snackbar.Add($"Prompt v{restoredVersion.Version} restored and activated!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error restoring prompt: {ex.Message}", Severity.Error);
        }
    }

    private async Task ViewVersion(PromptVersion version)
    {
        await DialogService.ShowMessageBox(
            $"Prompt Version {version.Version}",
            version.PromptText,
            "Close");
    }

    private async Task OpenImproveDialog(PromptVersion version)
    {
        var parameters = new DialogParameters<PromptImprovementDialog>
        {
            { x => x.CurrentPrompt, version.PromptText }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<PromptImprovementDialog>(
            $"Improve Prompt v{version.Version}",
            parameters,
            options);

        var result = await dialog.Result;

        if (result is { Canceled: false, Data: string improvedPrompt })
        {
            try
            {
                long targetChatId = IsGlobalView ? 0 : (ChatId ?? 0);
                var userEmail = await AuthHelper.GetCurrentUserEmailAsync();

                // Save as new version
                var newVersion = await PromptVersionRepository.CreateVersionAsync(
                    targetChatId,
                    improvedPrompt,
                    userEmail,
                    null
                );

                // Prompt saved to prompt_versions table - reload versions to show the new one
                await LoadPromptVersions();

                Snackbar.Add($"Improved prompt saved as v{newVersion.Version} and activated!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving improved prompt: {ex.Message}", Severity.Error);
            }
        }
    }
}
