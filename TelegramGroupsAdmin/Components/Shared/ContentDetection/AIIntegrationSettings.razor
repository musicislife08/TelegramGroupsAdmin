@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.Core.Services.AI
@using TelegramGroupsAdmin.Services
@inject ISystemConfigRepository ConfigRepository
@inject IAIServiceFactory AIServiceFactory
@inject IFeatureTestService FeatureTestService
@inject IAuditService AuditService
@inject BlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudStack Spacing="3" Class="mb-4">
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
        <MudText Typo="Typo.subtitle2"><strong>AI Feature Configuration</strong></MudText>
        <MudText Typo="Typo.body2">
            Assign AI connections and models to each feature. Connections are configured in
            <MudLink OnClick="@(() => Navigation.NavigateTo("/settings/system/ai-providers"))"
                     Style="cursor: pointer; color: inherit; text-decoration: underline;">
                System â†’ AI Providers
            </MudLink>.
        </MudText>
    </MudAlert>

    @if (!_config.Connections.Any(c => c.Enabled))
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
            <MudText Typo="Typo.body2">
                <strong>No AI Connections Available:</strong> Configure and enable at least one AI connection
                in <MudLink OnClick="@(() => Navigation.NavigateTo("/settings/system/ai-providers"))"
                           Style="cursor: pointer; color: inherit; text-decoration: underline;">
                    AI Providers
                </MudLink> before configuring features.
            </MudText>
        </MudAlert>
    }
</MudStack>

<MudGrid>
    @foreach (var featureType in Enum.GetValues<AIFeatureType>())
    {
        <MudItem xs="12" md="6">
            <AIFeatureCard FeatureType="@featureType"
                           FeatureConfig="@GetFeatureConfig(featureType)"
                           Connections="@_config.Connections"
                           TestService="@FeatureTestService"
                           OnConnectionChanged="@((connectionId) => OnConnectionChanged(featureType, connectionId))"
                           OnRefreshModels="@RefreshModels"
                           IsRefreshingModels="@(_refreshingConnectionId != null)" />
        </MudItem>
    }
</MudGrid>

<!-- Save Button -->
<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudStack Spacing="3">
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@SaveConfigAsync"
                       Disabled="@_isSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <text>&nbsp;Saving...</text>
                }
                else
                {
                    <text>Save Feature Configuration</text>
                }
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="@LoadConfigAsync"
                       Disabled="@_isSaving"
                       StartIcon="@Icons.Material.Filled.Refresh">
                Reset
            </MudButton>
        </MudStack>

        <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Info">
            Changes apply immediately (hot-reload). No app restart required.
        </MudAlert>
    </MudStack>
</MudPaper>

@code {
    private AIProviderConfig _config = new();
    private bool _isSaving;
    private string? _refreshingConnectionId;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigAsync();
    }

    private async Task LoadConfigAsync()
    {
        try
        {
            var config = await ConfigRepository.GetAIProviderConfigAsync();
            _config = config ?? new AIProviderConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new AIProviderConfig();
        }
    }

    private async Task SaveConfigAsync()
    {
        _isSaving = true;
        try
        {
            await ConfigRepository.SaveAIProviderConfigAsync(_config);

            // Audit log
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(userId))
            {
                var configuredCount = _config.Features.Count(f => f.Value.ConnectionId != null);
                await AuditService.LogEventAsync(
                    AuditEventType.ConfigurationChanged,
                    Actor.FromWebUser(userId),
                    Actor.FromWebUser(userId),
                    $"ai_features:configured={configuredCount}");
            }

            Snackbar.Add("AI feature configuration saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private AIFeatureConfig GetFeatureConfig(AIFeatureType featureType)
    {
        if (!_config.Features.TryGetValue(featureType, out var config))
        {
            config = new AIFeatureConfig();
            _config.Features[featureType] = config;
        }
        return config;
    }

    private void OnConnectionChanged(AIFeatureType featureType, string? connectionId)
    {
        var config = GetFeatureConfig(featureType);
        config.ConnectionId = connectionId;

        // Reset model if connection changed
        if (connectionId != null)
        {
            var connection = _config.Connections.FirstOrDefault(c => c.Id == connectionId);
            if (connection != null)
            {
                // Set default model based on provider
                if (connection.Provider == AIProviderType.AzureOpenAI)
                {
                    config.AzureDeploymentName ??= "";
                }
                else if (connection.AvailableModels.Count > 0)
                {
                    // Pick first model or keep existing if valid
                    if (!connection.AvailableModels.Any(m => m.Id == config.Model))
                    {
                        config.Model = connection.AvailableModels[0].Id;
                    }
                }
            }
        }
    }

    private async Task RefreshModels(AIConnection connection)
    {
        _refreshingConnectionId = connection.Id;
        try
        {
            var models = await AIServiceFactory.RefreshModelsAsync(connection.Id);
            connection.AvailableModels = models.ToList();
            connection.ModelsLastFetched = DateTimeOffset.UtcNow;

            if (models.Count > 0)
            {
                Snackbar.Add($"Loaded {models.Count} models from {connection.Id}", Severity.Success);
            }
            else
            {
                Snackbar.Add($"No models found for {connection.Id}. Check connection settings.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching models: {ex.Message}", Severity.Error);
        }
        finally
        {
            _refreshingConnectionId = null;
        }
    }
}
