@using TelegramGroupsAdmin.Configuration.Models
@using TelegramGroupsAdmin.Configuration.Repositories
@using TelegramGroupsAdmin.Core.Services.AI
@using TelegramGroupsAdmin.Services
@inject ISystemConfigRepository ConfigRepository
@inject IAIServiceFactory AIServiceFactory
@inject IAuditService AuditService
@inject BlazorAuthHelper AuthHelper
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudStack Spacing="3" Class="mb-4">
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
        <MudText Typo="Typo.subtitle2"><strong>AI Feature Configuration</strong></MudText>
        <MudText Typo="Typo.body2">
            Assign AI connections and models to each feature. Connections are configured in
            <MudLink OnClick="@(() => Navigation.NavigateTo("/settings/system/ai-providers"))"
                     Style="cursor: pointer; color: inherit; text-decoration: underline;">
                System â†’ AI Providers
            </MudLink>.
        </MudText>
    </MudAlert>

    @if (!_config.Connections.Any(c => c.Enabled))
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
            <MudText Typo="Typo.body2">
                <strong>No AI Connections Available:</strong> Configure and enable at least one AI connection
                in <MudLink OnClick="@(() => Navigation.NavigateTo("/settings/system/ai-providers"))"
                           Style="cursor: pointer; color: inherit; text-decoration: underline;">
                    AI Providers
                </MudLink> before configuring features.
            </MudText>
        </MudAlert>
    }
</MudStack>

<MudGrid>
    @foreach (var featureType in Enum.GetValues<AIFeatureType>())
    {
        var featureConfig = GetFeatureConfig(featureType);
        var selectedConnection = GetConnection(featureConfig.ConnectionId);
        var isVisionFeature = featureType is AIFeatureType.ImageAnalysis or AIFeatureType.VideoAnalysis;

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Spacing="3">
                    <!-- Feature Header -->
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@GetFeatureIcon(featureType)" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">@GetFeatureDisplayName(featureType)</MudText>
                        </MudStack>
                        @if (isVisionFeature)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Icon="@Icons.Material.Filled.Visibility">
                                Vision
                            </MudChip>
                        }
                    </MudStack>

                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @GetFeatureDescription(featureType)
                    </MudText>

                    <MudDivider />

                    <!-- Connection Selector -->
                    <MudSelect T="string"
                               Value="@featureConfig.ConnectionId"
                               ValueChanged="@((string val) => OnConnectionChanged(featureType, val))"
                               Label="Connection"
                               Variant="Variant.Outlined"
                               HelperText="@GetConnectionHelperText(selectedConnection)">
                        <MudSelectItem T="string" Value="@((string?)null)">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Color="Color.Error" />
                                <span>Disabled</span>
                            </MudStack>
                        </MudSelectItem>
                        @foreach (var conn in _config.Connections.Where(c => c.Enabled))
                        {
                            <MudSelectItem T="string" Value="@conn.Id">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@GetProviderIcon(conn.Provider)" Size="Size.Small" />
                                    <span>@conn.Id (@GetProviderShortName(conn.Provider))</span>
                                </MudStack>
                            </MudSelectItem>
                        }
                    </MudSelect>

                    @if (featureConfig.ConnectionId != null && selectedConnection != null)
                    {
                        <!-- Model Selection -->
                        @if (selectedConnection.Provider == AIProviderType.AzureOpenAI)
                        {
                            <!-- Azure: Deployment name text field -->
                            <MudTextField @bind-Value="featureConfig.AzureDeploymentName"
                                          Label="Deployment Name"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          HelperText="Azure OpenAI deployment name from Azure Portal" />
                        }
                        else
                        {
                            <!-- OpenAI/Local: Model dropdown or text field -->
                            <MudStack Row="true" AlignItems="AlignItems.End" Spacing="2">
                                @if (selectedConnection.AvailableModels.Count > 0)
                                {
                                    <MudSelect T="string"
                                               @bind-Value="featureConfig.Model"
                                               Label="Model"
                                               Variant="Variant.Outlined"
                                               Style="flex-grow: 1;">
                                        @foreach (var model in selectedConnection.AvailableModels)
                                        {
                                            <MudSelectItem T="string" Value="@model.Id">
                                                @model.Id @(model.SizeBytes.HasValue ? $" ({ByteSizeLib.ByteSize.FromBytes(model.SizeBytes.Value):0.#})" : "")
                                            </MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                                else
                                {
                                    <MudTextField @bind-Value="featureConfig.Model"
                                                  Label="Model"
                                                  Variant="Variant.Outlined"
                                                  Placeholder="gpt-4o-mini"
                                                  HelperText="Click refresh to load available models"
                                                  Style="flex-grow: 1;" />
                                }
                                <MudTooltip Text="Refresh available models">
                                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                                   OnClick="@(() => RefreshModels(selectedConnection))"
                                                   Disabled="@(_refreshingConnectionId == selectedConnection.Id)"
                                                   Color="Color.Primary" />
                                </MudTooltip>
                            </MudStack>

                            @if (selectedConnection.ModelsLastFetched.HasValue)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @selectedConnection.AvailableModels.Count models available
                                    (fetched @FormatRelativeTime(selectedConnection.ModelsLastFetched.Value))
                                </MudText>
                            }
                        }

                        <!-- Parameters -->
                        <MudStack Row="true" Spacing="2">
                            <MudNumericField @bind-Value="featureConfig.MaxTokens"
                                             Label="Max Tokens"
                                             Variant="Variant.Outlined"
                                             Min="100" Max="4000"
                                             Style="flex: 1;" />
                            <MudNumericField @bind-Value="featureConfig.Temperature"
                                             Label="Temperature"
                                             Variant="Variant.Outlined"
                                             Min="0.0" Max="2.0" Step="0.1"
                                             Format="F1"
                                             Style="flex: 1;" />
                        </MudStack>

                    }
                    else
                    {
                        <MudAlert Severity="Severity.Normal" Dense="true" Icon="@Icons.Material.Filled.Info">
                            Feature disabled - select a connection to enable.
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

<!-- Save Button -->
<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudStack Spacing="3">
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@SaveConfigAsync"
                       Disabled="@_isSaving"
                       StartIcon="@Icons.Material.Filled.Save">
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <text>&nbsp;Saving...</text>
                }
                else
                {
                    <text>Save Feature Configuration</text>
                }
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="@LoadConfigAsync"
                       Disabled="@_isSaving"
                       StartIcon="@Icons.Material.Filled.Refresh">
                Reset
            </MudButton>
        </MudStack>

        <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Info">
            Changes apply immediately (hot-reload). No app restart required.
        </MudAlert>
    </MudStack>
</MudPaper>

@code {
    private AIProviderConfig _config = new();
    private bool _isSaving;
    private string? _refreshingConnectionId;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigAsync();
    }

    private async Task LoadConfigAsync()
    {
        try
        {
            var config = await ConfigRepository.GetAIProviderConfigAsync();
            _config = config ?? new AIProviderConfig();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new AIProviderConfig();
        }
    }

    private async Task SaveConfigAsync()
    {
        _isSaving = true;
        try
        {
            await ConfigRepository.SaveAIProviderConfigAsync(_config);

            // Audit log
            var userId = await AuthHelper.GetCurrentUserIdAsync();
            if (!string.IsNullOrEmpty(userId))
            {
                var configuredCount = _config.Features.Count(f => f.Value.ConnectionId != null);
                await AuditService.LogEventAsync(
                    AuditEventType.ConfigurationChanged,
                    Actor.FromWebUser(userId),
                    Actor.FromWebUser(userId),
                    $"ai_features:configured={configuredCount}");
            }

            Snackbar.Add("AI feature configuration saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private AIFeatureConfig GetFeatureConfig(AIFeatureType featureType)
    {
        if (!_config.Features.TryGetValue(featureType, out var config))
        {
            config = new AIFeatureConfig();
            _config.Features[featureType] = config;
        }
        return config;
    }

    private AIConnection? GetConnection(string? connectionId)
    {
        return connectionId == null
            ? null
            : _config.Connections.FirstOrDefault(c => c.Id == connectionId);
    }

    private void OnConnectionChanged(AIFeatureType featureType, string? connectionId)
    {
        var config = GetFeatureConfig(featureType);
        config.ConnectionId = connectionId;

        // Reset model if connection changed
        if (connectionId != null)
        {
            var connection = GetConnection(connectionId);
            if (connection != null)
            {
                // Set default model based on provider
                if (connection.Provider == AIProviderType.AzureOpenAI)
                {
                    config.AzureDeploymentName ??= "";
                }
                else if (connection.AvailableModels.Count > 0)
                {
                    // Pick first model or keep existing if valid
                    if (!connection.AvailableModels.Any(m => m.Id == config.Model))
                    {
                        config.Model = connection.AvailableModels[0].Id;
                    }
                }
            }
        }
    }

    private async Task RefreshModels(AIConnection connection)
    {
        _refreshingConnectionId = connection.Id;
        try
        {
            var models = await AIServiceFactory.RefreshModelsAsync(connection.Id);
            connection.AvailableModels = models.ToList();
            connection.ModelsLastFetched = DateTimeOffset.UtcNow;

            if (models.Count > 0)
            {
                Snackbar.Add($"Loaded {models.Count} models from {connection.Id}", Severity.Success);
            }
            else
            {
                Snackbar.Add($"No models found for {connection.Id}. Check connection settings.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching models: {ex.Message}", Severity.Error);
        }
        finally
        {
            _refreshingConnectionId = null;
        }
    }

    private static string GetFeatureDisplayName(AIFeatureType feature) => feature switch
    {
        AIFeatureType.SpamDetection => "Spam Detection",
        AIFeatureType.Translation => "Translation",
        AIFeatureType.ImageAnalysis => "Image Analysis",
        AIFeatureType.VideoAnalysis => "Video Analysis",
        AIFeatureType.PromptBuilder => "Prompt Builder",
        _ => feature.ToString()
    };

    private static string GetFeatureDescription(AIFeatureType feature) => feature switch
    {
        AIFeatureType.SpamDetection => "AI-powered text spam analysis using LLM classification",
        AIFeatureType.Translation => "Automatic translation of non-English messages for spam detection",
        AIFeatureType.ImageAnalysis => "Vision API for detecting spam in images (requires vision-capable model)",
        AIFeatureType.VideoAnalysis => "Vision API for detecting spam in video frames (requires vision-capable model)",
        AIFeatureType.PromptBuilder => "AI-assisted prompt generation for spam detection rules",
        _ => ""
    };

    private static string GetFeatureIcon(AIFeatureType feature) => feature switch
    {
        AIFeatureType.SpamDetection => Icons.Material.Filled.Shield,
        AIFeatureType.Translation => Icons.Material.Filled.Translate,
        AIFeatureType.ImageAnalysis => Icons.Material.Filled.Image,
        AIFeatureType.VideoAnalysis => Icons.Material.Filled.VideoLibrary,
        AIFeatureType.PromptBuilder => Icons.Material.Filled.AutoAwesome,
        _ => Icons.Material.Filled.Psychology
    };

    private static string GetProviderIcon(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => Icons.Material.Filled.Cloud,
        AIProviderType.AzureOpenAI => Icons.Material.Filled.CloudQueue,
        AIProviderType.LocalOpenAI => Icons.Material.Filled.Computer,
        _ => Icons.Material.Filled.Psychology
    };

    private static string GetProviderShortName(AIProviderType provider) => provider switch
    {
        AIProviderType.OpenAI => "OpenAI",
        AIProviderType.AzureOpenAI => "Azure",
        AIProviderType.LocalOpenAI => "Local",
        _ => provider.ToString()
    };

    private static string GetConnectionHelperText(AIConnection? connection)
    {
        if (connection == null)
            return "Select an enabled connection to configure this feature";

        return connection.Provider switch
        {
            AIProviderType.OpenAI => "Using OpenAI API (api.openai.com)",
            AIProviderType.AzureOpenAI => $"Using Azure OpenAI at {connection.AzureEndpoint ?? "(not configured)"}",
            AIProviderType.LocalOpenAI => $"Using local endpoint at {connection.LocalEndpoint ?? "(not configured)"}",
            _ => ""
        };
    }

    private static string FormatRelativeTime(DateTimeOffset dateTime)
    {
        var diff = DateTimeOffset.UtcNow - dateTime;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} min ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hr ago";
        return $"{(int)diff.TotalDays} days ago";
    }
}
