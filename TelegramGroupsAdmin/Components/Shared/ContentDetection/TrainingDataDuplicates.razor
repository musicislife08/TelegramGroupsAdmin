@using TelegramGroupsAdmin.Telegram.Services
@using TelegramGroupsAdmin.Telegram.Models
@using TelegramGroupsAdmin.Telegram.Repositories
@inject TrainingDataDeduplicationService DeduplicationService
@inject IDetectionResultsRepository DetectionResultsRepository
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Training Data Deduplication</MudText>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="@AnalyzeTrainingData"
                      Disabled="@_loading">
                Analyze Duplicates
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        @if (_result != null)
        {
            <!-- Statistics Cards (Clickable Filters) -->
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="@(_selectedView == "exact" ? 4 : 2)"
                             Style="@(_selectedView == "exact" ? "border: 2px solid var(--mud-palette-error);" : "cursor: pointer;")"
                             @onclick="@(() => _selectedView = "exact")">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Large" Color="Color.Error" />
                            <MudText Typo="Typo.h6">@_result.ExactDuplicates.Count</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Exact Duplicates</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="@(_selectedView == "very-similar" ? 4 : 2)"
                             Style="@(_selectedView == "very-similar" ? "border: 2px solid var(--mud-palette-warning);" : "cursor: pointer;")"
                             @onclick="@(() => _selectedView = "very-similar")">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Size="Size.Large" Color="Color.Warning" />
                            <MudText Typo="Typo.h6">@_result.VerySimilar.Count</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Very Similar (95-99%)</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="@(_selectedView == "similar" ? 4 : 2)"
                             Style="@(_selectedView == "similar" ? "border: 2px solid var(--mud-palette-info);" : "cursor: pointer;")"
                             @onclick="@(() => _selectedView = "similar")">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Compare" Size="Size.Large" Color="Color.Info" />
                            <MudText Typo="Typo.h6">@_result.Similar.Count</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Similar (90-94%)</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Large" Color="Color.Success" />
                            <MudText Typo="Typo.h6">@_result.PotentialReduction</MudText>
                            <MudText Typo="Typo.body2" Align="Align.Center">Potential Reduction</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Duplicate Groups -->
            @if (GetCurrentGroups().Any())
            {
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-4">
                    <MudText Typo="Typo.h5">@GetViewTitle()</MudText>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Warning"
                              StartIcon="@Icons.Material.Filled.DeleteSweep"
                              OnClick="@(() => RemoveAllDuplicatesInView(GetCurrentGroups()))"
                              Disabled="@_processing">
                        Remove All Duplicates (Keep Recommended)
                    </MudButton>
                </MudStack>
                @foreach (var group in GetCurrentGroups())
                {
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.SpaceBetween">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudChip T="string" Size="Size.Small" Color="@(group.IsSameClass ? Color.Info : Color.Error)">
                                        @(group.IsSameClass ? "Same Class" : "⚠️ CROSS-CLASS CONFLICT")
                                    </MudChip>
                                    <MudText Typo="Typo.body2">@group.DuplicateCount duplicates · Avg confidence: @group.AverageConfidence.ToString("F0")%</MudText>
                                </MudStack>
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Warning"
                                          Size="Size.Small"
                                          StartIcon="@Icons.Material.Filled.Delete"
                                          OnClick="@(() => RemoveGroupDuplicates(group))"
                                          Disabled="@_processing">
                                    Remove Duplicates
                                </MudButton>
                            </MudStack>
                            <MudText Typo="Typo.body1" Style="max-width: 800px; word-wrap: break-word;">
                                "@group.MessageText[..Math.Min(200, group.MessageText.Length)]@(group.MessageText.Length > 200 ? "..." : "")"
                            </MudText>
                            <MudDivider />
                            @foreach (var sample in group.Samples)
                            {
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudChip T="string" Size="Size.Small" Color="@(sample.IsSpam ? Color.Error : Color.Success)">
                                            @(sample.IsSpam ? "SPAM" : "HAM")
                                        </MudChip>
                                        @if (sample.Id == group.RecommendedKeep?.Id)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">✓ Recommended Keep</MudChip>
                                        }
                                        <MudText Typo="Typo.body2">
                                            @sample.DetectionSource · @sample.Confidence% · @sample.DetectedAt.ToString("yyyy-MM-dd HH:mm")
                                        </MudText>
                                    </MudStack>
                                    @if (sample.Id != group.RecommendedKeep?.Id)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Color="Color.Error"
                                                      Size="Size.Small"
                                                      OnClick="@(() => RemoveSample(sample))"
                                                      Disabled="@_processing"
                                                      title="Remove from training" />
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudPaper>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">
                    No @GetViewTitle().ToLower() found in training data.
                </MudAlert>
            }
        }
    </MudStack>
</MudContainer>

@code {
    private DuplicateAnalysisResult? _result;
    private bool _loading;
    private bool _processing;
    private string _selectedView = "exact";

    private List<DuplicateGroup> GetCurrentGroups()
    {
        if (_result == null) return new List<DuplicateGroup>();

        return _selectedView switch
        {
            "exact" => _result.ExactDuplicates,
            "very-similar" => _result.VerySimilar,
            "similar" => _result.Similar,
            _ => _result.ExactDuplicates
        };
    }

    private string GetViewTitle()
    {
        return _selectedView switch
        {
            "exact" => "Exact Duplicates (100% Match)",
            "very-similar" => "Very Similar (95-99% Match)",
            "similar" => "Similar (90-94% Match)",
            _ => "Exact Duplicates (100% Match)"
        };
    }

    private async Task AnalyzeTrainingData()
    {
        _loading = true;
        try
        {
            _result = await DeduplicationService.AnalyzeTrainingDataAsync();
            Snackbar.Add("Training data analysis complete", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error analyzing training data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RemoveSample(TrainingSampleDto sample)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove from Training",
            $"Remove this {(sample.IsSpam ? "SPAM" : "HAM")} sample from training data?\n\nThis preserves detection history but excludes it from Bayes training.",
            yesText: "Remove", cancelText: "Cancel");

        if (confirmed == true)
        {
            _processing = true;
            try
            {
                await DetectionResultsRepository.UpdateDetectionResultAsync(
                    sample.Id,
                    sample.IsSpam,
                    usedForTraining: false);

                Snackbar.Add("Sample removed from training data", Severity.Success);

                // Re-analyze to update the UI
                await AnalyzeTrainingData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error removing sample: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processing = false;
            }
        }
    }

    private async Task RemoveGroupDuplicates(DuplicateGroup group)
    {
        var duplicatesToRemove = group.Samples.Where(s => s.Id != group.RecommendedKeep?.Id).Count();
        var confirmed = await DialogService.ShowMessageBox(
            "Remove Duplicates",
            $"Remove {duplicatesToRemove} duplicate sample(s) from this group?\n\nThe recommended sample (highest confidence, most recent) will be kept.\n\nThis preserves detection history but excludes duplicates from Bayes training.",
            yesText: "Remove Duplicates", cancelText: "Cancel");

        if (confirmed == true)
        {
            _processing = true;
            try
            {
                var removed = 0;
                foreach (var sample in group.Samples.Where(s => s.Id != group.RecommendedKeep?.Id))
                {
                    await DetectionResultsRepository.UpdateDetectionResultAsync(
                        sample.Id,
                        sample.IsSpam,
                        usedForTraining: false);
                    removed++;
                }

                Snackbar.Add($"Removed {removed} duplicate sample(s) from training data", Severity.Success);

                // Re-analyze to update the UI
                await AnalyzeTrainingData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error removing duplicates: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processing = false;
            }
        }
    }

    private async Task RemoveAllDuplicatesInView(List<DuplicateGroup> groups)
    {
        if (_result == null) return;

        var totalDuplicates = groups.Sum(g => g.Samples.Count(s => s.Id != g.RecommendedKeep?.Id));
        var confirmed = await DialogService.ShowMessageBox(
            "Remove All Duplicates",
            $"Remove {totalDuplicates} duplicate sample(s) across {groups.Count} groups?\n\nFor each group, the recommended sample (highest confidence, most recent) will be kept.\n\nThis preserves detection history but excludes duplicates from Bayes training.",
            yesText: "Remove All Duplicates", cancelText: "Cancel");

        if (confirmed == true)
        {
            _processing = true;
            try
            {
                var removed = 0;
                foreach (var group in groups)
                {
                    foreach (var sample in group.Samples.Where(s => s.Id != group.RecommendedKeep?.Id))
                    {
                        await DetectionResultsRepository.UpdateDetectionResultAsync(
                            sample.Id,
                            sample.IsSpam,
                            usedForTraining: false);
                        removed++;
                    }
                }

                Snackbar.Add($"Removed {removed} duplicate sample(s) from training data", Severity.Success);

                // Re-analyze to update the UI
                await AnalyzeTrainingData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error removing duplicates: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processing = false;
            }
        }
    }
}
