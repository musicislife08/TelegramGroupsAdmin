@inject IConfigService ConfigService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="1">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h6" Color="Color.Primary">Naive Bayes Classifier</MudText>
            <HelpTooltip Text="Statistical machine learning classifier that calculates spam probability based on word frequency patterns in training samples. Learns your community's unique spam patterns over time. Requires at least 50 spam and 50 ham samples for effective training." />
        </MudStack>

        @if (!IsGlobalView)
        {
            <!-- Override Toggle (only for chat-specific configs) -->
            <!--suppress CssUnresolvedCustomProperty -->
            <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                <MudSwitch T="bool" @bind-Value="_config.Bayes.UseGlobal"
                          Label="@(_config.Bayes.UseGlobal ? "Using Global Settings" : "Using Custom Settings")"
                          Color="@(_config.Bayes.UseGlobal ? Color.Default : Color.Primary)" />
                @if (_config.Bayes.UseGlobal)
                {
                    <MudText Typo="Typo.caption" Class="mt-1">
                        This chat is using the global Bayes configuration. Toggle off to customize.
                    </MudText>
                }
            </MudPaper>
        }

        @{
            var activeConfig = (IsGlobalView || !_config.Bayes.UseGlobal) ? _config.Bayes : _globalConfig.Bayes;
            var isReadOnly = !IsGlobalView && _config.Bayes.UseGlobal;
        }

        <MudSwitch T="bool" @bind-Value="activeConfig.Enabled"
                  Label="Enable Bayes Classification"
                  Color="Color.Primary"
                  Disabled="@isReadOnly" />

        @if (activeConfig.Enabled)
        {
            <FieldWithHelp HelpText="Probability threshold from 1-99%. The classifier calculates spam probability for each message. Recommended: 70-80% for balanced detection. Lower = more aggressive (catches more but risks false positives). Higher = conservative (only confident spam).">
                <MudNumericField @bind-Value="activeConfig.MinSpamProbability"
                                Label="Minimum Spam Probability (%)"
                                Min="1.0" Max="99.0" Step="0.1"
                                Disabled="@isReadOnly"
                                HelperText="@(isReadOnly ? $"Using global value: {activeConfig.MinSpamProbability:F1}%" : "Minimum probability (%) to classify as spam")" />
            </FieldWithHelp>

            <ConceptualAlert Severity="Severity.Info" Dense="true">
                <strong>How it works:</strong> Analyzes word frequency differences between spam and ham training samples.
                Words that appear more often in spam increase probability. Adapts automatically as you add more training samples.
            </ConceptualAlert>
        }

        @if (!IsGlobalView && !_config.Bayes.UseGlobal && _globalConfig.Bayes.Enabled != _config.Bayes.Enabled)
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                Global setting: @(_globalConfig.Bayes.Enabled ? "Enabled" : "Disabled")
            </MudAlert>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private ContentDetectionConfig _config = new();
    private ContentDetectionConfig _globalConfig = new();
    private bool IsGlobalView => ChatId is null or 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            // Always load global config for comparison/fallback
            _globalConfig = await ConfigService.GetAsync<ContentDetectionConfig>(ConfigType.ContentDetection, 0)
                            ?? new ContentDetectionConfig();

            if (IsGlobalView)
            {
                // Editing global config directly
                _config = _globalConfig;
            }
            else
            {
                // Load chat-specific config (which may have UseGlobal flags set)
                var chatConfig = await ConfigService.GetAsync<ContentDetectionConfig>(ConfigType.ContentDetection, ChatId!.Value);
                _config = chatConfig ?? new ContentDetectionConfig();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new ContentDetectionConfig();
            _globalConfig = new ContentDetectionConfig();
        }
    }

    public ContentDetectionConfig GetConfig()
    {
        // Ensure global configs always have UseGlobal=true
        if (IsGlobalView)
        {
            _config.Bayes.UseGlobal = true;
        }

        return _config;
    }
}
