@using TelegramGroupsAdmin.ContentDetection.Configuration
@using TelegramGroupsAdmin.ContentDetection.Repositories
@inject IContentDetectionConfigRepository ConfigRepository
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudStack Spacing="4">
    <!-- Action Buttons -->
    <MudPaper Class="pa-4" Elevation="1">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveConfiguration">
                Save All Changes
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadConfiguration">
                Reload
            </MudButton>
            @if (_config.TrainingMode)
            {
                <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">Training Mode Active</MudChip>
            }
        </MudStack>
    </MudPaper>

    <!-- Global Settings Card -->
    <MudPaper Class="pa-4" Elevation="1">
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h5" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
                    Global Detection Settings
                </MudText>
                <HelpTooltip Text="Configure how spam detection behaves globally. These settings apply to all enabled algorithms." />
            </MudStack>

            <MudGrid>
                @* Row 1: Feature Toggles *@
                <MudItem xs="12" md="6">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudSwitch T="bool" @bind-Value="_config.TrainingMode"
                                  Label="Training Mode"
                                  Color="Color.Warning" />
                        <HelpTooltip Text="Training Mode sends ALL detections to the review queue instead of auto-banning. Use this when first setting up spam detection or testing new algorithms to avoid false positives." />
                    </MudStack>
                    <MudText Typo="Typo.caption" Class="ml-8 mud-text-secondary">
                        @if (_config.TrainingMode)
                        {
                            <text>⚠️ All spam detections sent to review queue (no auto-ban)</text>
                        }
                        else
                        {
                            <text>Use this to validate detection before enabling auto-ban</text>
                        }
                    </MudText>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudSwitch T="bool" @bind-Value="_config.FirstMessageOnly"
                                  Label="Auto-Trust After First Messages"
                                  Color="Color.Primary" />
                        <HelpTooltip Text="Only run spam checks on the first N messages from each user, then automatically trust them. Reduces processing for established users." />
                    </MudStack>
                    <MudText Typo="Typo.caption" Class="ml-8 mud-text-secondary">
                        @if (_config.FirstMessageOnly)
                        {
                            <text>✓ Users trusted after passing spam checks</text>
                        }
                        else
                        {
                            <text>All messages from all users are checked</text>
                        }
                    </MudText>
                </MudItem>

                @* Row 2: Thresholds *@
                <MudItem xs="12" md="4">
                    <FieldWithHelp HelpText="Messages with confidence ≥ this value will be automatically deleted and the user banned.">
                        <MudNumericField @bind-Value="_config.AutoBanThreshold"
                                        Label="Auto-Ban Threshold"
                                        Min="50" Max="100"
                                        Disabled="@_config.TrainingMode"
                                        HelperText="@(_config.TrainingMode ? "Disabled in training mode" : "Confidence >= triggers ban")" />
                    </FieldWithHelp>
                </MudItem>

                <MudItem xs="12" md="4">
                    <FieldWithHelp HelpText="Messages with confidence ≥ this value but below auto-ban go to review queue.">
                        <MudNumericField @bind-Value="_config.ReviewQueueThreshold"
                                        Label="Review Queue Threshold"
                                        Min="20" Max="80"
                                        HelperText="Confidence >= goes to review" />
                    </FieldWithHelp>
                </MudItem>

                <MudItem xs="12" md="4">
                    <FieldWithHelp HelpText="Skip expensive checks (similarity, Bayes) for very short messages.">
                        <MudNumericField @bind-Value="_config.MinMessageLength"
                                        Label="Min Message Length"
                                        Min="5" Max="100"
                                        HelperText="Skip checks for shorter messages" />
                    </FieldWithHelp>
                </MudItem>

                @* Row 3: Trust Gaming Protection (conditional) *@
                @if (_config.FirstMessageOnly)
                {
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary">Trust Gaming Protection</MudText>
                            <HelpTooltip Text="Prevents spammers from gaming auto-trust by posting short agreeable messages like 'wow', 'yeah', 'amazing' to quickly reach the trust threshold." />
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_config.FirstMessagesCount"
                                        Label="Messages Required"
                                        Min="1" Max="10"
                                        HelperText="Non-spam messages needed for trust" />
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_config.AutoTrustMinMessageLength"
                                        Label="Min Message Length"
                                        Min="0" Max="100"
                                        HelperText="Short messages don't count (0 = any)" />
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_config.AutoTrustMinAccountAgeHours"
                                        Label="Min Account Age (Hours)"
                                        Min="0" Max="168"
                                        HelperText="Must wait before trust (0 = disabled)" />
                    </MudItem>
                }
            </MudGrid>
        </MudStack>
    </MudPaper>

    <!-- Text Content Detection Header -->
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mt-2">
        <MudIcon Icon="@Icons.Material.Filled.TextFields" Class="mr-2" />
        Text Content Detection
    </MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary">
        Configure text-based content detection algorithms. These checks analyze message text for spam patterns.
    </MudText>

    <ConceptualAlert Title="How Algorithm Orchestration Works" Severity="Severity.Info" Class="mb-3">
        All enabled algorithms run in parallel and each returns a confidence score (0-100). Scores are aggregated to produce a final confidence level:
        <ul class="mt-2 mb-0">
            <li><strong>≥ @_config.AutoBanThreshold%</strong> (Auto-Ban): Message deleted, user banned across all chats</li>
            <li><strong>@_config.ReviewQueueThreshold%-@(_config.AutoBanThreshold-1)%</strong> (Review Queue): Message sent to moderator review</li>
            <li><strong>&lt; @_config.ReviewQueueThreshold%</strong> (Pass): Message allowed</li>
        </ul>
        <div class="mt-2">
            OpenAI in <strong>Veto Mode</strong> can override high-confidence detections to reduce false positives. Enable algorithms incrementally and use Training Mode when testing new configurations.
        </div>
    </ConceptualAlert>

    <!-- Stop Words Detection -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.StopWords.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Stop Words Detection</MudText>
                    <HelpTooltip Text="Matches messages against a customizable list of spam keywords (e.g., 'crypto', 'earn money', 'investment'). Fast algorithm (~45ms average). Best for common spam patterns in your community. Configure stop words in the settings." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.StopWords.Enabled ? Color.Success : Color.Default)">
                        @(_config.StopWords.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Speed">Fast</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionStopWords>("Stop Words Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.StopWords.Enabled)
        {
            <MudCardContent>
                <MudNumericField @bind-Value="_config.StopWords.ConfidenceThreshold"
                                Label="Confidence Threshold"
                                Min="1" Max="100"
                                Variant="Variant.Outlined"
                                helperText="Confidence level when stop words are detected (0-100%)" />
            </MudCardContent>
        }
    </MudCard>

    <!-- CAS (Combot Anti-Spam) -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.Cas.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">CAS (Combot Anti-Spam)</MudText>
                    <HelpTooltip Text="Checks users against the CAS public database of known Telegram spammers. External API lookup (~12ms average). High precision for serial spammers. No configuration needed - automatically detects banned users." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.Cas.Enabled ? Color.Success : Color.Default)">
                        @(_config.Cas.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Speed">Fast</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionCAS>("CAS Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.Cas.Enabled)
        {
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    External lookup for known spammers. Click "Configure" for API settings.
                </MudText>
            </MudCardContent>
        }
    </MudCard>

    <!-- Similarity Detection -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.Similarity.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Similarity Detection (TF-IDF)</MudText>
                    <HelpTooltip Text="Compares new messages to known spam using TF-IDF cosine similarity. Catches copycat spam and slight variations of known spam. Medium performance (~87ms). Requires training samples to be effective. Set threshold 0.7-0.9 for best results." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.Similarity.Enabled ? Color.Success : Color.Default)">
                        @(_config.Similarity.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Speed">Medium</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionSimilarity>("Similarity Detection Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.Similarity.Enabled)
        {
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Detects messages similar to known spam samples. Click "Configure" for threshold settings.
                </MudText>
            </MudCardContent>
        }
    </MudCard>

    <!-- Bayes Classifier -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.Bayes.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Naive Bayes Classifier</MudText>
                    <HelpTooltip Text="Machine learning classifier that learns spam patterns from word frequency in training samples. Adapts to your community's spam patterns over time. Fast algorithm. Requires at least 50 spam and 50 ham samples to train effectively." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.Bayes.Enabled ? Color.Success : Color.Default)">
                        @(_config.Bayes.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Speed">Fast</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionBayes>("Bayes Classifier Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.Bayes.Enabled)
        {
            <MudCardContent>
                <MudNumericField @bind-Value="_config.Bayes.MinSpamProbability"
                                Label="Minimum Spam Probability"
                                Min="1.0" Max="99.0" Step="0.1"
                                Variant="Variant.Outlined"
                                helperText="Minimum probability (%) to classify as spam" />
            </MudCardContent>
        }
    </MudCard>

    <!-- Spacing Detection -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.Spacing.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Abnormal Spacing Detection</MudText>
                    <HelpTooltip Text="Detects deliberate spacing patterns used to evade filters (e.g., 'F R E E  M O N E Y'). Analyzes space-to-character ratio and sequential spacing. Fast algorithm. Catches creative filter evasion attempts." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.Spacing.Enabled ? Color.Success : Color.Default)">
                        @(_config.Spacing.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Speed">Fast</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionSpacing>("Spacing Detection Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.Spacing.Enabled)
        {
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Detects messages with unusual spacing patterns. Click "Configure" for detailed thresholds.
                </MudText>
            </MudCardContent>
        }
    </MudCard>

    <!-- Invisible Characters -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.InvisibleChars.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Invisible Character Detection</MudText>
                    <HelpTooltip Text="Detects zero-width Unicode characters used by spammers to hide text or evade filters. Excludes legitimate emoji sequences. Very fast algorithm with virtually no false positives. Recommended to keep enabled." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.InvisibleChars.Enabled ? Color.Success : Color.Default)">
                        @(_config.InvisibleChars.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Speed">Fast</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionInvisibleChars>("Invisible Characters Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.InvisibleChars.Enabled)
        {
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Detects zero-width Unicode characters used by spammers (excludes legitimate emoji sequences).
                </MudText>
            </MudCardContent>
        }
    </MudCard>

    <!-- Translation -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.Translation.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">Foreign Language Translation</MudText>
                    <HelpTooltip Text="Automatically translates non-English messages to English before running spam checks. Enables detection of foreign-language spam using English-trained algorithms. Uses OpenAI API (costs apply). Useful for international communities." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.Translation.Enabled ? Color.Success : Color.Default)">
                        @(_config.Translation.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Speed">Medium</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionTranslation>("Translation Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.Translation.Enabled)
        {
            <MudCardContent>
                <MudSwitch T="bool" @bind-Value="_config.Translation.CheckTranslatedContent"
                          Label="Check Translated Content"
                          Color="Color.Primary" />
                <MudText Typo="Typo.caption" Class="ml-8 mud-text-secondary">
                    Translates non-English messages to English before running spam checks
                </MudText>
            </MudCardContent>
        }
    </MudCard>

    <!-- AI Veto -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudSwitch T="bool" @bind-Value="_config.AIVeto.Enabled" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">AI Veto Check</MudText>
                    <HelpTooltip Text="Uses AI to verify spam detected by other algorithms. Acts as quality control - confirms or vetoes other algorithms' spam verdicts, reducing false positives. Only runs on messages already flagged as potential spam. Slow (~1.2s average) but high quality. Costs apply per API call." />
                    <MudChip T="string" Size="Size.Small" Color="@(_config.AIVeto.Enabled ? Color.Success : Color.Default)">
                        @(_config.AIVeto.Enabled ? "Enabled" : "Disabled")
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Schedule">Slow</MudChip>
                </MudStack>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenConfigDialog<ContentDetectionOpenAI>("AI Veto Configuration"))">
                    Configure
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        @if (_config.AIVeto.Enabled)
        {
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSwitch T="bool" @bind-Value="_config.AIVeto.CheckShortMessages"
                                  Label="Check Short Messages"
                                  Color="Color.Primary" />
                        <MudText Typo="Typo.caption" Class="ml-8 mud-text-secondary">
                            Include short messages in AI veto analysis.
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        }
    </MudCard>

    <!-- URL Content Detection Header -->
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mt-4">
        <MudIcon Icon="@Icons.Material.Filled.Link" Class="mr-2" />
        URL Content Detection
    </MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary">
        Detect and block malicious URLs, phishing domains, and blocked websites.
    </MudText>

    <!-- URL Filtering Card -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Link" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">URL Filtering</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Always-Run Capable</MudChip>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    540K+ blocked domains | 6 blocklists | Real-time domain reputation
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Settings" OnClick="@(() => Navigation.NavigateTo("/settings/content-detection/url-filters"))">
                    CONFIGURE →
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body2">
                Blocks known malicious URLs using curated blocklists (abuse.ch, Phishtank, Cybercrime Tracker, etc.).
                Supports hard mode (delete + ban) and soft mode (delete + notify). Can be configured as a critical check
                to apply to all users including trusted/admin.
            </MudText>
        </MudCardContent>
    </MudCard>

    <!-- File Content Detection Header -->
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mt-4">
        <MudIcon Icon="@Icons.Material.Filled.Scanner" Class="mr-2" />
        File Content Detection
    </MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary">
        Scan file attachments for malware, viruses, and malicious content.
    </MudText>

    <!-- File Scanning Card -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Scanner" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">File Scanning (ClamAV)</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Always-Run Capable</MudChip>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    10M+ signatures | Tier 1 local scanning | &lt;55ms average scan time
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Settings" OnClick="@(() => Navigation.NavigateTo("/settings/content-detection/file-scanning"))">
                    CONFIGURE →
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body2">
                Scans uploaded files using ClamAV antivirus engine with 10M+ malware signatures. Supports up to 4.5GB files
                (Telegram Premium limit). Results cached for 24 hours. Can be configured as a critical check to scan files
                from all users including trusted/admin. Fail-open design ensures infrastructure issues don't block legitimate files.
            </MudText>
        </MudCardContent>
    </MudCard>

    <!-- Critical Checks Configuration Header -->
    <MudText Typo="Typo.h5" Color="Color.Primary" Class="mt-4">
        <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Class="mr-2" />
        Critical Checks Configuration
    </MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary">
        Configure which checks run for ALL users (bypassing trust/admin exemptions).
    </MudText>

    <!-- Critical Checks Card -->
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Error" Class="mr-2" />
                    Always-Run Checks (Bypass Trust/Admin Status)
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                <strong>Policy:</strong> Critical violations trigger message deletion + DM notification for ALL users.
                Trusted/admin users are NOT banned or warned, but their violating messages are still deleted.
            </MudAlert>

            <CriticalChecks />
        </MudCardContent>
    </MudCard>

    <!-- Save Button (Bottom) -->
    <MudPaper Class="pa-4" Elevation="1">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="@SaveConfiguration" FullWidth="true">
            Save All Changes
        </MudButton>
    </MudPaper>
</MudStack>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private ContentDetectionConfig _config = new();
    private bool _isSaving;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            _config = ChatId.HasValue
                ? await ConfigRepository.GetEffectiveConfigAsync(ChatId.Value)
                : await ConfigRepository.GetGlobalConfigAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new ContentDetectionConfig();
        }
    }

    private async Task SaveConfiguration()
    {
        if (_isSaving) return;

        try
        {
            _isSaving = true;

            if (ChatId.HasValue)
            {
                await ConfigRepository.UpdateChatConfigAsync(ChatId.Value, _config);
                Snackbar.Add("Chat configuration saved successfully", Severity.Success);
            }
            else
            {
                await ConfigRepository.UpdateGlobalConfigAsync(_config);
                Snackbar.Add("Global configuration saved successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task OpenConfigDialog<T>(string title) where T : ComponentBase
    {
        var parameters = new DialogParameters<ConfigDialogWrapper>
        {
            { x => x.ChatId, ChatId },
            { x => x.ComponentType, typeof(T) }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<ConfigDialogWrapper>(title, parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            // Reload configuration after dialog closes
            await LoadConfiguration();
        }
    }
}
