@using TelegramGroupsAdmin.ContentDetection.Configuration
@using TelegramGroupsAdmin.ContentDetection.Repositories
@inject IContentDetectionConfigRepository ConfigRepository
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="1">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h6" Color="Color.Primary">ML Text Classifier (SDCA)</MudText>
            <HelpTooltip Text="Uses ML.NET SDCA (Stochastic Dual Coordinate Ascent) logistic regression with TF-IDF features to classify spam vs ham. Trained automatically on your spam/ham samples. Retrains every 8 hours to adapt to new patterns." />
        </MudStack>

        @if (!IsGlobalView)
        {
            <!-- Override Toggle (only for chat-specific configs) -->
            <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                <MudSwitch T="bool" @bind-Value="_config.Similarity.UseGlobal"
                          Label="@(_config.Similarity.UseGlobal ? "Using Global Settings" : "Using Custom Settings")"
                          Color="@(_config.Similarity.UseGlobal ? Color.Default : Color.Primary)" />
                @if (_config.Similarity.UseGlobal)
                {
                    <MudText Typo="Typo.caption" Class="mt-1">
                        This chat is using the global similarity configuration. Toggle off to customize.
                    </MudText>
                }
            </MudPaper>
        }

        @{
            var activeConfig = (IsGlobalView || !_config.Similarity.UseGlobal) ? _config.Similarity : _globalConfig.Similarity;
            var isReadOnly = !IsGlobalView && _config.Similarity.UseGlobal;
        }

        <MudSwitch T="bool" @bind-Value="activeConfig.Enabled"
                  Label="Enable ML Text Classifier"
                  Color="Color.Primary"
                  Disabled="@isReadOnly" />

        @if (activeConfig.Enabled)
        {
            <MudStack Spacing="1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText>Spam Probability Threshold: @activeConfig.Threshold.ToString("F2")</MudText>
                    <HelpTooltip Text="Minimum spam probability (0.0-1.0) required to contribute points. ML model outputs probability from 0% (definitely ham) to 100% (definitely spam). Recommended: 0.5-0.7 for balanced detection. Lower = more sensitive (catches more spam but more false positives). Higher = stricter (only high-confidence spam)." />
                </MudStack>
                <MudSlider @bind-Value="activeConfig.Threshold"
                          Min="0.1" Max="1.0" Step="0.05"
                          TickMarks="true" TickMarkLabels="@_similarityLabels"
                          Disabled="@isReadOnly" />
            </MudStack>

            <ConceptualAlert Severity="Severity.Info" Dense="true">
                @if (isReadOnly)
                {
                    <text>Using global value: @activeConfig.Threshold.ToString("F2")</text>
                }
                else
                {
                    <text>
                        <strong>How it works:</strong> ML.NET SDCA model analyzes message text and outputs spam probability (0-100%).
                        Messages above threshold contribute points: ≥95% → 5pts, ≥85% → 3.5pts, ≥70% → 2pts, ≥60% → 1pt.
                        Model retrains automatically every 8 hours with your latest spam/ham samples.
                        <MudLink Href="/settings/background-jobs" Color="Color.Info">Trigger manual retraining</MudLink>
                    </text>
                }
            </ConceptualAlert>
        }

        @if (!IsGlobalView && !_config.Similarity.UseGlobal && _globalConfig.Similarity.Enabled != _config.Similarity.Enabled)
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                Global setting: @(_globalConfig.Similarity.Enabled ? "Enabled" : "Disabled")
            </MudAlert>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private ContentDetectionConfig _config = new();
    private ContentDetectionConfig _globalConfig = new();
    private bool IsGlobalView => ChatId is null or 0;
    private readonly string[] _similarityLabels = ["0.1", "0.3", "0.5", "0.7", "0.9"];

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            // Always load global config for comparison/fallback
            _globalConfig = await ConfigRepository.GetGlobalConfigAsync();

            if (IsGlobalView)
            {
                // Editing global config directly
                _config = _globalConfig;
            }
            else
            {
                // Load chat-specific config (which may have UseGlobal flags set)
                var chatConfig = await ConfigRepository.GetByChatIdAsync(ChatId!.Value);
                _config = chatConfig ?? new ContentDetectionConfig();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new ContentDetectionConfig();
            _globalConfig = new ContentDetectionConfig();
        }
    }

    public ContentDetectionConfig GetConfig()
    {
        // Ensure global configs always have UseGlobal=true
        if (IsGlobalView)
        {
            _config.Similarity.UseGlobal = true;
        }

        return _config;
    }
}
