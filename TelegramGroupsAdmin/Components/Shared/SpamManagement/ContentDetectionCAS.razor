@using TelegramGroupsAdmin.ContentDetection.Configuration
@using TelegramGroupsAdmin.ContentDetection.Repositories
@inject ISpamDetectionConfigRepository ConfigRepository
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="1">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6" Color="Color.Primary">CAS (Combot Anti-Spam)</MudText>

        <MudSwitch T="bool" @bind-Value="_config.Cas.Enabled"
                  Label="Enable CAS Check"
                  Color="Color.Primary" />

        @if (_config.Cas.Enabled)
        {
            <MudTextField @bind-Value="_config.Cas.ApiUrl"
                         Label="CAS API URL"
                         helperText="API endpoint for CAS lookups" />

            <MudNumericField @bind-Value="_timeoutSeconds"
                            Label="Timeout (seconds)"
                            Min="1" Max="30"
                            helperText="Request timeout for CAS API calls" />

            <MudTextField @bind-Value="_config.Cas.UserAgent"
                         Label="User Agent (Optional)"
                         helperText="Custom User-Agent header for requests" />
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public long? ChatId { get; set; }

    private SpamDetectionConfig _config = new();
    private int _timeoutSeconds = 5;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        try
        {
            _config = ChatId.HasValue
                ? await ConfigRepository.GetEffectiveConfigAsync(ChatId.Value)
                : await ConfigRepository.GetGlobalConfigAsync();

            _timeoutSeconds = (int)_config.Cas.Timeout.TotalSeconds;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new SpamDetectionConfig();
        }
        finally
        {
        }
    }

    public SpamDetectionConfig GetConfig()
    {
        _config.Cas.Timeout = TimeSpan.FromSeconds(_timeoutSeconds);
        return _config;
    }
}
