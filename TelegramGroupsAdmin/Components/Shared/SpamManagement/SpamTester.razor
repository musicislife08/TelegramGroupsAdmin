@using TelegramGroupsAdmin.Services
@using TelegramGroupsAdmin.ContentDetection.Models
@using Microsoft.JSInterop
@using TelegramGroupsAdmin.Telegram.Services
@inject ISpamCheckCoordinator SpamCheckOrchestrator
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudPaper Class="pa-4" Elevation="0">
    <MudText Typo="Typo.h6" GutterBottom="true">Test Spam Detection</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Test how the spam detection engine would respond to a message. Optionally provide user ID/username to check trust status.
        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Info" Color="Color.Info">Tip: Paste images directly (Ctrl+V)</MudChip>
    </MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudTextField
                @bind-Value="_messageText"
                Label="Message Text"
                Variant="Variant.Outlined"
                Lines="5"
                Required="false"
                HelperText="The message content to test (optional if image uploaded)"
                Immediate="true" />
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudTextField
                @bind-Value="_userId"
                Label="User ID (optional)"
                Variant="Variant.Outlined"
                HelperText="Telegram user ID (e.g., 123456789)"
                Immediate="true" />
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudTextField
                @bind-Value="_userName"
                Label="Username (optional)"
                Variant="Variant.Outlined"
                HelperText="Telegram username (without at sign)"
                Immediate="true" />
        </MudItem>

        <MudItem xs="12">
            <MudTextField
                @bind-Value="_chatId"
                Label="Chat ID (optional)"
                Variant="Variant.Outlined"
                HelperText="Leave empty for global config, or specify chat ID to test chat-specific config"
                Immediate="true" />
        </MudItem>

        <MudItem xs="12">
            <MudFileUpload T="IBrowserFile" Accept="image/*" @bind-Files="_selectedImage" MaximumFileCount="1">
                <ActivatorContent>
                    <MudButton HtmlTag="label"
                               Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        Upload Image (optional)
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
            @if (_selectedImage != null)
            {
                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.Image" OnClose="ClearImage">
                    @_selectedImage.Name (@FormatFileSize(_selectedImage.Size))
                </MudChip>
            }
            @if (_pastedImageData?.Length > 0)
            {
                var size = _pastedImageData.Length;
                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.ContentPaste" OnClose="ClearPastedImage">
                    Pasted image (@FormatFileSize(size))
                </MudChip>
            }
        </MudItem>

        <MudItem xs="12">
            <MudButton
                Variant="Variant.Filled"
                Color="Color.Primary"
                StartIcon="@Icons.Material.Filled.Security"
                OnClick="RunSpamCheck"
                Disabled="@(_isRunning || (string.IsNullOrWhiteSpace(_messageText) && _selectedImage == null && _pastedImageData == null))">
                @(_isRunning ? "Checking..." : "Run Spam Check")
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_result != null)
    {
        <MudDivider Class="my-4" />

        <MudAlert Severity="@GetResultSeverity()" Variant="Variant.Filled" Class="mb-4">
            <MudText Typo="Typo.h6">
                @if (_result.SpamCheckSkipped)
                {
                    <text>âœ… Spam Check Skipped</text>
                }
                else if (_result.IsSpam)
                {
                    <text>ðŸš¨ SPAM DETECTED</text>
                }
                else
                {
                    <text>âœ… Not Spam</text>
                }
            </MudText>
        </MudAlert>

        @if (_result.SpamCheckSkipped)
        {
            <MudPaper Class="pa-3 mb-3" Outlined="true">
                <MudText Typo="Typo.body1"><strong>Reason:</strong> @_result.SkipReason</MudText>
                @if (_result.IsUserTrusted)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">User is explicitly trusted - bypasses all spam checks</MudText>
                }
                @if (_result.IsUserAdmin)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">User is a chat admin - bypasses all spam checks</MudText>
                }
            </MudPaper>
        }
        else if (_result.SpamResult != null)
        {
            <MudPaper Class="pa-3 mb-3" Outlined="true">
                <MudText Typo="Typo.body1"><strong>Primary Reason:</strong> @_result.SpamResult.PrimaryReason</MudText>
                <MudText Typo="Typo.body2" Class="mt-2">
                    <strong>Confidence:</strong> Max @_result.SpamResult.MaxConfidence% | Avg @_result.SpamResult.AvgConfidence% | Flags @_result.SpamResult.SpamFlags
                </MudText>
                <MudText Typo="Typo.body2" Class="mt-2">
                    <strong>Recommended Action:</strong> @_result.SpamResult.RecommendedAction
                </MudText>
            </MudPaper>

            <MudText Typo="Typo.h6" Class="mb-2">Individual Check Results</MudText>
            <MudTable Items="_result.SpamResult.CheckResults" Hover="true" Dense="true" Striped="true">
                <HeaderContent>
                    <MudTh>Check Name</MudTh>
                    <MudTh>Result</MudTh>
                    <MudTh>Confidence</MudTh>
                    <MudTh>Details</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.CheckName</MudTd>
                    <MudTd>
                        @switch (context.Result)
                        {
                            case TelegramGroupsAdmin.ContentDetection.Models.CheckResultType.Spam:
                                <MudChip T="string" Color="Color.Error" Size="Size.Small">SPAM</MudChip>
                                break;
                            case TelegramGroupsAdmin.ContentDetection.Models.CheckResultType.Review:
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small">REVIEW</MudChip>
                                break;
                            default:
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">OK</MudChip>
                                break;
                        }
                    </MudTd>
                    <MudTd>@context.Confidence%</MudTd>
                    <MudTd>@context.Details</MudTd>
                </RowTemplate>
            </MudTable>
        }
    }
</MudPaper>

@code {
    private string _messageText = string.Empty;
    private string? _userId;
    private string? _userName;
    private string? _chatId;
    private IBrowserFile? _selectedImage;
    private byte[]? _pastedImageData;
    private bool _isRunning;
    private SpamCheckCoordinatorResult? _result;
    private DotNetObjectReference<SpamTester>? _dotNetHelper;
    private bool _pasteListenerSetup = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetHelper = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("setupPasteListener", _dotNetHelper);
                _pasteListenerSetup = true;
            }
            catch (Exception ex)
            {
                // Paste listener setup failed, but component should still work
                Console.WriteLine($"Failed to setup paste listener: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public Task OnImagePasted(string imageData)
    {
        try
        {
            if (string.IsNullOrEmpty(imageData))
            {
                return Task.CompletedTask;
            }

            // Convert base64 to byte array
            var parts = imageData.Split(',');
            if (parts.Length != 2)
            {
                Console.WriteLine($"Invalid image data format: expected 'data:image/...;base64,DATA'");
                return Task.CompletedTask;
            }

            var base64Data = parts[1];
            _pastedImageData = Convert.FromBase64String(base64Data);

            // Use InvokeAsync to update UI on the correct thread
            _ = InvokeAsync(() =>
            {
                Snackbar.Add("Image pasted successfully!", Severity.Success);
                StateHasChanged();
            });

            return Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to process pasted image: {ex}");

            // Use InvokeAsync for Snackbar too
            _ = InvokeAsync(() =>
            {
                Snackbar.Add($"Failed to process pasted image: {ex.Message}", Severity.Warning);
            });

            return Task.CompletedTask;
        }
    }

    private void ClearPastedImage()
    {
        _pastedImageData = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        if (_pasteListenerSetup)
        {
            try
            {
                JSRuntime.InvokeVoidAsync("window.pasteListenerCleanup");
            }
            catch
            {
                // Cleanup failed, not critical
            }
        }
        _dotNetHelper?.Dispose();
    }

    private async Task RunSpamCheck()
    {
        if (string.IsNullOrWhiteSpace(_messageText) && _selectedImage == null && _pastedImageData == null)
        {
            Snackbar.Add("Please enter a message or upload/paste an image to test", Severity.Warning);
            return;
        }

        _isRunning = true;
        _result = null;

        try
        {
            Stream? imageStream = null;
            string? imageFileName = null;

            if (_selectedImage != null)
            {
                imageStream = _selectedImage.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
                imageFileName = _selectedImage.Name;
            }
            else if (_pastedImageData != null)
            {
                imageStream = new MemoryStream(_pastedImageData);
                imageFileName = "pasted-image.png";
            }

            var request = new TelegramGroupsAdmin.ContentDetection.Models.ContentCheckRequest
            {
                Message = _messageText ?? string.Empty, // Empty string if only testing image
                UserId = string.IsNullOrWhiteSpace(_userId) ? 0 : long.Parse(_userId), // Use 0 if no user provided
                UserName = _userName,
                ChatId = string.IsNullOrWhiteSpace(_chatId) ? 0 : long.Parse(_chatId), // Use 0 for global if not provided
                ImageData = imageStream,
                ImageFileName = imageFileName
            };

            _result = await SpamCheckOrchestrator.CheckAsync(request);

            if (_result.IsSpam)
            {
                Snackbar.Add("Spam detected!", Severity.Error);
            }
            else if (_result.SpamCheckSkipped)
            {
                Snackbar.Add("Spam check skipped - user is trusted/admin", Severity.Info);
            }
            else
            {
                Snackbar.Add("Message is not spam", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error running spam check: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRunning = false;
        }
    }

    private void OnImageSelected(IBrowserFile? file)
    {
        _selectedImage = file;
    }

    private void ClearImage()
    {
        _selectedImage = null;
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private Severity GetResultSeverity()
    {
        if (_result == null) return Severity.Normal;
        if (_result.SpamCheckSkipped) return Severity.Info;
        return _result.IsSpam ? Severity.Error : Severity.Success;
    }
}
