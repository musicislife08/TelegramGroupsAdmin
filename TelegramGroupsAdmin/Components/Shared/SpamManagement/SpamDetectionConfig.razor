@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.SpamDetection.Repositories
@using TelegramGroupsAdmin.SpamDetection.Configuration
@inject ISpamDetectionConfigRepository ConfigRepository
@inject AuditLogRepository AuditLogRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar


<MudContainer MaxWidth="@(ChatId.HasValue ? MaxWidth.False : MaxWidth.ExtraLarge)" Class="@(ChatId.HasValue ? "" : "mt-4")">
    <MudStack Spacing="4">
        @if (!ChatId.HasValue)
        {
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4">Spam Detection Configuration</MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Save"
                          OnClick="SaveConfiguration"
                          Disabled="@_saving">
                    @if (_saving)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ms-2">Saving...</MudText>
                    }
                    else
                    {
                        <MudText>Save Configuration</MudText>
                    }
                </MudButton>
            </MudStack>
        }

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        @if (_config != null)
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <!-- General Settings -->
                <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Detection Scope</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.FirstMessageOnly"
                                              Label="Check First Messages Only"
                                              Color="Color.Primary" />

                                    @if (_config.FirstMessageOnly)
                                    {
                                        <MudNumericField @bind-Value="_config.FirstMessagesCount"
                                                        Label="First Messages Count"
                                                        Min="1" Max="10"
                                                        helperText="Number of first messages to check from each user" />
                                    }

                                    <MudNumericField @bind-Value="_config.MinMessageLength"
                                                    Label="Minimum Message Length"
                                                    Min="10" Max="1000"
                                                    helperText="Skip expensive checks for messages shorter than this" />
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Action Thresholds</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.TrainingMode"
                                              Label="Training Mode"
                                              Color="Color.Warning">
                                        <MudText Typo="Typo.caption" Color="@(_config.TrainingMode ? Color.Warning : Color.Default)">
                                            @if (_config.TrainingMode)
                                            {
                                                <text>⚠️ All spam detections sent to review queue (no auto-ban)</text>
                                            }
                                            else
                                            {
                                                <text>Use this to validate detection before enabling auto-ban</text>
                                            }
                                        </MudText>
                                    </MudSwitch>

                                    <MudNumericField @bind-Value="_config.AutoBanThreshold"
                                                    Label="Auto-Ban Threshold"
                                                    Min="50" Max="100"
                                                    Disabled="@_config.TrainingMode"
                                                    HelperText="@(_config.TrainingMode ? "Disabled in training mode" : "Confidence >= this value triggers automatic ban")" />

                                    <MudNumericField @bind-Value="_config.ReviewQueueThreshold"
                                                    Label="Review Queue Threshold"
                                                    Min="20" Max="80"
                                                    HelperText="Confidence >= this value goes to review queue" />
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Stop Words -->
                <MudTabPanel Text="Stop Words" Icon="@Icons.Material.Filled.Block">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Stop Words Detection</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.StopWords.Enabled"
                                      Label="Enable Stop Words Check"
                                      Color="Color.Primary" />

                            @if (_config.StopWords.Enabled)
                            {
                                <MudNumericField @bind-Value="_config.StopWords.ConfidenceThreshold"
                                                Label="Confidence Threshold"
                                                Min="1" Max="100"
                                                helperText="Confidence level when stop words are detected (0-100%)" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Similarity -->
                <MudTabPanel Text="Similarity" Icon="@Icons.Material.Filled.ContentCopy">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Spam Similarity Detection</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Similarity.Enabled"
                                      Label="Enable Similarity Check"
                                      Color="Color.Primary" />

                            @if (_config.Similarity.Enabled)
                            {
                                <MudSlider @bind-Value="_config.Similarity.Threshold"
                                          Min="0.1" Max="1.0" Step="0.05"
                                          TickMarks="true" TickMarkLabels="@_similarityLabels">
                                    <MudText>Similarity Threshold: @_config.Similarity.Threshold.ToString("F2")</MudText>
                                </MudSlider>

                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    Messages with similarity >= this threshold to known spam samples will be flagged
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- CAS -->
                <MudTabPanel Text="CAS" Icon="@Icons.Material.Filled.Security">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">CAS (Combot Anti-Spam)</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Cas.Enabled"
                                      Label="Enable CAS Check"
                                      Color="Color.Primary" />

                            @if (_config.Cas.Enabled)
                            {
                                <MudTextField @bind-Value="_config.Cas.ApiUrl"
                                             Label="CAS API URL"
                                             helperText="API endpoint for CAS lookups" />

                                <MudNumericField @bind-Value="_timeoutSeconds"
                                                Label="Timeout (seconds)"
                                                Min="1" Max="30"
                                                helperText="Request timeout for CAS API calls" />

                                <MudTextField @bind-Value="_config.Cas.UserAgent"
                                             Label="User Agent (Optional)"
                                             helperText="Custom User-Agent header for requests" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Bayes -->
                <MudTabPanel Text="Bayes" Icon="@Icons.Material.Filled.Psychology">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Naive Bayes Classifier</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Bayes.Enabled"
                                      Label="Enable Bayes Classification"
                                      Color="Color.Primary" />

                            @if (_config.Bayes.Enabled)
                            {
                                <MudNumericField @bind-Value="_config.Bayes.MinSpamProbability"
                                                Label="Minimum Spam Probability"
                                                Min="1.0" Max="99.0" Step="0.1"
                                                helperText="Minimum probability (%) to classify as spam" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Advanced -->
                <MudTabPanel Text="Advanced" Icon="@Icons.Material.Filled.Tune">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Invisible Characters</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.InvisibleChars.Enabled"
                                              Label="Enable Invisible Character Detection"
                                              Color="Color.Primary" />

                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Detects zero-width Unicode characters used by spammers (excludes legitimate emoji sequences)
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Translation</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.Translation.Enabled"
                                              Label="Enable Foreign Language Translation"
                                              Color="Color.Primary" />

                                    @if (_config.Translation.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.Translation.CheckTranslatedContent"
                                                  Label="Check Translated Content"
                                                  Color="Color.Primary" />
                                    }

                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Translates non-English messages to English before running spam checks
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Spacing Detection</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.Spacing.Enabled"
                                              Label="Enable Abnormal Spacing Check"
                                              Color="Color.Primary" />

                                    @if (_config.Spacing.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_config.Spacing.MinWordsCount"
                                                        Label="Minimum Words for Analysis"
                                                        Min="3" Max="20"
                                                        helperText="Minimum number of words required" />

                                        <MudNumericField @bind-Value="_config.Spacing.ShortWordLength"
                                                        Label="Short Word Length"
                                                        Min="1" Max="5"
                                                        helperText="Maximum length for 'short' words" />

                                        <MudSlider @bind-Value="_config.Spacing.ShortWordRatioThreshold"
                                                  Min="0.1" Max="1.0" Step="0.05">
                                            <MudText>Short Word Ratio: @_config.Spacing.ShortWordRatioThreshold.ToString("F2")</MudText>
                                        </MudSlider>

                                        <MudSlider @bind-Value="_config.Spacing.SpaceRatioThreshold"
                                                  Min="0.1" Max="1.0" Step="0.05">
                                            <MudText>Space Ratio: @_config.Spacing.SpaceRatioThreshold.ToString("F2")</MudText>
                                        </MudSlider>
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">OpenAI Integration</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.OpenAI.Enabled"
                                              Label="Enable OpenAI Check"
                                              Color="Color.Primary" />

                                    @if (_config.OpenAI.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.OpenAI.VetoMode"
                                                  Label="Veto Mode (Confirm Spam)"
                                                  Color="Color.Primary"
                                                  helperText="If enabled, OpenAI confirms spam. If disabled, OpenAI finds spam." />

                                        @if (_config.OpenAI.VetoMode)
                                        {
                                            <MudNumericField @bind-Value="_config.OpenAI.VetoThreshold"
                                                            Label="Veto Threshold"
                                                            Min="50" Max="100"
                                                            HelperText="OpenAI veto runs only if spam confidence is below this (higher = more vetos)" />
                                        }

                                        <MudSwitch T="bool" @bind-Value="_config.OpenAI.CheckShortMessages"
                                                  Label="Check Short Messages"
                                                  Color="Color.Primary" />

                                        <MudTextField @bind-Value="_config.OpenAI.SystemPrompt"
                                                     Label="Custom System Prompt (Optional)"
                                                     Lines="3"
                                                     helperText="Topic-specific instructions for this group" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- External Services -->
                <MudTabPanel Text="External Services" Icon="@Icons.Material.Filled.CloudSync">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">URL Blocklist</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.UrlBlocklist.Enabled"
                                              Label="Enable URL Blocklist Check"
                                              Color="Color.Primary" />

                                    @if (_config.UrlBlocklist.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_cacheHours"
                                                        Label="Cache Duration (hours)"
                                                        Min="1" Max="168"
                                                        helperText="How long to cache blocklist entries" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Threat Intelligence</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.ThreatIntel.Enabled"
                                              Label="Enable Threat Intelligence"
                                              Color="Color.Primary" />

                                    @if (_config.ThreatIntel.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.ThreatIntel.UseVirusTotal"
                                                  Label="Use VirusTotal"
                                                  Color="Color.Primary" />

                                        <MudNumericField @bind-Value="_threatIntelTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="5" Max="60"
                                                        helperText="Request timeout for threat intel APIs" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">SEO Scraping</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.SeoScraping.Enabled"
                                              Label="Enable SEO Scraping"
                                              Color="Color.Primary" />

                                    @if (_config.SeoScraping.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_seoTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="5" Max="30"
                                                        helperText="Request timeout for SEO scraping" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Image Spam Detection</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.ImageSpam.Enabled"
                                              Label="Enable Image Spam Detection"
                                              Color="Color.Primary" />

                                    @if (_config.ImageSpam.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.ImageSpam.UseOpenAIVision"
                                                  Label="Use OpenAI Vision"
                                                  Color="Color.Primary" />

                                        <MudNumericField @bind-Value="_imageTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="10" Max="60"
                                                        helperText="Request timeout for image analysis" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        }
    </MudStack>
</MudContainer>

@code {
    /// <summary>
    /// Optional chat ID for per-chat configuration. If null, uses global configuration.
    /// </summary>
    [Parameter]
    public long? ChatId { get; set; }

    /// <summary>
    /// Optional callback when configuration is saved (for per-chat mode to close modal)
    /// </summary>
    [Parameter]
    public EventCallback OnSaved { get; set; }

    private TelegramGroupsAdmin.SpamDetection.Configuration.SpamDetectionConfig? _config;
    private bool _loading = true;
    private bool _saving = false;
    private string? _currentUserId;

    // Helper fields for TimeSpan to int conversion
    private int _timeoutSeconds = 5;
    private int _cacheHours = 24;
    private int _threatIntelTimeoutSeconds = 30;
    private int _seoTimeoutSeconds = 10;
    private int _imageTimeoutSeconds = 30;

    private readonly string[] _similarityLabels = { "0.1", "0.3", "0.5", "0.7", "0.9" };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        _loading = true;
        try
        {
            _config = ChatId.HasValue
                ? await ConfigRepository.GetEffectiveConfigAsync(ChatId.Value.ToString())
                : await ConfigRepository.GetGlobalConfigAsync();

            // Convert TimeSpan values to int for UI
            _timeoutSeconds = (int)_config.Cas.Timeout.TotalSeconds;
            _cacheHours = (int)_config.UrlBlocklist.CacheDuration.TotalHours;
            _threatIntelTimeoutSeconds = (int)_config.ThreatIntel.Timeout.TotalSeconds;
            _seoTimeoutSeconds = (int)_config.SeoScraping.Timeout.TotalSeconds;
            _imageTimeoutSeconds = (int)_config.ImageSpam.Timeout.TotalSeconds;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new TelegramGroupsAdmin.SpamDetection.Configuration.SpamDetectionConfig(); // Use default
        }
        finally
        {
            _loading = false;
        }
    }

    public async Task SaveConfiguration()
    {
        if (_config == null) return;

        _saving = true;
        try
        {
            // Load the current config from DB to compare changes
            var oldConfig = ChatId.HasValue
                ? await ConfigRepository.GetEffectiveConfigAsync(ChatId.Value.ToString())
                : await ConfigRepository.GetGlobalConfigAsync();

            // Convert int values back to TimeSpan
            _config.Cas.Timeout = TimeSpan.FromSeconds(_timeoutSeconds);
            _config.UrlBlocklist.CacheDuration = TimeSpan.FromHours(_cacheHours);
            _config.ThreatIntel.Timeout = TimeSpan.FromSeconds(_threatIntelTimeoutSeconds);
            _config.SeoScraping.Timeout = TimeSpan.FromSeconds(_seoTimeoutSeconds);
            _config.ImageSpam.Timeout = TimeSpan.FromSeconds(_imageTimeoutSeconds);

            // Build detailed change log
            var changes = new List<string>();

            // Track all configuration changes
            TrackChange(changes, "FirstMessageOnly", oldConfig.FirstMessageOnly, _config.FirstMessageOnly);
            TrackChange(changes, "FirstMessagesCount", oldConfig.FirstMessagesCount, _config.FirstMessagesCount);
            TrackChange(changes, "MinMessageLength", oldConfig.MinMessageLength, _config.MinMessageLength);

            TrackChange(changes, "StopWords", oldConfig.StopWords.Enabled, _config.StopWords.Enabled);
            TrackChange(changes, "CAS", oldConfig.Cas.Enabled, _config.Cas.Enabled);
            TrackChange(changes, "Similarity", oldConfig.Similarity.Enabled, _config.Similarity.Enabled);
            TrackChange(changes, "Bayes", oldConfig.Bayes.Enabled, _config.Bayes.Enabled);
            TrackChange(changes, "InvisibleChars", oldConfig.InvisibleChars.Enabled, _config.InvisibleChars.Enabled);
            TrackChange(changes, "Translation", oldConfig.Translation.Enabled, _config.Translation.Enabled);
            TrackChange(changes, "Spacing", oldConfig.Spacing.Enabled, _config.Spacing.Enabled);
            TrackChange(changes, "OpenAI", oldConfig.OpenAI.Enabled, _config.OpenAI.Enabled);
            TrackChange(changes, "UrlBlocklist", oldConfig.UrlBlocklist.Enabled, _config.UrlBlocklist.Enabled);
            TrackChange(changes, "ThreatIntel", oldConfig.ThreatIntel.Enabled, _config.ThreatIntel.Enabled);
            TrackChange(changes, "SeoScraping", oldConfig.SeoScraping.Enabled, _config.SeoScraping.Enabled);
            TrackChange(changes, "ImageSpam", oldConfig.ImageSpam.Enabled, _config.ImageSpam.Enabled);

            TrackChange(changes, "TrainingMode", oldConfig.TrainingMode, _config.TrainingMode);
            TrackChange(changes, "AutoBanThreshold", oldConfig.AutoBanThreshold, _config.AutoBanThreshold);
            TrackChange(changes, "ReviewQueueThreshold", oldConfig.ReviewQueueThreshold, _config.ReviewQueueThreshold);
            TrackChange(changes, "StopWordsConfidenceThreshold", oldConfig.StopWords.ConfidenceThreshold, _config.StopWords.ConfidenceThreshold);
            TrackChangeFormatted(changes, "SimilarityThreshold", oldConfig.Similarity.Threshold, _config.Similarity.Threshold, "F2");
            TrackChangeFormatted(changes, "BayesMinSpamProbability", oldConfig.Bayes.MinSpamProbability, _config.Bayes.MinSpamProbability, "F2");

            TrackChange(changes, "CAS ApiUrl", oldConfig.Cas.ApiUrl, _config.Cas.ApiUrl);
            TrackChange(changes, "CAS UserAgent", oldConfig.Cas.UserAgent ?? "null", _config.Cas.UserAgent ?? "null");
            TrackChangeFormatted(changes, "CAS Timeout", oldConfig.Cas.Timeout.TotalSeconds, _config.Cas.Timeout.TotalSeconds, "F0", "s");

            TrackChange(changes, "Translation.CheckTranslatedContent", oldConfig.Translation.CheckTranslatedContent, _config.Translation.CheckTranslatedContent);

            TrackChange(changes, "Spacing.MinWordsCount", oldConfig.Spacing.MinWordsCount, _config.Spacing.MinWordsCount);
            TrackChange(changes, "Spacing.ShortWordLength", oldConfig.Spacing.ShortWordLength, _config.Spacing.ShortWordLength);
            TrackChangeFormatted(changes, "Spacing.ShortWordRatioThreshold", oldConfig.Spacing.ShortWordRatioThreshold, _config.Spacing.ShortWordRatioThreshold, "F2");
            TrackChangeFormatted(changes, "Spacing.SpaceRatioThreshold", oldConfig.Spacing.SpaceRatioThreshold, _config.Spacing.SpaceRatioThreshold, "F2");

            TrackChange(changes, "OpenAI.VetoMode", oldConfig.OpenAI.VetoMode, _config.OpenAI.VetoMode);
            TrackChange(changes, "OpenAI.VetoThreshold", oldConfig.OpenAI.VetoThreshold, _config.OpenAI.VetoThreshold);
            TrackChange(changes, "OpenAI.CheckShortMessages", oldConfig.OpenAI.CheckShortMessages, _config.OpenAI.CheckShortMessages);
            TrackChange(changes, "OpenAI.SystemPrompt",
                string.IsNullOrEmpty(oldConfig.OpenAI.SystemPrompt) ? "empty" : "set",
                string.IsNullOrEmpty(_config.OpenAI.SystemPrompt) ? "empty" : "set");

            TrackChangeFormatted(changes, "UrlBlocklist CacheDuration", oldConfig.UrlBlocklist.CacheDuration.TotalHours, _config.UrlBlocklist.CacheDuration.TotalHours, "F0", "h");

            TrackChange(changes, "ThreatIntel.UseVirusTotal", oldConfig.ThreatIntel.UseVirusTotal, _config.ThreatIntel.UseVirusTotal);
            TrackChangeFormatted(changes, "ThreatIntel Timeout", oldConfig.ThreatIntel.Timeout.TotalSeconds, _config.ThreatIntel.Timeout.TotalSeconds, "F0", "s");

            TrackChangeFormatted(changes, "SeoScraping Timeout", oldConfig.SeoScraping.Timeout.TotalSeconds, _config.SeoScraping.Timeout.TotalSeconds, "F0", "s");

            TrackChange(changes, "ImageSpam.UseOpenAIVision", oldConfig.ImageSpam.UseOpenAIVision, _config.ImageSpam.UseOpenAIVision);
            TrackChangeFormatted(changes, "ImageSpam Timeout", oldConfig.ImageSpam.Timeout.TotalSeconds, _config.ImageSpam.Timeout.TotalSeconds, "F0", "s");

            if (ChatId.HasValue)
            {
                await ConfigRepository.UpdateChatConfigAsync(ChatId.Value.ToString(), _config, _currentUserId);
            }
            else
            {
                await ConfigRepository.UpdateGlobalConfigAsync(_config, _currentUserId);
            }

            // Log the configuration change to audit log with details
            var changeDetails = changes.Count > 0
                ? string.Join(", ", changes)
                : "No changes detected";

            var eventValue = ChatId.HasValue
                ? $"Chat {ChatId}: {changeDetails}"
                : changeDetails;

            await AuditLogRepository.LogEventAsync(
                Data.Models.AuditEventType.SpamDetectionConfigChanged,
                actorUserId: _currentUserId,
                targetUserId: null,
                value: eventValue
            );

            Snackbar.Add("Configuration saved successfully", Severity.Success);

            // Invoke callback if provided (for per-chat mode to close modal)
            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    /// <summary>
    /// Helper method to track configuration changes
    /// </summary>
    private void TrackChange<T>(List<string> changes, string name, T oldValue, T newValue)
    {
        if (!EqualityComparer<T>.Default.Equals(oldValue, newValue))
        {
            changes.Add($"{name}: {oldValue} → {newValue}");
        }
    }

    /// <summary>
    /// Helper method to track configuration changes with custom formatting
    /// </summary>
    private void TrackChangeFormatted<T>(List<string> changes, string name, T oldValue, T newValue, string format, string? suffix = null)
        where T : IFormattable
    {
        if (!EqualityComparer<T>.Default.Equals(oldValue, newValue))
        {
            var oldFormatted = oldValue.ToString(format, System.Globalization.CultureInfo.InvariantCulture);
            var newFormatted = newValue.ToString(format, System.Globalization.CultureInfo.InvariantCulture);
            var suffixStr = suffix != null ? suffix : "";
            changes.Add($"{name}: {oldFormatted}{suffixStr} → {newFormatted}{suffixStr}");
        }
    }
}