@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using TelegramGroupsAdmin.Auth
@using TelegramGroupsAdmin.SpamDetection.Repositories
@using TelegramGroupsAdmin.SpamDetection.Configuration
@using TelegramGroupsAdmin.Repositories
@inject ISpamDetectionConfigRepository ConfigRepository
@inject AuditLogRepository AuditLogRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Spam Detection Configuration</MudText>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Save"
                      OnClick="SaveConfiguration"
                      Disabled="@_saving">
                @if (_saving)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Saving...</MudText>
                }
                else
                {
                    <MudText>Save Configuration</MudText>
                }
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        @if (_config != null)
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <!-- General Settings -->
                <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Detection Scope</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.FirstMessageOnly"
                                              Label="Check First Messages Only"
                                              Color="Color.Primary" />

                                    @if (_config.FirstMessageOnly)
                                    {
                                        <MudNumericField @bind-Value="_config.FirstMessagesCount"
                                                        Label="First Messages Count"
                                                        Min="1" Max="10"
                                                        helperText="Number of first messages to check from each user" />
                                    }

                                    <MudNumericField @bind-Value="_config.MinMessageLength"
                                                    Label="Minimum Message Length"
                                                    Min="10" Max="1000"
                                                    helperText="Skip expensive checks for messages shorter than this" />
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Action Thresholds</MudText>

                                    <MudNumericField @bind-Value="_config.AutoBanThreshold"
                                                    Label="Auto-Ban Threshold"
                                                    Min="50" Max="100"
                                                    helperText="Confidence >= this value triggers automatic ban" />

                                    <MudNumericField @bind-Value="_config.ReviewQueueThreshold"
                                                    Label="Review Queue Threshold"
                                                    Min="20" Max="80"
                                                    helperText="Confidence >= this value but < auto-ban goes to review" />
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Stop Words -->
                <MudTabPanel Text="Stop Words" Icon="@Icons.Material.Filled.Block">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Stop Words Detection</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.StopWords.Enabled"
                                      Label="Enable Stop Words Check"
                                      Color="Color.Primary" />

                            @if (_config.StopWords.Enabled)
                            {
                                <MudNumericField @bind-Value="_config.StopWords.ConfidenceThreshold"
                                                Label="Confidence Threshold"
                                                Min="1" Max="100"
                                                helperText="Confidence level when stop words are detected (0-100%)" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Similarity -->
                <MudTabPanel Text="Similarity" Icon="@Icons.Material.Filled.ContentCopy">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Spam Similarity Detection</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Similarity.Enabled"
                                      Label="Enable Similarity Check"
                                      Color="Color.Primary" />

                            @if (_config.Similarity.Enabled)
                            {
                                <MudSlider @bind-Value="_config.Similarity.Threshold"
                                          Min="0.1" Max="1.0" Step="0.05"
                                          TickMarks="true" TickMarkLabels="@_similarityLabels">
                                    <MudText>Similarity Threshold: @_config.Similarity.Threshold.ToString("F2")</MudText>
                                </MudSlider>

                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    Messages with similarity >= this threshold to known spam samples will be flagged
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- CAS -->
                <MudTabPanel Text="CAS" Icon="@Icons.Material.Filled.Security">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">CAS (Combot Anti-Spam)</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Cas.Enabled"
                                      Label="Enable CAS Check"
                                      Color="Color.Primary" />

                            @if (_config.Cas.Enabled)
                            {
                                <MudTextField @bind-Value="_config.Cas.ApiUrl"
                                             Label="CAS API URL"
                                             helperText="API endpoint for CAS lookups" />

                                <MudNumericField @bind-Value="_timeoutSeconds"
                                                Label="Timeout (seconds)"
                                                Min="1" Max="30"
                                                helperText="Request timeout for CAS API calls" />

                                <MudTextField @bind-Value="_config.Cas.UserAgent"
                                             Label="User Agent (Optional)"
                                             helperText="Custom User-Agent header for requests" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Bayes -->
                <MudTabPanel Text="Bayes" Icon="@Icons.Material.Filled.Psychology">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Naive Bayes Classifier</MudText>

                            <MudSwitch T="bool" @bind-Value="_config.Bayes.Enabled"
                                      Label="Enable Bayes Classification"
                                      Color="Color.Primary" />

                            @if (_config.Bayes.Enabled)
                            {
                                <MudNumericField @bind-Value="_config.Bayes.MinSpamProbability"
                                                Label="Minimum Spam Probability"
                                                Min="1.0" Max="99.0" Step="0.1"
                                                helperText="Minimum probability (%) to classify as spam" />
                            }
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <!-- Advanced -->
                <MudTabPanel Text="Advanced" Icon="@Icons.Material.Filled.Tune">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Multi-Language Detection</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.MultiLanguage.Enabled"
                                              Label="Enable Multi-Language Check"
                                              Color="Color.Primary" />

                                    @if (_config.MultiLanguage.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.MultiLanguage.CheckTranslatedContent"
                                                  Label="Check Translated Content"
                                                  Color="Color.Primary" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Spacing Detection</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.Spacing.Enabled"
                                              Label="Enable Abnormal Spacing Check"
                                              Color="Color.Primary" />

                                    @if (_config.Spacing.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_config.Spacing.MinWordsCount"
                                                        Label="Minimum Words for Analysis"
                                                        Min="3" Max="20"
                                                        helperText="Minimum number of words required" />

                                        <MudNumericField @bind-Value="_config.Spacing.ShortWordLength"
                                                        Label="Short Word Length"
                                                        Min="1" Max="5"
                                                        helperText="Maximum length for 'short' words" />

                                        <MudSlider @bind-Value="_config.Spacing.ShortWordRatioThreshold"
                                                  Min="0.1" Max="1.0" Step="0.05">
                                            <MudText>Short Word Ratio: @_config.Spacing.ShortWordRatioThreshold.ToString("F2")</MudText>
                                        </MudSlider>

                                        <MudSlider @bind-Value="_config.Spacing.SpaceRatioThreshold"
                                                  Min="0.1" Max="1.0" Step="0.05">
                                            <MudText>Space Ratio: @_config.Spacing.SpaceRatioThreshold.ToString("F2")</MudText>
                                        </MudSlider>
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">OpenAI Integration</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.OpenAI.Enabled"
                                              Label="Enable OpenAI Check"
                                              Color="Color.Primary" />

                                    @if (_config.OpenAI.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.OpenAI.VetoMode"
                                                  Label="Veto Mode (Confirm Spam)"
                                                  Color="Color.Primary"
                                                  helperText="If enabled, OpenAI confirms spam. If disabled, OpenAI finds spam." />

                                        <MudSwitch T="bool" @bind-Value="_config.OpenAI.CheckShortMessages"
                                                  Label="Check Short Messages"
                                                  Color="Color.Primary" />

                                        <MudTextField @bind-Value="_config.OpenAI.SystemPrompt"
                                                     Label="Custom System Prompt (Optional)"
                                                     Lines="3"
                                                     helperText="Topic-specific instructions for this group" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- External Services -->
                <MudTabPanel Text="External Services" Icon="@Icons.Material.Filled.CloudSync">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">URL Blocklist</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.UrlBlocklist.Enabled"
                                              Label="Enable URL Blocklist Check"
                                              Color="Color.Primary" />

                                    @if (_config.UrlBlocklist.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_cacheHours"
                                                        Label="Cache Duration (hours)"
                                                        Min="1" Max="168"
                                                        helperText="How long to cache blocklist entries" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Threat Intelligence</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.ThreatIntel.Enabled"
                                              Label="Enable Threat Intelligence"
                                              Color="Color.Primary" />

                                    @if (_config.ThreatIntel.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.ThreatIntel.UseVirusTotal"
                                                  Label="Use VirusTotal"
                                                  Color="Color.Primary" />

                                        <MudNumericField @bind-Value="_threatIntelTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="5" Max="60"
                                                        helperText="Request timeout for threat intel APIs" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">SEO Scraping</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.SeoScraping.Enabled"
                                              Label="Enable SEO Scraping"
                                              Color="Color.Primary" />

                                    @if (_config.SeoScraping.Enabled)
                                    {
                                        <MudNumericField @bind-Value="_seoTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="5" Max="30"
                                                        helperText="Request timeout for SEO scraping" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Image Spam Detection</MudText>

                                    <MudSwitch T="bool" @bind-Value="_config.ImageSpam.Enabled"
                                              Label="Enable Image Spam Detection"
                                              Color="Color.Primary" />

                                    @if (_config.ImageSpam.Enabled)
                                    {
                                        <MudSwitch T="bool" @bind-Value="_config.ImageSpam.UseOpenAIVision"
                                                  Label="Use OpenAI Vision"
                                                  Color="Color.Primary" />

                                        <MudNumericField @bind-Value="_imageTimeoutSeconds"
                                                        Label="Timeout (seconds)"
                                                        Min="10" Max="60"
                                                        helperText="Request timeout for image analysis" />
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        }
    </MudStack>
</MudContainer>

@code {
    private TelegramGroupsAdmin.SpamDetection.Configuration.SpamDetectionConfig? _config;
    private bool _loading = true;
    private bool _saving = false;
    private string? _currentUserId;

    // Helper fields for TimeSpan to int conversion
    private int _timeoutSeconds = 5;
    private int _cacheHours = 24;
    private int _threatIntelTimeoutSeconds = 30;
    private int _seoTimeoutSeconds = 10;
    private int _imageTimeoutSeconds = 30;

    private readonly string[] _similarityLabels = { "0.1", "0.3", "0.5", "0.7", "0.9" };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        await LoadConfiguration();
    }

    private async Task LoadConfiguration()
    {
        _loading = true;
        try
        {
            _config = await ConfigRepository.GetGlobalConfigAsync();

            // Convert TimeSpan values to int for UI
            _timeoutSeconds = (int)_config.Cas.Timeout.TotalSeconds;
            _cacheHours = (int)_config.UrlBlocklist.CacheDuration.TotalHours;
            _threatIntelTimeoutSeconds = (int)_config.ThreatIntel.Timeout.TotalSeconds;
            _seoTimeoutSeconds = (int)_config.SeoScraping.Timeout.TotalSeconds;
            _imageTimeoutSeconds = (int)_config.ImageSpam.Timeout.TotalSeconds;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
            _config = new TelegramGroupsAdmin.SpamDetection.Configuration.SpamDetectionConfig(); // Use default
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveConfiguration()
    {
        if (_config == null) return;

        _saving = true;
        try
        {
            // Load the current config from DB to compare changes
            var oldConfig = await ConfigRepository.GetGlobalConfigAsync();

            // Convert int values back to TimeSpan
            _config.Cas.Timeout = TimeSpan.FromSeconds(_timeoutSeconds);
            _config.UrlBlocklist.CacheDuration = TimeSpan.FromHours(_cacheHours);
            _config.ThreatIntel.Timeout = TimeSpan.FromSeconds(_threatIntelTimeoutSeconds);
            _config.SeoScraping.Timeout = TimeSpan.FromSeconds(_seoTimeoutSeconds);
            _config.ImageSpam.Timeout = TimeSpan.FromSeconds(_imageTimeoutSeconds);

            // Build detailed change log
            var changes = new List<string>();

            // Check scope settings
            if (oldConfig.FirstMessageOnly != _config.FirstMessageOnly)
                changes.Add($"FirstMessageOnly: {oldConfig.FirstMessageOnly} → {_config.FirstMessageOnly}");
            if (oldConfig.FirstMessagesCount != _config.FirstMessagesCount)
                changes.Add($"FirstMessagesCount: {oldConfig.FirstMessagesCount} → {_config.FirstMessagesCount}");
            if (oldConfig.MinMessageLength != _config.MinMessageLength)
                changes.Add($"MinMessageLength: {oldConfig.MinMessageLength} → {_config.MinMessageLength}");

            // Check enabled/disabled changes
            if (oldConfig.StopWords.Enabled != _config.StopWords.Enabled)
                changes.Add($"StopWords: {oldConfig.StopWords.Enabled} → {_config.StopWords.Enabled}");
            if (oldConfig.Cas.Enabled != _config.Cas.Enabled)
                changes.Add($"CAS: {oldConfig.Cas.Enabled} → {_config.Cas.Enabled}");
            if (oldConfig.Similarity.Enabled != _config.Similarity.Enabled)
                changes.Add($"Similarity: {oldConfig.Similarity.Enabled} → {_config.Similarity.Enabled}");
            if (oldConfig.Bayes.Enabled != _config.Bayes.Enabled)
                changes.Add($"Bayes: {oldConfig.Bayes.Enabled} → {_config.Bayes.Enabled}");
            if (oldConfig.MultiLanguage.Enabled != _config.MultiLanguage.Enabled)
                changes.Add($"MultiLanguage: {oldConfig.MultiLanguage.Enabled} → {_config.MultiLanguage.Enabled}");
            if (oldConfig.Spacing.Enabled != _config.Spacing.Enabled)
                changes.Add($"Spacing: {oldConfig.Spacing.Enabled} → {_config.Spacing.Enabled}");
            if (oldConfig.OpenAI.Enabled != _config.OpenAI.Enabled)
                changes.Add($"OpenAI: {oldConfig.OpenAI.Enabled} → {_config.OpenAI.Enabled}");
            if (oldConfig.UrlBlocklist.Enabled != _config.UrlBlocklist.Enabled)
                changes.Add($"UrlBlocklist: {oldConfig.UrlBlocklist.Enabled} → {_config.UrlBlocklist.Enabled}");
            if (oldConfig.ThreatIntel.Enabled != _config.ThreatIntel.Enabled)
                changes.Add($"ThreatIntel: {oldConfig.ThreatIntel.Enabled} → {_config.ThreatIntel.Enabled}");
            if (oldConfig.SeoScraping.Enabled != _config.SeoScraping.Enabled)
                changes.Add($"SeoScraping: {oldConfig.SeoScraping.Enabled} → {_config.SeoScraping.Enabled}");
            if (oldConfig.ImageSpam.Enabled != _config.ImageSpam.Enabled)
                changes.Add($"ImageSpam: {oldConfig.ImageSpam.Enabled} → {_config.ImageSpam.Enabled}");

            // Check threshold changes
            if (oldConfig.AutoBanThreshold != _config.AutoBanThreshold)
                changes.Add($"AutoBanThreshold: {oldConfig.AutoBanThreshold} → {_config.AutoBanThreshold}");
            if (oldConfig.ReviewQueueThreshold != _config.ReviewQueueThreshold)
                changes.Add($"ReviewQueueThreshold: {oldConfig.ReviewQueueThreshold} → {_config.ReviewQueueThreshold}");
            if (oldConfig.StopWords.ConfidenceThreshold != _config.StopWords.ConfidenceThreshold)
                changes.Add($"StopWordsConfidenceThreshold: {oldConfig.StopWords.ConfidenceThreshold} → {_config.StopWords.ConfidenceThreshold}");
            if (oldConfig.Similarity.Threshold != _config.Similarity.Threshold)
                changes.Add($"SimilarityThreshold: {oldConfig.Similarity.Threshold:F2} → {_config.Similarity.Threshold:F2}");
            if (oldConfig.Bayes.MinSpamProbability != _config.Bayes.MinSpamProbability)
                changes.Add($"BayesMinSpamProbability: {oldConfig.Bayes.MinSpamProbability:F2} → {_config.Bayes.MinSpamProbability:F2}");

            // Check CAS config changes
            if (oldConfig.Cas.ApiUrl != _config.Cas.ApiUrl)
                changes.Add($"CAS ApiUrl: {oldConfig.Cas.ApiUrl} → {_config.Cas.ApiUrl}");
            if (oldConfig.Cas.UserAgent != _config.Cas.UserAgent)
                changes.Add($"CAS UserAgent: {oldConfig.Cas.UserAgent ?? "null"} → {_config.Cas.UserAgent ?? "null"}");
            if (oldConfig.Cas.Timeout != _config.Cas.Timeout)
                changes.Add($"CAS Timeout: {oldConfig.Cas.Timeout.TotalSeconds}s → {_config.Cas.Timeout.TotalSeconds}s");

            // Check MultiLanguage config changes
            if (oldConfig.MultiLanguage.CheckTranslatedContent != _config.MultiLanguage.CheckTranslatedContent)
                changes.Add($"MultiLanguage.CheckTranslatedContent: {oldConfig.MultiLanguage.CheckTranslatedContent} → {_config.MultiLanguage.CheckTranslatedContent}");

            // Check Spacing config changes
            if (oldConfig.Spacing.MinWordsCount != _config.Spacing.MinWordsCount)
                changes.Add($"Spacing.MinWordsCount: {oldConfig.Spacing.MinWordsCount} → {_config.Spacing.MinWordsCount}");
            if (oldConfig.Spacing.ShortWordLength != _config.Spacing.ShortWordLength)
                changes.Add($"Spacing.ShortWordLength: {oldConfig.Spacing.ShortWordLength} → {_config.Spacing.ShortWordLength}");
            if (oldConfig.Spacing.ShortWordRatioThreshold != _config.Spacing.ShortWordRatioThreshold)
                changes.Add($"Spacing.ShortWordRatioThreshold: {oldConfig.Spacing.ShortWordRatioThreshold:F2} → {_config.Spacing.ShortWordRatioThreshold:F2}");
            if (oldConfig.Spacing.SpaceRatioThreshold != _config.Spacing.SpaceRatioThreshold)
                changes.Add($"Spacing.SpaceRatioThreshold: {oldConfig.Spacing.SpaceRatioThreshold:F2} → {_config.Spacing.SpaceRatioThreshold:F2}");

            // Check OpenAI config changes
            if (oldConfig.OpenAI.VetoMode != _config.OpenAI.VetoMode)
                changes.Add($"OpenAI.VetoMode: {oldConfig.OpenAI.VetoMode} → {_config.OpenAI.VetoMode}");
            if (oldConfig.OpenAI.CheckShortMessages != _config.OpenAI.CheckShortMessages)
                changes.Add($"OpenAI.CheckShortMessages: {oldConfig.OpenAI.CheckShortMessages} → {_config.OpenAI.CheckShortMessages}");
            if (oldConfig.OpenAI.SystemPrompt != _config.OpenAI.SystemPrompt)
                changes.Add($"OpenAI.SystemPrompt: {(string.IsNullOrEmpty(oldConfig.OpenAI.SystemPrompt) ? "empty" : "set")} → {(string.IsNullOrEmpty(_config.OpenAI.SystemPrompt) ? "empty" : "set")}");

            // Check UrlBlocklist config changes
            if (oldConfig.UrlBlocklist.CacheDuration != _config.UrlBlocklist.CacheDuration)
                changes.Add($"UrlBlocklist CacheDuration: {oldConfig.UrlBlocklist.CacheDuration.TotalHours}h → {_config.UrlBlocklist.CacheDuration.TotalHours}h");

            // Check ThreatIntel config changes
            if (oldConfig.ThreatIntel.UseVirusTotal != _config.ThreatIntel.UseVirusTotal)
                changes.Add($"ThreatIntel.UseVirusTotal: {oldConfig.ThreatIntel.UseVirusTotal} → {_config.ThreatIntel.UseVirusTotal}");
            if (oldConfig.ThreatIntel.Timeout != _config.ThreatIntel.Timeout)
                changes.Add($"ThreatIntel Timeout: {oldConfig.ThreatIntel.Timeout.TotalSeconds}s → {_config.ThreatIntel.Timeout.TotalSeconds}s");

            // Check SeoScraping config changes
            if (oldConfig.SeoScraping.Timeout != _config.SeoScraping.Timeout)
                changes.Add($"SeoScraping Timeout: {oldConfig.SeoScraping.Timeout.TotalSeconds}s → {_config.SeoScraping.Timeout.TotalSeconds}s");

            // Check ImageSpam config changes
            if (oldConfig.ImageSpam.UseOpenAIVision != _config.ImageSpam.UseOpenAIVision)
                changes.Add($"ImageSpam.UseOpenAIVision: {oldConfig.ImageSpam.UseOpenAIVision} → {_config.ImageSpam.UseOpenAIVision}");
            if (oldConfig.ImageSpam.Timeout != _config.ImageSpam.Timeout)
                changes.Add($"ImageSpam Timeout: {oldConfig.ImageSpam.Timeout.TotalSeconds}s → {_config.ImageSpam.Timeout.TotalSeconds}s");

            await ConfigRepository.UpdateGlobalConfigAsync(_config, _currentUserId);

            // Log the configuration change to audit log with details
            var changeDetails = changes.Count > 0
                ? string.Join(", ", changes)
                : "No changes detected";

            await AuditLogRepository.LogEventAsync(
                Data.Models.AuditEventType.SpamDetectionConfigChanged,
                actorUserId: _currentUserId,
                targetUserId: null,
                value: changeDetails
            );

            Snackbar.Add("Configuration saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}