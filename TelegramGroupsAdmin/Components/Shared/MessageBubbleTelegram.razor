@using TelegramGroupsAdmin.Telegram.Models
@using TelegramGroupsAdmin.Helpers
@* Telegram-authentic message bubble design *@

<div class="@GetBubbleClass()" @onclick:stopPropagation="true" data-message-id="@Message.MessageId">
    @* User profile photo *@
    <div class="tg-avatar-container">
        @if (!string.IsNullOrEmpty(Message.UserPhotoPath))
        {
            <img src="@GetImagePath(Message.UserPhotoPath)" alt="@(Message.UserName ?? Message.FirstName ?? $"User {Message.UserId}")" class="tg-avatar" loading="lazy" />
        }
        else
        {
            <div class="tg-avatar tg-avatar-fallback">
                <svg viewBox="0 0 24 24" class="tg-avatar-icon">
                    <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                </svg>
            </div>
        }
    </div>

    @* Message bubble with tail *@
    <div class="tg-bubble-wrapper">
        <div class="tg-bubble-inner">
            @* Telegram-style Header: User name + timestamp + badges *@
            <div class="tg-header">
                <span class="tg-user-name" @onclick="() => OnFilterByUser.InvokeAsync(Message.UserId)" title="Filter by this user">
                    @(Message.UserName ?? Message.FirstName ?? $"User {Message.UserId}")
                </span>
                <span class="tg-timestamp local-timestamp" data-utc="@Message.Timestamp.ToString("o")">
                    @FormatTimestamp(Message.Timestamp)
                </span>

                @* User Tags (Phase 4.12) *@
                @if (UserTags != null && UserTags.Any())
                {
                    foreach (var tag in UserTags)
                    {
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Color="@tag.TagColor.ToMudColor()"
                                 Class="tg-user-tag"
                                 title="@($"Added by {tag.AddedBy.DisplayName} on {tag.AddedAt:yyyy-MM-dd}")">
                            @tag.TagName
                        </MudChip>
                    }
                }

                @* Notes Icon (Phase 4.12) *@
                @if (UserNotes != null && UserNotes.Any())
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Notes"
                                   Size="Size.Small"
                                   Class="tg-notes-icon"
                                   title="@($"{UserNotes.Count} note(s)")"
                                   OnClick="ShowNotesDialog" />
                }

                @if (Message.DeletedAt.HasValue)
                {
                    <span class="tg-badge tg-badge-deleted" title="Deleted @Message.DeletedAt.Value.ToString("yyyy-MM-dd HH:mm") UTC (@(Message.DeletionSource ?? "unknown"))">
                        üóëÔ∏è DELETED
                    </span>
                }
                @if (Message.EditDate.HasValue)
                {
                    <span class="tg-edited">edited</span>
                }
                @if (SpamCheck != null)
                {
                    <span class="tg-badge tg-badge-@(SpamCheck.IsSpam ? "spam" : "ham")">
                        @(SpamCheck.IsSpam ? "spam" : "ham") @SpamCheck.Confidence%
                    </span>
                }
            </div>

            @* Content *@
            <div class="tg-content">
                @* Reply Preview *@
                <ReplyPreview ReplyToMessageId="@Message.ReplyToMessageId"
                              ReplyToUser="@Message.ReplyToUser"
                              ReplyToText="@Message.ReplyToText"
                              OnReplyClick="@OnReplyClick" />

                @* Image Thumbnail *@
                @if (!string.IsNullOrEmpty(Message.PhotoThumbnailPath))
                {
                    <img src="@GetImagePath(Message.PhotoThumbnailPath)"
                         alt="Message image"
                         class="tg-image"
                         loading="lazy"
                         @onclick="() => OnImageClick.InvokeAsync(Message)" />
                }

                @* Media Attachments (Phase 4.X: GIF, Video, Audio, Voice, Sticker, VideoNote) *@
                @if (Message.MediaType.HasValue &&
                     Message.MediaType.Value != TelegramGroupsAdmin.Telegram.Models.MediaType.Document)
                {
                    @if (!string.IsNullOrEmpty(Message.MediaLocalPath))
                    {
                        @switch (Message.MediaType.Value)
                    {
                        case TelegramGroupsAdmin.Telegram.Models.MediaType.Animation:
                            <video src="@GetImagePath(Message.MediaLocalPath)"
                                   class="tg-media tg-animation"
                                   autoplay loop muted playsinline
                                   title="GIF Animation">
                            </video>
                            break;

                        case TelegramGroupsAdmin.Telegram.Models.MediaType.Video:
                            <video src="@GetImagePath(Message.MediaLocalPath)"
                                   class="tg-media tg-video"
                                   controls preload="metadata"
                                   title="@(Message.MediaFileName ?? "Video")">
                            </video>
                            break;

                        case TelegramGroupsAdmin.Telegram.Models.MediaType.Audio:
                            <div class="tg-audio-container">
                                <div class="tg-audio-icon">üéµ</div>
                                <audio src="@GetImagePath(Message.MediaLocalPath)"
                                       class="tg-audio"
                                       controls preload="metadata"
                                       title="@(Message.MediaFileName ?? "Audio")">
                                </audio>
                            </div>
                            break;

                        case TelegramGroupsAdmin.Telegram.Models.MediaType.Voice:
                            <div class="tg-voice-container">
                                <div class="tg-voice-icon">üé§</div>
                                <audio src="@GetImagePath(Message.MediaLocalPath)"
                                       class="tg-voice"
                                       controls preload="metadata"
                                       title="Voice message (@FormatDuration(Message.MediaDuration))">
                                </audio>
                                @if (Message.MediaDuration.HasValue)
                                {
                                    <span class="tg-voice-duration">@FormatDuration(Message.MediaDuration.Value)</span>
                                }
                            </div>
                            break;

                        case TelegramGroupsAdmin.Telegram.Models.MediaType.Sticker:
                            <img src="@GetImagePath(Message.MediaLocalPath)"
                                 alt="Sticker"
                                 class="tg-media tg-sticker"
                                 loading="lazy" />
                            break;

                        case TelegramGroupsAdmin.Telegram.Models.MediaType.VideoNote:
                            <video src="@GetImagePath(Message.MediaLocalPath)"
                                   class="tg-media tg-videonote"
                                   controls preload="metadata"
                                   title="Video message">
                            </video>
                            break;
                    }
                    }
                    else
                    {
                        @* Media file is being downloaded - show placeholder *@
                        <div class="tg-media-placeholder">
                            <div class="tg-media-placeholder-icon">
                                @switch (Message.MediaType.Value)
                                {
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.Animation:
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.Video:
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.VideoNote:
                                        <span>üé¨</span>
                                        break;
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.Audio:
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.Voice:
                                        <span>üéµ</span>
                                        break;
                                    case TelegramGroupsAdmin.Telegram.Models.MediaType.Sticker:
                                        <span>üé≠</span>
                                        break;
                                }
                            </div>
                            <div class="tg-media-placeholder-text">
                                @GetMediaTypeName(Message.MediaType.Value) downloading...
                            </div>
                        </div>
                    }
                }
                else if (Message.MediaType == TelegramGroupsAdmin.Telegram.Models.MediaType.Document)
                {
                    @* Document: Show icon + filename (no download, file scanner handles security) *@
                    <div class="tg-document-container">
                        <div class="tg-document-icon">üìé</div>
                        <div class="tg-document-info">
                            <div class="tg-document-name">@(Message.MediaFileName ?? "Document")</div>
                            @if (Message.MediaFileSize.HasValue)
                            {
                                <div class="tg-document-size">@FormatFileSize(Message.MediaFileSize.Value)</div>
                            }
                        </div>
                    </div>
                }

                @* Message Text *@
                @if (!string.IsNullOrEmpty(Message.MessageText))
                {
                    <div class="tg-text">@Message.MessageText</div>
                }

                @* URLs *@
                @if (!string.IsNullOrEmpty(Message.Urls))
                {
                    <div class="tg-urls">
                        @foreach (var url in GetUrls())
                        {
                            <div class="tg-url" title="@url">üîó @TruncateUrl(url)</div>
                        }
                    </div>
                }
            </div>

            @* Actions menu - compact popover like Telegram (hover-triggered) *@
            @if (ShowSpamActions)
            {
                <div class="tg-actions-menu"
                     @onmouseenter="() => _popoverOpen = true"
                     @onmouseleave="() => _popoverOpen = false">
                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                   Size="Size.Small"
                                   Class="tg-menu-btn" />

                    <MudPopover Open="@_popoverOpen"
                                AnchorOrigin="Origin.BottomRight"
                                TransformOrigin="Origin.TopRight"
                                Class="tg-actions-popover"
                                @onmouseenter="() => _popoverOpen = true"
                                @onmouseleave="() => _popoverOpen = false">
                        <div class="tg-actions-list">
                            @if (EditCount > 0)
                            {
                                <MudMenuItem OnClick="() => OnViewEdits.InvokeAsync(Message)">
                                    <div class="tg-menu-item">
                                        <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" />
                                        <span>View Edits (@EditCount)</span>
                                    </div>
                                </MudMenuItem>
                            }

                            @if (DetectionHistory?.Count > 0)
                            {
                                <MudMenuItem OnClick="() => OnViewDetections.InvokeAsync(Message)">
                                    <div class="tg-menu-item">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                        <span>Detection History</span>
                                    </div>
                                </MudMenuItem>
                            }

                            @if (SpamCheck?.IsSpam != true && !IsCurrentUser)
                            {
                                <MudMenuItem OnClick="async () => { _popoverOpen = false; await OnMarkAsSpam.InvokeAsync(Message); }" Disabled="@_actionInProgress">
                                    <div class="tg-menu-item tg-menu-item-danger">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                        <span>Mark as Spam</span>
                                    </div>
                                </MudMenuItem>
                            }

                            @if (!IsManuallyMarkedAsHam())
                            {
                                <MudMenuItem OnClick="async () => { _popoverOpen = false; await OnMarkAsHam.InvokeAsync(Message); }" Disabled="@_actionInProgress">
                                    <div class="tg-menu-item tg-menu-item-success">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                        <span>Mark as Ham</span>
                                    </div>
                                </MudMenuItem>
                            }

                            <MudMenuItem OnClick="async () => { _popoverOpen = false; await OnDeleteMessage.InvokeAsync(Message); }" Disabled="@_actionInProgress">
                                <div class="tg-menu-item tg-menu-item-danger">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                    <span>Delete Message</span>
                                </div>
                            </MudMenuItem>

                            <MudMenuItem OnClick="async () => { _popoverOpen = false; await OnTempBan.InvokeAsync(Message); }" Disabled="@_actionInProgress">
                                <div class="tg-menu-item tg-menu-item-warning">
                                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" />
                                    <span>Temp Ban User</span>
                                </div>
                            </MudMenuItem>
                        </div>
                    </MudPopover>
                </div>
            }
        </div>

        @* Telegram tail - small subtle curve at bottom-left *@
        <svg class="tg-tail" viewBox="0 0 6 12" xmlns="http://www.w3.org/2000/svg">
            <path d="M6,12 L0,12 L0,8 Q0,6 2,4 Q4,2 6,0 Z"/>
        </svg>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public MessageRecord Message { get; set; } = default!;

    [Parameter]
    public SpamCheckRecord? SpamCheck { get; set; }

    [Parameter]
    public int EditCount { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnImageClick { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnViewEdits { get; set; }

    [Parameter]
    public bool ShowSpamActions { get; set; }

    [Parameter]
    public List<DetectionResultRecord>? DetectionHistory { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnMarkAsSpam { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnMarkAsHam { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnViewDetections { get; set; }

    [Parameter]
    public EventCallback<long> OnFilterByUser { get; set; }

    [Parameter]
    public EventCallback<long> OnFilterByChat { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnDeleteMessage { get; set; }

    [Parameter]
    public EventCallback<MessageRecord> OnTempBan { get; set; }

    [Parameter]
    public bool IsCurrentUser { get; set; }

    [Parameter]
    public EventCallback<long> OnReplyClick { get; set; }

    /// <summary>
    /// Phase 4.12: User tags for contextual display in message UI
    /// </summary>
    [Parameter]
    public List<UserTag>? UserTags { get; set; }

    /// <summary>
    /// Phase 4.12: Admin notes for contextual display in message UI
    /// </summary>
    [Parameter]
    public List<AdminNote>? UserNotes { get; set; }

    [Inject]
    private IDialogService DialogService { get; set; } = default!;

    private bool _actionInProgress = false;
    private bool _popoverOpen = false;

    /// <summary>
    /// Show admin notes dialog when notes icon is clicked
    /// Phase 4.12: Display all notes for the message author
    /// </summary>
    private async Task ShowNotesDialog()
    {
        if (UserNotes == null || !UserNotes.Any())
            return;

        var parameters = new DialogParameters
        {
            { nameof(UserNotesDialog.Notes), UserNotes },
            { nameof(UserNotesDialog.UserName), Message.UserName ?? Message.FirstName ?? $"User {Message.UserId}" }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync<UserNotesDialog>("User Notes", parameters, options);
    }

    private string GetBubbleClass()
    {
        var baseClass = "tg-message";

        // Add spam/ham/neutral class
        if (SpamCheck != null)
        {
            if (SpamCheck.IsSpam)
                baseClass += " tg-message-spam";
            else
                baseClass += " tg-message-ham";
        }

        // Add current user class for lighter color
        if (IsCurrentUser)
            baseClass += " tg-message-current-user";

        return baseClass;
    }

    private string FormatTimestamp(DateTimeOffset timestamp)
    {
        var dt = timestamp.ToLocalTime();
        var now = DateTimeOffset.Now;

        if (dt.Date == now.Date)
            return dt.ToString("h:mm tt"); // 12-hour format with AM/PM
        if (dt.Date == now.AddDays(-1).Date)
            return $"Yesterday {dt:h:mm tt}";
        if (dt.Year == now.Year)
            return dt.ToString("MMM dd h:mm tt");
        return dt.ToString("MMM dd yyyy h:mm tt");
    }

    private string[] GetUrls()
    {
        if (string.IsNullOrEmpty(Message.Urls))
            return Array.Empty<string>();
        return Message.Urls.Split(',', StringSplitOptions.RemoveEmptyEntries);
    }

    private string TruncateUrl(string url)
    {
        const int maxLength = 50;
        if (url.Length <= maxLength)
            return url;
        return url.Substring(0, maxLength - 3) + "...";
    }

    private string GetImagePath(string? path)
    {
        if (string.IsNullOrEmpty(path))
            return string.Empty;

        var relativePath = path.Contains('/') || path.Contains('\\')
            ? path.Replace('\\', '/')
            : Path.GetFileName(path);

        return $"/images/{relativePath}";
    }

    private bool IsManuallyMarkedAsHam()
    {
        if (DetectionHistory == null || !DetectionHistory.Any())
            return false;

        var latest = DetectionHistory.OrderByDescending(d => d.DetectedAt).First();
        return latest.DetectionSource == "manual" && !latest.IsSpam;
    }

    /// <summary>
    /// Format duration in seconds to MM:SS format
    /// Phase 4.X: Used for audio/voice/video duration display
    /// </summary>
    private string FormatDuration(int? seconds)
    {
        if (!seconds.HasValue || seconds.Value < 0)
            return "0:00";

        var duration = TimeSpan.FromSeconds(seconds.Value);
        return duration.TotalHours >= 1
            ? duration.ToString(@"h\:mm\:ss")  // 1:23:45 for long files
            : duration.ToString(@"m\:ss");      // 3:45 for short files
    }

    /// <summary>
    /// Format file size in bytes to human-readable format (KB, MB, GB)
    /// Phase 4.X: Used for document file size display
    /// </summary>
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }

    /// <summary>
    /// Get friendly name for media type
    /// Phase 4.X: Used for media placeholder display
    /// </summary>
    private string GetMediaTypeName(TelegramGroupsAdmin.Telegram.Models.MediaType mediaType)
    {
        return mediaType switch
        {
            TelegramGroupsAdmin.Telegram.Models.MediaType.Animation => "GIF",
            TelegramGroupsAdmin.Telegram.Models.MediaType.Video => "Video",
            TelegramGroupsAdmin.Telegram.Models.MediaType.Audio => "Audio",
            TelegramGroupsAdmin.Telegram.Models.MediaType.Voice => "Voice message",
            TelegramGroupsAdmin.Telegram.Models.MediaType.Sticker => "Sticker",
            TelegramGroupsAdmin.Telegram.Models.MediaType.VideoNote => "Video message",
            TelegramGroupsAdmin.Telegram.Models.MediaType.Document => "Document",
            _ => "Media"
        };
    }
}
