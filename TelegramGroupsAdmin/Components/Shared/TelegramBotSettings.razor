@inject NavigationManager Navigation
@implements IDisposable

<MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" ActivePanelIndex="_activeSubTabIndex" ActivePanelIndexChanged="OnSubTabChanged">
    <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
        <BotGeneralSettings />
    </MudTabPanel>

    <MudTabPanel Text="Welcome System" Icon="@Icons.Material.Filled.WavingHand">
        <WelcomeSystemConfig />
    </MudTabPanel>
</MudTabs>

@code {
    private int _activeSubTabIndex;

    protected override void OnInitialized()
    {
        // Parse URL fragment to set initial sub-tab
        var fragment = new Uri(Navigation.Uri).Fragment.TrimStart('#');
        _activeSubTabIndex = fragment switch
        {
            "telegram-general" => 0,
            "telegram-welcome" => 1,
            "telegram" => 0, // Default to General when just #telegram
            _ => _activeSubTabIndex
        };

        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var fragment = new Uri(e.Location).Fragment.TrimStart('#');
        var newIndex = fragment switch
        {
            "telegram-general" => 0,
            "telegram-welcome" => 1,
            "telegram" => 0,
            _ => -1 // Don't update if fragment doesn't match
        };

        if (newIndex >= 0 && newIndex != _activeSubTabIndex)
        {
            _activeSubTabIndex = newIndex;
            StateHasChanged();
        }
    }

    private void OnSubTabChanged(int index)
    {
        _activeSubTabIndex = index;

        // Update URL fragment without reload
        var fragment = index switch
        {
            0 => "telegram-general",
            1 => "telegram-welcome",
            _ => "telegram"
        };

        Navigation.NavigateTo($"/settings/telegram/bot#{fragment}", false);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
