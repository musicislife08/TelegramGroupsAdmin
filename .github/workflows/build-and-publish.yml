name: Build and Publish

on:
  # Trigger explanations:
  # - pull_request: Runs build/test during PR review (validation only, no push)
  # - push to develop: Publishes development Docker images after merge
  # - release published: Publishes production Docker images with release tag version
  pull_request:
    types: [opened, ready_for_review, synchronize]
    branches:
      - develop
      - master
    paths-ignore:
      - 'CLAUDE.md'
      - 'README.md'
      - 'BACKLOG.md'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/workflows/claude*.yml'
  push:
    branches:
      - develop  # Only develop - master uses release trigger
    paths-ignore:
      - 'CLAUDE.md'
      - 'README.md'
      - 'BACKLOG.md'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/workflows/claude*.yml'
  release:
    types: [published]  # Production releases - tag already exists, GitVersion picks it up

env:
  REGISTRY: ghcr.io

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    # Only run on pull_request events (during PR review), skip on push events (after merge)
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

    outputs:
      semver: ${{ steps.gitversion.outputs.semVer }}
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitVersion

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1

      - name: Display Version
        env:
          SEMVER: ${{ steps.gitversion.outputs.semVer }}
          NUGET_VERSION: ${{ steps.gitversion.outputs.nuGetVersion }}
        run: |
          echo "SemVer: ${SEMVER}"
          echo "NuGetVersion: ${NUGET_VERSION}"
          echo "### Version: ${SEMVER}" >> $GITHUB_STEP_SUMMARY

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run all tests
        run: dotnet test --no-build --configuration Release --verbosity normal

  # Shared versioning job for Docker builds (runs before parallel platform builds)
  docker-version:
    name: Determine Docker Version
    runs-on: ubuntu-latest

    # Run on PRs (validation), push to develop (dev images), and releases (prod images)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'release')

    outputs:
      semver: ${{ steps.gitversion.outputs.semVer }}
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}
      tags: ${{ steps.docker-tags.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitVersion

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1

      - name: Determine Docker tags
        id: docker-tags
        env:
          EVENT_NAME: ${{ github.event_name }}
          BRANCH_NAME: ${{ github.ref_name }}
          SEMVER: ${{ steps.gitversion.outputs.semVer }}
          MAJOR: ${{ steps.gitversion.outputs.major }}
          MINOR: ${{ steps.gitversion.outputs.minor }}
          REPO: ${{ github.repository }}
        run: |
          # Convert repository name to lowercase for Docker
          REPO_LOWER="${REPO,,}"

          if [ "${EVENT_NAME}" == "release" ]; then
            # Release event: latest + semver + major.minor (production)
            TAGS="${REGISTRY}/${REPO_LOWER}:latest"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${SEMVER}"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${MAJOR}.${MINOR}"
          else
            # Develop branch (push) or PR validation: development + semver
            TAGS="${REGISTRY}/${REPO_LOWER}:development"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${SEMVER}"
          fi
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

  # Single multi-arch build (simplified approach - 30s slower but much simpler)
  # Trade-off: AMD64 30s + ARM64 3min = 3.5min total vs 3min parallel
  build-and-publish-multiarch:
    name: Build and Publish Multi-Arch Image
    runs-on: ubuntu-latest
    needs: docker-version

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Docker repository name
        id: repo
        run: |
          # Convert repository name to lowercase for Docker compatibility
          REPO_LOWER="${{ github.repository }}"
          REPO_LOWER="${REPO_LOWER,,}"
          echo "name=${REPO_LOWER}" >> $GITHUB_OUTPUT

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./TelegramGroupsAdmin/Dockerfile
          platforms: linux/amd64,linux/arm64
          # Push on develop merge (push) or release creation, validate only on PRs
          push: ${{ github.event_name == 'push' || github.event_name == 'release' }}
          tags: ${{ needs.docker-version.outputs.tags }}
          # Unified cache for both platforms (v2: force fresh cache after fixing NuGet cache IDs)
          cache-from: type=gha,scope=buildx-multiarch-v2
          cache-to: type=gha,mode=max,scope=buildx-multiarch-v2
          # Enable BuildKit inline cache for cross-platform sharing
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build summary
        env:
          VERSION: ${{ needs.docker-version.outputs.semver }}
          EVENT: ${{ github.event_name }}
          TAGS: ${{ needs.docker-version.outputs.tags }}
          REPO: ${{ steps.repo.outputs.name }}
        run: |
          if [ "$EVENT" == "pull_request" ]; then
            echo "### Validated Multi-Arch Build :white_check_mark:" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Build validation only (no push)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Docker Image Published :rocket:" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Built and pushed to registry" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Architectures:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Strategy:** Single multi-arch build (cross-compilation)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Optimizations:**" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cross-compilation (minimal QEMU overhead)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unified cache for all platforms" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Multi-stage Dockerfile (5 stages)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Direct manifest creation (no intermediate images)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$EVENT" == "push" ] || [ "$EVENT" == "release" ]; then
            echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${TAGS}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pull commands:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            if [ "$EVENT" == "release" ]; then
              echo "# Stable (latest)" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${REGISTRY}/${REPO}:latest" >> $GITHUB_STEP_SUMMARY
            else
              echo "# Development (testing)" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${REGISTRY}/${REPO}:development" >> $GITHUB_STEP_SUMMARY
            fi
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
