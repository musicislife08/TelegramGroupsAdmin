name: Build and Publish

on:
  # Split triggers to prevent duplicate runs and ensure Docker publishes from correct branch:
  # - pull_request: Runs build/test during PR review (feature branch context)
  # - push: Runs Docker publish after PR merge (target branch context - develop/master)
  pull_request:
    types: [opened, ready_for_review, synchronize]  # NOT closed - that's handled by push trigger
    branches:
      - develop
      - master
    paths-ignore:
      - 'CLAUDE.md'
      - 'README.md'
      - 'BACKLOG.md'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/workflows/claude*.yml'
  push:
    branches:
      - develop
      - master
    paths-ignore:
      - 'CLAUDE.md'
      - 'README.md'
      - 'BACKLOG.md'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/workflows/claude*.yml'

env:
  REGISTRY: ghcr.io

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    # Only run on pull_request events (during PR review), skip on push events (after merge)
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

    outputs:
      semver: ${{ steps.gitversion.outputs.semVer }}
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitVersion

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1

      - name: Display Version
        env:
          SEMVER: ${{ steps.gitversion.outputs.semVer }}
          NUGET_VERSION: ${{ steps.gitversion.outputs.nuGetVersion }}
        run: |
          echo "SemVer: ${SEMVER}"
          echo "NuGetVersion: ${NUGET_VERSION}"
          echo "### Version: ${SEMVER}" >> $GITHUB_STEP_SUMMARY

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run all tests
        run: dotnet test --no-build --configuration Release --verbosity normal

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (validation only, no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./TelegramGroupsAdmin/Dockerfile
          platforms: linux/amd64
          push: false
          cache-from: type=gha,scope=buildx-amd64
          tags: telegramgroupsadmin:pr-${{ github.event.pull_request.number }}

      - name: Docker build summary
        run: |
          echo "### Docker Build Validated :whale:" >> $GITHUB_STEP_SUMMARY
          echo "Multi-stage Dockerfile builds successfully for AMD64" >> $GITHUB_STEP_SUMMARY

  # Shared versioning job for Docker builds (runs before parallel platform builds)
  docker-version:
    name: Determine Docker Version
    runs-on: ubuntu-latest

    # Only run on push events to develop/master (after PR merge)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    outputs:
      semver: ${{ steps.gitversion.outputs.semVer }}
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}
      tags: ${{ steps.docker-tags.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitVersion

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1

      - name: Determine Docker tags
        id: docker-tags
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          SEMVER: ${{ steps.gitversion.outputs.semVer }}
          MAJOR: ${{ steps.gitversion.outputs.major }}
          MINOR: ${{ steps.gitversion.outputs.minor }}
          REPO: ${{ github.repository }}
        run: |
          # Convert repository name to lowercase for Docker
          REPO_LOWER="${REPO,,}"

          if [ "${BRANCH_NAME}" == "master" ]; then
            # Master branch: latest + semver
            TAGS="${REGISTRY}/${REPO_LOWER}:latest"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${SEMVER}"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${MAJOR}.${MINOR}"
          else
            # Develop branch: development + beta semver
            TAGS="${REGISTRY}/${REPO_LOWER}:development"
            TAGS="${TAGS},${REGISTRY}/${REPO_LOWER}:${SEMVER}"
          fi
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

  # Parallel platform-specific builds (AMD64 and ARM64 run concurrently)
  build-platform-images:
    name: Build ${{ matrix.platform }} Image
    runs-on: ${{ matrix.runner }}
    needs: docker-version

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false  # Continue ARM build even if AMD fails (or vice versa)
      matrix:
        include:
          # AMD64 build on standard GitHub runners (fast, no QEMU)
          - platform: linux/amd64
            runner: ubuntu-latest
            platform_tag: amd64

          # ARM64 build on native ARM runners (3x faster than QEMU)
          # GitHub ARM runners: Same cost as standard ($0.008/min)
          - platform: linux/arm64
            runner: ubuntu-latest-arm
            platform_tag: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push platform image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./TelegramGroupsAdmin/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          # Tag with platform suffix for intermediate images (merged later)
          tags: ${{ env.REGISTRY }}/${{ github.repository }}:build-${{ matrix.platform_tag }}-${{ needs.docker-version.outputs.semver }}
          # Per-platform cache keys for better cache reuse
          cache-from: type=gha,scope=buildx-${{ matrix.platform_tag }}
          cache-to: type=gha,mode=max,scope=buildx-${{ matrix.platform_tag }}
          # Enable BuildKit inline cache for cross-platform sharing
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build summary
        env:
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ needs.docker-version.outputs.semver }}
        run: |
          echo "### Built $PLATFORM Image :package:" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Runner:** ${{ matrix.runner }}" >> $GITHUB_STEP_SUMMARY

  # Merge multi-arch manifest and push final images
  publish-manifest:
    name: Publish Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [docker-version, build-platform-images]

    permissions:
      contents: read
      packages: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        env:
          TAGS: ${{ needs.docker-version.outputs.tags }}
          SEMVER: ${{ needs.docker-version.outputs.semver }}
          REPO: ${{ github.repository }}
        run: |
          # Convert repository name to lowercase for Docker
          REPO_LOWER="${REPO,,}"

          # Platform-specific intermediate images
          AMD64_IMAGE="${REGISTRY}/${REPO_LOWER}:build-amd64-${SEMVER}"
          ARM64_IMAGE="${REGISTRY}/${REPO_LOWER}:build-arm64-${SEMVER}"

          # Create and push manifest for each tag
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          for TAG in "${TAG_ARRAY[@]}"; do
            echo "Creating manifest for ${TAG}..."
            docker buildx imagetools create -t "${TAG}" \
              "${AMD64_IMAGE}" \
              "${ARM64_IMAGE}"
          done

          echo "Multi-arch manifests published successfully!"

      - name: Image published summary
        env:
          TAGS: ${{ needs.docker-version.outputs.tags }}
          VERSION: ${{ needs.docker-version.outputs.semver }}
          BRANCH_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          # Convert repository name to lowercase for Docker
          REPO_LOWER="${REPO,,}"

          echo "### Docker Image Published :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architectures:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Strategy:** Parallel platform builds + manifest merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Optimizations:**" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cross-compilation (no QEMU for builds)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Parallel AMD64 + ARM64 builds" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Per-platform cache keys" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Multi-stage Dockerfile (5 stages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${TAGS}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "${BRANCH_NAME}" == "master" ]; then
            echo "# Stable (latest)" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${REGISTRY}/${REPO_LOWER}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "# Development (testing)" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${REGISTRY}/${REPO_LOWER}:development" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
