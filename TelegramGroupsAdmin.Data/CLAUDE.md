# TelegramGroupsAdmin.Data - AI Reference

## Project Role

This is the **lowest-level project** in the solution - the data access layer. It contains:
- EF Core `AppDbContext`
- Database entity models (`*Dto` classes)
- EF Core migrations
- Data Protection key storage

## Critical Rules

### 1. No Outbound Project References

This project must **NEVER** reference other projects in the solution. It is the foundation layer that all other projects depend on. If you need shared types, they belong in `TelegramGroupsAdmin.Core`.

```
✅ Allowed dependencies: NuGet packages only (EF Core, Npgsql, etc.)
❌ Never reference: .Telegram, .ContentDetection, .Configuration, .Core, etc.
```

### 2. Entity Classes Must End in `Dto`

All database entity classes **MUST** have the `Dto` suffix. This naming convention is required by the backup/restore system which discovers entities via reflection.

```csharp
✅ public class ReportDto { }           // Correct - will be backed up
✅ public class ExamSessionDto { }      // Correct - will be backed up
❌ public class Report { }              // Wrong - won't be discovered
❌ public class ExamSession { }         // Wrong - won't be discovered
```

### 3. Code-First EF Core

All database schema changes must follow EF Core code-first patterns:

1. **Modify the model** (`*Dto` class) and/or `AppDbContext.OnModelCreating()`
2. **Generate migration**: `dotnet ef migrations add MigrationName -p TelegramGroupsAdmin.Data -s TelegramGroupsAdmin`
3. **Review the generated migration** - EF Core sometimes generates DROP+CREATE instead of RENAME
4. **Apply migration**: Handled automatically at app startup

### 4. Repository Mapping Pattern

Repositories in other projects (`.Telegram`, `.ContentDetection`) that use this data layer must:

- **Never expose `*Dto` types** in their public interfaces
- **Map to domain models** using extension methods:
  - `.ToModel()` - Convert `Dto` → domain model (for read operations)
  - `.ToDto()` - Convert domain model → `Dto` (for write operations)

```csharp
// In repository (e.g., ContentDetection project)
public async Task<Report?> GetByIdAsync(long id, CancellationToken ct)
{
    var dto = await _context.Reports.FindAsync(id, ct);
    return dto?.ToModel();  // ← Convert to domain model
}

public async Task<long> InsertAsync(Report report, CancellationToken ct)
{
    var dto = report.ToDto();  // ← Convert from domain model
    _context.Reports.Add(dto);
    await _context.SaveChangesAsync(ct);
    return dto.Id;
}
```

Mapping extensions live in each consuming project's `Repositories/Mappings/` folder.

## Folder Structure

```
TelegramGroupsAdmin.Data/
├── AppDbContext.cs              # DbContext with all DbSets and OnModelCreating
├── Migrations/                  # EF Core migrations (auto-generated)
├── Models/                      # All *Dto entity classes
│   ├── ReportDto.cs
│   ├── ReportStatus.cs          # Enums can live here too
│   └── ...
└── DataProtection/              # ASP.NET Data Protection key storage
```

## Common Patterns

### Enum Storage

Enums are stored as integers in the database. Configure conversion in `OnModelCreating`:

```csharp
modelBuilder.Entity<ReportDto>()
    .Property(r => r.Status)
    .HasConversion<int>();
```

### JSONB Columns

For flexible schema storage, use JSONB columns:

```csharp
// In Dto class
[Column("context")]
public string? Context { get; set; }  // Stored as JSONB

// In OnModelCreating
entity.Property(e => e.Context).HasColumnType("jsonb");
```

### Partial Unique Indexes

For state-dependent constraints (e.g., only one pending report per message):

```csharp
modelBuilder.Entity<ReportDto>()
    .HasIndex(r => new { r.MessageId, r.ChatId })
    .HasFilter("status = 0")  // Only applies to pending
    .IsUnique()
    .HasDatabaseName("IX_reports_unique_pending_per_message");
```

### Table/Column Naming

Use explicit `[Table]` and `[Column]` attributes to control database naming:

```csharp
[Table("exam_sessions")]  // snake_case table name
public class ExamSessionDto
{
    [Column("chat_id")]   // snake_case column name
    public long ChatId { get; set; }
}
```

## Migration Warnings

### RENAME vs DROP+CREATE

EF Core often generates `DROP TABLE` + `CREATE TABLE` instead of `RENAME TABLE` when renaming. **Always review migrations** and manually fix:

```csharp
// BAD - Generated by EF Core (causes data loss!)
migrationBuilder.DropTable(name: "reports");
migrationBuilder.CreateTable(name: "reviews", ...);

// GOOD - Manual fix (preserves data)
migrationBuilder.RenameTable(name: "reports", newName: "reviews");
```

### Index Renames

When renaming tables, also rename indexes manually:

```csharp
migrationBuilder.RenameIndex(
    name: "IX_reports_unique_pending_per_message",
    newName: "IX_reviews_unique_pending_per_message",
    table: "reviews");
```
