@page "/login/verify"
@using TelegramGroupsAdmin.Ui.Api
@using TelegramGroupsAdmin.Ui.Extensions
@using TelegramGroupsAdmin.Ui.Models
@layout LoginLayout
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpFactory
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Two-Factor Authentication - Telegram Groups Admin</PageTitle>

<div class="verify-container">
    <h1 class="verify-title">Two-Factor Authentication</h1>
    <p class="verify-subtitle">Enter the 6-digit code from your authenticator app</p>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert-error">@_errorMessage</div>
    }

    <form @onsubmit="HandleVerify" @onsubmit:preventDefault>
            <div class="form-group">
                <label class="form-label" for="code">Verification Code</label>
                <input type="text"
                       id="code"
                       class="form-input"
                       @bind="_code"
                       @bind:event="oninput"
                       placeholder="000000"
                       maxlength="6"
                       pattern="[0-9]*"
                       inputmode="numeric"
                       required />
            </div>

            <button type="submit" class="btn-primary">Verify</button>
        </form>

        <div class="divider"></div>

    <p class="text-center">
        Lost access to your authenticator? Contact your administrator to reset 2FA.<br />
        <a href="/login">Back to Login</a>
    </p>
</div>

@code {
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private string _code = string.Empty;
    private string? _errorMessage;

    private HttpClient Http => HttpFactory.CreateClient(HttpClientNames.Api);

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(Token))
        {
            // Security: Redirect to login if no valid token (matches Blazor Server behavior)
            Navigation.NavigateTo("/login", forceLoad: false);
        }
    }

    private async Task HandleVerify()
    {
        _errorMessage = null;

        try
        {
            var response = await Http.PostAsJsonAsync(Routes.Auth.VerifyTotp, new VerifyTotpRequest(
                Code: _code,
                IntermediateToken: Token!
            ));
            var result = await response.ReadApiResponseAsync<ApiResponse>("Invalid verification code. Please try again.");

            if (!result.IsSuccess)
            {
                _errorMessage = result.Error;
                _code = string.Empty; // Clear the code field for retry
                return;
            }

            // Notify auth state provider to refresh
            if (AuthStateProvider is WasmAuthStateProvider wasmAuth)
            {
                wasmAuth.NotifyAuthenticationStateChanged();
            }

            // Navigate to home
            Navigation.NavigateTo("/", forceLoad: false);
        }
        catch (HttpRequestException)
        {
            _errorMessage = "Unable to connect to the server. Please try again.";
        }
    }
}
