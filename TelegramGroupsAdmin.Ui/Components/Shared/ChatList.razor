@* Chat list sidebar - Telegram Desktop style *@
@using TelegramGroupsAdmin.Ui.Models

<div class="chat-list">
    @if (Chats == null || !Chats.Any())
    {
        <div class="chat-list-empty">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M6,9H18V11H6M14,14H6V12H14M18,8H6V6H18" />
                </svg>
            </div>
            <div class="empty-text">No chats available</div>
        </div>
    }
    else
    {
        @foreach (var chat in Chats.OrderBy(c => c.ChatId))
        {
            <div class="chat-list-item @(IsSelected(chat.ChatId) ? "active" : "")"
                 @onclick="() => OnChatSelected.InvokeAsync(chat.ChatId)">

                @* Chat Avatar *@
                <div class="chat-avatar-wrapper">
                    @if (!string.IsNullOrEmpty(chat.ChatIconPath))
                    {
                        <img src="@GetChatIconPath(chat.ChatIconPath)"
                             alt="@chat.ChatName"
                             class="chat-avatar"
                             loading="lazy" />
                    }
                    else
                    {
                        <div class="chat-avatar chat-avatar-fallback">
                            <svg viewBox="0 0 24 24" class="chat-icon">
                                <path fill="currentColor" d="M16,13C15.71,13 15.38,13 15.03,13.05C16.19,13.89 17,15 17,16.5V19H23V16.5C23,14.17 18.33,13 16,13M8,13C5.67,13 1,14.17 1,16.5V19H15V16.5C15,14.17 10.33,13 8,13M8,11A3,3 0 0,0 11,8A3,3 0 0,0 8,5A3,3 0 0,0 5,8A3,3 0 0,0 8,11M16,11A3,3 0 0,0 19,8A3,3 0 0,0 16,5A3,3 0 0,0 13,8A3,3 0 0,0 16,11Z" />
                            </svg>
                        </div>
                    }
                </div>

                @* Chat Info *@
                <div class="chat-info">
                    <div class="chat-title-row">
                        <span class="chat-title">@chat.ChatName</span>
                        @if (chat.MessageCount > 0)
                        {
                            <span class="chat-count">@chat.MessageCount</span>
                        }
                    </div>
                    <div class="chat-subtitle-row">
                        <span class="chat-last-message">
                            @GetLastMessagePreview(chat)
                        </span>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter, EditorRequired]
    public List<ChatSummary> Chats { get; set; } = [];

    [Parameter]
    public long? SelectedChatId { get; set; }

    [Parameter]
    public EventCallback<long> OnChatSelected { get; set; }

    private bool IsSelected(long chatId) => SelectedChatId == chatId;

    private static string GetChatIconPath(string? path)
    {
        if (string.IsNullOrEmpty(path))
            return string.Empty;

        var relativePath = path.Contains('/') || path.Contains('\\')
            ? path.Replace('\\', '/')
            : Path.GetFileName(path);

        return $"/media/{relativePath}";
    }

    private static string GetLastMessagePreview(ChatSummary chat)
    {
        if (!string.IsNullOrEmpty(chat.LastMessagePreview))
        {
            return chat.LastMessagePreview;
        }

        if (chat.LastMessageAt.HasValue)
        {
            return GetTimeAgo(chat.LastMessageAt.Value);
        }

        return "No messages yet";
    }

    private static string GetTimeAgo(DateTimeOffset timestamp)
    {
        var diff = DateTimeOffset.UtcNow - timestamp;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";

        return timestamp.LocalDateTime.ToString("MMM d");
    }
}
