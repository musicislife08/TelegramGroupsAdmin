@using TelegramGroupsAdmin.Ui.Navigation
@inject AuthenticationStateProvider AuthStateProvider

<MudNavMenu>
    @if (_isAuthenticated)
    {
        <!-- Main Navigation (all authenticated users) -->
        <MudNavLink Href="@PageRoutes.App.Home" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Home</MudNavLink>
        <MudNavLink Href="@PageRoutes.App.Messages" Icon="@Icons.Material.Filled.Message">Messages</MudNavLink>

        @if (_isGlobalAdminOrOwner)
        {
            <!-- GlobalAdmin/Owner only -->
            <MudNavLink Href="@PageRoutes.Settings.Index" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
        }

        <!-- Resources -->
        <MudNavLink Href="@PageRoutes.App.Docs" Icon="@Icons.Material.Filled.MenuBook">Documentation</MudNavLink>

        <!-- User Section (Bottom) -->
        <MudSpacer />
        <MudDivider Class="my-2" />
        <MudNavLink Href="@PageRoutes.App.Profile" Icon="@Icons.Material.Filled.AccountCircle">Profile</MudNavLink>
        <MudNavLink OnClick="@LogoutAsync" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
    }
</MudNavMenu>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    private bool _isAuthenticated;
    private bool _isGlobalAdminOrOwner;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            // Check for permission level claim
            var permissionClaim = user.FindFirst("permission_level");
            if (permissionClaim != null && int.TryParse(permissionClaim.Value, out var level))
            {
                // Admin=0, GlobalAdmin=1, Owner=2
                // GlobalAdmin and Owner can see Settings
                _isGlobalAdminOrOwner = level >= 1;
            }
        }
    }

    private void LogoutAsync()
    {
        Navigation.NavigateTo(PageRoutes.Auth.Logout, forceLoad: true);
    }
}
