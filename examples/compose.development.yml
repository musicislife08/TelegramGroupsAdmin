# =============================================================================
# TelegramGroupsAdmin - Development Deployment (Build from Source)
# =============================================================================
# This compose file builds the application from local source code
# Use this for development, testing, or when you want to customize the code
#
# Quick Start:
# 1. Copy this file: cp examples/compose.development.yml compose.yml
# 2. Edit compose.yml - replace all CHANGE_ME values with your actual credentials
# 3. Run: docker compose up -d --build
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:18-alpine
    container_name: telegram-groups-admin-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: telegram_groups_admin
      POSTGRES_USER: tgadmin
      POSTGRES_PASSWORD: CHANGE_ME_STRONG_PASSWORD  # CHANGE THIS!
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_MAX_CONNECTIONS: 100
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tgadmin -d telegram_groups_admin"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - telegram-admin

  # ---------------------------------------------------------------------------
  # ClamAV Antivirus Scanner
  # ---------------------------------------------------------------------------
  clamav:
    image: clamav/clamav:latest
    container_name: telegram-groups-admin-clamav
    platform: linux/amd64  # Force AMD64 on ARM Macs
    restart: unless-stopped
    ports:
      - "3310:3310"
    volumes:
      - ./data/clamav:/var/lib/clamav
    environment:
      # ClamAV has a hard 2GB limit - files larger than this will skip ClamAV and use VirusTotal only
      # Telegram file size limits: Free=2GB, Premium=4GB
      CLAMD_CONF_StreamMaxLength: 2000M       # 2GB - ClamAV's maximum supported size
      CLAMD_CONF_MaxFileSize: 2000M           # Maximum file size to scan
      CLAMD_CONF_MaxScanSize: 2000M           # Maximum amount of data to scan
      CLAMD_CONF_MaxScanTime: 300000          # 5 minutes max scan time
      CLAMD_CONF_PCREMaxFileSize: 100M        # PCRE pattern matching limit (reduce for performance)
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "1"]
      interval: 30s
      timeout: 10s
      retries: 10  # Allow up to 5 minutes of retries (10 * 30s) for first-time signature download
      start_period: 60s  # Give ClamAV daemon 1 minute to start, then begin health checks
    networks:
      - telegram-admin

  # ---------------------------------------------------------------------------
  # Seq - Structured Log Server (Optional - For Development/Debugging)
  # ---------------------------------------------------------------------------
  seq:
    image: datalust/seq:latest
    container_name: telegram-groups-admin-seq
    restart: unless-stopped
    ports:
      - "5341:80"  # Seq UI accessible at http://localhost:5341
    volumes:
      - ./seqdata:/data
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_NOAUTHENTICATION: "True"  # Disable authentication for development
    networks:
      - telegram-admin

  # ---------------------------------------------------------------------------
  # Aspire Dashboard - Unified Observability UI (Optional - In-Memory)
  # ---------------------------------------------------------------------------
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: telegram-groups-admin-aspire
    restart: unless-stopped
    ports:
      - "18888:18888"  # Dashboard UI accessible at http://localhost:18888
      - "4317:18889"   # OTLP gRPC endpoint (internal port 18889 mapped to standard 4317)
    environment:
      ASPIRE_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS: "true"  # Disable authentication for development
    networks:
      - telegram-admin

  # ---------------------------------------------------------------------------
  # TelegramGroupsAdmin Application (Build from Source)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: ..  # Parent directory (repository root)
      dockerfile: TelegramGroupsAdmin/Dockerfile
      # Optional: Override default UID/GID at build time (default 1654)
      # args:
      #   PUID: 1000
      #   PGID: 1000
    image: telegramgroupsadmin:local
    container_name: telegram-groups-admin-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      clamav:
        condition: service_healthy
    volumes:
      - ./data:/data
    # Optional: Set user/group ID to match your host system (must match build args above)
    # Uncomment and adjust if you need specific UID/GID (default is 1654)
    # user: "1000:1000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # Rotate when log file reaches 10MB
        max-file: "15"       # Keep up to 15 rotated files (10MB * 15 = 150MB total)
        compress: "true"     # Compress rotated logs to save disk space
    environment:
      # =======================================================================
      # System Configuration
      # =======================================================================
      TZ: America/Phoenix  # Set your timezone (e.g., America/New_York, Europe/London, UTC)
      # Note: PUID/PGID are set via build args and 'user:' directive above if needed

      # =======================================================================
      # ASP.NET Core Configuration
      # =======================================================================
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_HTTP_PORTS: 8080

      # =======================================================================
      # Application Settings
      # =======================================================================
      APP__BASEURL: http://localhost:8080  # Change to your domain (e.g., https://telegram-admin.yourdomain.com)
      APP__DATAPATH: /data  # Base path for all app data (images, media, keys)

      # =======================================================================
      # Database Connection
      # =======================================================================
      # Make sure password matches POSTGRES_PASSWORD above!
      ConnectionStrings__PostgreSQL: "Host=postgres;Port=5432;Database=telegram_groups_admin;Username=tgadmin;Password=CHANGE_ME_STRONG_PASSWORD"

      # =======================================================================
      # Service Configuration (All configured via Settings UI after first login)
      # =======================================================================
      # After creating your first admin account, configure these in the UI:
      # - Settings > Infrastructure > Telegram Bot Configuration
      # - Settings > Infrastructure > OpenAI Configuration
      # - Settings > Infrastructure > SendGrid Configuration
      # - Settings > Features > Spam Detection (VirusTotal, CAS)
      # All API keys are stored encrypted in the database

      # =======================================================================
      # ClamAV Connection (Internal Docker Network)
      # =======================================================================
      CLAMAV__HOST: clamav
      CLAMAV__PORT: "3310"

      # =======================================================================
      # Observability Configuration (Optional - For Development/Debugging)
      # =======================================================================
      # Seq - Structured Logging (http://localhost:5341)
      SEQ_URL: http://seq:80
      # SEQ_API_KEY: ""  # Optional - leave empty for no authentication

      # Aspire Dashboard - Unified UI with Traces & Metrics (http://localhost:18888)
      OTEL_EXPORTER_OTLP_ENDPOINT: http://aspire-dashboard:18889
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_SERVICE_NAME: TelegramGroupsAdmin

      # =======================================================================
      # Message History Configuration
      # =======================================================================
      MESSAGEHISTORY__ENABLED: "true"
      MESSAGEHISTORY__RETENTIONHOURS: "720"  # 30 days
    healthcheck:
      # Use liveness probe for Docker (checks if app is alive, not if dependencies are healthy)
      # Database failures shouldn't cause container restart
      test: ["CMD", "/usr/bin/wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - telegram-admin

networks:
  telegram-admin:
    name: telegram-admin

# =============================================================================
# IMPORTANT: Setup Steps
# =============================================================================
# 1. Set a strong PostgreSQL password (replace CHANGE_ME_STRONG_PASSWORD above)
# 2. Start containers: docker compose up -d
# 3. Wait for database migrations to complete (check logs)
# 4. Open http://localhost:8080 and create first admin account
# 5. Configure services in Settings UI:
#    - Settings > Infrastructure > Telegram Bot (get token from @BotFather)
#    - Settings > Infrastructure > OpenAI (get key from platform.openai.com)
#    - Settings > Infrastructure > SendGrid (get key from sendgrid.com)
#    - Settings > Features > Spam Detection (VirusTotal, CAS)
# All API keys stored encrypted in database - no env vars needed!
#
# Optional Observability Tools (included for development):
# - Seq (Logs): http://localhost:5341
# - Aspire Dashboard (Traces + Metrics): http://localhost:18888
# =============================================================================

# =============================================================================
# Development Notes
# =============================================================================
# - This file builds from source code in the parent directory
# - The Dockerfile is located at ../TelegramGroupsAdmin/Dockerfile
# - Multi-stage build produces optimized production image
# - Build time: ~2-5 minutes depending on machine
# - To rebuild: docker compose build --no-cache app
# =============================================================================

# =============================================================================
# Data Persistence (all relative to compose file location)
# =============================================================================
# ./data/postgres/  - PostgreSQL database files
# ./data/clamav/    - ClamAV virus signatures (~200MB)
# ./seqdata/        - Seq structured logs (optional, development only)
# ./data/           - Application data:
#   ./data/keys/      - Data Protection keys (DO NOT DELETE!)
#   ./data/images/    - Downloaded message images
#   ./data/media/     - Downloaded media files (videos, audio, etc.)
# ./backups/        - Database backup files (from /export command)
#
# Note: Aspire Dashboard is in-memory only (no persistent storage)
# =============================================================================
